import*as t from"three";import{LX as e}from"lexgui";import"lexgui/extensions/CodeEditor.js";import{OrbitControls as s}from"three/addons/controls/OrbitControls.js";import{GLTFLoader as i}from"three/addons/loaders/GLTFLoader.js";import{GLTFExporter as n}from"three/addons/exporters/GLTFExporter.js";import{BVHLoader as a}from"three/addons/loaders/BVHLoader.js";import{FBXLoader as r}from"three/addons/loaders/FBXLoader.js";import{LineGeometry as o}from"three/addons/lines/LineGeometry.js";import{LineMaterial as l}from"three/addons/lines/LineMaterial.js";import{Line2 as h}from"three/addons/lines/Line2.js";const c={version:"2.1.1",ATELIER_URL:"https://atelier.gti.upf.edu/",ANIMICS_URL:"https://animics.gti.upf.edu/",AVATARS_URL:"https://resources.gti.upf.edu/3Dcharacters/",Modes:{SCRIPT:0,KEYFRAME:1},Backgrounds:{OPEN:0,STUDIO:1,PHOTOCALL:2}};e.mainArea=await e.init(),e.registerIcon("CircleRecording",'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">\x3c!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--\x3e<path d="M64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320z"/></svg>'),e.setThemeColor("purple");class d{static THUMBNAIL="data/imgs/monster.png";static ACTIVEPANEL_NONE=0;static ACTIVEPANEL_SETTINGS=1;static ACTIVEPANEL_CAMERA=2;static ACTIVEPANEL_BACKGROUND=3;static ACTIVEPANEL_AVATARS=4;static ACTIVEPANEL_LIGHTS=5;constructor(t){this.performs=t,this.randomSignAmount=0,this.avatarOptions=t.avatars,this.mainArea=e.mainArea,this.mainArea.root.ondrop=this.onDropFiles.bind(this),this.bmlInputData={openButton:null,dialog:null,codeObj:null,prevInstanceText:""},this.sigmlInputData={openButton:null,dialog:null,codeObj:null,prevInstanceText:""},this.glossInputData={openButton:null,dialog:null,textArea:null,glosses:""};const[s,i]=this.mainArea.split({type:"horizontal",sizes:["88%","12%"],minimizable:!0});if(this.canvasArea=s,s.onresize=t=>this.resize(t.width,t.height),t.appendCanvasTo(s.root),this.panel=i.addPanel({height:"100%"}),i.addOverlayButtons([{icon:"X",class:"relative",callback:()=>{this.setActivePanel(d.ACTIVEPANEL_NONE)}}],{float:"rt"}),this.branchesOpened={Customization:!0,Transformations:!0,Recording:!0,Animation:!0,Export:!0},window.sessionStorage){let t;t=window.sessionStorage.getItem("msg"),this.performs.scriptApp.msg=t?JSON.parse(t):null,t=window.sessionStorage.getItem("bmlInput"),this.bmlInputData.prevInstanceText=t||"",t=window.sessionStorage.getItem("sigmlInput"),this.sigmlInputData.prevInstanceText=t||"",t=window.sessionStorage.getItem("glossInput"),this.glossInputData.glosses=t||"",window.addEventListener("beforeunload",t=>{window.sessionStorage.setItem("msg",JSON.stringify(this.performs.scriptApp.msg)),this.bmlInputData&&this.bmlInputData.codeObj&&window.sessionStorage.setItem("bmlInput",this.bmlInputData.codeObj.getText()),this.sigmlInputData&&this.sigmlInputData.codeObj&&window.sessionStorage.setItem("sigmlInput",this.sigmlInputData.codeObj.getText()),this.glossInputData&&this.glossInputData.glosses&&window.sessionStorage.setItem("glossInput",this.glossInputData.glosses)}),window.addEventListener("keyup",t=>{if(" "==t.key){if(this.performs.mode==c.Modes.KEYFRAME)Object.keys(this.performs.keyframeApp.loadedAnimations).length?(this.performs.changePlayState(),this.changePlayButtons(this.performs.keyframeApp.playing)):e.popup("No animations to play!",null,{size:["200px","auto"]});else if(this.performs.mode==c.Modes.SCRIPT){if("TEXTAREA"==t.target.tagName||t.target.classList.contains("lexcodeeditor"))return;this.performs.scriptApp.replay()}}else"Escape"==t.key&&(this.activePanelType?this.setActivePanel(d.ACTIVEPANEL_NONE):this.setActivePanel(this.prevActivePanelType))})}this.playing=!1,this.captureEnabled=!1,this.controlsActive=!0,this.activePanelType=d.ACTIVEPANEL_NONE,this.prevActivePanelType=d.ACTIVEPANEL_NONE,this.setActivePanel(d.ACTIVEPANEL_NONE),this.overlayButtonsPlay=null,this.overlayButtonsReset=null,this.overlayButtonsMenu=null,this.createIcons(s)}setTransparentBackground(){document.body.parentElement.classList.add("transparent"),document.body.classList.add("transparent"),e.mainArea.root.parentElement.classList.add("transparent"),e.mainArea.root.classList.add("transparent"),this.canvasArea.root.classList.add("transparent"),this.canvasArea.root.parentElement&&this.canvasArea.root.parentElement.classList.add("transparent")}restoreColorBackground(){document.body.parentElement.classList.remove("transparent"),document.body.classList.remove("transparent"),e.mainArea.root.parentElement.classList.remove("transparent"),e.mainArea.root.classList.remove("transparent"),this.canvasArea.root.classList.remove("transparent"),this.canvasArea.root.parentElement&&this.canvasArea.root.parentElement.classList.remove("transparent")}resize(t,e){const s=t/e;for(let t=0;t<this.performs.cameras.length;t++)this.performs.cameras[t].aspect=s,this.performs.cameras[t].updateProjectionMatrix();this.performs.renderer.setSize(t,e)}refresh(){this.setActivePanel(this.activePanelType)}setActivePanel(t){switch(this.activePanelType){case d.ACTIVEPANEL_SETTINGS:this.overlayButtonsMenu.buttons.Settings.root.children[0].classList.remove("selected");break;case d.ACTIVEPANEL_CAMERA:this.overlayButtonsMenu.buttons.Camera.root.children[0].classList.remove("selected");break;case d.ACTIVEPANEL_BACKGROUND:this.overlayButtonsMenu.buttons.Backgrounds.root.children[0].classList.remove("selected");break;case d.ACTIVEPANEL_AVATARS:this.overlayButtonsMenu.buttons.Avatars.root.children[0].classList.remove("selected");break;case d.ACTIVEPANEL_LIGHTS:this.overlayButtonsMenu.buttons.Lights.root.children[0].classList.remove("selected")}switch(t){case d.ACTIVEPANEL_SETTINGS:this.createSettingsPanel();break;case d.ACTIVEPANEL_CAMERA:this.createCameraPanel();break;case d.ACTIVEPANEL_BACKGROUND:this.createBackgroundsPanel();break;case d.ACTIVEPANEL_AVATARS:this.createAvatarsPanel();break;case d.ACTIVEPANEL_LIGHTS:this.createLightsPanel();break;default:t=d.ACTIVEPANEL_NONE}t?(this.activePanelType==d.ACTIVEPANEL_NONE&&this.mainArea._moveSplit(.3*window.innerWidth),this.panel.parent.show()):(this.mainArea._moveSplit(-window.innerWidth),this.panel.parent.hide()),t!=this.activePanelType&&(this.prevActivePanelType=this.activePanelType),this.activePanelType=t}createSettingsPanel(s=!1){const i=this.panel;let n=i.getBranch("Animation");n&&(this.branchesOpened.Animation=!i.getBranch("Animation").content.parentElement.classList.contains("closed")),i.clear(),n=i.branch("Animation",{icon:"ASL",closed:!this.branchesOpened.Animation}),i.addLabel("Animation mode options",{disabled:!0,inputClass:"nobg"});const a=new e.Area({height:"fit-content"}),r=a.addTabs({fit:!0,sizes:["auto","auto"]}),o=new e.Area({id:"script"});let l=o.addPanel({className:"h-fit"});this.createBMLPanel(l);const h=new e.Area({id:"keyframe"});let d=h.addPanel();this.createKeyframePanel(d),r.add("Script animation",o,{selected:this.performs.mode==c.Modes.SCRIPT||-1==this.performs.mode,icon:"Code2",width:"50%",selectable:!0,onSelect:(t,e)=>{this.performs.currentCharacter.config?(this.performs.changeMode(c.Modes.SCRIPT),this.performs.scriptApp.currentIdle&&this.performs.scriptApp.bindAnimationToCharacter(this.performs.scriptApp.currentIdle,this.performs.currentCharacter.model.name)):this.performs.changeMode(-1),this.overlayButtonsReset.buttons["Reset pose"].root.classList.remove("hidden")}}),r.add("Keyframe animation",h,{selected:this.performs.mode==c.Modes.KEYFRAME,icon:"Film",width:"50%",selectable:!0,onSelect:(t,e)=>{this.performs.changeMode(c.Modes.KEYFRAME),this.overlayButtonsReset.buttons["Reset pose"].root.classList.add("hidden")}}),n.content.appendChild(a.root),i.branch("Transformations",{icon:"Move",closed:!this.branchesOpened.Transformations});const p=this.performs.currentCharacter.model;i.addVector3("Position",[p.position.x,p.position.y,p.position.z],(t,e)=>{p.position.set(t[0],t[1],t[2]),window.localStorage.setItem("position",t[0].toString()+","+t[1].toString()+","+t[2].toString())},{step:.01}),i.addVector3("Rotation",[t.MathUtils.radToDeg(p.rotation.x),t.MathUtils.radToDeg(p.rotation.y),t.MathUtils.radToDeg(p.rotation.z)],(e,s)=>{p.rotation.set(t.MathUtils.degToRad(e[0]),t.MathUtils.degToRad(e[1]),t.MathUtils.degToRad(e[2])),window.localStorage.setItem("rotation",p.quaternion.x.toString()+","+p.quaternion.y.toString()+","+p.quaternion.z.toString()+","+p.quaternion.w.toString())},{step:.01}),i.addNumber("Scale",p.scale.x,(t,e)=>{p.scale.set(t,t,t),window.localStorage.setItem("scale",t.toString())},{step:.01}),i.getBranch("Export")&&(this.branchesOpened.Export=!i.getBranch("Export").content.parentElement.classList.contains("closed")),i.branch("Export",{icon:"FileOutput",closed:!this.branchesOpened.Export}),this.performs.mode==c.Modes.KEYFRAME&&i.addButton(null,"Export avatar",t=>{this.showExportAvatarDialog()}),i.addButton(null,"Export configuration",t=>{this.showExportDialog()})}createAnimationBranch(){}createBackgroundsPanel(){const s=this.panel;s.getBranch("Backgrounds")&&(this.branchesOpened.Backgrounds=!s.getBranch("Backgrounds").content.parentElement.classList.contains("closed")),s.clear(),s.branch("Backgrounds");let i=this.performs.sceneColor;i instanceof String&&(i=Number(i.replace("#","").replace("0x",""))),i=new t.Color(i),s.addColor("Color","#"+i.getHexString(),(t,e)=>{this.performs.setBackPlaneColor(t)});const n=s.addButton("openBtn","Open space",t=>{this.performs.setBackground(c.Backgrounds.OPEN),this.createBackgroundsPanel()},{img:"./data/imgs/open-space.png",className:"centered",buttonClass:"roundedbtn secondary",hideName:!0}).root;this.performs.background==c.Backgrounds.OPEN&&n.children[0].classList.add("selected");const a=new e.Panel,r=s.addButton("studioBtn","Studio",t=>{this.performs.setBackground(c.Backgrounds.STUDIO),this.createBackgroundsPanel()},{img:"./data/imgs/studio-space.png",className:"centered flex flex-col items-center",buttonClass:"roundedbtn secondary",hideName:!0}).root;if(this.performs.background==c.Backgrounds.STUDIO){r.children[0].classList.add("selected");const t=a.addButton(null,"Edit properties",t=>{this.showStudioPropertiesDialog()},{icon:"PenBox",className:"centered",width:"40px",height:"40px"}).root;r.append(t)}const o=new e.Panel,l=s.addButton("photocallBtn","Photocall",t=>{this.performs.setBackground(c.Backgrounds.PHOTOCALL),this.createBackgroundsPanel()},{img:"./data/imgs/photocall-space.png",className:"centered flex flex-col items-center",buttonClass:"roundedbtn secondary",hideName:!0}).root;if(this.performs.background==c.Backgrounds.PHOTOCALL){l.children[0].classList.add("selected");const t=o.addButton(null,"Edit properties",t=>{this.showPhotocallPropertiesDialog()},{icon:"PenBox",className:"centered",width:"40px"}).root;l.append(t)}}showStudioPropertiesDialog(){new e.Dialog("Properties",s=>{let i=!0;s.addComboButtons(null,[{value:"From File",callback:(t,e)=>{i=!0,s.components["Image/Video URL"].root.classList.add("hidden"),s.components.File.root.classList.remove("hidden")}},{value:"From URL",callback:(t,e)=>{i=!1,s.components.File.root.classList.add("hidden"),s.components["Image/Video URL"].root.classList.remove("hidden")}}],{selected:i?"From File":"From URL",width:"100%"}),s.addFile("File",(i,n)=>{const a=s.components.File.root.children[1].files;if(!a.length)return;const r=a[0].name.split(".");r[0];const o=r[1].toLowerCase();if("png"==o||"jpeg"==o||"jpg"==o||"mp4"==o){const e=e=>{if("mp4"==o){const s=new t.VideoTexture(e.target);s.colorSpace=t.SRGBColorSpace,this.performs.backgroundTexture=s}else this.performs.backgroundTexture=e.target;this.performs.setBackground(c.Backgrounds.STUDIO,this.performs.backgroundTexture)};if("mp4"!=o){const t=new Image;t.onload=e,t.src=i,this.performs.videoBackground=null}else{const t=document.createElement("video");t.id="backgrodundVideo",t.src=i,this.performs.videoBackground=t,e({target:t})}}else e.popup("Only accepts PNG, JPEG and JPG formats!")},{type:"url",read:!0}),s.addText("Image/Video URL","",(t,e)=>{if(!t)return;const s=t.split(".");let i=s[s.length-2];i=i.split("/"),i=i.pop();let n=s[s.length-1];n=n.split("?")[0];const a=new Image;a.onload=t=>{this.performs.backgroundTexture=t.target,this.performs.setBackground(c.Backgrounds.STUDIO,this.performs.backgroundTexture)},fetch(t).then(function(t){t.ok?t.blob().then(function(t){var e=URL.createObjectURL(t);a.src=e}):console.log("Not found")}).catch(function(t){console.log("Error:"+t.message)})},{className:"hidden",read:!0}),s.addSelect("Choose a setting",["Fill","Adjust","Expand","Extend"],this.performs.backgroundSettings,t=>{this.performs.setBackgroundSettings(t),this.performs.backgroundSettings=t}),s.addNumber("Scale",this.performs.textureScale,t=>{this.performs.setBackgroundTextureScale(t)},{min:0,max:2,step:.01}),s.addVector2("Position",this.performs.texturePosition,t=>{this.performs.setBackgroundTexturePosition(t)},{step:.01})},{className:"resizeable"})}showPhotocallPropertiesDialog(){new e.Dialog("Properties",t=>{let s=!0;t.addComboButtons(null,[{value:"From File",callback:(e,i)=>{s=!0,t.components["Logo URL"].root.classList.add("hidden"),t.components.File.root.classList.remove("hidden")}},{value:"From URL",callback:(e,i)=>{s=!1,t.components.File.root.classList.add("hidden"),t.components["Logo URL"].root.classList.remove("hidden")}}],{selected:s?"From File":"From URL",width:"100%"}),t.addFile("File",(s,i)=>{const n=t.components.File.root.children[1].files;if(!n.length)return;const a=n[0].name.split(".");a[0];const r=a[1].toLowerCase();if("png"==r||"jpeg"==r||"jpg"==r){const t=t=>{this.performs.logo=t.target,this.performs.setBackground(c.Backgrounds.PHOTOCALL,this.performs.logo)},e=new Image;e.onload=t,e.src=s}else e.popup("Only accepts PNG, JPEG and JPG formats!")},{type:"url",read:!0}),t.addText("Logo URL","",(t,e)=>{if(!t)return;const s=t.split(".");let i=s[s.length-2];i=i.split("/"),i=i.pop();let n=s[s.length-1];n=n.split("?")[0];const a=new Image;a.onload=t=>{this.performs.logo=t.target,this.performs.setBackground(c.Backgrounds.PHOTOCALL,this.performs.logo)},fetch(t).then(function(t){t.ok?t.blob().then(function(t){var e=URL.createObjectURL(t);a.src=e}):console.log("Not found")}).catch(function(t){console.log("Error:"+t.message)})},{read:!0,className:"hidden"}),t.addNumber("Offset",this.performs.repeatOffset,t=>{this.performs.setPhotocallOffset(t)},{min:0,max:1,step:.01}),t.addVector2("Repeatition",this.performs.repeatCount,t=>{this.performs.repeatCount=t},{min:0,max:20})},{className:"resizeable"})}createAvatarsPanel(){const t=this.panel;if(t.getBranch("Avatars")&&(this.branchesOpened.Avatars=!t.getBranch("Avatars").content.parentElement.classList.contains("closed")),t.clear(),t.branch("Avatars"),t.addButton("Upload yours","Upload Avatar",t=>{this.uploadAvatar((t,e)=>{this.selectAvatar(t)})},{nameWidth:"100px",icon:"UploadCloud",width:"140px"}),t.addSeparator(),this.performs.avatarShirt){let e=this.performs.getClothesColor();t.addColor("Clothes","#"+e,(t,e)=>{this.performs.setClothesColor(t)})}const s=(t,s,i,n=!1)=>{const a=e.makeContainer(["100%","auto"],"flex flex-col gap-3 p-3 items-center text-md rounded-lg hover:bg-accent cursor-pointer "+(n?"bg-secondary":""),"",null),r=e.makeContainer(["200px","auto"],"flex flex-col py-6 justify-center items-center content-center rounded-lg gap-3 card-button card-color hover:scale",`\n               <img src="${t}" height="120px">\n            `,a);let o=null;n&&(o=new e.Button(null,"Edit Character",(t,e)=>{this.createEditAvatarDialog(e)},{icon:"UserRoundPen",className:"justify-center",width:"50px",buttonClass:""}));const l=e.makeContainer(["auto","auto"],"flex items-center",`<p>${s}</p>`,a);return n&&l.appendChild(o.root),a.id=i,r.addEventListener("click",async(t,e)=>{a.id!=this.performs.currentCharacter.model.name&&(this.performs.scriptApp.mood="Neutral",this.performs.scriptApp.ECAcontroller&&this.performs.scriptApp.ECAcontroller.reset(),this.selectAvatar(a.id))}),a},i=e.makeContainer(["100%","auto"],"grid gap-2","");i.style.gridTemplateColumns="repeat(auto-fill, minmax(220px, 1fr))",i.classList.add("showScrollBar"),t.root.appendChild(i);for(let t in this.avatarOptions){const e=t==this.performs.currentCharacter.model.name,n=s(this.avatarOptions[t][3]??d.THUMBNAIL,t,t,e);i.appendChild(n),e&&n.scrollIntoViewIfNeeded&&setTimeout(n.scrollIntoViewIfNeeded.bind(n),1)}}createEditAvatarDialog(){let e=this.performs.currentCharacter.model.name;this.editAvatar(e,{callback:(s,i,n)=>{e!=s&&(this.avatarOptions[s]=[this.avatarOptions[e][0],this.avatarOptions[e][1],this.avatarOptions[e][2],this.avatarOptions[e][3]],delete this.avatarOptions[e],e=s,this.performs.currentCharacter.model.name=e,this.refresh()),this.avatarOptions[e][2]=i;const a=(new t.Quaternion).setFromAxisAngle(new t.Vector3(1,0,0),i);this.performs.currentCharacter.model.quaternion.premultiply(a),this.performs.currentCharacter.config&&this.performs.currentCharacter.config==n||(this.performs.currentCharacter.config=n,n&&(this.avatarOptions[e][1]=n._filename,this.performs.scriptApp.onLoadAvatar(this.performs.currentCharacter.model,this.performs.currentCharacter.config,this.performs.currentCharacter.skeleton),this.performs.currentCharacter.skeleton.pose(),this.performs.scriptApp.ECAcontroller.reset(),this.performs.changeMode(c.Modes.SCRIPT),this.activePanelType==d.ACTIVEPANEL_SETTINGS&&this.createSettingsPanel(),this.overlayButtonsReset.buttons["Reset pose"].root.classList.remove("hidden")))},name:e,modelFilePath:this.avatarOptions[e][0],modelConfigPath:this.avatarOptions[e][1]})}createCameraPanel(){const t=this.panel;t.getBranch("Recording")&&(this.branchesOpened.Recording=!t.getBranch("Recording").content.parentElement.classList.contains("closed")),t.clear(),t.branch("Recording",{icon:"Video",closed:!this.branchesOpened.Recording});let e=[];for(let t=0;t<this.performs.cameras.length;t++){const s={value:(t+1).toString(),callback:(t,e)=>{this.performs.controls[this.performs.camera].enabled=!1,this.performs.camera=t-1,this.performs.controls[this.performs.camera].enabled=!0}};e.push(s)}t.addComboButtons("View Type",[{value:"Restricted View",icon:"Camera",callback:(t,e)=>{this.performs.changeCameraMode(!0),this.createCameraPanel()}},{value:"Free View",icon:"Move",callback:(t,e)=>{this.performs.changeCameraMode(!1),this.createCameraPanel()}}],{selected:this.performs.cameraRestricted?"Restricted View":"Free View"}),t.addSeparator(),t.sameLine(),t.addComboButtons("Camera",e,{selected:(this.performs.camera+1).toString(),width:"80%"}),t.addButton(null,"Reset",t=>{this.performs.controls[this.performs.camera].reset()},{icon:"RotateCcw"}),t.endLine("left"),t.addCheckbox("Enable capture",this.captureEnabled,t=>{this.captureEnabled=t,this.captureEnabled?this.overlayButtonsPlay.buttons["Record video"].root.classList.remove("hidden"):this.overlayButtonsPlay.buttons["Record video"].root.classList.add("hidden")},{skipReset:!0,className:"contrast",label:"",suboptions:t=>{t.addText(null,"Select cameras to be recorded:",null,{disabled:!0,inputClass:"nobg"}),t.sameLine();for(let e=0;e<this.performs.cameras.length;++e)t.addCheckbox((e+1).toString(),this.performs.cameras[e].record,(t,s)=>{this.performs.cameras[e].record=t},{className:"contrast",label:""});t.endLine(),t.addTitle("Automatic exportation"),t.addCheckbox("Export as ZIP",this.performs.animationRecorder.exportZip,t=>{this.performs.animationRecorder.exportZip=t},{skipReset:!0,className:"contrast",label:"",title:"Pack all videos into a single ZIP or download each file individually"})}})}createLightsPanel(){const t=this.panel;t.clear(),t.branch("Lights",{icon:"Lightbulb"}),t.addColor("Color","#"+this.performs.dirLight.color.getHexString(),(t,e)=>{this.performs.dirLight.color.set(t)});const e=[this.performs.dirLight.position.x,this.performs.dirLight.position.y,this.performs.dirLight.position.z];t.addVector3("Position",e,t=>{this.performs.dirLight.position.set(t[0],t[1],t[2])},{min:-10,max:10})}createIcons(t){const e=[{name:"Hide controls",selectable:!1,icon:"EyeOff",swap:"Eye",class:"larger",state:!1,callback:t=>{this.controlsActive?this.hideControls():this.showControls()}},{name:"Settings",selectable:!1,icon:"Settings",class:"larger",callback:t=>{this.activePanelType==d.ACTIVEPANEL_SETTINGS?this.setActivePanel(d.ACTIVEPANEL_NONE):(this.setActivePanel(d.ACTIVEPANEL_SETTINGS),this.overlayButtonsMenu.buttons[t].root.children[0].classList.add("selected"))}},{name:"Avatars",selectable:!1,icon:"UserPen",class:"larger",callback:t=>{this.activePanelType==d.ACTIVEPANEL_AVATARS?this.setActivePanel(d.ACTIVEPANEL_NONE):(this.setActivePanel(d.ACTIVEPANEL_AVATARS),this.overlayButtonsMenu.buttons[t].root.children[0].classList.add("selected"))}},{name:"Backgrounds",selectable:!1,icon:"Images",class:"larger",callback:t=>{this.activePanelType==d.ACTIVEPANEL_BACKGROUND?this.setActivePanel(d.ACTIVEPANEL_NONE):(this.setActivePanel(d.ACTIVEPANEL_BACKGROUND),this.overlayButtonsMenu.buttons[t].root.children[0].classList.add("selected"))}},{name:"Camera",selectable:!1,icon:"Video",class:"larger",callback:t=>{this.activePanelType==d.ACTIVEPANEL_CAMERA?this.setActivePanel(d.ACTIVEPANEL_NONE):(this.setActivePanel(d.ACTIVEPANEL_CAMERA),this.overlayButtonsMenu.buttons[t].root.children[0].classList.add("selected"))}},{name:"Lights",selectable:!1,icon:"Lightbulb",class:"larger",callback:t=>{this.activePanelType==d.ACTIVEPANEL_LIGHTS?this.setActivePanel(d.ACTIVEPANEL_NONE):(this.setActivePanel(d.ACTIVEPANEL_LIGHTS),this.overlayButtonsMenu.buttons[t].root.children[0].classList.add("selected"))}},{name:"Info",selectable:!1,icon:"CircleQuestionMark",class:"larger",callback:t=>{this.showGuide()}}];this.overlayButtonsMenu=t.addOverlayButtons(e,{className:"hiddenBackground",float:"vr",id:"overlay-controls"}),t.panels[0].root.style.visibility="hidden",this.createPlayButtons()}createPlayButtons(){const t=this.mainArea.sections[0];let s=[{name:"Reset pose",icon:"PersonStanding",class:"relative left",callback:(t,e)=>{this.performs.mode==c.Modes.SCRIPT&&(this.performs.scriptApp.mood="Neutral",this.performs.scriptApp.ECAcontroller.reset(),this.createSettingsPanel())}}],i=[{name:"Record video",icon:"CircleRecording@solid",class:"relative",callback:(t,e)=>{this.performs.animationRecorder.isRecording||this.setActivePanel(d.ACTIVEPANEL_NONE);const s=this.overlayButtonsPlay.buttons["Record video"].root.children[0];this.performs.mode==c.Modes.SCRIPT?(this.performs.scriptApp.ECAcontroller.reset(!0),setTimeout(()=>{this.performs.animationRecorder.manageCapture(),this.createCameraPanel(),this.performs.animationRecorder.isRecording?(s.classList.remove("floating-button"),s.classList.add("floating-button-playing")):(s.classList.remove("floating-button-playing"),s.classList.add("floating-button"))},100)):this.showRecordingDialog(()=>{this.performs.animationRecorder.manageMultipleCapture(this.performs.keyframeApp),this.createCameraPanel()}),this.performs.animationRecorder.isRecording?(s.classList.remove("floating-button"),s.classList.add("floating-button-playing")):(s.classList.remove("floating-button-playing"),s.classList.add("floating-button"))}},{name:"Play",icon:"Play@solid",class:"large",callback:()=>{this.performs.mode==c.Modes.SCRIPT?this.performs.scriptApp.replay():this.performs.mode==c.Modes.KEYFRAME&&(Object.keys(this.performs.keyframeApp.loadedAnimations).length?(this.performs.changePlayState(!0),this.changePlayButtons(!0)):e.popup("No animations to play!",null,{size:["200px","auto"]})),this.performs.videoBackground&&this.performs.background==c.Backgrounds.STUDIO&&(this.performs.videoBackground.currentTime=0,this.performs.videoBackground.play())}},{name:"Stop",icon:"Stop@solid",class:"large",callback:()=>{this.performs.mode==c.Modes.SCRIPT?this.performs.scriptApp.ECAcontroller.reset(!0):this.performs.mode==c.Modes.KEYFRAME&&this.performs.changePlayState(!1),this.performs.videoBackground&&(this.performs.videoBackground.pause(),this.performs.videoBackground.currentTime=0),this.changePlayButtons(!1)}}];this.overlayButtonsPlay=t.addOverlayButtons(i,{float:"vbr",id:"overlay-playbuttons"}),this.overlayButtonsReset=t.addOverlayButtons(s,{float:"hbr",id:"overlay-buttons"}),t.panels[1].root.style.visibility="hidden",t.panels[2].root.style.visibility="hidden",this.overlayButtonsPlay.buttons.Stop.root.classList.add("hidden"),this.overlayButtonsPlay.buttons["Record video"].root.classList.add("hidden"),this.overlayButtonsPlay.buttons["Record video"].root.style.justifyContent="right",this.overlayButtonsPlay.buttons["Record video"].root.children[0].classList.add("floating-button"),this.overlayButtonsReset.buttons["Reset pose"].root.children[0].classList.add("floating-button"),this.performs.mode!=c.Modes.SCRIPT&&this.overlayButtonsReset.buttons["Reset pose"].root.classList.add("hidden")}changePlayButtons(t){t?(this.overlayButtonsPlay.buttons.Stop.root.classList.remove("hidden"),this.overlayButtonsPlay.buttons.Play.root.classList.add("hidden")):(this.overlayButtonsPlay.buttons.Stop.root.classList.add("hidden"),this.overlayButtonsPlay.buttons.Play.root.classList.remove("hidden"))}onChangeMode(t){if(t==c.Modes.SCRIPT){let t={type:"behaviours",data:[{type:"faceEmotion",emotion:this.performs.scriptApp.mood.toUpperCase(),amount:this.performs.scriptApp.moodIntensity,start:0,shift:!0}]};this.overlayButtonsReset.buttons["Reset pose"].root.classList.remove("hidden"),this.changePlayButtons(!1),this.performs.scriptApp.ECAcontroller.processMsg(JSON.stringify(t)),this.performs.keyframeApp.trajectoriesActive&&this.performs.keyframeApp.trajectoriesHelper.hide()}else t==c.Modes.KEYFRAME?(this.overlayButtonsReset.buttons["Reset pose"].root.classList.add("hidden"),this.changePlayButtons(this.performs.keyframeApp.playing),this.performs.keyframeApp.trajectoriesActive&&this.performs.keyframeApp.trajectoriesHelper.show()):(this.overlayButtonsReset.buttons["Reset pose"].root.classList.add("hidden"),this.changePlayButtons(!1))}createBMLPanel(t,s){if(this.bmlGui=t,this.bmlGui.clear(),!this.performs.currentCharacter.config)return this.bmlGui.addText(null,"To use this mode, the current character's configuration file is needed.",null,{disabled:!0,inputClass:"nobg"}),void this.bmlGui.addButton(null,"Edit avatar",()=>{this.createEditAvatarDialog()},{icon:"Edit"});this.bmlGui.addNumber("Speed",this.performs.scriptApp.speed,(t,e)=>{this.performs.setSpeed(t)},{min:.1,max:2,step:.01}),this.bmlGui.sameLine(),this.bmlGui.addButton(null,"Reset pose",(e,s)=>{this.performs.scriptApp.mood="Neutral",this.performs.scriptApp.ECAcontroller.reset(),this.createBMLPanel(t)},{icon:"PersonStanding",width:"30%",buttonclass:"floating-button",title:"Reset pose"}),this.bmlGui.addButton(null,"Replay",(t,e)=>{this.performs.scriptApp.replay(),this.changePlayButtons(!1)},{icon:"Play@solid",width:"70%"}),this.bmlGui.endLine(),this.bmlGui.addSeparator(),this.bmlInputData.openButton=this.bmlGui.addButton(null,"BML Input",(t,s)=>{this.bmlInputData.dialog&&this.bmlInputData.dialog.close(),this.bmlInputData.dialog=new e.PocketDialog("BML Instruction",t=>{this._firstPocketDialogOpen||(this._firstPocketDialogOpen=!0,setTimeout(this.bmlInputData.openButton.setState.bind(this.bmlInputData.openButton,!0),1));let s="Write in the text area below the bml instructions to move the avatar from the web application. A sample of BML instructions can be tested through the helper tabs in the right panel.";e.makeElement("div","p-2",s,t.root),t.addButton(null,"Click here to see BML instructions and attributes",()=>{window.open("https://github.com/upf-gti/performs/blob/main/docs/InstructionsBML.md")},{buttonClass:"warning outline"}),s="Note: In 'speech', all text between '%' is treated as actual words. An automatic translation from words (dutch) to phonemes (arpabet) is performed.",t.addTextArea(null,s,null,{disabled:!0,fitHeight:!0}),s="Note: Each instruction is inside '{}'. Each instruction is separated by a coma ',' except que last one.",t.addTextArea(null,s,null,{disabled:!0,fitHeight:!0}),s='An example: \n[{ "type":"speech", "start": 0, "text": "%hallo%.", "sentT": 1, "sentInt": 0.5 }, { "type": "gesture", "start": 0, "attackPeak": 0.5, "relax": 1, "end": 2, "locationBodyArm": "shoulder", "lrSym": true, "hand": "both", "distance": 0.1 }]',e.makeElement("div","p-2",s,t.root);const i=new e.Area({height:"59%"});t.attach(i.root);let n=new e.CodeEditor(i,{highlight:"JSON",allowAddScripts:!1,name:"BML",onContextMenu:t=>[{path:"Format",callback:()=>{let t=this.bmlInputData.codeObj.getText(),s=null;try{s=JSON.parse(t)}catch(t){s=null}if(!s)try{s=JSON.parse("["+t+"]")}catch(t){s=null}s?this.bmlInputData.codeObj.setText(JSON.stringify(s,void 0,parseInt(this.bmlInputData.codeObj.tabSpaces))):e.popup('Check your code for errors. Common errors include: \n- Keys must be quoted: {"intensity" : 0.2}\n- Numbers use points (.) for decimal numbers: 0.2\n- Elements of an array/object are separated by commas EXCEPT the last element {"a": 1, "b":2}',"Invalid bml message",{timeout:2e4})}}]});n.setText(this.bmlInputData.prevInstanceText),this.bmlInputData.codeObj=n,t.addButton(null,"Send",()=>{let t={type:"behaviours",data:this._stringToBML(this.bmlInputData.codeObj.getText())};t.data.length&&this.performs.scriptApp.processMessageRawBlocks([{type:"bml",data:t}])},{buttonClass:"primary"}),t.addButton(null,"Edit on Animics",()=>{const t=()=>{if(this.animics.app.global){this.animics.app.global.app||(this.animics.app.global.createApp({mode:"bml"}),this.animics.app.global.app.editor.realizer=window,this.animics.app.global.app.editor.performsApp=this.performs);let t={data:this._stringToBML(this.bmlInputData.codeObj.getText())};this.animics.app.global.app.editor.activeTimeline&&this.animics.app.global.app.editor.clearAllTracks(!1),this.animics.app.global.app.editor.gui.loadBMLClip({behaviours:t.data})}else setTimeout(t,1e3)};!this.animics||this.animics.closed?(this.animics=window.open(c.ANIMICS_URL),this.animics.onload=(e,s)=>{this.animics.app=e.currentTarget,t()},this.animics.addEventListener("beforeunload",()=>{this.animics=null})):t()})},{size:["35%","70%"],float:"left",className:"resizeable",draggable:!0,closable:!0,onBeforeClose:()=>{this.bmlInputData.prevInstanceText=this.bmlInputData.codeObj.getText(),this.bmlInputData.dialog=null,this.bmlInputData.codeObj=null}}),this.bmlInputData.dialog.root.children[1].classList.add("showScrollBar")}),this.sigmlInputData.openButton=this.bmlGui.addButton(null,"SiGML Input",(t,s)=>{this.sigmlInputData.dialog&&(this.sigmlInputData.prevInstanceText=this.sigmlInputData.codeObj.getText(),this.sigmlInputData.dialog.close()),this.sigmlInputData.dialog=new e.PocketDialog("SiGML Instruction",t=>{this._firstPocketDialogOpen||(this._firstPocketDialogOpen=!0,setTimeout(this.sigmlInputData.openButton.setState.bind(this.sigmlInputData.openButton,!0),1));let s=new e.Area({height:"100%"});t.attach(s.root);let[i,n]=s.split({type:"vertical",sizes:["90%","10%"]}),a=new e.Panel({height:"100%"});i.attach(a.root);e.makeElement("div","p-2","Write in the text area below the SiGML instructions (as in JaSigning) to move the avatar from the web application. Work in progress",a.root);const r=new e.Area({height:"85%"});a.attach(r.root);let o=new e.CodeEditor(r,{highlight:"XML",allowAddScripts:!1,name:"XML"});o.setText(this.sigmlInputData.prevInstanceText),this.sigmlInputData.codeObj=o;let l=new e.Panel({height:"100%"});n.attach(l.root),l.addButton(null,"Send",()=>{let t=this.sigmlInputData.codeObj.getText().replaceAll("\n","").replaceAll("\r","");this.performs.scriptApp.processMessageRawBlocks([{type:"sigml",data:t}])},{buttonClass:"primary"})},{size:["35%","70%"],float:"left",className:"resizeable",draggable:!0,closable:!0,onclose:t=>{this.sigmlInputData.prevInstanceText=this.sigmlInputData.codeObj.getText(),this.sigmlInputData.dialog=null,this.sigmlInputData.codeObj=null,t.remove()}}),this.sigmlInputData.dialog.root.children[1].classList.add("showScrollBar")});let i=Object.keys(this.performs.scriptApp.languageDictionaries),n={};this.language=i[0];for(let t=0;t<i.length;t++){let e=i[t];n[e]=[];for(let t in this.performs.scriptApp.languageDictionaries[e].glosses)n[e].push(t.replaceAll(".sigml",""))}this.glossInputData.openButton=this.bmlGui.addButton(null,"Glosses Input",(t,s)=>{this.glossInputData.dialog&&this.glossInputData.dialog.close(),this.glossInputData.dialog=new e.PocketDialog("Glosses Input",t=>{t.refresh=()=>{t.clear();e.makeElement("div","p-2","Select or write in the text area below the glosses (NGT) to move the avatar from the web application. Work in progress",t.root),t.addSelect("Language",i,this.performs.scriptApp.selectedLanguage,(e,s)=>{this.performs.scriptApp.selectedLanguage=e,t.refresh()});const s=t.addSelect("Select glosses",n[this.language],"",(t,e)=>{this.glossInputData.glosses+=" "+t,this.glossInputData.textArea.set(this.glossInputData.glosses)},{filter:!0});s.root.getElementsByClassName("lexselectoptions")[0].style.maxHeight="400px",this.glossInputData.textArea=t.addTextArea("Write glosses",this.glossInputData.glosses,(t,e)=>{this.glossInputData.glosses=t},{placeholder:"Hallo Leuk"}),t.addButton(null,"Send",()=>{let t=this.glossInputData.glosses.replaceAll("\n"," ").split(" ");for(let e=0;e<t.length;++e)"string"!=typeof t[e]||t[e].length<1?(t.splice(e,1),--e):t[e]={type:"glossName",data:t[e].toUpperCase()};t.length||alert("Please, write or select at least one gloss"),this.performs.scriptApp.processMessageRawBlocks(t)},{buttonClass:"primary"})},t.refresh()},{size:["35%"],float:"left",draggable:!0,closable:!0})}),this.bmlGui.addSeparator(),this.bmlGui.sameLine(),this.bmlGui.addNumber("Random Signs",this.randomSignAmount,(t,e)=>{this.randomSignAmount=t},{min:0,max:100,skipReset:!0,nameWidth:"105px",width:"80%"}),this.bmlGui.addButton(null,"Play random signs",(t,e)=>{if(!this.randomSignAmount)return;let s=Object.keys(this.performs.scriptApp.languageDictionaries[this.performs.scriptApp.selectedLanguage].glosses),i=[];for(let t=0;t<this.randomSignAmount;++t)i.push({type:"glossName",data:s[Math.floor(Math.random()*(s.length-1))]});console.log(JSON.parse(JSON.stringify(i))),this.performs.scriptApp.processMessageRawBlocks(i)},{icon:"ArrowRightFromLine@solid",width:"20%",title:"Play random signs"}),this.bmlGui.endLine(),this.bmlGui.addSeparator(),this.bmlGui.addSelect("Mood",["Neutral","Anger","Happiness","Sadness","Surprise","Fear","Disgust","Contempt"],this.performs.scriptApp.mood,(t,e)=>{let s={type:"behaviours",data:[{type:"faceEmotion",emotion:t.toUpperCase(),amount:this.performs.scriptApp.moodIntensity,start:0,shift:!0}]};this.performs.scriptApp.mood=t,this.performs.scriptApp.ECAcontroller.processMsg(JSON.stringify(s))}),this.bmlGui.addNumber("Mood intensity",this.performs.scriptApp.moodIntensity,t=>{let e={type:"behaviours",data:[{type:"faceEmotion",emotion:this.performs.scriptApp.mood.toUpperCase(),amount:t,start:0,shift:!0}]};this.performs.scriptApp.ECAcontroller.processMsg(JSON.stringify(e)),this.performs.scriptApp.moodIntensity=t},{min:0,max:1,step:.01,nameWidth:"110px"}),this.bmlGui.addToggle("Apply idle animation",this.performs.scriptApp.applyIdle,t=>{this.performs.scriptApp.onApplyIdle(t)},{nameWidth:"auto",skipReset:!0,label:"",nameWidth:"135px",className:"success",suboptions:t=>{t.addSelect("Animations",Object.keys(this.performs.scriptApp.loadedIdleAnimations),this.performs.scriptApp.currentIdle,t=>{this.performs.scriptApp.bindAnimationToCharacter(t,this.performs.currentCharacter.model.name)}),t.addNumber("Intensity",this.performs.scriptApp.intensity,t=>{this.performs.scriptApp.setIntensity(t)},{min:.1,max:1,step:.01})}}),this.bmlGui.merge()}createKeyframePanel(t,s){this.keyframeGui=t,this.keyframeGui.clear(),this.keyframeGui.addNumber("Speed",this.performs.keyframeApp.speed,(t,e)=>{this.performs.setSpeed(t)},{min:-2,max:2,step:.01});const i=Object.keys(this.performs.keyframeApp.loadedAnimations);this.keyframeGui.addSelect("Animation",i,this.performs.keyframeApp.currentAnimation,t=>{this.performs.changeAnimation(t)}),this.keyframeGui.sameLine();const n=this.keyframeGui.addFile("Animation File",(s,i)=>{let n=t.components["Animation File"].root.children[1].files;n.length&&this.performs.keyframeApp.loadFiles(n,s=>{s.length?(this.performs.changeMode(c.Modes.KEYFRAME),this.createKeyframePanel(t)):e.popup("This file doesn't contain any animation or a valid source avatar!")})},{type:"url",multiple:"multiple"});n.root.classList.add("hidden"),n.root.children[1].setAttribute("multiple","multiple"),this.keyframeGui.addButton(null,"Upload animation",(t,e)=>{n.root.children[1].click()},{icon:"Upload",width:"30%",className:"no-padding"}),this.keyframeGui.addButton(null,null,(t,e)=>{this.performs.changePlayState(),this.changePlayButtons(this.performs.keyframeApp.playing)},{icon:"Play@solid",width:"70%",className:"no-padding"}),this.keyframeGui.endLine(),i.length>1&&this.keyframeGui.addToggle("Blend animations",this.performs.keyframeApp.useCrossFade,t=>{this.performs.keyframeApp.useCrossFade=t},{skipReset:!0,label:"",suboptions:t=>{t.addNumber("Blend time",this.performs.keyframeApp.blendTime,t=>{this.performs.keyframeApp.blendTime=t},{min:0,step:.01})}}),this.keyframeGui.branch("Retargeting",{icon:"Tags"}),this.keyframeGui.addToggle("Source embedded transforms",this.performs.keyframeApp.srcEmbedWorldTransforms,t=>{this.performs.keyframeApp.srcEmbedWorldTransforms=t,window.localStorage.setItem("srcEmbeddedTransforms",this.performs.keyframeApp.srcEmbedWorldTransforms),this.performs.changeAnimation(this.performs.keyframeApp.currentAnimation,!0)},{nameWidth:"auto",skipReset:!0,label:"",className:"contrast"}),this.keyframeGui.addToggle("Target embedded transforms",this.performs.keyframeApp.trgEmbedWorldTransforms,t=>{this.performs.keyframeApp.trgEmbedWorldTransforms=t,window.localStorage.setItem("trgEmbedWorldTransforms",this.performs.keyframeApp.trgEmbedWorldTransforms),this.performs.changeAnimation(this.performs.keyframeApp.currentAnimation,!0)},{nameWidth:"auto",skipReset:!0,label:"",className:"contrast"});const a=["DEFAULT","CURRENT","TPOSE"];this.keyframeGui.addSelect("Source reference pose",a,a[this.performs.keyframeApp.srcPoseMode],t=>{this.performs.keyframeApp.srcPoseMode=a.indexOf(t),window.localStorage.setItem("srcReferencePose",this.performs.keyframeApp.srcPoseMode),this.performs.changeAnimation(this.performs.keyframeApp.currentAnimation,!0)},{nameWidth:"200px",skipReset:!0}),this.keyframeGui.addSelect("Character reference pose",a,a[this.performs.keyframeApp.trgPoseMode],t=>{this.performs.keyframeApp.trgPoseMode=a.indexOf(t),window.localStorage.setItem("trgReferencePose",this.performs.keyframeApp.trgPoseMode),this.performs.changeAnimation(this.performs.keyframeApp.currentAnimation,!0)},{nameWidth:"200px",skipReset:!0}),this.performs.keyframeApp.trajectoriesHelper&&(this.keyframeGui.branch("Trajectories",{icon:"Spline"}),this.keyframeGui.addToggle("Show trajectories",this.performs.keyframeApp.trajectoriesActive,t=>{const e=this.performs.keyframeApp;t?e.showTrajectories():e.hideTrajectories()},{nameWidth:"auto",skipReset:!0,label:"",className:"contrast"}),this.performs.keyframeApp.currentAnimation&&this.keyframeGui.addRange("Window range (s)",[this.performs.keyframeApp.trajectoriesStart,this.performs.keyframeApp.trajectoriesEnd],t=>{this.performs.keyframeApp.updateTrajectories(t[0],t[1])},{step:.01,min:0,max:this.performs.keyframeApp.loadedAnimations[this.performs.keyframeApp.currentAnimation].bodyAnimation.duration}))}showRecordingDialog(t){const s=new e.Dialog("Record all animations",i=>{let n=[],a=this.performs.keyframeApp.loadedAnimations;for(let t in a){let e=a[t];e.record=void 0===e.record||e.record;let s={id:t,type:"animation",selected:e.record,checkbox:!0};n.push(s)}let r=new e.AssetView({skipBrowser:!0,skipPreview:!0,layout:e.AssetView.LAYOUT_LIST,contextMenu:!1,allowMultipleSelection:!0});r.load(n,t=>{if(t.type==e.AssetViewEvent.ASSET_CHECKED){const e=t.item;a[e.id].record=e.selected}});let o=new e.Panel({height:"calc(100% - 40px)"});o.addCheckbox("Select All",!0,(t,e)=>{for(let e in n)n[e].selected=t,a[n[e].id].record=t;r._refreshContent()},{label:"",className:"contrast"}).onSetValue(!1,!1),o.attach(r),i.attach(o),i.sameLine(2),i.addButton("","Record",()=>{t&&t(),s.close()},{buttonClass:"accept",width:"100px"}),i.addButton(null,"Cancel",()=>{s.close()},{width:"100px"})},{size:["40%","60%"],resizable:!0,draggable:!0,scroll:!1})}createImportDialog(t,s){let i=!1;const n=new e.Dialog(t+" File Detected!",t=>{t.sameLine(),t.addButton(null,"Use as Avatar",t=>{i=!0,n.close(),s(i)},{width:"50%"}),t.addButton(null,"Use Animations only",t=>{i=!1,n.close(),s(i)},{width:"50%"}),t.endLine()})}selectAvatar(s){if(!this.performs.loadedCharacters[s]){this.makeLoading("Loading avatar...");let i=this.avatarOptions[s][0],n=this.avatarOptions[s][1],a=(new t.Quaternion).setFromAxisAngle(new t.Vector3(1,0,0),this.avatarOptions[s][2]);return void this.performs.loadAvatar(i,n,a,s,()=>{this.performs.changeAvatar(s),this.activePanelType==d.ACTIVEPANEL_AVATARS&&this.createAvatarsPanel(),this.performs.currentCharacter.config&&this.performs.mode!=c.Modes.SCRIPT&&!this.performs.keyframeApp.currentAnimation&&(this.performs.changeMode(c.Modes.SCRIPT),this.overlayButtonsReset.buttons["Reset pose"].root.classList.remove("hidden")),this.hideLoading()},t=>{this.hideLoading(),e.popup("There was an error loading the avatar","Avatar not loaded",{width:"30%"})})}this.performs.changeAvatar(s),this.activePanelType==d.ACTIVEPANEL_AVATARS&&this.createAvatarsPanel()}uploadAvatar(t=null){let s,i,n,a=0,r=!0,o=!0;return this.avatarDialog=new e.Dialog("Upload Avatar",l=>{l.refresh=()=>{l.clear();let h=l.addText("Name Your Avatar",s,(t,i)=>{this.avatarOptions[t]&&e.popup("This avatar name is taken. Please, change it.",null,{size:["300px","auto"],position:["45%","20%"]}),s=t});l.sameLine(null,"justify-between");let p=l.addFile("Avatar File",(t,n)=>{let a=l.components["Avatar File"].root.children[1].files;if(!a.length)return;const r=a[0].name.split("."),o=r[0],c=r[1];"glb"==c||"gltf"==c?(i=t,s||(s=o,h.set(s))):e.popup("Only accepts GLB and GLTF formats!")},{type:"url",nameWidth:"41%",width:"70%"});r||p.root.classList.add("hidden");let m=l.addText("Avatar URL",i,(t,n)=>{if(t==i)return;if(!t)return void(i=t);const a=t.split(".");let r=a[a.length-2];r=r.split("/"),r=r.pop();let d=a[a.length-1];d=d.split("?")[0],"glb"==d||"gltf"==d?(i=t,s||(s=r,h.set(s)),i.includes("models.readyplayer.me")&&e.prompt("It looks like you are importing an avatar from a Ready Player Me. Would you like to use the default configuration for this character?\nPlease note that the contact settings may vary. We recommend customizing the settings based on the default to better suit your avatar.","Ready Player Me detected!",(t,e)=>{o=!1,l.refresh(),l.setValue("Config URL",c.AVATARS_URL+"ReadyEva/ReadyEva_v3.json")},{input:!1,fitHeight:!0})):e.popup("Only accepts GLB and GLTF formats!")},{nameWidth:"43%",width:"70%"});r&&m.root.classList.add("hidden"),l.addComboButtons(null,[{value:"From File",callback:(t,e)=>{r=!0,m.root.classList.contains("hidden")||m.root.classList.add("hidden"),p.root.classList.remove("hidden"),l.refresh()}},{value:"From URL",callback:(t,e)=>{r=!1,p.root.classList.contains("hidden")||p.root.classList.add("hidden"),m.root.classList.remove("hidden")}}],{selected:r?"From File":"From URL"}),l.endLine(),l.sameLine(null,"justify-between");let u=l.addFile("Config File",(t,s)=>{if(!t)return;const i=l.components["Config File"].root.children[1].files[0].name;let a=i.split(".");a=a.pop(),"json"==a?(n=JSON.parse(t),n._filename=i,g.classList.remove("hidden")):e.popup("Config file must be a JSON!")},{type:"text",nameWidth:"41%",width:"70%"}),f=l.addText("Config URL",n?n._filename:"",async(t,s)=>{if(!t)return void(n=t);const i=t.split(".");let a=i[i.length-2];a=a.split("/"),a=a.pop();let r=i[i.length-1];if(r=r.split("?")[0].toLowerCase(),"json"==r){if("json"==r)try{const e=await fetch(t);if(!e.ok)throw new Error(`Response status: ${e.status}`);n=await e.json(),n._filename=t,g.root.classList.remove("hidden")}catch(t){e.popup(t.message,"File error!")}}else e.popup("Config file must be a JSON!")},{nameWidth:"43%",width:"70%"});o?f.root.classList.add("hidden"):u.root.classList.add("hidden");const g=l.addButton(null,"Edit config file",()=>{this.performs.openAtelier(s,i,n,!0,a)},{icon:"Settings",width:"40px"});n||g.root.classList.add("hidden"),l.addComboButtons(null,[{value:"From File",callback:(t,e)=>{o=!0,f.root.classList.contains("hidden")||f.root.classList.add("hidden"),u.root.classList.remove("hidden")}},{value:"From URL",callback:(t,e)=>{o=!1,u.root.classList.contains("hidden")||u.root.classList.add("hidden"),f.root.classList.remove("hidden")}}],{selected:o?"From File":"From URL"}),l.endLine(),l.addNumber("Apply Rotation",0,t=>{a=t*Math.PI/180},{min:-180,max:180,step:1}),l.sameLine(2),l.addButton(null,"Create Config File",()=>{this.performs.openAtelier(s,i,n,!0,a)},{width:"50%"}),l.addButton(null,"Upload",()=>{if(s&&i){if(this.avatarOptions[s])return void e.popup("This avatar name is taken. Please, change it.",null,{position:["45%","20%"]});let r=d.THUMBNAIL;i.includes("models.readyplayer.me")&&(i+="?pose=T&morphTargets=ARKit&lod=1",r="https://models.readyplayer.me/"+s+".png"),n?(this.avatarOptions[s]=[i,n,a,r],l.clear(),this.avatarDialog.root.remove(),this.avatarOptions[s][1]=n._filename,t&&t(s,n)):e.prompt("Uploading without config file will disable BML animations for this avatar. Do you want to proceed?","Warning!",e=>{this.avatarOptions[s]=[i,null,a,r],l.clear(),this.avatarDialog.root.remove(),t&&t(s)},{input:!1,on_cancel:()=>{}})}else e.popup("Complete all fields!",null,{position:["45%","20%"]})},{width:"50%"}),l.root.addEventListener("drop",(t,e)=>{let s=t.dataTransfer.files;this.onDropAvatarFiles(s)})},l.refresh()},{size:["40%"],className:"resizeable",closable:!0,onclose:t=>{t.remove()}}),s}editAvatar(t,s={}){const i=this.performs.currentCharacter,n=s.callback;let a=i.config,r=0,o=!a??!1;return this.avatarDialog=new e.Dialog("Edit Avatar",s=>{s.refresh=()=>{s.clear(),s.addText("Name Your Avatar",t,(s,i)=>{this.avatarOptions[s]&&e.popup("This avatar name is taken. Please, change it.",null,{position:["45%","20%"]}),t=s}),s.sameLine(null,"justify-between"),s.addFile("Config File",(t,i)=>{if(!t)return;const n=s.components["Config File"].root.children[1].files[0].name;let r=n.split(".");r=r.pop(),"json"==r?(a=JSON.parse(t),a._filename=n):e.popup("Config file must be a JSON!")},{type:"text",className:o?"":"hidden"}),s.addText("Config URL",a?a._filename:"",async(t,s)=>{if(!t)return;const i=t.split(".");let n=i[i.length-2];n=n.split("/"),n=n.pop();let r=i[i.length-1];if(r=r.split("?")[0].toLowerCase(),"json"==r){if("json"==r)try{const e=await fetch(t);if(!e.ok)throw new Error(`Response status: ${e.status}`);a=await e.json(),a._filename=t}catch(t){e.popup(t.message,"File error!")}}else e.popup("Config file must be a JSON!")},{className:o?"hidden":"",width:"70%"}),s.addComboButtons(null,[{value:"From File",callback:(t,e)=>{o=!0,s.components["Config URL"].root.classList.add("hidden"),s.components["Config File"].root.classList.remove("hidden")}},{value:"From URL",callback:(t,e)=>{o=!1,s.components["Config File"].root.classList.add("hidden"),s.components["Config URL"].root.classList.remove("hidden")}}],{selected:o?"From File":"From URL"}),s.endLine(),s.addNumber("Apply Rotation",0,t=>{r=t*Math.PI/180},{min:-180,max:180,step:1}),s.sameLine(2,"justify-between"),s.addButton(null,(a?"Edit":"Create")+" Config File",()=>{this.performs.openAtelier(t,this.avatarOptions[t][0],a,!1,r)},{width:"50%"}),s.addButton(null,"Update",()=>{if(t){if(this.avatarOptions[t])return void e.popup("This avatar name is taken. Please, change it.",null,{position:["45%","20%"]});a?(s.clear(),this.avatarDialog.root.remove(),n&&n(t,r,a)):e.prompt("Uploading without config file will disable BML animations for this avatar. Do you want to proceed?","Warning!",e=>{s.clear(),this.avatarDialog.root.remove(),n&&n(t,r)},{input:!1,on_cancel:()=>{}})}else e.popup("Complete all fields!",null,{position:["45%","20%"]})},{width:"50%"}),s.root.addEventListener("drop",(t,e)=>{let s=t.dataTransfer.files;this.onDropAvatarFiles(s)})},s.refresh()},{size:["40%"],className:"resizeable",closable:!0,onclose:t=>{t.remove()}}),t}onDropFiles(t){t.preventDefault(),t.stopPropagation();let s=[],i=null,n=[],a=null;const r=["json","bvh","bvhe","glb","gltf","fbx","bml","sigml"];let o=t.dataTransfer.files;for(let t=0;t<o.length;t++){const e=o[t],l=e.name.substr(e.name.lastIndexOf(".")+1).toLowerCase();if(r.indexOf(l)<0)return alert(e.name+": Format not supported.\n\nFormats accepted:\n\t 'bml', 'sigml', 'bvh', 'bvhe', 'glb, 'gltf', 'json', 'fbx' (animations only)\n\t"),void this.hideLoading();"gltf"==l||"glb"==l?n.push(e):"json"==l?i=e:"bml"==l||"sigml"==l?a=e:s.push(e)}if(n.length)this.createImportDialog(".glb",t=>{if(t){this.uploadAvatar(t=>{this.selectAvatar(t)});let t=new DataTransfer;t.items.add(n[0]);const e=t.files;if(this.avatarDialog.panel.components["Avatar File"].root.children[1].files=e,this.avatarDialog.panel.components["Avatar File"].root.children[1].dispatchEvent(new Event("change"),{bubbles:!0}),i){t=new DataTransfer,t.items.add(i);const e=t.files;this.avatarDialog.panel.components["Config File"].root.children[1].files=e,this.avatarDialog.panel.components["Config File"].root.children[1].dispatchEvent(new Event("change"),{bubbles:!0})}}else this.makeLoading("Loading animations..."),this.performs.keyframeApp.loadFiles(n,t=>{this.hideLoading(),t.length?(this.performs.changeMode(c.Modes.KEYFRAME),this.setActivePanel(d.ACTIVEPANEL_SETTINGS),this.overlayButtonsMenu.buttons.Settings.root.children[0].classList.add("selected")):e.popup("This file doesn't contain any animation or a valid source avatar!")})});else if(i){let t=this.performs.currentCharacter.model.name;const e=new FileReader;e.readAsText(i),e.onload=e=>{const s=JSON.parse(e.currentTarget.result);s.boneMap?(this.avatarOptions[t][1]=i._filename,this.performs.currentCharacter.config=s,this.performs.scriptApp.onLoadAvatar(this.performs.currentCharacter.model,this.performs.currentCharacter.config,this.performs.currentCharacter.skeleton),this.performs.currentCharacter.skeleton.pose(),this.performs.scriptApp.ECAcontroller.reset(),this.performs.changeMode(c.Modes.SCRIPT),this.activePanelType==d.ACTIVEPANEL_SETTINGS&&(this.setActivePanel(d.ACTIVEPANEL_SETTINGS),this.overlayButtonsMenu.buttons.Settings.root.children[0].classList.add("selected"))):this.performs.setConfiguration(s,()=>{this.activePanelType==d.ACTIVEPANEL_SETTINGS&&(this.setActivePanel(d.ACTIVEPANEL_SETTINGS),this.overlayButtonsMenu.buttons.Settings.root.children[0].classList.add("selected"))})}}if(a)if(i||this.performs.currentCharacter.config){const t=a.name.substr(a.name.lastIndexOf(".")+1).toLowerCase(),e=new FileReader;e.readAsText(a),e.onload=e=>{const s=e.currentTarget.result;this.performs.scriptApp.onMessage([{type:t,data:s}],e=>{"sigml"==t&&this.setSIGMLInputText(s),"bml"!=t&&"sigml"!=t||this.setBMLInputText(JSON.stringify(e.msg.data,function(t,e){return e.toFixed?Number(e.toFixed(3)):e}))})}}else alert("To use the Script mode, the current character's configuration file is needed.");s.length&&(this.makeLoading("Loading animations..."),this.performs.keyframeApp.loadFiles(s,t=>{this.hideLoading(),t.length?(this.performs.changeMode(c.Modes.KEYFRAME),this.setActivePanel(d.ACTIVEPANEL_SETTINGS),this.overlayButtonsMenu.buttons.Settings.root.children[0].classList.add("selected")):e.popup("This file doesn't contain any animation or a valid source avatar!")}))}onDropAvatarFiles(t){if(t.length)for(let e=0;e<t.length;e++){const s=t[e].name.split(".");s[0];const i=s[1];if("glb"==i||"gltf"==i){const s=new DataTransfer;s.items.add(t[e]);const i=s.files;this.avatarDialog.panel.components["Avatar File"].root.children[1].files=i,this.avatarDialog.panel.components["Avatar File"].root.children[1].dispatchEvent(new Event("change"),{bubbles:!0})}else if("json"==i){const s=new DataTransfer;s.items.add(t[e]);const i=s.files;this.avatarDialog.panel.components["Config File"].root.children[1].files=i,this.avatarDialog.panel.components["Config File"].root.children[1].dispatchEvent(new Event("change"),{bubbles:!0})}}}setBMLInputText(t){this.bmlInputData.prevInstanceText=t,this.bmlInputData.codeObj&&this.bmlInputData.codeObj.setText(t)}setSIGMLInputText(t){this.sigmlInputData.prevInstanceText=t,this.sigmlInputData.codeObj&&this.sigmlInputData.codeObj.setText(t)}_stringToBML(t){let e=[],s=t.replaceAll("\n","").replaceAll("\r",""),i=!1;try{e=JSON.parse(s),i=!0}catch(t){i=!1}if(!i)try{e=JSON.parse("["+s+"]")}catch(t){return alert('Invalid bml message\nCheck your code for errors. Common errors include: \n- Keys must be quoted: {"intensity" : 0.2}\n- Numbers use points (.) for decimal numbers: 0.2\n- Elements of an array/object are separated by commas EXCEPT the last element {"a": 1, "b":2}'),[]}Array.isArray(e)||(e=Array.isArray(e.behaviours)?e.behaviours:[e]);for(let t=0;t<e.length;++t)if("speech"==e[t].type&&"string"==typeof e[t].text){let s=e[t].text.split("%"),i="";for(let t=0;t<s.length;)i+=s[t],t++,t<s.length-1&&(i+=this.performs.scriptApp.wordsToArpa(s[t],"NGT")),t++;e[t].text=i+"."}return e}showControls(){this.controlsActive=!0,window.localStorage.setItem("controls",this.controlsActive),this.canvasArea.panels[0].root.classList.remove("hide");const t=this.overlayButtonsMenu.buttons["Hide controls"];"Eye"==t.options.icon&&t.swap(!0),t.root.firstChild.title="Hide controls";let e=document.getElementById("overlay-controls");for(let t=1;t<e.children.length;t++)e.children[t].classList.remove("hide");e=document.getElementById("overlay-buttons");for(let t=1;t<e.children.length;t++)e.children[t].classList.remove("hide")}hideControls(){this.controlsActive=!1,window.localStorage.setItem("controls",this.controlsActive);const t=this.overlayButtonsMenu.buttons["Hide controls"];"EyeOff"==t.options.icon&&t.swap(!0),t.root.firstChild.title="Show controls",this.canvasArea.panels[0].root.classList.add("hide");let e=document.getElementById("overlay-controls");for(let t=1;t<e.children.length;t++)e.children[t].classList.add("hide");e=document.getElementById("overlay-buttons");for(let t=1;t<e.children.length;t++)e.children[t].classList.add("hide")}showCaptureModal(t){t&&this.makeLoading("Capturing animation: "+t,.5)}hideCaptureModal(){this.hideLoading()}showGuide(){const t=document.getElementById("guide-modal");t.classList.remove("hidden");const e=document.querySelectorAll(".guide-modal .container"),s=t=>{e.forEach(e=>{e.classList.remove("show"),e.classList.add("hidden"),e.id===t&&(e.classList.add("show"),e.classList.remove("hidden"))})};s("modal0");for(let i=0;i<e.length;i++){const n=e[i],a=n.getElementsByTagName("button");for(let e=0;e<a.length;e++){const n=a[e];"back"==n.id?n.addEventListener("click",()=>{s("modal"+(i-1).toString())}):"next"==n.id?n.addEventListener("click",()=>{s("modal"+(i+1).toString())}):n.addEventListener("click",()=>{t.classList.add("hidden")})}n.getElementsByClassName("close-button")[0].addEventListener("click",()=>{t.classList.add("hidden")})}}showExportAvatarDialog(t){this.performs.export("GLB",this.performs.currentCharacter.model.name,t=>{e.popup("Error: "+t,null,{size:["800px","auto"],timeout:6e3})})}showExportDialog(){const t=this.avatarOptions[this.performs.currentCharacter.model.name];let s=t[0];s=s.split("?")[0];let i=this.performs.getBackPlaneColor();"string"==typeof i&&(i=i.replace("#","0x"));const n=Object.keys(c.Backgrounds);let a=this.performs.logo;"string"!=typeof a&&(a=a.src);const r={avatar:{state:null!=localStorage.getItem("avatar")?JSON.parse(localStorage.getItem("avatar")):s.includes("https"),text:"Character file URL",value:s},cloth:{state:null!=localStorage.getItem("cloth")&&JSON.parse(localStorage.getItem("cloth")),text:"Top cloth color value",value:"0x"+this.performs.getClothesColor()},color:{state:null==localStorage.getItem("color")||JSON.parse(localStorage.getItem("color")),text:"Background color",value:i},background:{state:null==localStorage.getItem("background")||JSON.parse(localStorage.getItem("background")),text:"Background design",value:n[this.performs.background]},img:{state:null!=localStorage.getItem("img")&&JSON.parse(localStorage.getItem("img")),text:"Logo/image file URL for photocall",value:a},offset:{state:null!=localStorage.getItem("offset")&&JSON.parse(localStorage.getItem("offset")),text:"Logo space repetition",value:this.performs.repeatOffset},light:{state:null!=localStorage.getItem("light")&&JSON.parse(localStorage.getItem("light")),text:"Light color",value:"0x"+this.performs.dirLight.color.getHexString()},lightpos:{state:null!=localStorage.getItem("lightpos")&&JSON.parse(localStorage.getItem("lightpos")),text:"Light position",value:this.performs.dirLight.position.x+","+this.performs.dirLight.position.y+","+this.performs.dirLight.position.z},restrictView:{state:null!=localStorage.getItem("restrictView")&&JSON.parse(localStorage.getItem("restrictView")),text:"Restrict camera controls",value:this.performs.cameraRestricted??!1},controls:{state:null!=localStorage.getItem("controls")&&JSON.parse(localStorage.getItem("controls")),text:"Show GUI controls",value:this.performs.controlsActive},autoplay:{state:null!=localStorage.getItem("autplay")&&JSON.parse(localStorage.getItem("autoplay")),text:"Play animation automatically after load it",value:this.performs.autoplay}},o={config:{state:null!=localStorage.getItem("config")?JSON.parse(localStorage.getItem("config")):t[1]??!1,text:"Configuration file URL",value:t[1]},applyIdle:{state:null!=localStorage.getItem("applyIdle")?JSON.parse(localStorage.getItem("applyIdle")):t[1]??!1,text:"Apply idle animation",value:this.performs.scriptApp.applyIdle}};let l=this.performs.keyframeApp.currentAnimation??!1;const h={srcEmbeddedTransforms:{state:null!=localStorage.getItem("srcEmbeddedTransforms")?JSON.parse(localStorage.getItem("srcEmbeddedTransforms")):l,text:"Source embedded transformations",value:this.performs.keyframeApp.srcEmbedWorldTransforms},trgEmbeddedTransforms:{state:null!=localStorage.getItem("trgEmbeddedTransforms")?JSON.parse(localStorage.getItem("trgEmbeddedTransforms")):l,text:"Target embedded transformations",value:this.performs.keyframeApp.trgEmbedWorldTransforms},srcReferencePose:{state:null!=localStorage.getItem("srcReferencePose")?JSON.parse(localStorage.getItem("srcReferencePose")):l,text:"Source reference pose",value:this.performs.keyframeApp.srcPoseMode},trgReferencePose:{state:null!=localStorage.getItem("trgReferencePose")?JSON.parse(localStorage.getItem("trgReferencePose")):l,text:"Target reference pose",value:this.performs.keyframeApp.trgPoseMode},crossfade:{state:null!=localStorage.getItem("crossfade")?JSON.parse(localStorage.getItem("crossfade")):l,text:"Concatenate and blend animations",value:this.performs.keyframeApp.useCrossFade},blendTime:{state:null!=localStorage.getItem("blendTime")?JSON.parse(localStorage.getItem("blendTime")):l,text:"Time interval between animations",value:this.performs.keyframeApp.blendTime},trajectories:{state:null!=localStorage.getItem("trajectories")&&JSON.parse(localStorage.getItem("trajectories")),text:"Show trajectories",value:this.performs.keyframeApp.trajectoriesActive}},d={position:{state:null!=localStorage.getItem("position")&&JSON.parse(localStorage.getItem("position")),text:"Character position",value:this.performs.currentCharacter.model.position.x+","+this.performs.currentCharacter.model.position.y+","+this.performs.currentCharacter.model.position.z},rotation:{state:null!=localStorage.getItem("rotation")&&JSON.parse(localStorage.getItem("rotation")),text:"Character rotation",value:this.performs.currentCharacter.model.quaternion.x+","+this.performs.currentCharacter.model.quaternion.y+","+this.performs.currentCharacter.model.quaternion.z+","+this.performs.currentCharacter.model.quaternion.w},scale:{state:null!=localStorage.getItem("scale")&&JSON.parse(localStorage.getItem("scale")),text:"Character scale",value:this.performs.currentCharacter.model.scale.x}},p=new e.Dialog("Export configuration",t=>{t.sameLine(),t.addButton("Select the configuration settings you want to export. ","More info...",t=>{window.open("https://github.com/upf-gti/performs/blob/main/docs/IntegrationGuide.md","_blank")},{nameWidth:"auto"}),t.endLine();let s=new URL(window.location.origin+window.location.pathname),i=new e.Panel({height:"auto"});i.refresh=()=>{i.clear(),i.sameLine(),i.addTextArea("Iframe",s.toJSON(),null,{nameWidth:"80px",fitHeight:!0,disabled:!0,className:"iframe-text nobg"}),i.addButton(null,"Copy",(t,e)=>{navigator.clipboard.writeText(s);const i=document.getElementById("bubble"),n=e.target.getBoundingClientRect();i.style.left=n.left-20+"px",i.style.top=n.top-35+"px",i.classList.add("show"),setTimeout(function(){i.classList.remove("show")},2e3)},{icon:"Clipboard",width:"40px"}),i.endLine()};let n=new e.Area({height:"fit-content"}),a=n.addTabs();const l=t=>{const n=new e.Panel({height:"auto"}),a=new e.Panel({height:"auto"});return a.addCheckbox("Select All",!1,(e,s)=>{for(let s in t)t[s].state=e,localStorage.setItem(s,e);n.refresh()},{nameWidth:"auto",className:"contrast",label:"",skipReset:!0}),a.addSeparator(),n.refresh=()=>{n.clear();for(let e in t)s.searchParams.delete(e),n.sameLine(),n.addCheckbox("",t[e].state,(s,i)=>{localStorage.setItem(e,s),t[e].state=s,n.refresh()},{nameWidth:"auto",className:"contrast",label:e}),n.addText(null,t[e].text,null,{disabled:!0,inputClass:"nobg"}),n.endLine(),t[e].state&&s.searchParams.append(e,t[e].value);n.addSeparator(),i.refresh()},n.refresh(),a.attach(n.root),[a,n]};let[c,m]=l(r);a.add("Customization",c.root,()=>m.refresh()),[c,m]=l(o),a.add("Script mode",c.root,()=>m.refresh()),[c,m]=l(h),a.add("Keyframe mode",c.root,()=>m.refresh()),[c,m]=l(d),a.add("Transforms",c.root,()=>d.refresh()),t.root.appendChild(n.root),i.refresh(),t.root.appendChild(i.root),t.addButton(null,"Download configuration as file (.json)",()=>{let t={};for(let e in r)r[e].state&&(t[e]=r[e].value);for(let e in d)d[e].state&&(t[e]=d[e].value);for(let e in o)o[e].state&&(t[e]=o[e].value);for(let e in h)h[e].state&&(t[e]=h[e].value);const e=JSON.stringify(t);let s=document.createElement("a");s.href="data:text/json;charset=utf-8,"+encodeURIComponent(e),s.download="performsSettings.json",s.click(),p.close()},{buttonClass:"accept",width:"auto"})},{size:["40%","fit-content"],className:"resizeable",draggable:!0,scroll:!0});p.root.style.maxHeight="90%",p.root.style.translate="-50% 0%",p.root.style.top="10%"}fadeCSSAnimation(t,e,s,i=!0){let n=t.getAnimations({subtree:!0});for(let t=0;t<n.length;++t){const e=n[t];if(e.isOpacityFade){e.commitStyles(),e.finish();break}}if(i){let i=parseFloat(t.style.opacity);isNaN(i)&&(i=1),s*=Math.abs(i-e)}const a=t.animate([{opacity:t.style.opacity},{opacity:e}],{duration:s,iterations:1});return a.isOpacityFade=!0,t.style.opacity=e,a}makeLoading(t,e=1){const s=document.getElementById("loading");if(s)return s.classList.remove("hidden"),s.getElementsByTagName("p")[0].innerText=t,this.fadeCSSAnimation(s,e,200,!0)}hideLoading(){const t=document.getElementById("loading");if(!t)return;const e=t.getElementsByTagName("p")[0].innerText;if(t.classList.contains("hidden"))return void(t.style.opacity=0);this.fadeCSSAnimation(t,0,200,!0).onfinish=()=>{e==t.getElementsByTagName("p")[0].innerText&&t.classList.add("hidden")}}}c.GUI=d;let p="undefined"!=typeof JSZip?new JSZip:null;class m{constructor(e,s){this.isRecording=!1,this.timeLimit=null,this.mediaRecorders=[],this.recordedChunks=[],this.renderers=[],this.clock=new t.Clock,this.handleDataAvailable=this.handleDataAvailable.bind(this),this.handleStop=this.handleStop.bind(this),this.animationsCount=0,this.enabledCameras=0,this.exportZip=!0;for(let s=0;s<e;s++){const e=new t.WebGLRenderer({antialias:!0});if(e.setSize(window.innerWidth,window.innerHeight),e.setPixelRatio(window.devicePixelRatio),e.toneMapping=t.LinearToneMapping,e.toneMappingExposure=1,this.renderers.push(e),this.renderers[s].domElement.captureStream){const t=this.renderers[s].domElement.captureStream(60),e=new MediaRecorder(t,{mimeType:"video/webm;",videoBitsPerSecond:5242880});e.ondataavailable=t=>this.handleDataAvailable(t,s),e.onstop=()=>this.handleStop(s),e.onstart=()=>this.handleStart(s),this.mediaRecorders.push(e),this.recordedChunks.push([])}else console.error("Animation Recorder Error: CaptureSteam not supported.")}this.app=s}async manageMultipleCapture(t){this.keyframeApp=t;let e=[];for(let s in t.loadedAnimations){t.loadedAnimations[s].record&&e.push(s)}this.animationsCount=e.length;for(let s=0;s<e.length;s++){const i=e[s];let n=t.loadedAnimations[i];this.onStartCapture&&this.onStartCapture("("+(s+1)+"/"+e.length+") "+i),await this.manageCapture(i,n.bodyAnimation.duration)}}manageCapture(t,e=null){if(this.app.mode==c.Modes.SCRIPT)this.animationsCount=1,this.onStartCapture&&this.onStartCapture(""),this.isRecording?this.stopCapture():this.startCapture("BML");else if(this.app.mode==c.Modes.KEYFRAME)return new Promise(s=>{this.onCaptureComplete=s;const i=this.keyframeApp.useCrossFade;this.keyframeApp.useCrossFade=!1,this.keyframeApp.onChangeAnimation(t),this.keyframeApp.useCrossFade=i,this.startCapture(t),this.timeLimit=e})}startCapture(t){this.isRecording=!0,this.enabledCameras=0;for(let t=0;t<this.app.cameras.length;t++)this.app.cameras[t].record&&(this.enabledCameras+=1,this.recordedChunks[t]=[],this.mediaRecorders[t].start());this.currentAnimationName=t}stopCapture(){this.isRecording=!1,this.mediaRecorders.forEach(t=>t.stop())}handleDataAvailable(t,e){t.data.size>0&&this.recordedChunks[e].push(t.data)}handleStart(t){0===t&&(this.app.mode==c.Modes.SCRIPT?this.app.scriptApp.replay():this.app.mode==c.Modes.KEYFRAME&&this.app.keyframeApp.changePlayState(!0)),this.clock.start()}handleStop(t){const e=this.currentAnimationName,s=new Blob(this.recordedChunks[t],{type:"video/webm"}),i=`${e} ${t+1}.webm`;!function(t,e){var s=new FileReader;s.onload=function(){var t=s.result.split(",")[1];e(t)},s.readAsDataURL(t)}(s,t=>{if(!p&&this.exportZip&&console.error("JSZip not imported. The recordings can't be downloaded."),p&&this.exportZip){p.folder(e).file(i,t,{base64:!0}),Object.keys(p.files).length-this.animationsCount==this.animationsCount*this.enabledCameras&&(this.onStopCapture&&this.onStopCapture(),p.generateAsync({type:"base64"}).then(function(t){let e=document.createElement("a");e.href="data:application/zip;base64,"+t,e.download="performs-recordings.zip",e.click(),p.files={}}))}else{let e=document.createElement("a");e.href="data:application/webm;base64,"+t,e.download=i,e.click(),0==this.isRecording&&this.onStopCapture&&this.onStopCapture()}}),0===t&&this.app.mode==c.Modes.SCRIPT&&this.app.scriptApp.ECAcontroller.reset(!0),this.clock.elapsedTime=0,this.clock.stop(),this.mediaRecorders.every(t=>"inactive"===t.state)&&this.onCaptureComplete&&(this.onCaptureComplete(),this.onCaptureComplete=null)}update(t,e){for(let s=0;s<this.renderers.length;s++)this.renderers[s].render(t,e[s]);this.timeLimit&&this.clock.getElapsedTime()>this.timeLimit&&(this.app.keyframeApp.changePlayState(!1),this.stopCapture())}}const u={version:"0.1.2",extensions:[]};function f(t,e,s,i){t.x=e.x*(1-i)+s.x*i,t.y=e.y*(1-i)+s.y*i,t.z=e.z*(1-i)+s.z*i,t.w=e.w*(1-i)+s.w*i,t.normalize()}function g(t,e,s){let i=t.x*e.x+t.y*e.y+t.z*e.z;return s.set(i*e.x,i*e.y,i*e.z,t.w),s.normalize(),s}function A(t,e,s=0,i=!1){if(e.set(0,0,0),"string"!=typeof t)return!1;let n=!1;return(t=t.toUpperCase()).includes("L")&&(e.x+=1*(i?t.split("L").length-1:1),n=!0),t.includes("R")&&(e.x-=1*(i?t.split("R").length-1:1),n=!0),t.includes("U")&&(e.y+=1*(i?t.split("U").length-1:1),n=!0),t.includes("D")&&(e.y-=1*(i?t.split("D").length-1:1),n=!0),t.includes("O")&&(e.z+=1*(i?t.split("O").length-1:1),n=!0),t.includes("I")&&(e.z-=1*(i?t.split("I").length-1:1),n=!0),1&s&&(e.x*=-1),2&s&&(e.y*=-1),4&s&&(e.z*=-1),n?i||e.normalize():e.set(0,0,0),n}function y(t,e){if(!e)return-1;let s=t.bones;for(let t=0;t<s.length;++t)if(s[t]==e)return t;return-1}function x(t,e){if(!e)return-1;let s=t.bones;for(let t=0;t<s.length;++t)if(s[t].name==e)return t;return-1}function b(t,e,s){let i=t.boneInverses[e].clone().invert(),n=y(t,t.bones[e].parent);if(n>-1){let e=t.boneInverses[n];i.premultiply(e)}return s.setFromRotationMatrix(i).normalize(),s}function S(t,e=!1){let s=t.bones,i=t.boneInverses;if(i.length<1)return;let n=i[0].clone(),a=t.bones[0].position.clone();for(let r=0;r<s.length;++r){n.copy(i[r]),n.invert();let o=y(t,s[r].parent);if(o>-1)n.premultiply(i[o]);else if(e)continue;n.decompose(a,s[r].quaternion,a),s[r].quaternion.normalize()}}u.getTwistSwingQuaternions=function(t,e,s,i){let n=t.x*e.x+t.y*e.y+t.z*e.z;s.set(n*e.x,n*e.y,n*e.z,t.w),s.normalize(),i.copy(s),i.invert(),i.premultiply(t),i.normalize()},u.getTwistQuaternion=g,u.findIndexOfBone=y,u.findIndexOfBoneByName=x,u.getBindQuaternion=b,u.forceBindPoseQuats=S;const L=Math.PI/180,_=180/Math.PI;class k{static WAITING=0;static PROCESSING=1;static SPEAKING=2;static LISTENING=3;constructor(){this.reset()}reset(){this.conversation="--- New dialogue---\n\n",this.state=k.WAITING,this.stateTime=0,this.nextBlockIn=1+2*Math.random(),this.defaultValence=.4,this.currentArousal=0,this.blinkIdle=.5+6*Math.random(),this.blinkDur=.5*Math.random()+.15,this.blinkCountdown=0,this.saccIdle=.5+6*Math.random(),this.saccDur=Math.random()+.5,this.saccCountdown=0}update(t){return this.stateTime+=t,this.nextBlockIn<this.stateTime?(this.stateTime=0,this.createBlock()):this.updateBlinksAndSaccades(t)}transition(t){var e=t.control;if(e!=this.state){switch(this.stateTime=0,e){case k.WAITING:this.nextBlockIn=2+4*Math.random();break;case k.LISTENING:t.composition="MERGE",this.attentionToUser(t,!0),this.nextBlockIn=0+2*Math.random();break;case k.PROCESSING:this.nextBlockIn=0;break;case k.SPEAKING:this.attentionToUser(t,!0),this.nextBlockIn=1*Math.random()}this.state=e}}createBlock(){var t=this.state,e={id:t,composition:"MERGE"};switch(t){case k.LISTENING:if(this.nextBlockIn=1.5+3*Math.random(),Math.random()<.4&&(e.head={start:0,end:1.5+2*Math.random(),lexeme:"NOD",amount:.05+.05*Math.random(),type:"head"}),Math.random()<.5){var s=(n=Math.random())+1+Math.random();e.face=[{start:n,attackPeak:n+.2*(s-n),relax:n+.5*(s-n),end:s,lexeme:{lexeme:"BROW_RAISER",amount:.1+.2*Math.random()},type:"face"},{start:n,attackPeak:n+.2*(s-n),relax:n+.5*(s-n),end:s,lexeme:{lexeme:"UPPER_LID_RAISER",amount:.1+.2*Math.random()},type:"face"}]}if(Math.random()<.2){var i={start:n=Math.random(),attackPeak:n+.2*((s=n+1+Math.random())-n),relax:n+.5*(s-n),end:s,lexeme:{lexeme:"CHEEK_RAISER",amount:.1+.2*Math.random()},type:"face"};e.face?e.face.push(i):e.face=i}break;case k.SPEAKING:if(this.nextBlockIn=2+4*Math.random(),Math.random()<.2&&Math.random()<.85){var n=Math.random();(r=["CAMERA","DOWN_RIGHT","DOWN_LEFT","LEFT","RIGHT"])[Math.floor(Math.random()*r.length)]}if(Math.random()<.7){s=(n=Math.random())+1.2+.5*Math.random();e.face={start:n,attackPeak:n+.2*(s-n),relax:n+.5*(s-n),end:s,lexeme:{lexeme:"BROW_RAISER",amount:.1+.2*Math.random()},type:"face"}}Math.random()<.7&&(e.composition="MERGE");break;case k.PROCESSING:if(this.nextBlockIn=2+2*Math.random(),r=["UP_RIGHT","UP_LEFT","LEFT","RIGHT"],Math.floor(Math.random()*r.length),Math.random()<.6&&(e.face={start:0,end:1+Math.random(),lexeme:[{lexeme:"BROW_LOWERER",amount:.2+.5*Math.random()}],type:"face"}),Math.random()<.3){var a={lexeme:"LIP_PRESSOR",amount:.1+.3*Math.random()};e.face?e.face.lexeme.push(a):e.face={start:0,end:1+Math.random(),lexeme:a},e.face.type="face"}break;case k.WAITING:var r;this.nextBlockIn=2+3*Math.random(),(r=["CAMERA","DOWN","DOWN_RIGHT","DOWN_LEFT","LEFT","RIGHT"])[Math.floor(Math.random()*r.length)],e.composition="MERGE"}return e}newBlock(t){if(t.control&&this.transition(t),t.nonVerbal&&t.nonVerbal.constructor===Array)for(var e=0;e<t.nonVerbal.length;e++){var s=t.nonVerbal[e].dialogueAct;t.gesture={lexeme:s,start:0,end:2,type:"gesture"}}}updateBlinksAndSaccades(t){var e=null;if(this.saccCountdown+=t,this.saccCountdown>this.saccIdle){var s=["RIGHT","LEFT","DOWN","DOWN_RIGHT","DOWN_LEFT","UP","UP_LEFT","UP_RIGHT"];Math.floor(Math.random()*s.length),this.state,e||(e={}),this.saccCountdown=this.saccDur,this.state==k.LISTENING||this.state==k.SPEAKING?this.saccIdle=this.saccDur+2+6*Math.random():this.saccIdle=this.saccDur+.5+6*Math.random(),this.saccDur=.5*Math.random()+.5}return e}attentionToUser(t,e){this.defaultValence}addToBlock(t,e,s){if(e[s])if(e[s].constructor===Array)if(t.constructor===Array)for(var i=0;i<t.length;i++)e[s].push(t[i]);else e[s].push(t);else{var n=e[s];if(e[s]=[],e[s].push(n),t.constructor===Array)for(i=0;i<t.length;i++)e[s].push(t[i]);else e[s].push(t)}else e[s]=t}}u.BehaviourPlanner=k;class T{constructor(){this.bmlKeys=["blink","gaze","gazeShift","face","faceShift","head","headDirectonShift","lg","gesture","posture","animation"],this.blinkStack=[],this.gazeStack=[],this.faceStack=[],this.headStack=[],this.headDirStack=[],this.speechStack=[],this.gestureStack=[],this.pointingStack=[],this.postureStack=[],this.lgStack=[],this.animationStack=[],this.BMLStacks=[this.blinkStack,this.gazeStack,this.faceStack,this.headStack,this.headDirStack,this.speechStack,this.lgStack,this.gestureStack,this.pointingStack,this.postureStack,this.animationStack],this.stack=[]}reset(){this.blinkStack.length=0,this.gazeStack.length=0,this.faceStack.length=0,this.headStack.length=0,this.headDirStack.length=0,this.speechStack.length=0,this.gestureStack.length=0,this.pointingStack.length=0,this.postureStack.length=0,this.lgStack.length=0,this.animationStack.length=0,this.stack.length=0}update(t,e){this.time=e;for(let t=0;t<this.stack.length;t++)this.stack[t].isActive||this.stack[t].startGlobalTime<=this.time&&(this.stack.splice(t,1),t--);for(let e=0;e<this.BMLStacks.length;e++){let s=this.BMLStacks[e];for(let e=0;e<s.length;e++){let i=s[e];i.startGlobalTime<=this.time&&(t(i.key,i),s.splice(e,1),e--)}}}newBlock(t,e){t&&(0==e&&(e=.001),this.time=e,this.fixBlock(t),0!=t.end&&this.addToStack(t))}fixBlock(t){t.start=isNaN(t.start)?0:t.start,t.blink&&(t.blink=this.fixBML(t.blink,"blink",t,{start:0,attackPeak:.25,relax:.25,end:.5})),t.gaze&&(t.gaze=this.fixBML(t.gaze,"gaze",t,{start:0,ready:.33,relax:.66,end:2})),t.gazeShift&&(t.gazeShift=this.fixBML(t.gazeShift,"gazeShift",t,{start:0,end:2})),t.head&&(t.head=this.fixBML(t.head,"head",t,{start:0,ready:.15,strokeStart:.15,stroke:.5,strokeEnd:.8,relax:.8,end:2})),t.headDirectionShift&&(t.headDirectionShift=this.fixBML(t.headDirectionShift,"headDirectionShift",t,{start:0,end:2})),t.face&&(t.face=this.fixBML(t.face,"face",t,{start:0,attackPeak:.4,relax:.6,end:1})),t.faceFACS&&(t.faceFACS=this.fixBML(t.faceFACS,"faceFACS",t,{start:0,attackPeak:.4,relax:.6,end:1})),t.faceLexeme&&(t.faceLexeme=this.fixBML(t.faceLexeme,"faceLexeme",t,{start:0,attackPeak:.4,relax:.6,end:1})),t.faceEmotion&&(t.face=this.fixBML(t.faceEmotion,"face",t,{start:0,attackPeak:.4,relax:.6,end:1})),t.faceVA&&(t.face=this.fixBML(t.faceVA,"face",t,{start:0,attackPeak:.4,relax:.6,end:1})),t.faceShift&&(t.faceShift=this.fixBML(t.faceShift,"faceShift",t,{start:0,end:1})),t.speech&&(t.speech=this.fixBML(t.speech,"speech",t,{start:0,end:2.5})),t.lg&&(t.lg=this.fixBML(t.lg,"lg",t,{start:0,end:1})),t.posture&&(t.posture=this.fixBML(t.posture,"posture",t,{start:0,ready:.3,strokeStart:.3,stroke:.4,strokeEnd:.6,relax:.7,end:1})),t.gesture&&(t.gesture=this.fixBML(t.gesture,"gesture",t,{start:0,ready:.1,strokeStart:.2,stroke:.7,strokeEnd:.7,relax:1.4,end:1.5})),t.pointing&&(t.pointing=this.fixBML(t.pointing,"pointing",t,{start:0,ready:.3,strokeStart:.3,stroke:.4,strokeEnd:.6,relax:.7,end:1})),t.animation&&(t.animation=this.fixBML(t.animation,"animation",t,{start:0,end:2})),t.end=this.findEndOfBlock(t)}fixBML(t,e,s,i){if(!t)return console.warn("BML instruction undefined or null:",e,t),void delete s[e];if(t.constructor===Array){for(var n=0;n<t.length;n++)t[n]=this.fixBML(t[n],e,s,i);return t}return"object"==typeof t&&null!==t||(t={}),t.key=e,t.start=isNaN(t.start)?0:t.start,t.start<0&&(t.start=0),t.end=isNaN(t.end)?t.start+i.end:t.end,t}findEndOfBlock(t){let e=Object.keys(t),s=0;for(let i=0;i<e.length;i++){let n=t[e[i]];if(null!=n)if(isNaN(n.end)){if(n.constructor===Array)for(let t=0;t<n.length;t++)n[t]&&!isNaN(n[t].end)&&(s=Math.max(n[t].end,s))}else s=Math.max(n.end,s)}return s}addToStack(t){if("[object String]"===Object.prototype.toString.call(t.composition)&&(t.composition=t.composition.toUpperCase()),0==this.stack.length)t.startGlobalTime=this.time+t.start,t.endGlobalTime=this.time+t.end,this.stack.push(t);else if("OVERWRITE"==t.composition){t.startGlobalTime=this.time+t.start,t.endGlobalTime=this.time+t.end;let e=this.stack[this.stack.length-1];t.endGlobalTime<e.endGlobalTime?(this.stack[this.stack.length-1]=t,this.stack.push(e)):this.stack.push(t)}else if("APPEND"==t.composition)t.startGlobalTime=this.stack[this.stack.length-1].endGlobalTime+t.start,t.endGlobalTime=this.stack[this.stack.length-1].endGlobalTime+t.end,this.stack.push(t);else if("REPLACE"==t.composition){t.startGlobalTime=this.stack[0].isActive?this.stack[0].endGlobalTime:this.time,t.endGlobalTime=t.startGlobalTime+t.end;for(let t=this.stack[0].isActive?1:0;t<this.stack.length;t++)this.removeFromStacks(this.stack[t]);this.stack.push(t)}else if(t.startGlobalTime=this.time+t.start,t.endGlobalTime=this.time+t.end,this.stack.push(t),this.stack.length>1)for(let e=this.stack.length-2;e>=0;--e){let s=this.stack[e];if(!(s.startGlobalTime>t.startGlobalTime))break;this.stack[e]=t,this.stack[e+1]=s}this.addToBMLStacks(t)}removeFromStacks(t){let e=Object.keys(t);for(let s=0;s<e.length;s++){let i=t[e[s]];if(null!==i||void 0!==i)if("object"==typeof i)i.del=!0;else if(i.constructor===Array)for(let t=0;t<i.length;t++)i[t].del=!0}for(let t=0;t<this.BMLStacks.length;t++)for(let e=0;e<this.BMLStacks[t].length;e++)this.BMLStacks[t][e].del&&(this.BMLStacks[t][e].isActive=void 0,this.BMLStacks[t].splice(e,1),e--)}addToBMLStacks(t){let e=t.startGlobalTime;t.blink&&this.processIntoBMLStack(t.blink,this.blinkStack,e,t.composition),t.gaze&&this.processIntoBMLStack(t.gaze,this.gazeStack,e,t.composition),t.gazeShift&&this.processIntoBMLStack(t.gazeShift,this.gazeStack,e,t.composition),t.head&&this.processIntoBMLStack(t.head,this.headStack,e,t.composition),t.headDirectionShift&&this.processIntoBMLStack(t.headDirectionShift,this.headDirStack,e,t.composition),t.faceLexeme&&this.processIntoBMLStack(t.faceLexeme,this.faceStack,e,t.composition),t.faceFACS&&this.processIntoBMLStack(t.faceFACS,this.faceStack,e,t.composition),t.face&&this.processIntoBMLStack(t.face,this.faceStack,e,t.composition),t.faceShift&&this.processIntoBMLStack(t.faceShift,this.faceStack,e,t.composition),t.speech&&this.processIntoBMLStack(t.speech,this.speechStack,e,t.composition),t.posture&&this.processIntoBMLStack(t.posture,this.postureStack,e,t.composition),t.gesture&&this.processIntoBMLStack(t.gesture,this.gestureStack,e,t.composition),t.pointing&&this.processIntoBMLStack(t.pointing,this.pointingStack,e,t.composition),t.lg&&this.processIntoBMLStack(t.lg,this.lgStack,e,t.composition),t.animation&&this.processIntoBMLStack(t.animation,this.animationStack,e,t.composition)}processIntoBMLStack(t,e,s,i){if(t.constructor===Array){for(let n=0;n<t.length;n++)this.processIntoBMLStack(t[n],e,s,i);return}let n=this.mergeBML(t,e,s,i);t.del=!n,n||console.warn("Could not add to "+t.key+" stack. \n")}mergeBML(t,e,s,i){let n=!1;t.start<0&&(t.start=-t.start-s),t.end<0&&(t.end=-t.end-s),t.startGlobalTime=s+t.start,t.endGlobalTime=s+t.end,t.start<0&&console.error("BML start is negative",t.start,t.key,s),t.end<0&&console.error("BML end is negative",t.end,t.key,s),t.end-=t.start,isNaN(t.attackPeak)||(t.attackPeak=this.mergeBMLSyncFix(t.attackPeak,t.start,s)),isNaN(t.ready)||(t.ready=this.mergeBMLSyncFix(t.ready,t.start,s)),isNaN(t.strokeStart)||(t.strokeStart=this.mergeBMLSyncFix(t.strokeStart,t.start,s)),isNaN(t.stroke)||(t.stroke=this.mergeBMLSyncFix(t.stroke,t.start,s)),isNaN(t.strokeEnd)||(t.strokeEnd=this.mergeBMLSyncFix(t.strokeEnd,t.start,s)),isNaN(t.relax)||(t.relax=this.mergeBMLSyncFix(t.relax,t.start,s)),t.start=0,t.composition=i;let a="OVERWRITE"===i,r="MERGE"===i;if(!a){e.push(t);for(let s=e.length-2;s>0&&e[s].startGlobalTime>t.startGlobalTime;--s)e[s+1]=e[s],e[s]=t;return!0}if(0==e.length)return e.push(t),!0;if(e.length>1)if(t.startGlobalTime>=e[e.length-1].endGlobalTime)e.push(t),n=!0;else for(let s=0;s<e.length-1&&!n;s++)if(t.startGlobalTime>=e[s].endGlobalTime&&t.endGlobalTime<=e[s+1].startGlobalTime||0==s&&t.endGlobalTime<e[s].startGlobalTime){let i=e.splice(s,e.length);e.push(t),e=e.concat(i),n=!0}else a?(e.splice(s,1),s--):r&&(e.push(t),n=!0);return n&&!a||(e[e.length-1].endGlobalTime<=t.startGlobalTime?n||(e.push(t),n=!0):a?e.splice(e.length-1,1):t.endGlobalTime<e[0].startGlobalTime&&(e.push(t),e.reverse())),a&&!n&&(e.push(t),n=!0),n}mergeBMLSyncFix(t,e,s){return t>e?t-e:0}check(){this.errorCheck(this.blinkStack)&&console.error("Previous error is in blink stack"),this.errorCheck(this.gazeStack)&&console.error("Previous error is in gaze stack"),this.errorCheck(this.faceStack)&&console.error("Previous error is in face stack"),this.errorCheck(this.headStack)&&console.error("Previous error is in head stack"),this.errorCheck(this.headDirStack)&&console.error("Previous error is in headDir stack"),this.errorCheck(this.speechStack)&&console.error("Previous error is in speech stack"),this.errorCheck(this.postureStack)&&console.error("Previous error is in posture stack"),this.errorCheck(this.gestureStack)&&console.error("Previous error is in gesture stack"),this.errorCheck(this.pointingStack)&&console.error("Previous error is in pointing stack"),this.errorCheck(this.lgStack)&&console.error("Previous error is in lg stack"),this.errorCheck(this.animationStack)&&console.error("Previous error is in animation stack")}errorCheck(t){for(let e=0;e<t.length-1;e++)if(t[e].endGlobalTime>t[e+1].startGlobalTime)return console.error("Timing error in stack: ",t),!0}}u.BehaviourManager=T;class E{constructor(t=!0){this.start=0,this.end=0,this.elapsedTime=0,this.initWs=[0,0],this.endWs=[0,0],this.weights=[0,0],this.state=1,this.auto=!!t,this.timeoutID=null}setAuto(t){this.auto=!!t,this.auto&&!this.state&&(this.state=1)}reset(){this.auto?this.state=1:this.state=0,this.timeoutID&&(clearTimeout(this.timeoutID),this.timeoutID=null)}initBlinking(t,e){2&this.state?(this.initWs[0]=this.weights[0],this.initWs[1]=this.weights[1]):(this.initWs[0]=t,this.initWs[1]=e,this.weights[0]=t,this.weights[1]=e),this.endWs[0]=t,this.endWs[1]=e,this.elapsedTime=0,this.start=0;let s=Math.min(t,e);s=Math.min(1,Math.max(0,s)),this.end=.5*(1-s),this.end=Math.max(this.end,this.start),this.state=2}blink(){this.state|=1}_timeoutBlink(){this.auto&&(this.state|=1),this.timeoutID=null}update(t,e,s){if(1&this.state&&this.initBlinking(e,s),this.state&&t>0&&(this.elapsedTime+=t,this.endWs[0]=e,this.endWs[1]=s,this.computeWeight(this.elapsedTime),this.elapsedTime>this.end))return this.state=0,void(this.auto&&!this.timeoutID&&(this.timeoutID=setTimeout(this._timeoutBlink.bind(this),3e3*Math.random()+1500)))}computeWeight(t){let e=(t-this.start)/(this.end-this.start)*100;e=Math.min(100,Math.max(0,e));let s=0,i=null;e<=37?(s=1-Math.pow(e/37,2),i=this.initWs):(s=1.18-Math.pow(Math.E,-.37*Math.log2(e-37+1)),i=this.endWs),s=Math.min(1,Math.max(0,s)),this.weights[0]=1-s*(1-i[0]),this.weights[1]=1-s*(1-i[1])}}class R{static NMF={ARCH:[[1,2,0],[1,1,1]],BROW_LOWERER:[[3,4],[1,1]],BROW_LOWERER_LEFT:[[3],[1]],BROW_LOWERER_RIGHT:[[4],[1]],BROW_RAISER:[[1,2],[1,1]],BROW_RAISER_LEFT:[[1],[1]],BROW_RAISER_RIGHT:[[2],[1]],INNER_BROW_RAISER:[[0],[1]],OUTER_BROW_RAISER:[[1,2],[1,1]],SQUINT:[[49,50],[1,1]],BLINK:[[51,52],[1,1]],EYES_CLOSED:[[51,52],[1,1]],UPPER_LID_RAISER:[[47,48],[1,1]],UPPER_LID_RAISER_LEFT:[[47],[1]],UPPER_LID_RAISER_RIGHT:[[48],[1]],LID_TIGHTENER:[[51,52,49,50],[.2,.2,.8,.8]],WINK_LEFT:[[53],[1]],WINK_RIGHT:[[54],[1]],CHEEK_RAISER:[[41,42],[1,1]],CHEEK_SUCK:[[45,46],[1,1]],CHEEK_SUCK_LEFT:[[45],[1]],CHEEK_SUCK_RIGHT:[[46],[1]],CHEEK_BLOW:[[43,44],[1,1]],CHEEK_BLOW_LEFT:[[43],[1]],CHEEK_BLOW_RIGHT:[[44],[1]],NOSE_WRINKLER:[[5,6],[1,1]],NOSTRIL_DILATOR:[[7],[1]],NOSTRIL_COMPRESSOR:[[8],[1]],LIP_CORNER_DEPRESSOR:[[15,16],[1,1]],LIP_CORNER_DEPRESSOR_LEFT:[[15],[1]],LIP_CORNER_DEPRESSOR_RIGHT:[[16],[1]],LIP_CORNER_PULLER:[[13,14],[1,1]],LIP_CORNER_PULLER_LEFT:[[13],[1]],LIP_CORNER_PULLER_RIGHT:[[14],[1]],LIP_STRETCHER:[[21,22],[1,1]],LIP_FUNNELER:[[23],[1]],LIP_TIGHTENER:[[19,20,24,25],[1,1,.3,.3]],LIP_PUCKERER:[[19,20],[1,1]],LIP_PUCKERER_LEFT:[[19],[1]],LIP_PUCKERER_RIGHT:[[20],[1]],LIP_PRESSOR:[[24,25],[1,1]],LIPS_PART:[[26],[1]],LIP_SUCK:[[27,28],[1,1]],LIP_SUCK_UPPER:[[27],[1]],LIP_SUCK_LOWER:[[28],[1]],LOWER_LIP_DEPRESSOR:[[17,18],[1,1]],LOWER_LIP_DEPRESSOR_LEFT:[[17],[1]],LOWER_LIP_DEPRESSOR_RIGHT:[[18],[1]],UPPER_LIP_RAISER:[[11,12],[1,1]],UPPER_LIP_RAISER_LEFT:[[11],[1]],UPPER_LIP_RAISER_RIGHT:[[12],[1]],CHIN_RAISER:[[40],[1]],DIMPLER:[[9,10],[1,1]],DIMPLER_LEFT:[[9],[1]],DIMPLER_RIGHT:[[10],[1]],LIP_BITE:[[28,35,36],[1,.1,.05]],SMILE_TEETH:[[13,14,35],[.5,.5,.2]],SMILE_TEETH_WIDE:[[13,14,35],[1,1,.2]],SMILE_CLOSED:[[13,14],[1,1]],ROUND_OPEN:[[19,20,35],[.7,.7,.7]],ROUND_CLOSED:[[19,20],[1,1]],MOUTH_STRETCH:[[35],[1]],CLOSE_TIGHT:[[28,19,20,27],[1,1,1,1]],JAW_DROP:[[36],[1]],JAW_THRUST:[[37],[1]],JAW_SIDEWAYS_LEFT:[[38],[1]],JAW_SIDEWAYS_RIGHT:[[39],[1]],TONGUE_BULGE_LEFT:[[32],[1]],TONGUE_BULGE_RIGHT:[[33],[1]],TONGUE_UP:[[30],[1]],TONGUE_SHOW:[[31],[1]],TONGUE_WIDE:[[34],[1]],LIP_WIPE:[[29],[1]],NECK_TIGHTENER:[[55],[1]]};constructor(t,e){this.transition=!1;let s=t.lexeme;s&&("string"==typeof s?this.initFaceLexeme(t,e,[t]):Array.isArray(s)?this.initFaceLexeme(t,e,s):"object"==typeof s&&this.initFaceLexeme(t,e,[s]))}initFaceLexeme(t,e,s){this.start=t.start||0,this.end=t.end,e?(this.end=t.end||t.attackPeak||0,this.attackPeak=t.attackPeak||this.end,this.relax=0):(this.attackPeak=t.attackPeak||.25*(this.end-this.start)+this.start,this.relax=t.relax||(this.end-this.attackPeak)/2+this.attackPeak),this.indicesLex=[],this.targetLexBSW=[],this.currentLexBSW=[];let i=0;for(let e=0;e<s.length;e++){let n=s[e].lexeme;if(n="string"!=typeof n?"NO_LEXEME":n.toUpperCase(),!R.NMF[n]){this.transition=!1,this.time=this.end,console.warn("Facial lexeme not found:",n,". Please refer to the standard.");continue}let a=R.NMF[n][0],r=R.NMF[n][1];this.indicesLex[i]=a,this.targetLexBSW[i]=[],this.currentLexBSW[i]=[];let o=s[e].amount;o=isNaN(o)||null==o?t.amount:o,o=isNaN(o)||null==o?1:o;for(let t=0;t<a.length;++t)this.targetLexBSW[i][t]=o*r[t],this.currentLexBSW[i][t]=0;i++}this.transition=!0,this.time=0}updateLexemesBSW(t){if(0==this.attackPeak&&0==this.end&&0==this.time){for(var e=0;e<this.indicesLex.length;e++)for(var s=0;s<this.indicesLex[e].length;s++)this.currentLexBSW[e][s]=this.targetLexBSW[e][s];return void(this.time+=t)}if(this.time+=t,this.time<this.start)return;let i=0;this.time<this.start?i=0:this.time<this.attackPeak?(i=(this.time-this.start)/(this.attackPeak-this.start),i=.5*Math.cos(Math.PI*i+Math.PI)+.5):this.time<this.relax?i=1:this.time<this.end?(i=(this.time-this.relax)/(this.end-this.relax),i=1-i,i=.5*Math.cos(Math.PI*i+Math.PI)+.5):(i=0,this.transition=!1);for(e=0;e<this.indicesLex.length;e++)for(s=0;s<this.indicesLex[e].length;s++)this.currentLexBSW[e][s]=i*this.targetLexBSW[e][s]}}class w{constructor(t){this._emotionsVAE=[[-.76,.64,[R.NMF.BROW_LOWERER,.9],[R.NMF.UPPER_LID_RAISER,.1],[R.NMF.LID_TIGHTENER,.25],[R.NMF.LIP_CORNER_DEPRESSOR,.3],[R.NMF.NOSE_WRINKLER,.2]],[.95,.23,[R.NMF.CHEEK_RAISER,.4],[R.NMF.BROW_RAISER,.1],[R.NMF.SMILE_CLOSED,.75]],[-.81,-.57,[R.NMF.INNER_BROW_RAISER,.8],[R.NMF.BROW_LOWERER,.5],[R.NMF.LIP_CORNER_DEPRESSOR,.5]],[.22,.98,[R.NMF.INNER_BROW_RAISER,.5],[R.NMF.OUTER_BROW_RAISER,.5],[R.NMF.UPPER_LID_RAISER,.3],[R.NMF.LIP_PUCKERER,.3],[R.NMF.JAW_DROP,.35],[R.NMF.MOUTH_STRETCH,.1]],[-.25,.98,[R.NMF.INNER_BROW_RAISER,1],[R.NMF.BROW_LOWERER,.5],[R.NMF.UPPER_LID_RAISER,.3],[R.NMF.LIP_STRETCHER,.3],[R.NMF.JAW_DROP,.3]],[-.96,.23,[R.NMF.NOSE_WRINKLER,.35],[R.NMF.BROW_LOWERER,.35],[R.NMF.SQUINT,.5],[R.NMF.LIP_CORNER_DEPRESSOR,.2],[R.NMF.UPPER_LIP_RAISER,.3],[R.NMF.LOWER_LIP_DEPRESSOR,.1]],[-.98,-.21,[R.NMF.LIP_CORNER_PULLER_LEFT,.7],[R.NMF.DIMPLER_LEFT,.5]],[0,0]],this.gridSize=100,this.precomputeVAWeights(this.gridSize),this.transition=!1,this.time=0,this.sceneBSW=t,this.initialVABSW=[],this.targetVABSW=[],this.currentVABSW=[],this.currentVABSW=t?this.sceneBSW.slice():this._emotionsVAE[0].slice(2),this.currentVABSW.fill(0),this.initialVABSW=this.currentVABSW.slice(),this.targetVABSW=this.currentVABSW.slice(),this.defaultVABSW=this.currentVABSW.slice()}reset(){this.currentVABSW.fill(0),this.initialVABSW.fill(0),this.targetVABSW.fill(0),this.defaultVABSW.fill(0),this.transition=!1,this.time=0}precomputeVAWeights(e=100){let s=[];for(let e=0;e<this._emotionsVAE.length;e++){let i=new t.Vector2(this._emotionsVAE[e][0],this._emotionsVAE[e][1]);s.push(i)}let i=s.length,n=new t.Vector2,a=2*e*e;this._precomputed_weights=new Float32Array(a);let r=this._precomputed_weights;this._precomputed_weights_gridsize=e;for(var o=0;o<e;++o)for(var l=0;l<e;++l){let t=-1,a=1e5;n.x=l/e,n.y=o/e,n.x=2*n.x-1,n.y=2*n.y-1;for(var h=0;h<i;++h){let e=n.distanceToSquared(s[h]);e>a||(t=h,a=e)}r[2*(l+o*e)]=t,r[2*(l+o*e)+1]=a}return r}initFaceValAro(e,s){if(this.valaro=(new t.Vector2).fromArray(e.valaro||[.1,.1]),e.emotion){switch(e.emotion.toUpperCase?e.emotion.toUpperCase():e.emotion){case"ANGER":this.valaro.fromArray(this._emotionsVAE[0].slice(0,2));break;case"HAPPINESS":this.valaro.fromArray(this._emotionsVAE[1].slice(0,2));break;case"SADNESS":this.valaro.fromArray(this._emotionsVAE[2].slice(0,2));break;case"SURPRISE":this.valaro.fromArray(this._emotionsVAE[3].slice(0,2));break;case"FEAR":this.valaro.fromArray(this._emotionsVAE[4].slice(0,2));break;case"DISGUST":this.valaro.fromArray(this._emotionsVAE[5].slice(0,2));break;case"CONTEMPT":this.valaro.fromArray(this._emotionsVAE[6].slice(0,2));break;default:this.valaro.fromArray(this._emotionsVAE[7].slice(0,2))}}let i=this.valaro.length();i>1&&(this.valaro.x/=i,this.valaro.y/=i),this.start=e.start||0,this.end=e.end,this.amount=e.amount||1,s?(this.attackPeak=e.attackPeak||this.end,this.relax=this.end=this.attackPeak+1):(this.attackPeak=e.attackPeak||.25*(this.end-this.start)+this.start,this.relax=e.relax||(this.end-this.attackPeak)/2+this.attackPeak),this.amount=isNaN(e.amount)?1:e.amount,this.VA2BSW(this.valaro,s),this.transition=!0,this.time=0}VA2BSW(e,s){let i=this.gridSize,n=this.currentVABSW.slice();n.fill(0);let a=e.clone(),r=this._precomputed_weights,o=[];o.length=this._emotionsVAE.length,o.fill(0);let l=0,h=new t.Vector2;for(let t=0;t<i;++t)for(let e=0;e<i;++e){h.x=e/i,h.y=t/i,h.x=2*h.x-1,h.y=2*h.y-1;let s=2*(e+t*i),n=r[s],c=r[s+1];h.distanceToSquared(a)<c+.001&&(o[n]+=1,l++)}for(let t=0;t<o.length;++t){o[t]/=l;let e=this._emotionsVAE[t];for(let s=2;s<e.length;s++){let i=e[s][0],a=e[s][1];for(let e=0;e<i[0].length;e++)n[i[0][e]]+=i[1][e]*a*o[t]}}for(let t=0;t<n.length;t++)this.targetVABSW[t]=n[t]*this.amount,this.initialVABSW[t]=this.currentVABSW[t],s&&(this.defaultVABSW[t]=this.targetVABSW[t])}updateVABSW(t){if(0==this.transition){for(let t=0;t<this.currentVABSW.length;t++)this.currentVABSW[t]=this.defaultVABSW[t];return}if(this.time+=t,this.time<this.start)return;if(this.time>this.attackPeak&&this.time<this.relax)return;if(this.time>=this.end){for(let t=0;t<this.currentVABSW.length;t++)this.currentVABSW[t]=this.defaultVABSW[t];return void(this.transition=!1)}let e=0;if(this.time<=this.attackPeak){e=(this.time-this.start)/(this.attackPeak-this.start),e=.5*Math.cos(Math.PI*e+Math.PI)+.5;for(let t=0;t<this.targetVABSW.length;t++)this.currentVABSW[t]=this.initialVABSW[t]*(1-e)+this.targetVABSW[t]*e}else if(this.time>this.relax&&this.time<this.end){e=(this.time-this.relax)/(this.end-this.relax),e=.5*Math.cos(Math.PI*e)+.5;for(let t=0;t<this.targetVABSW.length;t++)this.currentVABSW[t]=this.defaultVABSW[t]*(1-e)+this.targetVABSW[t]*e}else;}}class I{static gazeBS={RIGHT:{squint:0,eyelids:0},LEFT:{squint:0,eyelids:0},UP:{squint:.3,eyelids:0},DOWN:{squint:0,eyelids:.2},UP_RIGHT:{squint:.3,eyelids:0},UP_LEFT:{squint:.3,eyelids:0},DOWN_RIGHT:{squint:0,eyelids:.2},DOWN_LEFT:{squint:0,eyelids:.2},FRONT:{squint:0,eyelids:0},CAMERA:{squint:0,eyelids:0},EYES_TARGET:{squint:0,eyelids:0},HEAD_TARGET:{squint:0,eyelids:0},NECK_TARGET:{squint:0,eyelids:0}};static _tempQ=new t.Quaternion;static targetP=new t.Vector3;constructor(e,s,i=!1){this.isEyes=i,s&&(this.gazePositions=s),this.cameraEye=s.CAMERA||new t.Vector3,this.headPos=s.HEAD||new t.Vector3,this.lookAt=e,this.transition=!1,this.eyelidsW=0,this.squintW=0,this.src={p:new t.Vector3,squint:0,lids:0},this.trg={p:new t.Vector3,squint:0,lids:0},this.def={p:s.FRONT.clone(),squint:0,lids:0}}reset(){this.transition=!1,this.eyelidsW=0,this.squintW=0,this.src.p.set(0,0,0),this.src.squint=0,this.src.lids=0,this.trg.p.set(0,0,0),this.trg.squint=0,this.trg.lids=0,this.def.p.copy(this.gazePositions.FRONT),this.def.squint=0,this.def.lids=0}initGazeData(t,e){this.start=t.start||0,this.end=t.end||2,e?(this.ready=this.end,this.relax=0):(this.ready=t.ready||this.start+(this.end-this.start)/3,this.relax=t.relax||this.start+2*(this.end-this.start)/3),this.offsetDirection=t.offsetDirection&&t.offsetDirection.toUpperCase?t.offsetDirection.toUpperCase():"RIGHT",this.target=t.target&&t.target.toUpperCase?t.target.toUpperCase():"FRONT",this.offsetAngle=t.offsetAngle||0,this.transition=!0,this.time=0,this.dynamic=t.dynamic||!1,this.src.lids=this.eyelidsW,this.trg.lids=I.gazeBS[this.target].eyelids,this.src.squint=this.squintW,this.trg.squint=I.gazeBS[this.target].squint,this.initGazeValues(),e&&(this.def.p.copy(this.trg.p),this.def.lids=this.trg.lids,this.def.squint=this.trg.squint)}update(t){if(this.transition&&(this.time+=t,!(this.time<this.start)))if(this.time>this.ready&&this.time<this.relax)this.isEyes&&(this.eyelidsW=this.trg.lids,this.squintW=this.trg.squint);else{if(this.dynamic&&this.trg.p.copy(this.gazePositions[this.target]),this.time<=this.ready){let t=(this.time-this.start)/(this.ready-this.start);return t=.5*Math.sin(Math.PI*t-.5*Math.PI)+.5,this.isEyes&&(this.eyelidsW=this.src.lids*(1-t)+this.trg.lids*t,this.squintW=this.src.squint*(1-t)+this.trg.squint*t),void this.lookAt.position.lerpVectors(this.src.p,this.trg.p,t)}if(this.time<=this.end){let t=(this.time-this.relax)/(this.end-this.relax);return t=.5*Math.sin(Math.PI*t-.5*Math.PI)+.5,this.isEyes&&(this.eyelidsW=this.trg.lids*(1-t)+this.def.lids*t,this.squintW=this.trg.squint*(1-t)+this.def.squint*t),void this.lookAt.position.lerpVectors(this.trg.p,this.def.p,t)}this.time>this.end&&(this.dynamic?this.lookAt.position.copy(this.def.p):(this.transition=!1,this.lookAt.position.copy(this.def.p),this.eyelidsW=this.def.lids,this.squintW=this.def.squint))}}initGazeValues(){this.gazePositions&&this.gazePositions[this.target]?I.targetP.copy(this.gazePositions[this.target]):I.targetP.set(0,110,100);let e=I._tempQ,s=I.targetP.sub(this.headPos),i=s.length();switch(s.normalize(),this.trg.lids=I.gazeBS[this.target].eyelids,this.trg.squint=I.gazeBS[this.target].squint,this.offsetDirection){case"UP_RIGHT":e.setFromAxisAngle(s,-25*L),s.applyAxisAngle(new t.Vector3(0,1,0),this.offsetAngle*L),s.applyQuaternion(e),this.isEyes&&(this.trg.squint*=Math.abs(this.offsetAngle/30));break;case"UP_LEFT":e.setFromAxisAngle(s,-75*L),s.applyAxisAngle(new t.Vector3(0,1,0),this.offsetAngle*L),s.applyQuaternion(e),this.isEyes&&(this.trg.squint*=Math.abs(this.offsetAngle/30));break;case"DOWN_RIGHT":e.setFromAxisAngle(s,-25*L),s.applyAxisAngle(new t.Vector3(0,1,0),this.offsetAngle*L),s.applyQuaternion(e),this.isEyes&&(this.trg.lids*=Math.abs(this.offsetAngle/30));break;case"DOWN_LEFT":e.setFromAxisAngle(s,75*L),s.applyAxisAngle(new t.Vector3(0,1,0),this.offsetAngle*L),s.applyQuaternion(e),this.isEyes&&(this.trg.lids*=Math.abs(this.offsetAngle/30));break;case"RIGHT":s.applyAxisAngle(new t.Vector3(0,1,0),this.offsetAngle*L);break;case"LEFT":s.applyAxisAngle(new t.Vector3(0,1,0),-this.offsetAngle*L);break;case"UP":s=new t.Vector3(1,0,0),e.setFromAxisAngle(s,-45*L),s.applyAxisAngle(new t.Vector3(1,0,0),this.offsetAngle*L),s.applyQuaternion(e),this.isEyes&&(this.trg.squint*=Math.abs(this.offsetAngle/30));break;case"DOWN":this.isEyes&&(this.trg.lids*=Math.abs(this.offsetAngle/30))}if(s.addScaledVector(s,i),s.addVectors(s,this.headPos),I.targetP.copy(s),!this.lookAt||!this.lookAt.position)return console.log("ERROR: lookAt not defined ",this.lookAt);this.src.p.copy(this.lookAt.position),this.trg.p.copy(I.targetP)}}class P{static gazePositions={RIGHT:new t.Vector3(-30,2,100),LEFT:new t.Vector3(30,2,100),UP:new t.Vector3(0,20,100),DOWN:new t.Vector3(0,-20,100),UP_RIGHT:new t.Vector3(-30,20,100),UP_LEFT:new t.Vector3(30,20,100),DOWN_RIGHT:new t.Vector3(-30,-20,100),DOWN_LEFT:new t.Vector3(30,-20,100),FRONT:new t.Vector3(0,2,100),CAMERA:new t.Vector3(0,2,100)};constructor(t,e,s,i=null){this.gazePositions=i||P.gazePositions,this.lookAtNeck=t,this.lookAtHead=e,this.lookAtEyes=s,this.gazeActions=[null,null,null],this.gazeActions[0]=new I(this.lookAtEyes,this.gazePositions,!0),this.gazeActions[1]=new I(this.lookAtHead,this.gazePositions,!1),this.gazeActions[2]=new I(this.lookAtNeck,this.gazePositions,!1)}reset=function(){this.lookAtNeck.position.set(0,2.5,100),this.lookAtHead.position.set(0,2.5,100),this.lookAtEyes.position.set(0,2.5,100),this.gazeActions[0].reset(),this.gazeActions[1].reset(),this.gazeActions[2].reset()};newGaze=function(t,e,s,i){switch(this.gazePositions=s||this.gazePositions,t.influence=t.influence&&t.influence.toUpperCase?t.influence.toUpperCase():"HEAD",t.influence){case"NECK":this.gazeActions[2].initGazeData(t,e);case"HEAD":this.gazeActions[1].initGazeData(t,e);case"EYES":i||this.gazeActions[0].initGazeData(t,e)}};update=function(t){for(let e=0;e<this.gazeActions.length;e++)this.gazeActions[e]&&this.gazeActions[e].transition&&this.gazeActions[e].update(t);return{eyelids:this.gazeActions[0].eyelidsW,squint:this.gazeActions[0].squintW}}}class M{constructor(e,s,i,n,a){this.limVert=Math.abs(n)||20,this.limHor=Math.abs(a)||30,this.headNode=s,this.lookAtRot=new t.Quaternion(i.x,i.y,i.z,i.w),this.initHeadData(e)}initHeadData(t){t.lexeme=t.lexeme&&t.lexeme.toUpperCase?t.lexeme.toUpperCase():"NOD",this.lexeme=t.lexeme||"NOD",this.amount=t.amount||.2,"NOD"==this.lexeme||"TILT_LEFT"==this.lexeme||"TILT_RIGHT"==this.lexeme||"TILT_FORWARD"==this.lexeme||"TILT_BACKWARD"==this.lexeme||"FORWARD"==this.lexeme||"BACKWARD"==this.lexeme?this.maxDeg=2*this.limVert:this.maxDeg=2*this.limHor,this.start=t.start||0,this.end=t.end||2,this.ready=t.ready||t.strokeStart||this.end/4,this.relax=t.relax||t.strokeEnd||3*this.end/4,this.strokeStart=t.strokeStart||this.ready,this.strokeEnd=t.strokeEnd||this.relax,this.repetition=isNaN(t.repetition)?0:Math.abs(t.repetition),this.repeatedIndx=0,this.strokeEnd=this.strokeStart+(this.strokeEnd-this.strokeStart)/(1+this.repetition),this.stroke=(this.strokeStart+this.strokeEnd)/2,this.transition=!0,this.phase=0,this.time=0,this.currentAngle=0,this.initHeadValues()}initHeadValues(){this.inQ=this.headNode.quaternion.clone();var e=this.lookAtRot.clone().invert().clone();e.multiply(this.inQ);var s=(new t.Euler).setFromQuaternion(e);switch(this.strokeAxis=new t.Vector3(1,0,0),this.strokeDeg=0,this.readyDeg=0,this.lexeme){case"NOD":this.strokeAxis.set(1,0,0),this.strokeDeg=this.amount*this.maxDeg,this.readyDeg=.5*this.strokeDeg,s.z*_+this.strokeDeg>this.limVert&&(this.readyDeg=this.strokeDeg-this.limVert+s.z*_);break;case"SHAKE":this.strokeAxis.set(0,1,0),this.strokeDeg=this.amount*this.maxDeg,this.readyDeg=.5*this.strokeDeg,this.RorL=Math.sign(s.y)?Math.sign(s.y):1,this.readyDeg*=-this.RorL,this.strokeDeg*=-this.RorL;break;case"TILT":this.strokeAxis.set(0,0,1),this.strokeDeg=20*this.amount,this.readyDeg=.5*this.strokeDeg;break;case"ROTATE_LEFT":this.strokeAxis.set(0,-1,0),this.strokeDeg=this.amount*this.maxDeg,this.readyDeg=.8*this.strokeDeg,this.repetition||(this.strokeStart=this.ready,this.strokeEnd=this.relax);break;case"ROTATE_RIGHT":this.strokeAxis.set(0,1,0),this.strokeDeg=this.amount*this.maxDeg,this.readyDeg=.8*this.strokeDeg,this.repetition||(this.strokeStart=this.ready,this.strokeEnd=this.relax);break;case"TILT_LEFT":this.strokeAxis.set(0,0,1),this.strokeDeg=this.amount*this.maxDeg,this.readyDeg=.8*this.strokeDeg,this.repetition||(this.strokeStart=this.ready,this.strokeEnd=this.relax);break;case"TILT_RIGHT":this.strokeAxis.set(0,0,-1),this.strokeDeg=this.amount*this.maxDeg,this.readyDeg=.8*this.strokeDeg,this.repetition||(this.strokeStart=this.ready,this.strokeEnd=this.relax);break;case"TILT_FORWARD":case"FORWARD":this.strokeAxis.set(-1,0,0),this.strokeDeg=this.amount*this.maxDeg,this.readyDeg=.8*this.strokeDeg,this.repetition||(this.strokeStart=this.ready,this.strokeEnd=this.relax);break;case"TILT_BACKWARD":case"BACKWARD":this.strokeAxis.set(1,0,0),this.strokeDeg=this.amount*this.maxDeg,this.readyDeg=.8*this.strokeDeg,this.repetition||(this.strokeStart=this.ready,this.strokeEnd=this.relax)}this.currentStrokeQuat=new t.Quaternion,this.currentStrokeQuat.setFromAxisAngle(this.strokeAxis,0)}update(t){this.time+=t;let e=0;if(!(this.time<this.start)){if(this.time<this.relax&&this.time>=this.strokeEnd&&this.repeatedIndx<this.repetition){this.repeatedIndx++;let t=this.strokeEnd-this.strokeStart;this.strokeStart=this.strokeEnd,this.strokeEnd+=t,this.stroke=(this.strokeEnd+this.strokeStart)/2,this.phase=0}if(this.time<=this.ready)e=(this.time-this.start)/(this.ready-this.start),e=.5*Math.cos(Math.PI*e+Math.PI)+.5,this.currentAngle=-this.readyDeg*e,this.currentStrokeQuat.setFromAxisAngle(this.strokeAxis,this.currentAngle*L);else{if(this.time>this.ready&&this.time<this.strokeStart)return;if(this.time>=this.strokeStart&&this.time<=this.stroke){if(e=(this.time-this.strokeStart)/(this.stroke-this.strokeStart),e=.5*Math.cos(Math.PI*e+Math.PI)+.5,1!=this.phase){if(this.repeatedIndx>=this.repetition&&"TILT"!=this.lexeme&&"NOD"!=this.lexeme&&"SHAKE"!=this.lexeme)return;this.phase=1}this.currentAngle=-this.readyDeg+e*this.strokeDeg,this.currentStrokeQuat.setFromAxisAngle(this.strokeAxis,this.currentAngle*L)}else if(this.time>this.stroke&&this.time<=this.strokeEnd&&this.repeatedIndx<this.repetition)e=(this.time-this.stroke)/(this.strokeEnd-this.stroke),e=.5*Math.cos(Math.PI*e+Math.PI)+.5,2!=this.phase&&(this.phase=2),this.currentAngle=-this.readyDeg+(1-e)*this.strokeDeg,this.currentStrokeQuat.setFromAxisAngle(this.strokeAxis,this.currentAngle*L);else{if(this.time>=this.strokeEnd&&this.time<this.relax)return;if(this.time>this.relax&&this.time<=this.end)e=(this.time-this.relax)/(this.end-this.relax),e=.5*Math.cos(Math.PI*e+Math.PI)+.5,this.currentStrokeQuat.setFromAxisAngle(this.strokeAxis,(1-e)*this.currentAngle*L);else if(this.time>this.end)return this.currentStrokeQuat.set(0,0,0,1),void(this.transition=!1)}}}}}class C{constructor(t,e,s){this.refFBins=[0,500,700,3e3,6e3],this.energy=[0,0,0,0,0,0,0,0],this.BSW=[0,0,0],this.threshold=t||0,this.dynamics=30,this.maxDB=-30,this.smoothness=e||.6,this.pitch=s||1,this.fBins=[],this.defineFBins(this.pitch),this.init(),this.working=!1}start(t){C.AContext||(C.AContext=new text),this.stopSample(),thatLip=this,void 0===t||this.loadSample(t)}loadBlob(t){C.AContext&&C.AContext.resume();const e=new FileReader;e.onloadend=()=>{const t=e.result;var s=this;this.context.decodeAudioData(t,function(t){s.stopSample(),s.sample=C.AContext.createBufferSource(),s.sample.buffer=t,console.log("Audio loaded"),s.playSample()},function(t){console.log("Failed to load audio")})},e.readAsArrayBuffer(function(t){var e,s,i;e=(s=t).length,i=new Uint8Array(e);for(var n=0;n<e;n++)i[n]=s.charCodeAt(n);return new Blob([i],{type:"application/octet-stream"})}(t))}loadSample(t){var e=LS.RM.getFullURL(t);if(LGAudio.cached_audios[e]&&-1==e.indexOf("blob:"))this.stopSample(),this.sample=C.AContext.createBufferSource(),this.sample.buffer=LGAudio.cached_audios[e],this.playSample();else{var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer";var i=this;s.onload=function(){i.context.decodeAudioData(s.response,function(t){LGAudio.cached_audios[e]=t,i.stopSample(),i.sample=C.AContext.createBufferSource(),i.sample.buffer=t,console.log("Audio loaded"),i.playSample()},function(t){console.log("Failed to load audio")})},s.send()}}playSample(){this.sample.connect(this.analyser),this.analyser.connect(this.gainNode),this.gainNode.connect(this.context.destination),this.gainNode.gain.value=1,console.log("Sample rate: ",this.context.sampleRate);var t=this;this.working=!0,this.sample.onended=function(){t.working=!1},this.sample.start(0)}update(){this.working&&(this.analyser||(this.analyser=this.context.createAnalyser(),this.analyser.fftSize=1024,this.analyser.smoothingTimeConstant=this.smoothness),this.analyser.getFloatFrequencyData(this.data),this.binAnalysis(),this.lipAnalysis())}stop(t){void 0===t?(this.stopSample(),this.working=!1):(thatLip=this,setTimeout(thatLip.stop.bind(thatLip),1e3*t))}defineFBins(t){for(var e=0;e<this.refFBins.length;e++)this.fBins[e]=this.refFBins[e]*t}init(){if(!C.AContext){if(!window.AudioContext)return;C.AContext=new AudioContext}const t=this.context=C.AContext;this.sample=t.createBufferSource(),this.gainNode=t.createGain(),this.analyser=t.createAnalyser(),this.analyser.fftSize=1024,this.analyser.smoothingTimeConstant=this.smoothness,this.data=new Float32Array(this.analyser.frequencyBinCount)}binAnalysis(){for(var t=this.analyser.frequencyBinCount,e=this.context.sampleRate,s=this.fBins,i=this.energy,n=0;n<s.length-1;n++){var a=Math.round(s[n]*t/(e/2)),r=Math.round(s[n+1]*t/(e/2));i[n]=0;for(var o=a;o<r;o++){var l=.5+(this.data[o]+20)/140;l<0&&(l=0),i[n]+=l}i[n]/=r-a}}lipAnalysis(){var t=this.energy;if(void 0!==t){var e=0;e=2*(.5-t[2]),t[1]<.2&&(e*=5*t[1]),e=Math.max(0,Math.min(e,1)),this.BSW[0]=e,e=3*t[3],e=Math.max(0,Math.min(e,1)),this.BSW[1]=e,e=.8*t[1]-.8*t[3],e=Math.max(0,Math.min(e,1)),this.BSW[2]=e}}stopSample(){if(this.sample&&this.sample.buffer&&this.sample.stop(0),this.stream){for(var t=this.stream.getTracks(),e=0;e<t.length;e++)(t[e].kind="audio")&&t[e].stop();this.stream=null}}}class v{constructor(){let t=new B;this.start=t.start.bind(t),this.stop=t.stop.bind(t),this.pause=t.pause.bind(t),this.resume=t.resume.bind(t),this.update=t.update.bind(t),this.setEvent=t.setEvent.bind(t),this.setTables=t.setTables.bind(t),this.setDefaultSpeed=t.setDefaultSpeed.bind(t),this.setDefaultIntensity=t.setDefaultIntensity.bind(t),this.setSourceBSWValues=t.setSourceBSWValues.bind(t),this.getDefaultSpeed=t.getDefaultSpeed.bind(t),this.getDefaultIntensity=t.getDefaultIntensity.bind(t),this.getCurrentIntensity=t.getCurrentIntensity.bind(t),this.getSentenceDuration=t.getSentenceDuration.bind(t),this.cleanQueueSentences=t.cleanQueueSentences.bind(t),this.pushSentence=t.pushSentence.bind(t),this.getBSW=function(){return t.BSW},this.getCompactState=t.getCompactState.bind(t),this.isWorking=t.isWorking.bind(t),this.isPaused=t.isPaused.bind(t),this.needsSentences=t.needsSentences.bind(t),this.getNumSentences=t.getNumSentences.bind(t),this.getMaxNumSentences=t.getMaxNumSentences.bind(t)}}class B{static QUEUE_MAX_SIZE=32;constructor(){this.DEFAULT_SPEED=8,this.DEFAULT_INTENSITY=.5,this.lowerBoundVisemes=null,this.upperBoundVisemes=null,this.coarts=null,this.ph2v=null,this.numShapes=0,this.working=!1,this.paused=!1,this.speed=this.DEFAULT_SPEED,this.intensity=this.DEFAULT_INTENSITY,this.text="",this.currTargetIdx=0,this.currT=0,this.useCoarticulation=!0,this.delay=0,this.currSent=null,this.queueIdx=0,this.queueSize=0,this.sentenceQueue=new Array(B.QUEUE_MAX_SIZE),this.sentenceIDCount=1,this.BSW=new Float32Array(this.numShapes),this.BSW.fill(0),this.currV=new Float32Array(this.numShapes),this.currV.fill(0),this.targV=new Float32Array(this.numShapes),this.targV.fill(0),this.onIdle=null,this.onSentenceEnd=null,this.onSentenceStart=null,this.setTables(N.PhonemeToViseme,N.Coarticulations,N.LowerBound,N.UpperBound)}setDefaultSpeed(t){return"number"==typeof t&&t>.001&&(this.DEFAULT_SPEED=t,!0)}setDefaultIntensity(t){return"number"==typeof t&&(this.DEFAULT_INTENSITY=Math.max(0,Math.min(1,t)),!0)}setSourceBSWValues(t){if("number"!=typeof t)for(let e=0;e<this.BSW.length&&e<t.length;++e){let s="number"==typeof t[e]?t[e]:0;this.currV[e]=s}else for(let e=0;e<this.currV.length;++e)this.currV[e]=t}setEvent(t,e){if("function"!=typeof e)return!1;switch(t){case"onIdle":this.onIdle=e;break;case"onSentenceEnd":this.onSentenceEnd=e;break;case"onSentenceStart":this.onSentenceStart=e;break;default:return!1}return!0}setTables(t,e,s,i=null){this.lowerBoundVisemes=s,this.upperBoundVisemes=i&&i.length>0?i:s,this.coarts=e,this.ph2v=t,this.numShapes=0,s&&s.length>0&&(this.numShapes=s[0].length),this.BSW=new Float32Array(this.numShapes),this.BSW.fill(0),this.currV=new Float32Array(this.numShapes),this.currV.fill(0),this.targV=new Float32Array(this.numShapes),this.targV.fill(0)}getDefaultSpeed(){return this.DEFAULT_SPEED}getDefaultIntensity(){return this.DEFAULT_INTENSITY}getCurrentIntensity(){return this.getIntensityAtIndex(this.currTargetIdx)}getIntensityAtIndex(t){if(this.currSent&&t>=0&&t<this.currSent.text.length){let e=this.currSent.phInt;if(e&&t<e.length)return e[t];if(null!==this.currSent.sentInt)return this.currSent.sentInt}return this.DEFAULT_INTENSITY}getViseme(t,e=null){if(!(t in this.ph2v))return this.lowerBoundVisemes[0];let s=this.ph2v[t];if(s<0||s>=this.lowerBoundVisemes.length)return this.lowerBoundVisemes[0];let i=this.lowerBoundVisemes[s],n=this.upperBoundVisemes[s],a=e||new Float32Array(this.numShapes),r=this.intensity;for(let t=0;t<this.numShapes;t++)a[t]=i[t]*(1-r)+n[t]*r;return a}getCoarts(t){if(!(t in this.ph2v))return this.coarts[0];let e=this.ph2v[t];return e<0||e>=this.coarts.length?this.coarts[0]:this.coarts[e]}getCoarticulatedViseme(t,e,s=null){let i=this.getViseme(t),n=this.getCoarts(t),a=this.getViseme(e),r=s||new Float32Array(this.numShapes);for(let t=0;t<this.numShapes;++t)r[t]=(1-n[t])*i[t]+n[t]*a[t];return r}start(){this.stop(!1),this.working=!0,this.paused=!1,this.changeCurrentSentence(!1)}pause(){this.paused=this.working}resume(){this.paused=!1}stop(t=!1){this.working=!1,this.paused=!1,this.currTargetIdx=0,this.currT=0,this.BSW.fill(0),this.currV.fill(0),this.targV.fill(0),t&&this.cleanQueueSentences()}getCompactState(){let t=!this.working;return t|=this.paused<<1,t|=!this.queueSize<<2,t}isWorking(){return this.working}isPaused(){return this.paused}needsSentences(){return!this.queueSize}getNumSentences(){return this.queueSize}getMaxNumSentences(){return B.QUEUE_MAX_SIZE}update(t){if(!this.working||this.paused||!this.currSent)return;if(this.delay>.001){if(this.delay-=t,this.delay>=0)return;if(t=-this.delay,this.delay=0,t<.001)return}let e=this.currSent.phT,s=1/this.speed;this.currT+=t;let i=0,n=0,a=!0;if(e&&this.currTargetIdx<e.length){a=!1;let t=this.currTargetIdx;for(;t<e.length&&e[t]<this.currT;)this.currT-=Math.max(.001,e[t]),t++,i++;a=t>=e.length,this.currT=Math.max(0,this.currT),n=t<e.length?this.currT/e[t]:Math.max(0,Math.min(1,this.currT*this.speed)),this.currTargetIdx=t}if(a){let t=Math.floor(this.currT*this.speed);n=this.currT*this.speed-t,this.currT-=t*s,this.currTargetIdx+=t,i+=t}if(i>0){for(let t=0;t<this.numShapes;++t)this.currV[t]=this.BSW[t];if(this.currTargetIdx>=this.text.length){this.getViseme(this.text[this.text.length-1],this.currV);for(let t=0;t<this.numShapes;++t)this.BSW[t]=this.currV[t];return void this.changeCurrentSentence()}if(this.intensity=this.getIntensityAtIndex(this.currTargetIdx),this.useCoarticulation){let t=this.text[this.currTargetIdx],e=this.currTargetIdx==this.text.length-1?null:this.text[this.currTargetIdx+1];this.getCoarticulatedViseme(t,e,this.targV)}else this.getViseme(this.text[this.currTargetIdx],this.targV)}let r=this.currV,o=this.targV;for(let t=0;t<this.numShapes;++t)this.BSW[t]=(1-n)*r[t]+n*o[t]}cleanQueueSentences(t=!1){this.queueIdx=0,this.currSent=null,this.queueSize=0,this.sentenceQueue.fill(null),t&&(this.BSW.fill(0),this.currV.fill(0),this.targV.fill(0))}changeCurrentSentence(t=!0){if(t&&(--this.queueSize,this.sentenceQueue[this.queueIdx]=null,this.queueIdx=(this.queueIdx+1)%B.QUEUE_MAX_SIZE,this.currSent&&this.onSentenceEnd&&this.onSentenceEnd(this.currSent),this.currSent.onEndEvent&&this.currSent.onEndEvent()),this.queueSize<=0)return this.currT=0,this.cleanQueueSentences(),void(this.onIdle&&this.onIdle());if(this.currSent=this.sentenceQueue[this.queueIdx],this.text=this.currSent.text,this.speed=this.currSent.speed,this.delay=this.currSent.delay,this.useCoarticulation=this.currSent.useCoart,this.currTargetIdx=0,t||(this.currT=0),this.intensity=this.getIntensityAtIndex(this.currTargetIdx),this.useCoarticulation){let t=this.text[0],e=this.text.length>1?this.text[1]:null;this.getCoarticulatedViseme(t,e,this.targV)}else this.getViseme(this.text[0],this.targV);this.onSentenceStart&&this.onSentenceStart(this.currSent),this.currSent.onStartEvent&&this.currSent.onStartEvent()}pushSentence(t,e={}){let s=e.phT,i=e.sentT,n=e.speed,a=e.phInt,r=e.sentInt,o=e.delay,l=e.outro,h=e.useCoart,c=e.copyArrays,d=e.onEndEvent,p=e.onStartEvent;if(this.queueSize===B.QUEUE_MAX_SIZE)return null;if(!t||!t.length)return null;if(s=s?new Float32Array(s):null,a=a?new Float32Array(a):null,c){if(t=Array.from(t),s){let t=new Float32Array(s.length);t.set(s),s=t}if(a){let t=new Float32Array(a.length);t.set(a),a=t}}if(l&&("string"==typeof t?t+=".":t.push(".")),t.length<0)return null;let m=this.DEFAULT_SPEED;"number"==typeof n&&!isNaN(n)&&n>=.001&&(m=n),"number"==typeof i&&!isNaN(i)&&i>=.001&&(m=t.length/i),("number"!=typeof o||isNaN(o)||o<0)&&(o=0),void 0===h&&(h=!0),h=!!h,d instanceof Function||(d=null),p instanceof Function||(p=null),r="number"!=typeof r||isNaN(r)?null:Math.max(0,Math.min(1,r));let u=this.sentenceIDCount++,f=this.getSentenceDuration(t,e),g={id:u,totalTime:f,text:t,phT:s,speed:m,phInt:a,sentInt:r,useCoart:h,delay:o,onStartEvent:p,onEndEvent:d},A=(this.queueIdx+this.queueSize)%B.QUEUE_MAX_SIZE;return this.sentenceQueue[A]=g,this.queueSize++,this.working&&1==this.queueSize&&this.changeCurrentSentence(!1),{id:u,totalTime:f}}getSentenceDuration(t,e){let s=e.phT,i=e.sentT,n=e.speed,a=e.delay,r=e.outro;if(!t||!t.length)return 0;s instanceof Float32Array||(s=null);let o=t.length;r&&o++;let l=this.DEFAULT_SPEED;"number"==typeof n&&!isNaN(n)&&n>=.001&&(l=n),"number"==typeof i&&!isNaN(i)&&i>=.001&&(l=o/i),("number"!=typeof a||isNaN(a)||a<0)&&(a=0);let h=0;if(h+=a,s){let t=s.length>=o?o:s.length;for(let e=0;e<t;++e)h+=Math.max(s[e],.001);o-=t}return h+=o*(1/l),h}}let N={BlendshapeMapping:{kiss:0,upperLipClosed:1,lowerLipClosed:2,jawOpen:3,tongueFrontUp:4,tongueBackUp:5,tongueOut:6},LowerBound:[[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[.1,.15,0,.2,0,0,0],[0,.13,0,.2,.2,0,0],[0,.08,0,.1,.5,.5,0],[.25,.15,.15,.2,0,0,0],[.35,.15,.15,.2,0,0,0],[0,.15,0,.1,1,0,0],[0,.5,.2,0,0,0,0],[0,0,.2,.1,0,0,0],[.15,0,0,.13,.8,0,0],[0,0,0,.2,0,.3,0],[0,0,0,.1,0,1,0],[.3,0,0,.1,1,0,0],[0,0,0,.1,.35,0,.3],[.3,0,0,.13,.8,0,0]],UpperBound:[[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[.1,.15,0,.6,0,0,0],[0,.13,0,.3,.2,0,0],[0,.08,0,.2,.6,.6,.2],[.45,.15,.15,.6,0,0,0],[.85,.3,.3,.3,0,0,0],[0,.15,0,.4,1,0,.5],[0,1,1,0,0,0,0],[0,0,1,.4,0,0,0],[.15,0,0,.13,.8,0,0],[0,0,0,.4,0,.3,0],[.1,0,0,.2,0,1,0],[.3,0,0,.22,1,0,0],[0,0,0,.4,.55,0,.8],[.3,0,0,.13,.8,0,0]],Coarticulations:[[0,0,0,0,0,0,0],[.6,.6,.6,.6,.6,.6,.6],[.2,.3,.3,.3,.1,.3,.5],[0,.3,.3,.3,.1,.3,.5],[.1,.3,.3,.3,0,0,.5],[.2,.3,.3,.3,.3,.3,.5],[.2,.3,.3,.3,.3,.3,.5],[1,.4,.4,.9,0,.5,.5],[1,0,0,0,1,.8,.5],[1,0,0,.2,1,.5,.5],[1,.6,.6,.6,0,.5,.5],[1,1,1,.7,.5,.5,.5],[.7,.5,.5,.9,.6,0,.5],[1,1,1,.5,0,0,.5],[1,.3,.3,.3,0,.6,0],[.5,.3,.3,.5,0,0,0]],PhonemeToViseme:{".":0,_:1," ":1,a:2,"@":2,A:2,c:5,W:2,x:2,Y:2,E:3,R:3,e:3,I:4,X:4,i:4,o:5,O:5,U:6,u:6,b:8,C:15,d:13,D:13,F:13,L:7,M:8,N:7,f:9,g:12,h:11,J:15,k:12,l:7,m:8,n:7,G:12,p:8,Q:2,r:7,s:10,S:15,t:13,T:14,v:9,w:6,H:6,y:4,z:10,Z:10}};class O{constructor(e=null){this._gazePositions={RIGHT:new t.Vector3(-30,2,100),LEFT:new t.Vector3(30,2,100),UP:new t.Vector3(0,20,100),DOWN:new t.Vector3(0,-20,100),UP_RIGHT:new t.Vector3(-30,20,100),UP_LEFT:new t.Vector3(30,20,100),DOWN_RIGHT:new t.Vector3(-30,-20,100),DOWN_LEFT:new t.Vector3(30,-20,100),FRONT:new t.Vector3(0,2,100),CAMERA:new t.Vector3(0,2,100)},this._morphTargets={},this._avatarParts={},this._boneMap={},this._mappingAU2BS={},this._actionUnits={dictionary:{Inner_Brow_Raiser:0,Outer_Brow_Raiser_Left:1,Outer_Brow_Raiser_Right:2,Brow_Lowerer_Left:3,Brow_Lowerer_Right:4,Nose_Wrinkler_Left:5,Nose_Wrinkler_Right:6,Nostril_Dilator:7,Nostril_Compressor:8,Dimpler_Left:9,Dimpler_Right:10,Upper_Lip_Raiser_Left:11,Upper_Lip_Raiser_Right:12,Lip_Corner_Puller_Left:13,Lip_Corner_Puller_Right:14,Lip_Corner_Depressor_Left:15,Lip_Corner_Depressor_Right:16,Lower_Lip_Depressor_Left:17,Lower_Lip_Depressor_Right:18,Lip_Puckerer_Left:19,Lip_Puckerer_Right:20,Lip_Stretcher_Left:21,Lip_Stretcher_Right:22,Lip_Funneler:23,Lip_Pressor_Left:24,Lip_Pressor_Right:25,Lips_Part:26,Lip_Suck_Upper:27,Lip_Suck_Lower:28,Lip_Wipe:29,Tongue_Up:30,Tongue_Show:31,Tongue_Bulge_Left:32,Tongue_Bulge_Right:33,Tongue_Wide:34,Mouth_Stretch:35,Jaw_Drop:36,Jaw_Thrust:37,Jaw_Sideways_Left:38,Jaw_Sideways_Right:39,Chin_Raiser:40,Cheek_Raiser_Left:41,Cheek_Raiser_Right:42,Cheek_Blow_Left:43,Cheek_Blow_Right:44,Cheek_Suck_Left:45,Cheek_Suck_Right:46,Upper_Lid_Raiser_Left:47,Upper_Lid_Raiser_Right:48,Squint_Left:49,Squint_Right:50,Blink_Left:51,Blink_Right:52,Wink_Left:53,Wink_Right:54,Neck_Tightener:55},influences:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},this._eyeLidsAU=[51,52],this._squintAU=[49,50],this._t2lMap={kiss:["Lip_Puckerer_Left","Lip_Puckerer_Right"],upperLipClosed:["Lip_Suck_Upper"],lowerLipClosed:["Lip_Suck_Lower"],jawOpen:["Mouth_Stretch"],tongueFrontUp:["Tongue_Up"],tongueOut:["Tongue_Show"]},this.lipsPressedBSName="Jaw_Up",this.lowerLipINBSName="Lip_Suck_Lower",this.lowerLipDownBSName="Lower_Lip_Depressor_Left",this.mouthNarrowBSName="MouthNarrow",this.mouthOpenBSName="MouthOpen",this.lipsyncModule=new C,e&&this.configure(e)}configure(t){t.character&&(this.character=t.character,this.skeleton=t.skeleton),t.gazePositions&&(this._gazePositions=t.gazePositions),t.morphTargets&&(this._morphTargets=t.morphTargets),t.characterConfig&&(this._mappingAU2BS=t.characterConfig.faceController.blendshapeMap,this._boneMap=t.characterConfig.boneMap,this._avatarParts=t.characterConfig.faceController.parts)}start(e){this._morphTargets={};for(const t in this._avatarParts){let e=this.character.getObjectByName(t);e&&e.morphTargetDictionary&&e.morphTargetInfluences?(this._morphTargets[t]=e,Array.isArray(this._avatarParts[t])||(this._avatarParts[t]=Object.keys(this._actionUnits.dictionary))):(console.log('FacialController: "'+t+'" object could not be found in the avatar'),delete this._avatarParts[t])}if(this._facialAUAcc=this._actionUnits.influences.slice(),this._facialAUFinal=this._actionUnits.influences.slice(),!this._morphTargets)return void console.error("Morph deformer not found");if(this.resetFace(),this._FacialLexemes=[],this.FA=new w(this._facialAUFinal),this._boneMap.Head){if(!this._gazePositions.HEAD){let e=this.skeleton.bones[this._boneMap.Head];this._gazePositions.HEAD=e.getWorldPosition(new t.Vector3)}}else console.error("Head bone node not found with id: ");let s=this.character.eyesTarget,i=this.character.neckTarget,n=this.character.headTarget;this._gazePositions.EYESTARGET||(this._gazePositions.EYESTARGET=s.getWorldPosition(new t.Vector3)),this._gazePositions.HEADTARGET||(this._gazePositions.HEADTARGET=n.getWorldPosition(new t.Vector3)),this._gazePositions.NECKTARGET||(this._gazePositions.NECKTARGET=i.getWorldPosition(new t.Vector3)),this.gazeManager=new P(i,n,s,this._gazePositions),this.headBML=[],this.autoBlink=new E(!1),this.autoBlink.setAuto(!e||!e.hasOwnProperty("autoBlink")||e.autoBlink)}reset(t=!1){this.resetFace(),this.textToLip&&this.textToLip.cleanQueueSentences(!0),this.lipsyncModule&&this.lipsyncModule.stop(),this._FacialLexemes.length=0,t||this.FA.reset(),this.gazeManager.reset(),this.headBML.length=0,this.blink&&this.blink.reset()}resetFace(){for(let t=0;t<this._facialAUFinal.length;t++)this._facialAUAcc[t]=0,this._facialAUFinal[t]=0,this._actionUnits.influences[t]=0}update(t){this.innerUpdate(t);let e={};for(let t in this._mappingAU2BS){let s=this._mappingAU2BS[t],i=this._actionUnits.dictionary[t],n=this._actionUnits.influences[i];for(let t=0;t<s.length;t++){let i=s[t][0],a=s[t][1];e[i]||(e[i]=[]),e[i].push(n*a)}}for(let t in this._avatarParts){let s=this._avatarParts[t]?this._avatarParts[t]:Object.keys(this._actionUnits.dictionary);for(let i=0;i<s.length;i++){let n=this._mappingAU2BS[s[i]]?this._mappingAU2BS[s[i]]:[];for(let s=0;s<n.length;s++){let i=n[s][0],a=e[i]?e[i]:[],r=0,o=0,l=0;for(let t=0;t<a.length;t++)o+=Math.abs(a[t]),l+=a[t]*Math.abs(a[t]);o>1e-4&&(r=l/o);let h=this._morphTargets[t].morphTargetDictionary[i];void 0!==h&&(this._morphTargets[t].morphTargetInfluences[h]=r)}}}}innerUpdate(e){this.faceUpdate(e);let s=this.character.eyesTarget.getWorldPosition(new t.Vector3),i=this.character.headTarget.getWorldPosition(new t.Vector3),n=this.character.neckTarget.getWorldPosition(new t.Vector3);this.skeleton.bones[this._boneMap.Neck].lookAt(n),this.skeleton.bones[this._boneMap.Head].lookAt(i);let a=this.skeleton.bones[this._boneMap.Head].quaternion,r=this.skeleton.bones[this._boneMap.Neck].quaternion;for(let t=0;t<this.headBML.length;++t){let s=this.headBML[t];s.transition?(s.update(e),"FORWARD"==s.lexeme||"BACKWARD"==s.lexeme?(r.multiply(s.currentStrokeQuat),a.multiply(s.currentStrokeQuat.invert()),s.currentStrokeQuat.invert()):a.multiply(s.currentStrokeQuat)):(this.headBML.splice(t,1),--t)}this.skeleton.bones[this._boneMap.LEye].lookAt(s),this.skeleton.bones[this._boneMap.REye].lookAt(s)}faceUpdate(t){if(this._facialAUAcc.fill(0),this._facialAUFinal.fill(0),this.textToLip&&0==this.textToLip.getCompactState()){this.textToLip.update(t);let e=this.textToLip.getBSW();for(let t=0;t<this.textToLipBSMapping.length;t++){let s=this.textToLipBSMapping[t],i=Math.min(1,Math.max(-1,e[s[1]])),n=s[0];this._facialAUAcc[n]+=Math.abs(i),this._facialAUFinal[n]+=i*Math.abs(i)}}if(this.lipsyncModule&&this.lipsyncModule.working){this.lipsyncModule.update(t);let e=this.lipsyncModule.BSW;if(e){let t=.66,s=this._facialAUAcc,i=this._facialAUFinal,n=this._actionUnits.influences,a=this._actionUnits.dictionary,r=Object.keys(a);for(let o=0;o<r.length;o++){let l=r[o],h=a[l],c=0;l.includes(this.mouthOpenBSName)&&(c=(1-t)*n[h]+t*e[2]),l.includes(this.lowerLipINBSName)&&(c=(1-t)*n[h]+t*e[1]),l.includes(this.lowerLipDownBSName)&&(c=(1-t)*n[h]+t*e[1]),l.includes(this.mouthNarrowBSName)&&(c=(1-t)*n[h]+t*e[0]*.5),l.includes(this.lipsPressedBSName)&&(c=(1-t)*n[h]+t*e[1]),s[h]+=Math.abs(c),i[h]+=c*Math.abs(c)}}}this.FA.updateVABSW(t);for(let t=0;t<this.FA.currentVABSW.length;t++){let e=this.FA.currentVABSW[t];this._facialAUAcc[t]+=Math.abs(e),this._facialAUFinal[t]+=e*Math.abs(e)}for(let e=0;e<this._FacialLexemes.length;e++){let s=this._FacialLexemes[e];if(s.transition){s.updateLexemesBSW(t);for(let t=0;t<s.indicesLex.length;t++)for(let e=0;e<s.indicesLex[t].length;e++){let i=s.currentLexBSW[t][e],n=s.indicesLex[t][e];this._facialAUAcc[n]+=Math.abs(i),this._facialAUFinal[n]+=i*Math.abs(i)}}s.transition||(this._FacialLexemes.splice(e,1),--e)}if(this.gazeManager){let e=this.gazeManager.update(t);for(let t=0;t<this._eyeLidsAU.length;t++)this._facialAUAcc[this._eyeLidsAU[t]]+=Math.abs(e.eyelids),this._facialAUFinal[this._eyeLidsAU[t]]+=e.eyelids*Math.abs(e.eyelids);for(let t=0;t<this._squintAU.length;t++)this._facialAUAcc[this._squintAU[t]]+=Math.abs(e.squint),this._facialAUFinal[this._squintAU[t]]+=e.squint*Math.abs(e.squint)}let e=this._facialAUFinal,s=this._facialAUFinal,i=this._facialAUAcc;for(let t=0;t<e.length;++t)i[t]<1e-4?e[t]=0:e[t]=s[t]/i[t];this.autoBlink.state&&(this.autoBlink.update(t,this._facialAUFinal[this._eyeLidsAU[0]],this._facialAUFinal[this._eyeLidsAU[1]]),this._facialAUFinal[this._eyeLidsAU[0]]=this.autoBlink.weights[0],this._facialAUFinal[this._eyeLidsAU[1]]=this.autoBlink.weights[1]);let n=this._actionUnits.influences,a=this._facialAUFinal;for(let t=0;t<n.length;++t)n[t]=a[t]}newTextToLip(t){if(!this.textToLip){this.textToLip=new v,this.textToLip.start(),this.textToLipBSMapping=[];let t=N.BlendshapeMapping;for(const e in this._t2lMap)for(let s=0;s<this._t2lMap[e].length;s++){let i=this._actionUnits.dictionary[this._t2lMap[e][s]];i&&this.textToLipBSMapping.push([i,t[e]])}}let e=t.text;"."!=e[e.length-1]&&(e+="."),this.textToLip.cleanQueueSentences(),this.textToLip.pushSentence(t.text,t)}newLipsync(t){this.lipsyncModule&&(t.audio?this.lipsyncModule.loadBlob(t.audio):t.url&&this.lipsyncModule.loadSample(t.url))}newFA(t,e){for(let t=0;t<this._facialAUFinal.length;t++)this._facialAUFinal[t]=this._actionUnits.influences[t];t.emotion||t.valaro?this.FA.initFaceValAro(t,e,this._facialAUFinal):t.lexeme&&this._FacialLexemes.push(new R(t,e,this._facialAUFinal))}newBlink(t){this.autoBlink.blink()}newGaze(t,e,s=null){let i=this._facialAUFinal[0],n=this._facialAUFinal[this._eyeLidsAU[0]],a=this._facialAUFinal[this._squintAU[0]];t.eyelidsWeight=n,t.squintWeight=a,t.blinkWeight=i,this.gazeManager.newGaze(t,e,s,!!t.headOnly)}headDirectionShift(t,e){t.end=t.end||2,t.influence="HEAD",this.newGaze(t,!0,null,!0)}newHeadBML(t){let e="FORWARD"==t.lexeme||"BACKWARD"==t.lexeme?this._boneMap.Neck:this._boneMap.Head,s=this.skeleton.bones[e];s&&this.headBML.push(new M(t,s,s.quaternion.clone()))}}class F{constructor(e,s,i=!1){this._tempM4_0=new t.Matrix4,this._tempM3_0=new t.Matrix3,this._tempQ_0=new t.Quaternion,this._tempQ_1=new t.Quaternion,this._tempQ_2=new t.Quaternion,this._tempV3_0=new t.Vector3,this._tempV3_1=new t.Vector3,this._tempV3_2=new t.Vector3,this.skeleton=e,this.config=s,this.isLeftHand=!!i;let n=i?"L":"R";this.shoulderBone=this.skeleton.bones[this.config.boneMap[n+"Shoulder"]],this.armBone=this.skeleton.bones[this.config.boneMap[n+"Arm"]],this.elbowBone=this.skeleton.bones[this.config.boneMap[n+"Elbow"]],this.wristBone=this.skeleton.bones[this.config.boneMap[n+"Wrist"]],this.bindQuats={shoulder:new t.Quaternion,arm:new t.Quaternion,elbow:new t.Quaternion,wrist:new t.Quaternion},this.beforeBindAxes={shoulderRaise:new t.Vector3,shoulderHunch:new t.Vector3,armTwist:new t.Vector3,armFront:new t.Vector3,armBearing:new t.Vector3,elbow:new t.Vector3};let a=this.config.boneMap[n+"Shoulder"];b(this.skeleton,a,this.bindQuats.shoulder);let r=this._tempM3_0.setFromMatrix4(this.skeleton.boneInverses[a]);this._tempV3_0.copy(this.config.axes[2]).applyMatrix3(r).normalize(),this.beforeBindAxes.shoulderHunch.crossVectors(this.skeleton.bones[a+1].position,this._tempV3_0).normalize(),this.beforeBindAxes.shoulderRaise.crossVectors(this.skeleton.bones[a+1].position,this.beforeBindAxes.shoulderHunch).multiplyScalar(i?-1:1).normalize(),a=this.config.boneMap[n+"Arm"],b(this.skeleton,a,this.bindQuats.arm),r.setFromMatrix4(this.skeleton.boneInverses[a]),this._tempV3_0.copy(this.config.axes[2]).applyMatrix3(r).normalize(),this.beforeBindAxes.armTwist.copy(this.skeleton.bones[a+1].position).normalize(),this.beforeBindAxes.armBearing.crossVectors(this.beforeBindAxes.armTwist,this._tempV3_0).normalize(),this.beforeBindAxes.armFront.crossVectors(this.beforeBindAxes.armBearing,this.beforeBindAxes.armTwist).normalize(),a=this.config.boneMap[n+"Elbow"],b(this.skeleton,a,this.bindQuats.elbow),r.setFromMatrix4(this.skeleton.boneInverses[a]),this._tempV3_0.addVectors(this.config.axes[2],this.config.axes[1]).applyMatrix3(r).normalize(),this.beforeBindAxes.elbow.crossVectors(this.skeleton.bones[a+1].position,this._tempV3_0).normalize(),b(this.skeleton,this.config.boneMap[n+"Wrist"],this.bindQuats.wrist),this.shoulderBone.quaternion.copy(this.bindQuats.shoulder),this.armBone.quaternion.copy(this.bindQuats.arm),this.elbowBone.quaternion.copy(this.bindQuats.elbow),this.armBone.getWorldPosition(this._tempV3_0),this.elbowBone.getWorldPosition(this._tempV3_1),this.wristBone.getWorldPosition(this._tempV3_2);let o=new t.Vector3;this.armWorldSize=o.subVectors(this._tempV3_2,this._tempV3_0).length(),this.upperarmWSize=o.subVectors(this._tempV3_1,this._tempV3_0).length(),this.forearmWSize=o.subVectors(this._tempV3_2,this._tempV3_1).length()}reachTarget(e,s=0,i=0,n=0,a=!0){let r=this.wristBone,o=this.elbowBone,l=this.armBone,h=this.shoulderBone;h.quaternion.copy(this.bindQuats.shoulder),l.quaternion.copy(this.bindQuats.arm),o.quaternion.copy(this.bindQuats.elbow),r.updateWorldMatrix(!0,!1);let c=(new t.Vector3).setFromMatrixPosition(l.matrixWorld),d=new t.Vector3;this._tempM4_0.multiplyMatrices(this.skeleton.bones[this.config.boneMap.ShouldersUnion].matrixWorld,this.skeleton.boneInverses[this.config.boneMap.ShouldersUnion]);let p=this._tempM3_0.setFromMatrix4(this._tempM4_0);this._tempV3_0.subVectors(e,c),this._tempV3_1.copy(this.config.axes[0]).applyMatrix3(p).normalize(),d.x=this._tempV3_1.dot(this._tempV3_0)/this.armWorldSize,this._tempV3_1.copy(this.config.axes[1]).applyMatrix3(p).normalize(),d.y=this._tempV3_1.dot(this._tempV3_0)/this.armWorldSize,this._tempV3_1.copy(this.config.axes[2]).applyMatrix3(p).normalize(),d.z=this._tempV3_1.dot(this._tempV3_0)/this.armWorldSize,d.lengthSq()>1&&d.normalize();let m=d.x*(this.isLeftHand?-1:1),u=d.y;u=Math.max(-1,Math.min(1,u*u*Math.sign(u))),m=Math.max(-1,Math.min(1,m*m*Math.sign(m)));let f=i+this.config.shoulderRaise[0];f+=u<0?-1*this.config.shoulderRaise[1]*u:this.config.shoulderRaise[2]*u,this._tempQ_0.setFromAxisAngle(this.beforeBindAxes.shoulderRaise,f);let g=n+this.config.shoulderHunch[0];g+=m<0?-1*this.config.shoulderHunch[1]*m:this.config.shoulderHunch[2]*m,this._tempQ_1.setFromAxisAngle(this.beforeBindAxes.shoulderHunch,g);let A=this._tempQ_1.multiply(this._tempQ_0);h.quaternion.multiply(A),l.quaternion.premultiply(A.invert()),r.updateWorldMatrix(!0,!1),c.setFromMatrixPosition(l.matrixWorld),this._tempV3_0.subVectors(e,c),this._tempV3_1.copy(this.config.axes[0]).applyMatrix3(p).normalize(),d.x=this._tempV3_1.dot(this._tempV3_0)/this.armWorldSize,this._tempV3_1.copy(this.config.axes[1]).applyMatrix3(p).normalize(),d.y=this._tempV3_1.dot(this._tempV3_0)/this.armWorldSize,this._tempV3_1.copy(this.config.axes[2]).applyMatrix3(p).normalize(),d.z=this._tempV3_1.dot(this._tempV3_0)/this.armWorldSize,d.lengthSq()>1&&d.normalize();let y=this._tempV3_2,x=this._tempQ_1,b=this._tempQ_2;this._tempV3_0.subVectors(e,c);let S=this.forearmWSize,L=this.upperarmWSize,_=this._tempV3_0.lengthSq(),k=Math.acos(Math.max(-1,Math.min(1,(_-S*S-L*L)/(-2*S*L))));k=Math.min(Math.PI,Math.max(.349,k)),_=this.armWorldSize*this.armWorldSize;let T=Math.acos(Math.max(-1,Math.min(1,(_-S*S-L*L)/(-2*S*L))));this._tempQ_0.setFromAxisAngle(this.beforeBindAxes.elbow,T-k),o.quaternion.multiply(this._tempQ_0),o.updateMatrix(),y.copy(r.position).applyMatrix4(o.matrix).normalize();let E={x:this.beforeBindAxes.armTwist.dot(y),y:this.beforeBindAxes.armBearing.dot(y),z:this.beforeBindAxes.armFront.dot(y)},R=Math.asin(E.y),w=Math.atan2(-E.x,E.z);b.set(0,0,0,1),this._tempQ_0.setFromAxisAngle(this.beforeBindAxes.armBearing,-w),b.premultiply(this._tempQ_0),this._tempQ_0.setFromAxisAngle(this.beforeBindAxes.armTwist,-R),b.premultiply(this._tempQ_0),l.updateWorldMatrix(!1,!1);let I=this._tempM4_0.copy(this.armBone.matrixWorld).invert(),P=this._tempV3_0.copy(e).applyMatrix4(I).normalize(),M=this._tempV3_1.crossVectors(this.beforeBindAxes.armFront,P).normalize();this._tempQ_0.setFromAxisAngle(M,this.beforeBindAxes.armFront.angleTo(P)),b.premultiply(this._tempQ_0);let C=-1.5*(1-k/Math.PI);C+=.1*Math.PI*Math.max(0,Math.min(1,2*d.x*(this.isLeftHand?-1:1))),C+=.1*Math.PI*Math.max(0,Math.min(1,2*d.y)),C+=.2*Math.PI*Math.max(0,Math.min(1,5*-d.z)),C+=s+this.config.elbowRaise,C*=this.isLeftHand?1:-1,x.setFromAxisAngle(y,C),l.quaternion.multiply(b),l.quaternion.multiply(x),a&&this._correctArmTwist()}_correctArmTwist(){let t=this._tempQ_0,e=this._tempQ_1.copy(this.bindQuats.arm).invert().multiply(this.armBone.quaternion),s=this._tempV3_0.copy(this.elbowBone.position).normalize();g(e,s,t),this.elbowBone.quaternion.premultiply(t),this.armBone.quaternion.multiply(t.invert()),e=this._tempQ_1.copy(this.bindQuats.elbow).invert().multiply(this.elbowBone.quaternion),s=this._tempV3_0.copy(this.wristBone.position).normalize(),g(e,s,t),this.elbowBone.quaternion.multiply(t.invert())}}u.GeometricArmIK=F;class H{constructor(e,s,i=!1){this._tempV3_0=new t.Vector3,this._tempV3_1=new t.Vector3,this._tempV3_2=new t.Vector3,this.skeleton=s,this.config=e,this.bodyLocations=e.bodyLocations,this.handLocations=i?e.handLocationsL:e.handLocationsR,this.isLeftHand=!!i;let n=e.boneMap,a=i?"L":"R";this.idx={shoulder:n[a+"Shoulder"],arm:n[a+"Arm"],elbow:n[a+"Elbow"],wrist:n[a+"Wrist"]},this.cur={p:new t.Vector3,offset:new t.Vector3},this.src={p:new t.Vector3,offset:new t.Vector3},this.trg=new t.Vector3,this.def=new t.Vector3,this.contactFinger=null,this.keepUpdatingContact=!1,this.contactUpdateDone=!1,this.time=0,this.start=0,this.attackPeak=0,this.relax=0,this.end=0,this.transition=!1,this.worldArmSize=0,this.skeleton.bones[n[a+"Arm"]].getWorldPosition(this._tempV3_0),this.skeleton.bones[n[a+"Elbow"]].getWorldPosition(this._tempV3_1),this.skeleton.bones[n[a+"Wrist"]].getWorldPosition(this._tempV3_2),this.worldArmSize=this._tempV3_0.sub(this._tempV3_1).length()+this._tempV3_1.sub(this._tempV3_2).length(),this.reset()}reset(){this.transition=!1,this.contactFinger=null,this.cur.p.set(0,0,0),this.def.set(0,0,0),this.keepUpdatingContact=!1,this.contactUpdateDone=!1}update(t){if(this.transition)if(this.time+=t,this.time<this.start);else if(this.time>=this.end)this.cur.p.copy(this.def),this.cur.offset.set(0,0,0),this.transition=!1;else{let t=this._tempV3_0.copy(this.trg);if(this.contactFinger&&!this.contactUpdateDone){this.contactFinger.updateWorldMatrix(!0),this._tempV3_1.setFromMatrixPosition(this.contactFinger.matrixWorld),this._tempV3_2.setFromMatrixPosition(this.skeleton.bones[this.idx.wrist].matrixWorld);let e=this._tempV3_1.sub(this._tempV3_2);t.sub(e),!this.keepUpdatingContact&&this.time>=this.attackPeak&&(this.contactUpdateDone=!0,this.trg.copy(t))}if(this.time>this.attackPeak&&this.time<this.relax)this.cur.p.copy(t),this.cur.offset.set(0,0,0);else if(this.time<=this.attackPeak){let e=(this.time-this.start)/(this.attackPeak-this.start);e>1&&(e=1),e=.5*Math.sin(Math.PI*e-.5*Math.PI)+.5,this.cur.offset.copy(this.src.offset).multiplyScalar(1-e),this.cur.p.lerpVectors(this.src.p,t,e);let s=Math.min(1,t.sub(this.src.p).lengthSq()/(this.worldArmSize*this.worldArmSize*.5)),i=.3*this.worldArmSize*s;this.cur.p.z+=2*i*e*(1-e)}else if(this.time>=this.relax){let e=(this.time-this.relax)/(this.end-this.relax);e>1&&(e=1),e=.5*Math.sin(Math.PI*e-.5*Math.PI)+.5,this.cur.offset.set(0,0,0),this.cur.p.lerpVectors(t,this.def,e);let s=Math.min(1,t.sub(this.def).lengthSq()/(this.worldArmSize*this.worldArmSize*.5)),i=2*(.3*this.worldArmSize*s)*e*(1-e);this.cur.p.z+=i}}}_newGestureLocationComposer(e,s,i,n=!1){let a=n?e.secondLocationBodyArm:e.locationBodyArm;if("string"!=typeof a)return!1;if(a=a.toUpperCase(),"EAR"!=a&&"EARLOBE"!=a&&"CHEEK"!=a&&"EYE"!=a&&"EYEBROW"!=a&&"SHOULDER"!=a||(a+=this.isLeftHand?"_LEFT":"_RIGHT"),A(n?e.secondSide:e.side,this._tempV3_0,s,!0)&&(this._tempV3_0.x<-1.5?a+="_SideRR":this._tempV3_0.x<-.5?a+="_SideR":this._tempV3_0.x>1.5?a+="_SideLL":this._tempV3_0.x>.5&&(a+="_SideL")),a=this.bodyLocations[a],!a)return!1;a.getWorldPosition(i);let r=isNaN(e.distance)?0:e.distance;if(a.direction){let e=(new t.Matrix3).setFromMatrix4(a.matrixWorld);this._tempV3_0.copy(a.direction).applyMatrix3(e).normalize()}else{this._tempV3_0.copy(this.config.axes[2]);let e=(new t.Matrix3).setFromMatrix4(this.skeleton.boneInverses[this.config.boneMap.Hips]);this._tempV3_0.applyMatrix3(e),e.setFromMatrix4(this.skeleton.bones[this.config.boneMap.Hips].matrixWorld),this._tempV3_0.applyMatrix3(e),this._tempV3_0.normalize()}return i.addScaledVector(this._tempV3_0,this.worldArmSize*r),!0}newGestureBML(t,e=0,s=null){if(this.keepUpdatingContact=!!t.keepUpdatingContact,this.contactUpdateDone=!1,!this._newGestureLocationComposer(t,e,this.trg,!1))return console.warn('Gesture: Location Arm no location found with name "'+t.locationBodyArm+'"'),!1;if(this._newGestureLocationComposer(t,e,this.src.p,!0)&&this.trg.lerp(this.src.p,.5),A(t.displace,this._tempV3_0,e,!0)){this._tempV3_0.normalize();let e=parseFloat(t.displaceDistance);e=isNaN(e)?0:e,this.trg.x+=this._tempV3_0.x*e,this.trg.y+=this._tempV3_0.y*e,this.trg.z+=this._tempV3_0.z*e}s?(this.src.offset.subVectors(s,this.cur.p),this.src.p.copy(this.cur.p)):(this.src.offset.copy(this.cur.offset),this.src.p.copy(this.cur.p)),t.shift&&this.def.copy(this.trg),this.contactFinger=null;let i=u.HandConstellation.handLocationComposer(t,this.handLocations,this.isLeftHand,!0,!1);return i&&(!i.name||i.name.includes("ARM")||i.name.includes("ELBOW")||(this.contactFinger=i)),this.start=t.start,this.attackPeak=t.attackPeak,this.relax=t.relax,this.end=t.end,this.time=0,this.transition=!0,!0}}u.LocationBodyArm=H;class D{constructor(){this.shape=[[new t.Quaternion,new t.Quaternion,new t.Quaternion],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]}reset(){this.shape[0][0].set(0,0,0,1),this.shape[0][1].set(0,0,0,1),this.shape[0][2].set(0,0,0,1);for(let t=1;t<5;++t)for(let e=0;e<3;++e)this.shape[t][e]=0}copy(t){let e=t.shape[0],s=this.shape[0];s[0].copy(e[0]),s[1].copy(e[1]),s[2].copy(e[2]);for(let i=1;i<5;++i)e=t.shape[i],s=this.shape[i],s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3]}lerpHandInfos(t,e,s){let i=t.shape[0],n=e.shape[0],a=this.shape[0];f(a[0],i[0],n[0],s),f(a[1],i[1],n[1],s),f(a[2],i[2],n[2],s);for(let r=1;r<5;++r)i=t.shape[r],n=e.shape[r],a=this.shape[r],a[0]=i[0]*(1-s)+n[0]*s,a[1]=i[1]*(1-s)+n[1]*s,a[2]=i[2]*(1-s)+n[2]*s,a[3]=i[3]*(1-s)+n[3]*s}lerp(t,e){this.lerpHandInfos(this,t,e)}setDigit(t,e){let s=this.shape[t];0==t?(s[0].copy(e[0]),s[1].copy(e[1]),s[2].copy(e[2])):(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3])}setDigits(t=null,e=null,s=null,i=null,n=null){t&&(this.thumb=t),e&&(this.index=e),s&&(this.middle=s),i&&(this.ring=i),n&&(this.pinky=n)}set thumb(t){this.setDigit(0,t)}set index(t){this.setDigit(1,t)}set middle(t){this.setDigit(2,t)}set ring(t){this.setDigit(3,t)}set pinky(t){this.setDigit(4,t)}getDigit(t){return this.shape[t]}get thumb(){return this.shape[0]}get index(){return this.shape[1]}get middle(){return this.shape[2]}get ring(){return this.shape[3]}get pinky(){return this.shape[4]}}class U{constructor(e,s,i=!1){this._tempQ_0=new t.Quaternion(0,0,0,1),this.skeleton=s,this.isLeftHand=!!i,this.config=e;let n=e.boneMap;this.handLocations=this.isLeftHand?e.handLocationsL:e.handLocationsR;let a=this.isLeftHand?"L":"R";this.wristIdx=n[a+"Wrist"],this.fingerIdxs=[n[a+"HandThumb"],n[a+"HandIndex"],n[a+"HandMiddle"],n[a+"HandRing"],n[a+"HandPinky"]],this.thumbIKMaxIter=30,this.fingerAxes=this._computeFingerAxesOfHand(),this._computeLookUpTables(),this.curG=new D,this.srcG=new D,this.trgG=new D,this.defG=new D,this.time=0,this.start=0,this.attackPeak=0,this.relax=0,this.end=0,this.transition=!1,this.reset()}reset(){this.transition=!1,this.time=1,this.start=0,this.attackPeak=0,this.relax=0,this.end=.1;let t=this.skeleton.bones,e=null;for(let s=0;s<5;++s)for(let i=0;i<3;++i)e=this.fingerAxes.bindQuats[3*s+i],t[this.fingerIdxs[s]+i].quaternion.copy(e);this.curG.reset(),this.curG.thumb=this.fingerAxes.bindQuats,this.defG.reset(),this.defG.thumb=this.fingerAxes.bindQuats,this.transition=!0,this.update(1)}update(t,e=null){if(!this.transition&&!e)return;this.time+=t;let s=this.skeleton.bones,i=this.fingerIdxs;if(this.time<this.start);else if(this.time<this.attackPeak){let t=(this.time-this.start)/(this.attackPeak-this.start);this.curG.lerpHandInfos(this.srcG,this.trgG,t)}else if(this.time<this.relax)this.curG.copy(this.trgG);else if(this.time<this.end){let t=(this.time-this.relax)/(this.end-this.relax);this.curG.lerpHandInfos(this.trgG,this.defG,t)}else this.curG.copy(this.defG),this.transition=!1;e&&(this.curG.index[1]=Math.max(-.2,Math.min(1,this.curG.index[1]+e[1])),this.curG.middle[1]=Math.max(-.2,Math.min(1,this.curG.middle[1]+e[2])),this.curG.ring[1]=Math.max(-.2,Math.min(1,this.curG.ring[1]+e[3])),this.curG.pinky[1]=Math.max(-.2,Math.min(1,this.curG.pinky[1]+e[4]))),this._setFingers(this.curG.index,this.curG.middle,this.curG.ring,this.curG.pinky),this._setThumb(this.curG.thumb),e&&s[i[0]].quaternion.multiply(this._tempQ_0.setFromAxisAngle(this.fingerAxes.bendAxes[0],e[0]*Math.PI*40/180))}thumbIK(e,s=!1,i=null){let n=new t.Quaternion,a=new t.Quaternion,r=new t.Vector3,o=new t.Vector3,l=this.fingerIdxs[0],h=this.skeleton.bones,c=this.fingerAxes.bindQuats,d=this.fingerAxes.bendAxes;h[l].quaternion.copy(c[0]),h[l+1].quaternion.copy(c[1]),h[l+2].quaternion.copy(c[2]),h[l+3].updateWorldMatrix(!0,!1);let p=null,m=null;s?(p=[h[l],h[l+1],h[l+2]],m=h[l+2]):(p=[h[l],h[l+1],h[l+2],h[l+3]],m=this.handLocations["1_TIP"]);let u=this.thumbIKMaxIter;for(let t=0;t<u;++t){let s=t>0?0:1;for(let i=p.length-2;i>=s;--i){let s=m.getWorldPosition(r);if(o.subVectors(s,e).lengthSq()<1e-6){t=u;break}let l=p[i],h=l.worldToLocal(r.copy(s)).normalize().applyQuaternion(l.quaternion),f=l.worldToLocal(o.copy(e)).normalize().applyQuaternion(l.quaternion);if(n.setFromUnitVectors(h,f),0!=i){let t=d[i];a.setFromUnitVectors(r.copy(t).applyQuaternion(n),t),n.premultiply(a),l.quaternion.premultiply(n),a.copy(c[i]).invert(),a.premultiply(l.quaternion),a.x*t.x+a.y*t.y+a.z*t.z<0&&(a.w*=-1),a.w<0&&l.quaternion.copy(c[i])}else l.quaternion.premultiply(n);l.updateWorldMatrix()}}if(isNaN(i)||null===i){let e=(new t.Matrix3).setFromMatrix4(h[this.wristIdx].matrixWorld),s=this.thumbThings.palmLateralVec.clone().applyMatrix3(e).normalize(),n=this.thumbThings.palmOutVec.clone().applyMatrix3(e).normalize(),a=this.thumbThings.palmUpVec.clone().applyMatrix3(e).normalize();this.thumbThings.thumbSizeFull;let l=this.thumbThings.thumbSizeUpper;m.getWorldPosition(r),this.handLocations.HAND_RADIAL.getWorldPosition(o),r.sub(o),o.set(s.dot(r),a.dot(r),n.dot(r)),o.x*=-1;let c=Math.min(1,Math.max(0,o.x/l)),d=.25*Math.min(1,Math.max(0,(o.x-.5*l)/l)),p=Math.min(1,Math.max(0,o.z/l));p=.65*p+.45*p*c,i=Math.max(0,Math.min(1,d+p))}i=this.angleRanges[0][0][0]*(1-i)+this.angleRanges[0][0][1]*i,i*=this.isLeftHand?1:-1,m.getWorldPosition(r),h[l].worldToLocal(r).applyQuaternion(h[l].quaternion),n.setFromAxisAngle(r.normalize(),i),h[l].quaternion.premultiply(n)}_computeFingerAxesOfHand(){let e=this.isLeftHand,s=this.skeleton.bones,i=this.fingerIdxs,n=new t.Vector3,a=new t.Vector3,r=new t.Vector3,o=new t.Matrix3,l=new t.Vector3,h=new t.Vector3,c={bendAxes:[],splayAxes:[],bindQuats:[]};this.bendRange=4,o.setFromMatrix4(s[0].matrixWorld.clone().multiply(this.skeleton.boneInverses[0]));let d=this.config.axes[2].clone().applyMatrix3(o).normalize(),p=i[0];for(let m=0;m<3;++m){o.setFromMatrix4(s[p+m].matrixWorld).invert(),l.setFromMatrixPosition(s[p+m].matrixWorld),h.setFromMatrixPosition(s[p+m+1].matrixWorld),r.subVectors(h,l).normalize(),n.crossVectors(d,r).normalize();let u=n.clone().applyMatrix3(o);u.applyQuaternion(s[p+m].quaternion).normalize();let f=s[p+m].quaternion.clone();if(0==m){a.crossVectors(n,r).normalize(),e||a.multiplyScalar(-1);let g=a.clone().applyMatrix3(o).normalize();g.applyQuaternion(s[p+m].quaternion).normalize();let A=new t.Vector3;l.setFromMatrixPosition(s[p].matrixWorld),h.setFromMatrixPosition(s[p+1].matrixWorld),A.subVectors(h,l).normalize();let y=new t.Vector3;l.setFromMatrixPosition(s[i[3]].matrixWorld),h.setFromMatrixPosition(s[i[3]+2].matrixWorld),y.subVectors(h,l).normalize(),l.crossVectors(y,d).normalize(),l.cross(y).normalize(),y.multiplyScalar(Math.cos(60*Math.PI/180)).addScaledVector(l,Math.sin(60*Math.PI/180));let x={x:n.dot(A),y:a.dot(A),z:r.dot(A)},b={x:n.dot(y),y:a.dot(y),z:r.dot(y)},S={elevation:-Math.asin(x.y),bearing:Math.atan2(x.x,x.z)},L={elevation:-Math.asin(b.y),bearing:Math.atan2(b.x,b.z)};f.set(0,0,0,1),f.premultiply(this._tempQ_0.setFromAxisAngle(g,-S.bearing*(e?-1:1))),f.premultiply(this._tempQ_0.setFromAxisAngle(u,-S.elevation*(e?-1:1))),f.premultiply(this._tempQ_0.setFromAxisAngle(u,L.elevation*(e?-1:1))),f.premultiply(this._tempQ_0.setFromAxisAngle(g,L.bearing*(e?-1:1))),f.normalize(),f.multiply(s[p+m].quaternion),g.copy(a).applyMatrix3(o).applyQuaternion(f).normalize(),u.copy(n).applyMatrix3(o).applyQuaternion(f).normalize(),c.splayAxes.push(g)}c.bendAxes.push(u),c.bindQuats.push(f)}let m=[0,-6*Math.PI/180,0,6*Math.PI/180,7*Math.PI/180];for(let t=1;t<i.length;++t){l.setFromMatrixPosition(s[i[t]].matrixWorld),h.setFromMatrixPosition(s[i[t]+2].matrixWorld),r.subVectors(h,l).normalize(),a.crossVectors(r,d).normalize(),n.crossVectors(a,r).normalize();for(let l=0;l<3;++l){let h=n.clone();if(o.setFromMatrix4(s[i[t]+l].matrixWorld).invert(),0==l){let e=a.clone();e.applyMatrix3(o),e.applyQuaternion(s[i[t]+l].quaternion).normalize(),c.splayAxes.push(e),h.multiplyScalar(Math.cos(m[t])).addScaledVector(r,Math.sin(m[t]))}e&&h.multiplyScalar(-1),h.applyMatrix3(o),h.applyQuaternion(s[i[t]+l].quaternion).normalize(),c.bendAxes.push(h),c.bindQuats.push(s[i[t]+l].quaternion.clone())}}return c}_computeLookUpTables(){let e=new t.Vector3,s=new t.Vector3,i=new t.Vector3,n=this.skeleton.bones;for(let t=0;t<5;++t)for(let e=0;e<3;++e)this.skeleton.bones[this.fingerIdxs[t]+e].quaternion.copy(this.fingerAxes.bindQuats[3*t+e]);let a=new t.Vector3,r=new t.Vector3,o=new t.Vector3,l=0,h=0,c=0;n[this.fingerIdxs[0]+0].getWorldPosition(e),n[this.fingerIdxs[0]+3].getWorldPosition(s),h=i.subVectors(s,e).length(),n[this.fingerIdxs[0]+1].getWorldPosition(e),l=i.subVectors(s,e).length(),this.handLocations["2_MID_ULNAR"].getWorldPosition(s),this.handLocations["2_MID_RADIAL"].getWorldPosition(e),c=i.subVectors(s,e).length(),n[this.fingerIdxs[1]].getWorldPosition(e),n[this.fingerIdxs[3]].getWorldPosition(s),n[this.wristIdx].getWorldPosition(i),e.sub(i),s.sub(i),a.crossVectors(e,s).multiplyScalar(this.isLeftHand?-1:1).normalize(),n[this.fingerIdxs[3]].getWorldPosition(e),n[this.fingerIdxs[3]+2].getWorldPosition(s),r.subVectors(s,e).cross(a).multiplyScalar(this.isLeftHand?-1:1).normalize(),o.crossVectors(a,r).multiplyScalar(this.isLeftHand?-1:1).normalize(),this.thumbThings={};let d=n[this.wristIdx].matrixWorld.clone().invert(),p=(new t.Matrix3).setFromMatrix4(d);this.thumbThings.palmOutVec=a.clone().applyMatrix3(p),this.thumbThings.palmLateralVec=r.clone().applyMatrix3(p),this.thumbThings.palmUpVec=o.clone().applyMatrix3(p),this.thumbThings.thumbSizeUpper=l,this.thumbThings.thumbSizeFull=h,this.thumbThings.fingerWidth=c,this.angleRanges=this.config.fingerAngleRanges,this.thumbshapes={OUT:null,DEFAULT:null,OPPOSED:null,ACROSS:null},n[this.fingerIdxs[1]].getWorldPosition(e).addScaledVector(r,1.2*l),this.thumbIK(e,!0),this.thumbshapes.OUT=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()],n[this.fingerIdxs[1]].getWorldPosition(e).addScaledVector(a,h),this.thumbIK(e,!1),this.thumbshapes.OPPOSED=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()],this.handLocations["2_BASE_PALMAR"].getWorldPosition(e),e.addScaledVector(r,1.5*c),this.thumbIK(e,!0),this.thumbshapes.DEFAULT=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()],this.handLocations["5_BASE_PALMAR"].getWorldPosition(e),e.addScaledVector(a,.5*c),this.thumbIK(e,!1,0),this.thumbshapes.ACROSS=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()];for(let t=0;t<5;++t)for(let e=0;e<3;++e)n[this.fingerIdxs[t]+e].quaternion.copy(this.fingerAxes.bindQuats[3*t+e]),n[this.fingerIdxs[t]+e].updateWorldMatrix();let m=this.handshapes={FIST:{selected:[0,0,0,0,0],defaultThumb:this.thumbshapes.DEFAULT,thumbOptions:null,fingers:[[0,1,1,1],[0,1,1,1],[0,1,1,1],[0,1,1,1]]},FINGER_2:{selected:[0,1,0,0,0],defaultThumb:null,thumbOptions:[],fingers:[[0,0,0,0],[0,1,1,1],[0,1,1,1],[0,1,1,1]]},FINGER_23:{selected:[0,1,1,0,0],defaultThumb:null,thumbOptions:[],fingers:[[0,0,0,0],[0,0,0,0],[0,1,1,1],[0,1,1,1]]},FINGER_23_SPREAD:{selected:[0,1,1,0,0],defaultThumb:null,thumbOptions:[],fingers:[[.8,0,0,0],[-.2,0,0,0],[0,1,1,1],[0,1,1,1]]},FINGER_2345:{selected:[0,1,1,1,1],defaultThumb:this.thumbshapes.DEFAULT,thumbOptions:null,fingers:[[.8,0,0,0],[0,0,0,0],[.8,0,0,0],[.8,0,0,0]]},FLAT:{selected:[0,1,1,1,1],defaultThumb:this.thumbshapes.DEFAULT,thumbOptions:null,fingers:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]},PINCH_12:{selected:[2,2,0,0,0],defaultThumb:null,thumbOptions:[],fingers:[[0,.7,.4,.25],[0,1,1,1],[0,1,1,1],[0,1,1,1]]},PINCH_12_OPEN:{selected:[2,2,0,0,0],defaultThumb:null,thumbOptions:[],fingers:[[0,.7,.4,.25],[0,.4,.2,.2],[0,.2,.2,.2],[0,0,.2,.2]]},PINCH_ALL:{selected:[2,2,2,2,2],defaultThumb:null,thumbOptions:[],fingers:[[0,.7,.4,.25],[0,.7,.34,.26],[0,.7,.3,.23],[0,.89,.22,.22]]},CEE_12:{selected:[3,3,0,0,0],defaultThumb:null,thumbOptions:[],fingers:[[0,.6,.4,.2],[0,1,1,1],[0,1,1,1],[0,1,1,1]]},CEE_12_OPEN:{selected:[3,3,0,0,0],defaultThumb:null,thumbOptions:[],fingers:[[0,.6,.4,.2],[0,.4,.2,.2],[0,.2,.2,.1],[0,0,.2,.2]]},CEE_ALL:{selected:[3,3,3,3,3],defaultThumb:null,thumbOptions:[],fingers:[[0,.6,.4,.2],[0,.6,.4,.2],[0,.6,.4,.1],[0,.6,.4,.2]]}},u=m.FIST;this._setFingers(u.fingers[0],u.fingers[1],u.fingers[2],u.fingers[3]);for(let t=2;t<6;++t){this.handLocations[t.toString()+"_MID_RADIAL"].getWorldPosition(e),this.thumbIK(e,!0);let s=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()];m.FINGER_2.thumbOptions.push(s),m.FINGER_23.thumbOptions.push(s),m.FINGER_23_SPREAD.thumbOptions.push(s)}m.FINGER_2.defaultThumb=m.FINGER_2.thumbOptions[1],m.FINGER_23.defaultThumb=m.FINGER_23.thumbOptions[2],m.FINGER_23_SPREAD.defaultThumb=m.FINGER_23_SPREAD.thumbOptions[2],u=m.PINCH_ALL,this._setFingers(u.fingers[0],u.fingers[1],u.fingers[2],u.fingers[3]);for(let t=2;t<6;++t){this.handLocations[t.toString()+"_TIP"].getWorldPosition(e),this.thumbIK(e,!1);let s=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()];m.PINCH_12.thumbOptions.push(s),m.PINCH_12_OPEN.thumbOptions.push(s),m.PINCH_ALL.thumbOptions.push(s),e.addScaledVector(a,l),this.thumbIK(e,!1),s=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()],m.CEE_12.thumbOptions.push(s),m.CEE_12_OPEN.thumbOptions.push(s),m.CEE_ALL.thumbOptions.push(s)}m.PINCH_12.defaultThumb=m.PINCH_12.thumbOptions[0],m.PINCH_12_OPEN.defaultThumb=m.PINCH_12_OPEN.thumbOptions[0],m.PINCH_ALL.defaultThumb=m.PINCH_ALL.thumbOptions[1],m.CEE_12.defaultThumb=m.CEE_12.thumbOptions[0],m.CEE_12_OPEN.defaultThumb=m.CEE_12_OPEN.thumbOptions[0],m.CEE_ALL.defaultThumb=m.CEE_ALL.thumbOptions[1];let g=this.handBendings={STRAIGHT:{1:[0,0,0,0],2:{t:null,f:[0,0,0,0]}},HALF_BENT:{1:[0,.5,0,0],2:{t:[],f:[0,.5,0,0]}},BENT:{1:[0,1,0,0],2:{t:[],f:[0,1,0,0]}},ROUND:{1:[0,.5,.5,.5],2:{t:[],f:[0,5/9,6/9,1]}},HOOKED:{1:[0,0,1,1],2:{t:[],f:[0,1,1,8/9]}},DOUBLE_BENT:{1:[0,1,1,0],2:{t:[],f:[0,1,1,8/9]}},DOUBLE_HOOKED:{1:[0,1,1,1],2:{t:[],f:[0,1,1,8/9]}}};this._setFingers(g.BENT[2].f,g.BENT[2].f,g.BENT[2].f,g.BENT[2].f);for(let t=2;t<6;++t){this.handLocations[t.toString()+"_TIP"].getWorldPosition(e),this.thumbIK(e,!1);let s=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()];g.BENT[2].t.push(s),s=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()],f(s[0],s[0],this.thumbshapes.DEFAULT[0],.1),f(s[1],s[1],this.thumbshapes.DEFAULT[1],.1),f(s[2],s[2],this.thumbshapes.DEFAULT[2],.1),g.HALF_BENT[2].t.push(s)}this._setFingers(g.ROUND[2].f,g.ROUND[2].f,g.ROUND[2].f,g.ROUND[2].f);for(let t=2;t<6;++t){this.handLocations[t.toString()+"_PAD_BACK"].getWorldPosition(e),this.thumbIK(e,!1);let s=[n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()];g.ROUND[2].t.push(s)}this._setFingers(g.HOOKED[2].f,g.HOOKED[2].f,g.HOOKED[2].f,g.HOOKED[2].f);for(let t=2;t<6;++t)this.handLocations[t.toString()+"_MID_BACK"].getWorldPosition(e),this.thumbIK(e,t<4),g.HOOKED[2].t.push([n[this.fingerIdxs[0]].quaternion.clone(),n[this.fingerIdxs[0]+1].quaternion.clone(),n[this.fingerIdxs[0]+2].quaternion.clone()]);g.DOUBLE_BENT[2].t=g.HOOKED[2].t,g.DOUBLE_HOOKED[2].t=g.HOOKED[2].t}_getThumb(t){t[0].copy(this.skeleton.bones[this.fingerIdxs[0]].quaternion),t[1].copy(this.skeleton.bones[this.fingerIdxs[0]+1].quaternion),t[2].copy(this.skeleton.bones[this.fingerIdxs[0]+2].quaternion)}_setThumb(t){this.skeleton.bones[this.fingerIdxs[0]].quaternion.copy(t[0]),this.skeleton.bones[this.fingerIdxs[0]+1].quaternion.copy(t[1]),this.skeleton.bones[this.fingerIdxs[0]+2].quaternion.copy(t[2])}_setFingers(t,e,s,i){let n=this.skeleton.bones,a=this.fingerAxes.bendAxes,r=this.fingerAxes.splayAxes,o=this.fingerIdxs;n[o[1]].quaternion.setFromAxisAngle(a[3],this._computeBendAngle(t,1,1)),n[o[1]+1].quaternion.setFromAxisAngle(a[4],this._computeBendAngle(t,1,2)),n[o[1]+2].quaternion.setFromAxisAngle(a[5],this._computeBendAngle(t,1,3)),n[o[2]].quaternion.setFromAxisAngle(a[6],this._computeBendAngle(e,2,1)),n[o[2]+1].quaternion.setFromAxisAngle(a[7],this._computeBendAngle(e,2,2)),n[o[2]+2].quaternion.setFromAxisAngle(a[8],this._computeBendAngle(e,2,3)),n[o[3]].quaternion.setFromAxisAngle(a[9],this._computeBendAngle(s,3,1)),n[o[3]+1].quaternion.setFromAxisAngle(a[10],this._computeBendAngle(s,3,2)),n[o[3]+2].quaternion.setFromAxisAngle(a[11],this._computeBendAngle(s,3,3)),n[o[4]].quaternion.setFromAxisAngle(a[12],this._computeBendAngle(i,4,1)),n[o[4]+1].quaternion.setFromAxisAngle(a[13],this._computeBendAngle(i,4,2)),n[o[4]+2].quaternion.setFromAxisAngle(a[14],this._computeBendAngle(i,4,3)),n[o[1]].quaternion.multiply(this._tempQ_0.setFromAxisAngle(r[1],this._computeSplayAngle(t,1))),n[o[2]].quaternion.multiply(this._tempQ_0.setFromAxisAngle(r[2],this._computeSplayAngle(e,2))),n[o[3]].quaternion.multiply(this._tempQ_0.setFromAxisAngle(r[3],-1*this._computeSplayAngle(s,3))),n[o[4]].quaternion.multiply(this._tempQ_0.setFromAxisAngle(r[4],-1*this._computeSplayAngle(i,4)-this._computeSplayAngle(s,3)));for(let t=1;t<5;++t)n[o[t]].quaternion.multiply(this._tempQ_0.copy(this.fingerAxes.bindQuats[3*t])),n[o[t]+1].quaternion.multiply(this._tempQ_0.copy(this.fingerAxes.bindQuats[3*t+1])),n[o[t]+2].quaternion.multiply(this._tempQ_0.copy(this.fingerAxes.bindQuats[3*t+2]))}_computeBendAngle(t,e,s){let i=t[s],n=this.angleRanges[e][s];return n[0]*(1-i)+n[1]*i}_computeSplayAngle(t,e){let s=t[0]*(1-Math.abs(t[1])),i=this.angleRanges[e][0];return i[0]*(1-s)+i[1]*s}_stringToMainBend(t,e,s,i=null){t&&t.toUpperCase&&(t=t.toUpperCase());let n=this.handBendings[t];if(n){if(s[0]>=2){let t=n[2].t;if(t&&t.length>3)if(i&&i.length)t=t[i[0]-1];else for(let e=1;e<5;++e)if(s[e]){t=t[e-1];break}t||(t=this.thumbshapes.DEFAULT),e.thumb=t}for(let t=1;t<5;++t){let i=s[t];if(!i)continue;let a=1==i?n[1]:n[2].f,r=e.getDigit(t);r[1]=3==i?.8*a[1]:a[1],r[2]=a[2],r[3]=a[3]}}}_bmlToFingerBend(t,e,s=0,i=4){if(!t)return;const n="string"==typeof t;n&&(t=t.toUpperCase());let a=this.handBendings[t];if(!a){if(n)for(let s=0;s<3&&s<t.length;++s){let n=parseInt(t[s]);isNaN(n)||(e[1+s]=n/i)}else if(Array.isArray(t))for(let s=0;s<3&&s<t.length;++s)e[1+s]=t[s];return}if(!s)return;let r=1==s?a[1]:a[2].f;e[1]=3==s?.8*r[1]:r[1],e[2]=r[2],e[3]=r[3]}_stringToSplay(t,e){let s=t;"string"==typeof s&&(s=parseFloat(s)),isNaN(s)||(e[0]=s)}_newGestureHandComposer(t,e,s){let i=s?t.secondHandshape:t.handshape;i&&i.toUpperCase&&(i=i.toUpperCase());let n=this.handshapes[i];if(!n)return!1;e.setDigits(n.defaultThumb,n.fingers[0],n.fingers[1],n.fingers[2],n.fingers[3]);let a=n.selected,r=t.specialFingers;if(r&&!s){let t=[a[0],0,0,0,0];r=r.split("");for(let e=0;e<r.length;e++){let s=parseInt(r[e])-1;isNaN(s)||s<1||s>4?(r.splice(e,1),e--):(t[s]=n.selected[0]?n.selected[0]:1,r[e]=s)}if(r.length){switch(a=t,i){case"FIST":for(let t=1;t<a.length;t++)a[t]||e.setDigit(t,[0,0,0,0]),a[t]=1-a[t];break;case"FLAT":case"CEE_ALL":case"PINCH_ALL":for(let t=1;t<a.length;t++)a[t]||e.setDigit(t,[0,1,1,1]);break;case"PINCH_12":case"PINCH_12_OPEN":case"CEE_12":case"CEE_12_OPEN":for(let t=0;t<r.length;t++)e.setDigit(r[t],this.handshapes[i.includes("CEE_")?"CEE_ALL":"PINCH_ALL"].fingers[r[t]-1]);break;default:let t=i.match(/\d+/g);if(t){t=t[0].split(""),t=t.map(function(t){return parseInt(t)-1}),0==t[0]&&t.shift();for(let s=0;s<r.length;s++)if(t[s]){if(r[s]==t[s])continue;e.setDigit(r[s],e.getDigit(t[s]))}else e.setDigit(r[s],e.getDigit(t[0]))}}let s=i.includes("_OPEN",5);for(let t=1;t<a.length;t++)a[t]||e.setDigit(t,s?[0,.2,.2,.2]:[0,1,1,1]);if(i.includes("PINCH_")||i.includes("CEE_")){let t=i.includes("PINCH_")?this.handshapes.PINCH_ALL.thumbOptions:this.handshapes.CEE_ALL.thumbOptions;t=t[r[0]-1],e.thumb=t}if("FINGER_2"==i||"FINGER_23"==i||"FINGER_23_SPREAD"==i){let t=0;for(let e=1;e<a.length;++e)if(!a[e]){t=e;break}e.thumb=t?this.handshapes.FINGER_2.thumbOptions[t-1]:this.thumbshapes.DEFAULT}}}this._stringToMainBend(s?t.secondMainBend:t.mainBend,e,a,r);let o=s?t.secondThumbshape:t.thumbshape;"string"==typeof o&&(o=o.toUpperCase());let l=this.thumbshapes[o];l&&(e.thumb=l);let h=parseFloat(s?t.secondtco:t.tco);h=isNaN(h)?0:Math.max(-1,Math.min(1,h)),h=1-h;for(let t=1;t<5;++t)e.shape[t][1]*=h,e.shape[t][2]*=h,e.shape[t][3]*=h;return!0}newGestureBML(e){let s=this.skeleton.bones;this.fingerIdxs,this.srcG.copy(this.curG);let i=new D,n=new D;if(!this._newGestureHandComposer(e,i,!1))return console.warn('Gesture: HandShape incorrect handshape "'+e.handshape+'"'),!1;this._newGestureHandComposer(e,n,!0)&&i.lerp(n,.5);let a=this.bendRange;this._bmlToFingerBend(e.bend2,i.index,1,a),this._bmlToFingerBend(e.bend3,i.middle,1,a),this._bmlToFingerBend(e.bend4,i.ring,1,a),this._bmlToFingerBend(e.bend5,i.pinky,1,a),this._stringToSplay(e.splay2??e.mainSplay,i.index),this._stringToSplay(e.splay3,i.middle),this._stringToSplay(e.splay4??e.mainSplay,i.ring),this._stringToSplay(e.splay5??e.mainSplay,i.pinky),this.trgG.copy(i);let r="string"==typeof e.thumbTarget?this.handLocations[e.thumbTarget.toUpperCase()]:null;if(r){this._setFingers(i.index,i.middle,i.ring,i.pinky);let n=r.getWorldPosition(new t.Vector3);if(e.thumbDistance){let i=isNaN(parseFloat(e.thumbDistance))?0:e.thumbDistance,a=(new t.Matrix3).setFromMatrix4(s[this.wristIdx].matrixWorld),r=this.thumbThings.palmOutVec.clone().applyMatrix3(a).normalize();n.addScaledVector(r,i*this.thumbThings.thumbSizeFull)}this.thumbIK(n,"PAD"==e.thumbSource,e.thumbSplay),this._getThumb(this.trgG.thumb),this._setFingers(this.srcG.index,this.srcG.middle,this.srcG.ring,this.srcG.pinky),this._setThumb(this.srcG.thumb)}e.shift&&this.defG.copy(this.trgG),this.time=0,this.start=e.start,this.attackPeak=e.attackPeak,this.relax=e.relax,this.end=e.end,this.transition=!0}}u.HandShape=U;class V{constructor(e,s,i=!1){this.skeleton=s,this.isLeftHand=!!i,this.config=e;let n=e.boneMap,a=i?"L":"R",r=this.skeleton.bones;this.wristIdx=n[a+"Wrist"],this.wristBone=r[this.wristIdx],this.forearmBone=r[n[a+"Elbow"]],this.wristBindQuat=b(this.skeleton,this.wristIdx,new t.Quaternion),this.twistAxisForearm=(new t.Vector3).copy(r[n[a+"Wrist"]].position).normalize(),this.twistAxisWrist=(new t.Vector3).copy(r[n[a+"HandMiddle"]].position).normalize(),this.bearingAxis=(new t.Vector3).crossVectors(r[n[a+"HandRing"]].position,r[n[a+"HandIndex"]].position).multiplyScalar(i?-1:1).normalize(),this.elevationAxis=(new t.Vector3).crossVectors(this.bearingAxis,this.twistAxisWrist).normalize(),this.bearingAxis.crossVectors(this.twistAxisWrist,this.elevationAxis).normalize(),this.palmor={srcAngle:0,trgAngle:0,defAngle:0},this.extfidir={trgDir:new t.Vector3(0,-1,0),defDir:new t.Vector3(0,-1,0)},this.curAproxPalmor=0,this.srcQuat=new t.Quaternion(0,0,0,1),this.curQuat=new t.Quaternion(0,0,0,1),this.time=0,this.start=0,this.attackPeak=0,this.relax=0,this.end=0,this.transition=!1,this.reset(),this._tempMat3_0=new t.Matrix3,this._tempV3_0=new t.Vector3,this._tempV3_1=new t.Vector3,this._tempV3_2=new t.Vector3,this._tempV3_3=new t.Vector3,this._tempQ_0=new t.Quaternion}reset(){this.transition=!1,this.curQuat.set(0,0,0,1),this.srcQuat.set(0,0,0,1),this.curAproxPalmor=0,this.palmor.srcAngle=0,this.palmor.trgAngle=0,this.palmor.defAngle=0,this.extfidir.trgDir.set(0,-1,0),this.extfidir.defDir.set(0,-1,0)}_computeSwingFromCurrentPose(t,e){let s=Math.atan2(t.y,Math.sqrt(t.x*t.x+t.z*t.z)),i=Math.atan2(t.x,t.z);this.isLeftHand&&i>1.58825?i-=2*Math.PI:!this.isLeftHand&&i<-1.58825&&(i+=2*Math.PI);let n=this.wristBone;n.quaternion.copy(this.wristBindQuat),n.updateWorldMatrix(!0);let a=this._tempMat3_0.setFromMatrix4(n.matrixWorld).invert(),r=this._tempV3_1.set(0,0,1).applyMatrix3(a).normalize(),o=this._tempV3_2.set(1,0,0).applyMatrix3(a).normalize(),l=this._tempV3_3.crossVectors(r,o).normalize(),h=Math.acos(this.twistAxisWrist.dot(r)),c=this._tempV3_0;c.crossVectors(this.twistAxisWrist,r).normalize(),e.setFromAxisAngle(c,h);let d=this._tempV3_0.copy(this.elevationAxis).applyQuaternion(e);h=Math.acos(d.dot(o)),c.crossVectors(d,o).normalize(),this._tempQ_0.setFromAxisAngle(c,h),e.premultiply(this._tempQ_0);let p=this._tempQ_0.setFromAxisAngle(o,-s);e.premultiply(p);let m=this._tempQ_0.setFromAxisAngle(l,i);e.premultiply(m),e.premultiply(this.wristBindQuat)}update(t){if(this.wristBone.quaternion.copy(this.wristBindQuat),this.time+=t,this.time<this.start)this.wristBone.quaternion.copy(this.srcQuat);else if(this.time<this.attackPeak){this._computeSwingFromCurrentPose(this.extfidir.trgDir,this.curQuat),this._tempQ_0.setFromAxisAngle(this.twistAxisWrist,this.palmor.trgAngle),this.curQuat.multiply(this._tempQ_0);let t=(this.time-this.start)/(this.attackPeak-this.start);f(this.curQuat,this.srcQuat,this.curQuat,t),this.curAproxPalmor=this.palmor.srcAngle*(1-t)+this.palmor.trgAngle*t,this.wristBone.quaternion.copy(this.curQuat)}else if(this.time<this.relax)this._computeSwingFromCurrentPose(this.extfidir.trgDir,this.curQuat),this._tempQ_0.setFromAxisAngle(this.twistAxisWrist,this.palmor.trgAngle),this.curQuat.multiply(this._tempQ_0),this.wristBone.quaternion.copy(this.curQuat),this.curAproxPalmor=this.palmor.trgAngle;else{this._computeSwingFromCurrentPose(this.extfidir.trgDir,this.srcQuat),this._tempQ_0.setFromAxisAngle(this.twistAxisWrist,this.palmor.trgAngle),this.srcQuat.multiply(this._tempQ_0),this._computeSwingFromCurrentPose(this.extfidir.defDir,this.curQuat),this._tempQ_0.setFromAxisAngle(this.twistAxisWrist,this.palmor.defAngle),this.curQuat.multiply(this._tempQ_0);let t=(this.time-this.relax)/(this.end-this.relax);t>1&&(t=1,this.transition=!1),f(this.curQuat,this.srcQuat,this.curQuat,t),this.wristBone.quaternion.copy(this.curQuat),this.curAproxPalmor=this.palmor.trgAngle*(1-t)+this.palmor.defAngle*t}}newGestureBMLExtfidir(t,e=!1){if(t.extfidir)return A(t.extfidir,this.extfidir.trgDir,e,!0)?(this.extfidir.trgDir.normalize(),A(t.secondExtfidir,this._tempV3_0,e,!0)&&(this.extfidir.trgDir.lerpVectors(this.extfidir.trgDir,this._tempV3_0,.5),this.extfidir.trgDir.normalize()),t.shift&&this.extfidir.defDir.copy(this.extfidir.trgDir),!0):(console.warn('Gesture: Extfidir incorrect direction "'+t.extfidir+'"'),!1)}newGestureBMLPalmor(t,e=0){if(!t.palmor)return;let s=this._tempV3_0;if(!A(t.palmor,s,e,!0))return!1;let i=Math.atan2(s.x,-s.y);if(A(t.secondPalmor,s,e,!0)){let t=Math.atan2(s.x,-s.y);Math.abs(i-t)>Math.PI&&(i-t<0?t-=2*Math.PI:t+=2*Math.PI),i=.5*(i+t)}return!this.isLeftHand&&i<-120*Math.PI/180?i+=2*Math.PI:this.isLeftHand&&i>120*Math.PI/180&&(i-=2*Math.PI),this.palmor.trgAngle=i,t.shift&&(this.palmor.defAngle=this.palmor.trgAngle),!0}newGestureBML(t,e=0){return this.srcQuat.copy(this.curQuat),this.palmor.srcAngle=this.curAproxPalmor,this.newGestureBMLExtfidir(t,e)||this.time>this.relax&&this.extfidir.trgDir.copy(this.extfidir.defDir),e=254&e|1&e^(this.extfidir.trgDir.z<0?1:0),this.newGestureBMLPalmor(t,e)||this.time>this.relax&&(this.palmor.trgAngle=this.palmor.defAngle),this.time=0,this.start=t.start,this.attackPeak=t.attackPeak,this.relax=t.relax,this.end=t.end,this.transition=!0,!0}}u.ExtfidirPalmor=V;let z=new t.Vector3(0,0,0),W=new t.Vector3(0,0,0),G=new t.Quaternion(0,0,0,1),j=new t.Quaternion(0,0,0,1);class q{constructor(){this.finalOffset=new t.Vector3(0,0,0),this.bezier=[new t.Vector3,new t.Vector3,new t.Vector3,new t.Vector3],this.distance=.05,this.curveSize=.5,this.zigzagDir=new t.Vector3(0,0,1),this.zigzagSize=.01,this.zigzagSpeed=2,this.transition=!1,this.time=0,this.start=0,this.attackPeak=0,this.relax=0,this.end=0}reset(){this.transition=!1,this.finalOffset.set(0,0,0)}update(t){if(this.transition){if(this.time+=t,this.time<this.start)return this.finalOffset;if(this.time<this.attackPeak){let t=(this.time-this.start)/(this.attackPeak-this.start);!function(t,e,s,i,n,a){let r=1-a,o=r*r*r,l=3*a*r*r,h=3*a*a*r,c=a*a*a;n.x=t.x*o+e.x*l+s.x*h+i.x*c,n.y=t.y*o+e.y*l+s.y*h+i.y*c,n.z=t.z*o+e.z*l+s.z*h+i.z*c}(this.bezier[0],this.bezier[1],this.bezier[2],this.bezier[3],this.finalOffset,t);let e=Math.min(1,Math.min((this.attackPeak-this.time)/.15,(this.time-this.start)/.15)),s=Math.sin(2*Math.PI*this.zigzagSpeed*(this.time-this.start))*this.zigzagSize*.5*e;this.finalOffset.x=this.finalOffset.x+this.zigzagDir.x*s,this.finalOffset.y=this.finalOffset.y+this.zigzagDir.y*s,this.finalOffset.z=this.finalOffset.z+this.zigzagDir.z*s}else if(this.time<this.relax)this.finalOffset.copy(this.bezier[3]);else if(this.time<this.end){let t=(this.time-this.relax)/(this.end-this.relax);this.finalOffset.copy(this.bezier[3]),this.finalOffset.multiplyScalar(1-t)}else this.transition=!1,this.finalOffset.set(0,0,0);return this.finalOffset}}newGestureBML(t,e){this.finalOffset.set(0,0,0),this.distance=isNaN(t.distance)?.2:t.distance,this.curveSize=isNaN(t.curveSize)?.5:Math.max(0,Math.min(1,t.curveSize));let s=z.set(0,0,0);A(t.curve,s,e,!0)&&(s.z=0,A(t.secondCurve,W,e,!0)&&(W.z=0,s.lerp(W,.5)),s.lengthSq()>1e-5&&s.normalize()),s.multiplyScalar(.5*this.curveSize),this.bezier[0].set(0,0,0),this.bezier[1].set(s.x,s.y,0),this.bezier[2].set(s.x,s.y,this.distance),this.bezier[3].set(0,0,this.distance);let i=z;if(!A(t.direction,i,e,!0))return console.warn("DirectedMotion has incorrect direction values"),!1;i.lengthSq()>1e-4&&i.normalize(),A(t.secondDirection,W,e,!0)&&(W.lengthSq()>1e-4&&W.normalize(),i.lerp(W,.5),i.lengthSq()>1e-4&&i.normalize()),i.z<0&&(this.bezier[0].z*=-1,this.bezier[1].z*=-1,this.bezier[2].z*=-1,this.bezier[3].z*=-1);let n=G;if(Math.abs(i.dot(this.bezier[3]))>.999)n.set(0,0,0,1);else{let t=i.angleTo(this.bezier[3]);z.crossVectors(this.bezier[3],i),z.normalize(),n.setFromAxisAngle(z,t)}return this.bezier[0].applyQuaternion(n),this.bezier[1].applyQuaternion(n),this.bezier[2].applyQuaternion(n),this.bezier[3].applyQuaternion(n),A(t.zigzag,this.zigzagDir)?(this.zigzagSize=isNaN(t.zigzagSize)?.01:t.zigzagSize,this.zigzagSpeed=isNaN(t.zigzagSpeed)?2:t.zigzagSpeed):(this.zigzagDir.set(0,0,0),this.zigzagSize=0,this.zigzagSpeed=0),this.start=t.start,this.attackPeak=t.attackPeak,this.relax=t.relax,this.end=t.end,this.time=0,this.transition=!0,!0}}u.DirectedMotion=q;class Q{constructor(){this.yAxis=new t.Vector3(0,1,0),this.xAxis=new t.Vector3(1,0,0),this.startPoint=new t.Vector3(0,0,0),this.trgAngle=0,this.srcAngle=0,this.finalOffset=new t.Vector3(0,0,0),this.zigzagDir=new t.Vector3(0,0,1),this.zigzagSize=.01,this.zigzagSpeed=2,this.transition=!1,this.time=0,this.start=0,this.end=0}reset(){this.transition=!1,this.finalOffset.set(0,0,0)}update(t){if(!this.transition)return this.finalOffset;if(this.time+=t,this.time<this.start)return this.finalOffset;if(this.time>=this.attackPeak&&this.time<=this.relax)return this.finalOffset.set(0,0,0),this.finalOffset.addScaledVector(this.xAxis,Math.cos(this.trgAngle)),this.finalOffset.addScaledVector(this.yAxis,Math.sin(this.trgAngle)),this.finalOffset.sub(this.startPoint),this.finalOffset;if(this.time>=this.relax&&this.time<=this.end)return this.finalOffset.set(0,0,0),this.finalOffset.addScaledVector(this.xAxis,Math.cos(this.trgAngle)),this.finalOffset.addScaledVector(this.yAxis,Math.sin(this.trgAngle)),this.finalOffset.sub(this.startPoint),this.finalOffset.multiplyScalar((this.end-this.time)/(this.end-this.relax)),this.finalOffset;if(this.time>=this.end)return this.transition=!1,this.finalOffset.set(0,0,0),this.finalOffset;let e=(this.time-this.start)/(this.attackPeak-this.start);if(e=e>1?1:e,this.finalOffset.set(0,0,0),this.finalOffset.addScaledVector(this.xAxis,Math.cos(this.srcAngle*(1-e)+this.trgAngle*e)),this.finalOffset.addScaledVector(this.yAxis,Math.sin(this.srcAngle*(1-e)+this.trgAngle*e)),this.finalOffset.sub(this.startPoint),Math.abs(this.zigzagSize)>1e-4){let t=Math.max(0,Math.min(1,Math.min((this.time-this.start)/.5,(this.attackPeak-this.time)/.5))),e=Math.sin(2*Math.PI*this.zigzagSpeed*(this.time-this.start))*this.zigzagSize*.5*t;this.finalOffset.x=this.finalOffset.x+this.zigzagDir.x*e,this.finalOffset.y=this.finalOffset.y+this.zigzagDir.y*e,this.finalOffset.z=this.finalOffset.z+this.zigzagDir.z*e}return this.finalOffset}newGestureBML(t,e){this.finalOffset.set(0,0,0);let s=isNaN(t.distance)?.05:t.distance,i=parseFloat(t.ellipseAxisRatio);if(isNaN(i)&&(i=1),A(t.ellipseAxisDirection,z,e,!0)?(z.z=0,z.lengthSq()<1e-4?z.set(1,0,0):z.normalize()):z.set(1,0,0),this.xAxis.copy(z).multiplyScalar(s),this.yAxis.set(-this.xAxis.y,this.xAxis.x,0).multiplyScalar(i),!A(t.direction,z,e,!0))return console.warn('Gesture: Location Motion no direction found with name "'+t.direction+'"'),!1;A(t.secondDirection,W,e,!0)||W.copy(z),W.lerpVectors(W,z,.5),W.lengthSq()<1e-4&&W.copy(z),W.normalize();let n=Math.asin(W.y),a=Math.atan2(W.x,W.z);return G.setFromAxisAngle(z.set(1,0,0),-n),j.setFromAxisAngle(z.set(0,1,0),a),G.premultiply(j),this.xAxis.applyQuaternion(G),this.yAxis.applyQuaternion(G),this.srcAngle=isNaN(t.startAngle)?0:t.startAngle*Math.PI/180,this.trgAngle=isNaN(t.endAngle)?this.srcAngle+2*Math.PI:t.endAngle*Math.PI/180,e&&(this.trgAngle*=-1,this.srcAngle*=-1),this.startPoint.set(0,0,0),this.startPoint.addScaledVector(this.xAxis,Math.cos(this.srcAngle)),this.startPoint.addScaledVector(this.yAxis,Math.sin(this.srcAngle)),A(t.zigzag,this.zigzagDir)?(this.zigzagSize=isNaN(t.zigzagSize)?.01:t.zigzagSize,this.zigzagSpeed=isNaN(t.zigzagSpeed)?2:t.zigzagSpeed):(this.zigzagDir.set(0,0,0),this.zigzagSize=0,this.zigzagSpeed=0),this.start=t.start,this.attackPeak=t.attackPeak,this.relax=t.relax,this.end=t.end,this.time=0,this.transition=!0,!0}}u.CircularMotion=Q;class K{constructor(){this.curBends=[0,0,0,0,0],this.fingerEnabler=0,this.transition=!1,this.speed=3,this.intensity=.3,this.clock=0,this.curUpdateIntensity=[0,0,0,0,0],this.srcUpdateIntensity=[0,0,0,0,0],this.time=0,this.start=0,this.attackPeak=0,this.relax=0,this.end=0}reset(){this.transition=!1,this.curBends.fill(0)}update(t){if(!this.transition)return;this.clock+=t,this.time+=t;let e=0,s=1;this.time<this.start?(s=0,e=0):this.time<this.attackPeak?(e=(this.time-this.start)/(this.attackPeak-this.start),s=e):this.time<this.relax?e=1:this.time<this.end?e=(this.end-this.time)/(this.end-this.relax):(e=0,this.transition=!1);let i=e*this.intensity;this.curUpdateIntensity[0]=(1&this.fingerEnabler?1:0)*i+this.srcUpdateIntensity[0]*(1-s),this.curBends[0]=(.5*Math.cos(2*Math.PI*this.speed*this.clock+.25*Math.PI)+.5)*this.curUpdateIntensity[0],this.curUpdateIntensity[1]=(2&this.fingerEnabler?1:0)*i+this.srcUpdateIntensity[1]*(1-s),this.curBends[1]=(.5*Math.cos(2*Math.PI*this.speed*this.clock)+.5)*this.curUpdateIntensity[1],this.curUpdateIntensity[2]=(4&this.fingerEnabler?1:0)*i+this.srcUpdateIntensity[2]*(1-s),this.curBends[2]=(.5*Math.cos(2*Math.PI*this.speed*this.clock+.65*Math.PI)+.5)*this.curUpdateIntensity[2],this.curUpdateIntensity[3]=(8&this.fingerEnabler?1:0)*i+this.srcUpdateIntensity[3]*(1-s),this.curBends[3]=(.5*Math.cos(2*Math.PI*this.speed*this.clock+1.05*Math.PI)+.5)*this.curUpdateIntensity[3],this.curUpdateIntensity[4]=(16&this.fingerEnabler?1:0)*i+this.srcUpdateIntensity[4]*(1-s),this.curBends[4]=(.5*Math.cos(2*Math.PI*this.speed*this.clock+1.35*Math.PI)+.5)*this.curUpdateIntensity[4]}newGestureBML(t){this.transition=!0,this.speed=isNaN(t.speed)?3:t.speed,this.intensity=isNaN(t.intensity)?.3:t.intensity,this.intensity=.5*Math.min(1,Math.max(-1,this.intensity));let e=this.srcUpdateIntensity;if(this.srcUpdateIntensity=this.curUpdateIntensity,this.curUpdateIntensity=e,this.fingerEnabler=31,"string"==typeof t.fingers){this.fingerEnabler=0;for(let e=0;e<t.fingers.length;++e){let s=parseInt(t.fingers[e]);isNaN(s)||(this.fingerEnabler|=1<<s-1)}this.fingerEnabler&=31}if("string"==typeof t.exemptedFingers){for(let e=0;e<t.exemptedFingers.length;++e){let s=parseInt(t.exemptedFingers[e]);isNaN(s)||(this.fingerEnabler&=~(1<<s-1))}this.fingerEnabler&=31}return this.start=t.start,this.attackPeak=t.attackPeak,this.relax=t.relax,this.end=t.end,this.time=0,!0}}u.FingerPlay=K;class J{constructor(e,s,i=!1){this.skeleton=s,this.config=e,this.time=0,this.start=0,this.attackPeak=0,this.relax=0,this.end=0,this.transition=!1,this.clock=0,this.curUpdateIntensity=[0,0,0],this.srcUpdateIntensity=[0,0,0],this.mode=0,this.intensity=1,this.speed=1;let n=i?"L":"R";this.wristBone=this.skeleton.bones[e.boneMap[n+"Wrist"]],this.axes=[new t.Vector3(0,0,1),new t.Vector3(1,0,0),new t.Vector3(0,1,0)];let a=this.skeleton.boneInverses[e.boneMap[n+"Wrist"]],r=this.skeleton.boneInverses[e.boneMap[n+"HandMiddle"]],o=this.skeleton.boneInverses[e.boneMap[n+"HandIndex"]],l=this.skeleton.boneInverses[e.boneMap[n+"HandRing"]],h=(new t.Vector3).setFromMatrixPosition(a.clone().invert()),c=(new t.Vector3).setFromMatrixPosition(r.clone().invert()).sub(h).normalize(),d=(new t.Vector3).setFromMatrixPosition(o.clone().invert()).sub(h).normalize(),p=(new t.Vector3).setFromMatrixPosition(l.clone().invert()).sub(h).normalize();this.axes[0].copy(c),this.axes[2].crossVectors(p,d).multiplyScalar(i?-1:1).normalize(),this.axes[1].crossVectors(this.axes[2],this.axes[0]).normalize(),this.axes[2].crossVectors(this.axes[0],this.axes[1]);let m=(new t.Matrix3).setFromMatrix4(a);this.axes[0].applyMatrix3(m).normalize(),this.axes[1].applyMatrix3(m).normalize(),this.axes[2].applyMatrix3(m).normalize()}reset(){this.time=0,this.mode=0,this.transition=!1}update(t){if(!this.transition)return;this.clock+=t,this.time+=t;let e=0,s=0;this.time<this.start?e=0:this.time<this.attackPeak?(e=(this.time-this.start)/(this.attackPeak-this.start),s=1-e):this.time<this.relax?e=1:this.time<this.end?e=(this.end-this.time)/(this.end-this.relax):(e=0,this.mode=0,this.transition=!1);let i=0,n=z;n.copy(this.axes[0]).applyQuaternion(this.wristBone.quaternion),i=this.srcUpdateIntensity[0]*s,1&this.mode&&(i+=this.intensity*e),this.curUpdateIntensity[0]=i,G.setFromAxisAngle(n,Math.cos(2*Math.PI*this.speed*this.clock)*i*(.5*Math.PI)),this.wristBone.quaternion.premultiply(G),n.copy(this.axes[1]).applyQuaternion(this.wristBone.quaternion),i=this.srcUpdateIntensity[1]*s,2&this.mode&&(i+=this.intensity*e),this.curUpdateIntensity[1]=i,G.setFromAxisAngle(n,Math.cos(2*Math.PI*this.speed*this.clock)*i*(.5*Math.PI)),this.wristBone.quaternion.premultiply(G),n.copy(this.axes[2]).applyQuaternion(this.wristBone.quaternion),i=this.srcUpdateIntensity[2]*s,4&this.mode&&(i+=this.intensity*e),this.curUpdateIntensity[2]=i,G.setFromAxisAngle(n,Math.sin(2*Math.PI*this.speed*this.clock)*i*(.5*Math.PI)),this.wristBone.quaternion.premultiply(G)}newGestureBML(t,e){if(this.speed=isNaN(t.speed)?3:t.speed,7&e&&(this.speed*=-1),this.intensity=isNaN(t.intensity)?.3:t.intensity,this.intensity=Math.min(1,Math.max(0,this.intensity)),"string"==typeof t.mode)switch(t.mode.toLowerCase()){case"nod":case"nodding":this.mode=2;break;case"swing":case"swinging":this.mode=4;break;case"twist":case"twisting":this.mode=1;break;case"stir_cw":this.mode=6;break;case"stir_ccw":this.mode=6,this.speed*=-1;break;case"all":this.mode=7;break;default:return console.warn('Gesture: No wrist motion called "',t.mode,'" found'),!1}else{if(isNaN(t.mode))return console.warn('Gesture: No wrist motion called "',t.mode,'" found'),!1;this.mode=7&t.mode}let s=this.curUpdateIntensity;return this.curUpdateIntensity=this.srcUpdateIntensity,this.srcUpdateIntensity=s,this.start=t.start,this.attackPeak=t.attackPeak,this.relax=t.relax,this.end=t.end,this.time=0,this.transition=!0,!0}}u.WristMotion=J;class Y{constructor(e,s,i,n){this.skeleton=s,this.boneMap=e,this.time=0,this.start=0,this.attackPeak=0,this.relax=0,this.end=0,this.transition=!1,this.worldArmSize=0;let a=new t.Vector3,r=a.clone(),o=a.clone();this.skeleton.bones[e.RArm].getWorldPosition(a),this.skeleton.bones[e.RElbow].getWorldPosition(r),this.skeleton.bones[e.RWrist].getWorldPosition(o),this.worldArmSize=a.sub(r).length()+r.sub(o).length(),this.handLocationsR=i,this.handLocationsL=n,this.prevOffsetL=new t.Vector3,this.prevOffsetR=new t.Vector3,this.curOffsetL=new t.Vector3,this.curOffsetR=new t.Vector3,this.keepUpdatingContact=!1,this.peakOffsetL=new t.Vector3(0,0,0),this.peakOffsetR=new t.Vector3(0,0,0),this.peakUpdated=!1,this.srcCurOffset=null,this.srcPoints=[null,null],this.dstCurOffset=null,this.dstPoints=[null,null],this.distanceVec=new t.Vector3(0,0,0),this.isBothHands=!1,this.activeArmsFlag=0,this.reset(),this._tempV3_0=new t.Vector3,this._tempV3_1=new t.Vector3,this._tempV3_2=new t.Vector3}reset(){this.transition=!1,this.prevOffsetL.set(0,0,0),this.prevOffsetR.set(0,0,0),this.curOffsetL.set(0,0,0),this.curOffsetR.set(0,0,0),this.distanceVec.set(0,0,0),this.isBothHands=!1,this.activeArmsFlag=0,this.keepUpdatingContact=!1,this.peakUpdated=!1,this.peakOffsetL.set(0,0,0),this.peakOffsetR.set(0,0,0)}update(t){if(!this.transition)return;if(this.time+=t,this.time<this.start)return;if(this.keepUpdatingContact||!this.peakUpdated){this.srcPoints[0].updateWorldMatrix(!0);let t=this._tempV3_0.setFromMatrixPosition(this.srcPoints[0].matrixWorld);this.srcPoints[1]&&(this.srcPoints[1].updateWorldMatrix(!0),this._tempV3_2.setFromMatrixPosition(this.srcPoints[1].matrixWorld),t.lerp(this._tempV3_2,.5)),this.dstPoints[0].updateWorldMatrix(!0);let e=this._tempV3_1.setFromMatrixPosition(this.dstPoints[0].matrixWorld);this.dstPoints[1]&&(this.dstPoints[1].updateWorldMatrix(!0),this._tempV3_2.setFromMatrixPosition(this.dstPoints[1].matrixWorld),e.lerp(this._tempV3_2,.5)),this.isBothHands?(1&this.activeArmsFlag?(this.srcCurOffset.lerpVectors(t,e,.5),this.srcCurOffset.sub(t),this.srcCurOffset.addScaledVector(this.distanceVec,.5)):this.srcCurOffset.set(0,0,0),2&this.activeArmsFlag?(this.dstCurOffset.lerpVectors(e,t,.5),this.dstCurOffset.sub(e),this.dstCurOffset.addScaledVector(this.distanceVec,-.5)):this.dstCurOffset.set(0,0,0)):(this.srcCurOffset.copy(e),this.srcCurOffset.sub(t),this.srcCurOffset.add(this.distanceVec),this.dstCurOffset.set(0,0,0)),this.time>this.attackPeak&&!this.keepUpdatingContact&&!this.peakUpdated&&(this.peakOffsetL.copy(this.curOffsetL),this.peakOffsetR.copy(this.curOffsetR),this.peakUpdated=!0)}let e=0;this.time<=this.attackPeak?(e=(this.time-this.start)/(this.attackPeak-this.start),e>1&&(e=1),e=.5*Math.sin(Math.PI*e-.5*Math.PI)+.5,this.curOffsetL.lerpVectors(this.prevOffsetL,this.curOffsetL,e),this.curOffsetR.lerpVectors(this.prevOffsetR,this.curOffsetR,e)):this.time>this.attackPeak&&this.time<this.relax||this.time>=this.relax&&(e=(this.end-this.time)/(this.end-this.relax),e>1&&(e=1),e<0&&(e=0),e=.5*Math.sin(Math.PI*e-.5*Math.PI)+.5,this.time>=this.end&&(this.transition=!1),this.keepUpdatingContact||(this.curOffsetL.copy(this.peakOffsetL),this.curOffsetR.copy(this.peakOffsetR)),this.curOffsetL.multiplyScalar(e),this.curOffsetR.multiplyScalar(e))}cancelArm(t="R"){"B"==t&&(this.activeArmsFlag=0),"R"==t?(this.activeArmsFlag&=this.srcCurOffset==this.curOffsetR?-2:-3,this.prevOffsetR.set(0,0,0),this.curOffsetR.set(0,0,0),this.peakOffsetR.set(0,0,0)):"L"==t&&(this.activeArmsFlag&=this.srcCurOffset==this.curOffsetL?-2:-3,this.prevOffsetL.set(0,0,0),this.curOffsetL.set(0,0,0),this.peakOffsetL.set(0,0,0)),this.activeArmsFlag||this.reset()}static handLocationComposer(t,e,s=!1,i=!0,n=!1){let a,r,o,l;if(a=i?n?t.secondSrcContact:t.srcContact:n?t.secondDstContact:t.dstContact,"string"==typeof a){a=a.toUpperCase();let t=e[a];if(t)return t}return i?n?(r=t.secondSrcFinger,o=t.secondSrcSide,l=t.secondSrcLocation):(r=t.srcFinger,o=t.srcSide,l=t.srcLocation):n?(r=t.secondDstFinger,o=t.secondDstSide,l=t.secondDstLocation):(r=t.dstFinger,o=t.dstSide,l=t.dstLocation),r=parseInt(r),(isNaN(r)||r<1||r>5)&&(r=""),l="string"!=typeof l||l.length<1?"":(r>0?"_":"")+l.toUpperCase(),"string"!=typeof o||o.length<1?o="":(o=o.toUpperCase(),l.includes("ELBOW")||l.includes("UPPER_ARM")||("RIGHT"==o?o=s?"RADIAL":"ULNAR":"LEFT"==o&&(o=s?"ULNAR":"RADIAL")),o="_"+o),e[r+l+o]}newGestureBML(t,e="R"){this.keepUpdatingContact=!!t.keepUpdatingContact,this.peakUpdated=!1;let s=null,i=null,n=!1;"BOTH"==t.hand?(this.isBothHands=!0,this.activeArmsFlag=3,n="L"==e):(this.isBothHands=!1,this.activeArmsFlag=1,n="RIGHT"!=t.hand&&("LEFT"==t.hand||("NON_DOMINANT"==t.hand?"R"==e:"L"==e))),this.prevOffsetL.copy(this.curOffsetL),this.prevOffsetR.copy(this.curOffsetR),n?(this.srcCurOffset=this.curOffsetL,this.dstCurOffset=this.curOffsetR,s=this.handLocationsL,i=this.handLocationsR):(this.srcCurOffset=this.curOffsetR,this.dstCurOffset=this.curOffsetL,s=this.handLocationsR,i=this.handLocationsL),this.srcPoints[0]=Y.handLocationComposer(t,s,n,!0,!1),this.srcPoints[1]=Y.handLocationComposer(t,s,n,!0,!0),this.dstPoints[0]=Y.handLocationComposer(t,i,!n,!1,!1),this.dstPoints[1]=Y.handLocationComposer(t,i,!n,!1,!0),this.srcPoints[0]||(this.srcPoints[0]=s["2_TIP"]),this.dstPoints[0]||(this.dstPoints[0]=i["2_TIP"]);let a=parseFloat(t.distance);return isNaN(a)?this.distanceVec.set(0,0,0):(A(t.distanceDirection,this.distanceVec,0,!0)||(this.srcCurOffset==this.curOffsetR?this.distanceVec.set(-1,0,0):this.distanceVec.set(1,0,0)),this.distanceVec.normalize(),this.distanceVec.multiplyScalar(a*this.worldArmSize)),this.start=t.start,this.attackPeak=t.attackPeak,this.relax=t.relax,this.end=t.end,this.time=0,this.transition=!0,!0}}u.HandConstellation=Y;class X{constructor(t,e,s=!1){this.skeleton=e,this.isLeftHand=!!s,this.config=t,this.defValue=0,this.trgValue=0,this.srcValue=0,this.curValue=0,this.time=0,this.start=0,this.attackPeak=0,this.relax=0,this.end=0,this.transition=!1,this.reset()}reset(){this.transition=!1,this.defValue=0,this.curValue=0}update(t){if(this.transition&&(this.time+=t,!(this.time<this.start)))if(this.time>this.attackPeak&&this.time<this.relax)this.curValue=this.trgValue;else{if(this.time<=this.attackPeak){let t=(this.time-this.start)/(this.attackPeak-this.start);return t>1&&(t=1),t=.5*Math.sin(Math.PI*t-.5*Math.PI)+.5,void(this.curValue=this.srcValue*(1-t)+this.trgValue*t)}if(this.time>=this.relax){let t=(this.time-this.relax)/(this.end-this.relax);t>1&&(t=1),t=.5*Math.sin(Math.PI*t-.5*Math.PI)+.5,this.curValue=this.trgValue*(1-t)+this.defValue*t,this.time>this.end&&(this.transition=!1)}}}newGestureBML(t,e,s,i,n,a=!1){return!isNaN(t)&&null!=t&&(this.srcValue=this.curValue,this.trgValue=t,a&&(this.defValue=this.trgValue),this.start=e,this.attackPeak=s,this.relax=i,this.end=n,this.time=0,this.transition=!0,!0)}}class Z extends X{newGestureBML(t){let e=parseFloat(t.elbowRaise)*(90*Math.PI/180);return super.newGestureBML(e,t.start,t.attackPeak,t.relax,t.end,t.shift)}}u.ElbowRaise=Z;class $ extends X{newGestureBML(t){let e=parseFloat(t.shoulderRaise)*(30*Math.PI/180);return super.newGestureBML(e,t.start,t.attackPeak,t.relax,t.end,t.shift)}}u.ShoulderRaise=$;class tt extends X{newGestureBML(t){let e=parseFloat(t.shoulderHunch)*(30*Math.PI/180);return super.newGestureBML(e,t.start,t.attackPeak,t.relax,t.end,t.shift)}}u.ShoulderHunch=tt;class et{constructor(e,s){this.config=e,this.skeleton=s,this.tiltFB=[],this.tiltLR=[],this.rotateLR=[],this.transition=!1,this._tempQ_0=new t.Quaternion,this.jointsData={},this.jointsData.shouldersUnion=this.computeJointData(this.config.boneMap.ShouldersUnion,this.config.boneMap.Neck),this.jointsData.stomach=this.computeJointData(this.config.boneMap.Stomach,this.config.boneMap.ShouldersUnion),this.jointsData.belowStomach=this.computeJointData(this.config.boneMap.BelowStomach,this.config.boneMap.Stomach)}computeJointData(e,s){let i=new t.Quaternion;b(this.skeleton,e,i);let n=new t.Vector3,a=new t.Vector3,r=new t.Vector3;r.setFromMatrixPosition(this.skeleton.boneInverses[e].clone().invert()),a.setFromMatrixPosition(this.skeleton.boneInverses[s].clone().invert()),a.subVectors(a,r);let o=(new t.Matrix3).setFromMatrix4(this.skeleton.boneInverses[e]);return a.applyMatrix3(o).normalize(),r.copy(this.config.axes[2]).applyMatrix3(o).normalize(),n.crossVectors(a,r).normalize(),r.crossVectors(n,a).normalize(),{idx:e,lastFrameQuat:new t.Quaternion,bindQuat:i,beforeBindAxes:[n,a,r]}}reset(){this.transition=!1,this.tiltFB=[],this.tiltLR=[],this.rotateLR=[],this.forceBindPose()}forceBindPose(){for(let t in this.jointsData)this.skeleton.bones[this.jointsData[t].idx].quaternion.copy(this.jointsData[t].bindQuat)}forceLastFramePose(){for(let t in this.jointsData)this.skeleton.bones[this.jointsData[t].idx].quaternion.copy(this.jointsData[t].lastFrameQuat)}update(t,e,s,i){if(!this.transition)return;let n=!1,a=0;for(let e=0;e<this.tiltFB.length;++e){let s=this.tiltFB[e];s.update(t),s.transition||(this.tiltFB.splice(e,1),--e),a+=s.curValue,n|=s.transition}let r=0;for(let e=0;e<this.tiltLR.length;++e){let s=this.tiltLR[e];s.update(t),s.transition||(this.tiltLR.splice(e,1),--e),r+=s.curValue,n|=s.transition}let o=0;for(let e=0;e<this.rotateLR.length;++e){let s=this.rotateLR[e];s.update(t),s.transition||(this.rotateLR.splice(e,1),--e),o+=s.curValue,n|=s.transition}this.transition=n;let l=this._tempQ_0;for(let t in this.jointsData){let e=this.jointsData[t],s=this.skeleton.bones[e.idx];s.quaternion.setFromAxisAngle(e.beforeBindAxes[1],.3333*o),l.setFromAxisAngle(e.beforeBindAxes[0],.3333*a),s.quaternion.premultiply(l),l.setFromAxisAngle(e.beforeBindAxes[2],.3333*r),s.quaternion.premultiply(l),s.quaternion.premultiply(e.bindQuat),s.quaternion.normalize(),this.jointsData[t].lastFrameQuat.copy(s.quaternion)}}newGestureBML(t){let e=parseFloat(t.amount);isNaN(e)&&(e=1),e=15*e*Math.PI/180;let s=null;switch(t.bodyMovement){case"TILT_LEFT":case"TL":e*=-1;case"TILT_RIGHT":case"TR":s=this.tiltLR;break;case"TILT_BACKWARD":case"TB":e*=-1;case"TILT_FORWARD":case"TF":s=this.tiltFB;break;case"ROTATE_RIGHT":case"RR":e*=-1;case"ROTATE_LEFT":case"RL":s=this.rotateLR}if(s){let i=new X(this.config,this.skeleton);i.newGestureBML(e,t.start,t.attackPeak,t.relax,t.end),s.push(i),this.transition=!0}return!0}}u.BodyMovement=et;class st{constructor(e,s,i){this.character=e,this.skeleton=s,this.computeConfig(i),S(this.skeleton,!0),this.character.updateWorldMatrix(!0,!0),this.right=this._createArm(!1),this.left=this._createArm(!0),this.handConstellation=new Y(this.config.boneMap,this.skeleton,this.config.handLocationsR,this.config.handLocationsL),this.bodyMovement=new et(this.config,this.skeleton),this.dominant=this.right,this.nonDominant=this.left,this._tempQ_0=new t.Quaternion,this._tempQ_1=new t.Quaternion,this._tempV3_0=new t.Vector3,this._tempV3_1=new t.Vector3,this.foreArmFactor=.6}computeConfig(e){if(this.config=e.bodyController,this.config.boneMap=e.boneMap,this.config.axes)for(let e=0;e<this.config.axes.length;++e)this.config.axes[e]=new t.Vector3(this.config.axes[e].x,this.config.axes[e].y,this.config.axes[e].z);else{this.config.axes=[new t.Vector3,new t.Vector3,new t.Vector3];let e=this.config.boneMap;this.skeleton.bones[e.Hips].updateWorldMatrix(!0,!0);let s=(new t.Vector3).setFromMatrixPosition(this.skeleton.boneInverses[e.LShoulder].clone().invert()),i=(new t.Vector3).setFromMatrixPosition(this.skeleton.boneInverses[e.RShoulder].clone().invert());this.config.axes[0].subVectors(s,i).normalize(),s=s.setFromMatrixPosition(this.skeleton.boneInverses[e.BelowStomach].clone().invert()),i=i.setFromMatrixPosition(this.skeleton.boneInverses[e.Hips].clone().invert()),this.config.axes[1].subVectors(s,i).normalize(),this.config.axes[2].crossVectors(this.config.axes[0],this.config.axes[1]).normalize(),this.config.axes[1].crossVectors(this.config.axes[2],this.config.axes[0]).normalize()}function s(e,s,i=!1){let n={};for(let a in e){let r=e[a],o=x(s,i?r[0].replace("Right","Left"):r[0]);if(o<0)continue;let l=new t.Object3D;if(l.position.copy(r[1]).applyMatrix4(s.boneInverses[o]),r[2]){let e=new t.Matrix3;e.setFromMatrix4(s.boneInverses[o]),l.direction=(new t.Vector3).copy(r[2]).applyMatrix3(e)}l.name=a,s.bones[o].add(l),n[a]=l}return n}this.config.bodyLocations=s(this.config.bodyLocations,this.skeleton,!1),this.config.handLocationsL=s(this.config.handLocationsL?this.config.handLocationsL:this.config.handLocationsR,this.skeleton,!this.config.handLocationsL),this.config.handLocationsR=s(this.config.handLocationsR,this.skeleton,!1);let i={elbowRaise:0,shoulderRaise:[0,-5*Math.PI/180,45*Math.PI/180],shoulderHunch:[0,-10*Math.PI/180,55*Math.PI/180]};if("number"==typeof this.config.elbowRaise&&(i.elbowRaise=this.config.elbowRaise*Math.PI/180),Array.isArray(this.config.shoulderRaise)){for(let t=0;t<3&&t<this.config.shoulderRaise.length;++t)i.shoulderRaise[t]=this.config.shoulderRaise[t]*Math.PI/180;i.shoulderRaise[1]>0&&(i.shoulderRaise[1]=0),i.shoulderRaise[2]<0&&(i.shoulderRaise[2]=0)}if(Array.isArray(this.config.shoulderHunch)){for(let t=0;t<3&&t<this.config.shoulderHunch.length;++t)i.shoulderHunch[t]=this.config.shoulderHunch[t]*Math.PI/180;i.shoulderHunch[1]>0&&(i.shoulderHunch[1]=0),i.shoulderHunch[2]<0&&(i.shoulderHunch[2]=0)}this.config.elbowRaise=i.elbowRaise,this.config.shoulderRaise=i.shoulderRaise,this.config.shoulderHunch=i.shoulderHunch;let n=[[[0,45*Math.PI/180]],[[0,20*Math.PI/180],[0,.5*Math.PI],[0,.6*Math.PI],[0,.5*Math.PI]],[[0,20*Math.PI/180],[0,.5*Math.PI],[0,.6*Math.PI],[0,.5*Math.PI]],[[0,20*Math.PI/180],[0,.5*Math.PI],[0,.6*Math.PI],[0,.5*Math.PI]],[[0,20*Math.PI/180],[0,.5*Math.PI],[0,.6*Math.PI],[0,.5*Math.PI]]];if(Array.isArray(this.config.fingerAngleRanges)){let t=this.config.fingerAngleRanges;for(let e=0;e<n.length&&e<t.length;++e){let s=n[e],i=t[e];if(Array.isArray(i))for(let t=0;t<s.length&&t<i.length;++t){let e=s[t],n=i[t];if(!Array.isArray(n)||n.length<2)continue;let a=n[0]*Math.PI/180;e[0]=isNaN(a)?e[0]:a,a=n[1]*Math.PI/180,e[1]=isNaN(a)?e[1]:a}}}this.config.fingerAngleRanges=n}_createArm(e=!1){return{loc:new H(this.config,this.skeleton,e),locMotions:[],extfidirPalmor:new V(this.config,this.skeleton,e),wristMotion:new J(this.config,this.skeleton,e),handshape:new U(this.config,this.skeleton,e),fingerplay:new K,elbowRaise:new Z(this.config,this.skeleton,e),shoulderRaise:new $(this.config,this.skeleton,e),shoulderHunch:new tt(this.config,this.skeleton,e),needsUpdate:!1,ikSolver:new F(this.skeleton,this.config,e),locUpdatePoint:new t.Vector3(0,0,0),_tempWristQuat:new t.Quaternion(0,0,0,1)}}_resetArm(t){t.loc.reset(),t.locMotions=[],t.wristMotion.reset(),t.handshape.reset(),t.fingerplay.reset(),t.elbowRaise.reset(),t.shoulderRaise.reset(),t.shoulderHunch.reset(),t.locUpdatePoint.set(0,0,0),t.needsUpdate=!1,t.extfidirPalmor.reset()}reset(){this.bodyMovement.reset(),this.handConstellation.reset(),this._resetArm(this.right),this._resetArm(this.left),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,locationBodyArm:"neutral",hand:"RIGHT",distance:.0251,srcContact:"HAND_PALMAR",shift:!0}),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,locationBodyArm:"neutral",hand:"LEFT",distance:.0251,srcContact:"HAND_PALMAR",shift:!0}),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,handshape:"FLAT",mainBend:"ROUND",tco:.5,thumbshape:"TOUCH",hand:"RIGHT",shift:!0}),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,handshape:"FLAT",mainBend:"ROUND",tco:.75,thumbshape:"TOUCH",hand:"LEFT",shift:!0}),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,palmor:"l",hand:"RIGHT",shift:!0}),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,palmor:"r",hand:"LEFT",shift:!0}),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,extfidir:"dl",hand:"RIGHT",mode:"local",shift:!0}),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,extfidir:"dr",hand:"LEFT",mode:"local",shift:!0}),this.newGesture({type:"gesture",start:0,attackPeak:.1,relax:.2,end:.3,handConstellation:!0,hand:"right",srcContact:"2_mid_palmar",secondSrcContact:"2_pad_palmar",dstContact:"hand_ulnar"}),this.update(.15),this.left.loc.def.copy(this.left.locUpdatePoint),this.right.loc.def.copy(this.right.locUpdatePoint),this.update(1)}setDominantHand(t){t?(this.dominant=this.right,this.nonDominant=this.left):(this.dominant=this.left,this.nonDominant=this.right)}_updateLocationMotions(t,e){let s=!1,i=e.locMotions,n=e.locUpdatePoint;n.set(0,0,0);for(let e=0;e<i.length;++e)i[e].transition?(s=!0,n.add(i[e].update(t))):(i.splice(e,1),e--);return s}_updateArm(t,e){let s=this.skeleton.bones;s[e.loc.idx.shoulder].quaternion.set(0,0,0,1),s[e.loc.idx.arm].quaternion.set(0,0,0,1),s[e.loc.idx.elbow].quaternion.set(0,0,0,1),e.fingerplay.update(t),e.handshape.update(t,e.fingerplay.transition?e.fingerplay.curBends:null),e.extfidirPalmor.update(t),e.wristMotion.update(t),e._tempWristQuat.copy(e.extfidirPalmor.wristBone.quaternion),e.loc.update(t);let i=this._updateLocationMotions(t,e);e.elbowRaise.update(t),e.shoulderRaise.update(t),e.shoulderHunch.update(t),e.needsUpdate=i|e.fingerplay.transition|e.handshape.transition|e.wristMotion.transition|e.extfidirPalmor.transition|e.loc.transition|e.elbowRaise.transition|e.shoulderRaise.transition|e.shoulderHunch.transition}update(t){(this.bodyMovement.transition||this.right.needsUpdate||this.left.needsUpdate||this.handConstellation.transition)&&(this.bodyMovement.forceBindPose(),this._updateArm(t,this.right),this._updateArm(t,this.left),this.handConstellation.transition&&(this.right.ikSolver.reachTarget(this.right.loc.cur.p,this.right.elbowRaise.curValue,this.right.shoulderRaise.curValue,this.right.shoulderHunch.curValue,!1),this.left.ikSolver.reachTarget(this.left.loc.cur.p,this.left.elbowRaise.curValue,this.left.shoulderRaise.curValue,this.left.shoulderHunch.curValue,!1),this._fixArmQuats(this.right,!1),this._fixArmQuats(this.left,!1),this.handConstellation.update(t),this.right.locUpdatePoint.add(this.handConstellation.curOffsetR),this.left.locUpdatePoint.add(this.handConstellation.curOffsetL)),this.right.locUpdatePoint.add(this.right.loc.cur.p),this.right.locUpdatePoint.add(this.right.loc.cur.offset),this.right.ikSolver.reachTarget(this.right.locUpdatePoint,this.right.elbowRaise.curValue,this.right.shoulderRaise.curValue,this.right.shoulderHunch.curValue,!0),this.left.locUpdatePoint.add(this.left.loc.cur.p),this.left.locUpdatePoint.add(this.left.loc.cur.offset),this.left.ikSolver.reachTarget(this.left.locUpdatePoint,this.left.elbowRaise.curValue,this.left.shoulderRaise.curValue,this.left.shoulderHunch.curValue,!0),this._fixArmQuats(this.right,!0),this._fixArmQuats(this.left,!0),this.bodyMovement.update(t))}_fixArmQuats(t,e=!1){let s=this._tempQ_0;this._tempQ_1;let i=this.skeleton.bones,n=t.extfidirPalmor.twistAxisForearm,a=t.extfidirPalmor.forearmBone.quaternion,r=t.extfidirPalmor.twistAxisWrist,o=t.extfidirPalmor.wristBone.quaternion;if(s.copy(i[t.loc.idx.shoulder].quaternion),s.multiply(i[t.loc.idx.arm].quaternion),s.multiply(i[t.loc.idx.elbow].quaternion),s.invert(),o.copy(t._tempWristQuat).premultiply(s),!e)return;let l=this._tempV3_0;l.copy(t.extfidirPalmor.elevationAxis),g(o,r,s),l.applyQuaternion(s),g(t.ikSolver.bindQuats.wrist,r,s),l.applyQuaternion(s.invert());let h=Math.acos(l.dot(t.extfidirPalmor.elevationAxis));this._tempV3_1.crossVectors(t.extfidirPalmor.elevationAxis,l),this._tempV3_1.dot(t.extfidirPalmor.twistAxisWrist)<0&&(h*=-1),t==this.right&&h<-2.61&&(h=2*Math.PI+h),t==this.left&&h>2.61&&(h=2*-Math.PI+h),h*=this.foreArmFactor,s.setFromAxisAngle(n,h),a.multiply(s),o.premultiply(s.invert())}_newGestureArm(t,e,s=0){if(t.locationBodyArm&&(e.loc.newGestureBML(t,s,e.locUpdatePoint),e.locMotions=[],this.handConstellation.cancelArm(e==this.right?"R":"L")),t.motion){let i=null,n="string"==typeof t.motion?t.motion.toUpperCase():"";"FINGERPLAY"==n?i=e.fingerplay:"WRIST"==n?i=e.wristMotion:"DIRECTED"==n?(i=new q,e.locMotions.push(i)):"CIRCULAR"==n&&(i=new Q,e.locMotions.push(i)),i&&i.newGestureBML(t,s)}(t.palmor||t.extfidir)&&e.extfidirPalmor.newGestureBML(t,s),t.handshape&&e.handshape.newGestureBML(t,s),t.hasOwnProperty("shoulderRaise")&&e.shoulderRaise.newGestureBML(t,s),t.hasOwnProperty("shoulderHunch")&&e.shoulderHunch.newGestureBML(t,s),t.hasOwnProperty("elbowRaise")&&e.elbowRaise.newGestureBML(t,s),e.needsUpdate=!0}newGesture(t){t.start=t.start||0,t.end=t.end||t.relax||t.attackPeak||t.start+1,t.attackPeak=t.attackPeak||.25*(t.end-t.start)+t.start,t.relax=t.relax||.5*(t.end-t.attackPeak)+t.attackPeak;let e=!!t.lrSym;if(e|=!!t.udSym<<1,e|=!!t.ioSym<<2,"string"==typeof t.hand&&(t.hand=t.hand.toUpperCase()),t.config){let e=t.config;e.dominant&&this.setDominantHand("RIGHT"==e.dominant),e.handshapeBendRange&&(this.left.handshape.setBendRange(handshapeBendRange),this.right.handshape.setBendRange(handshapeBendRange))}switch(t.handConstellation&&this.handConstellation.newGestureBML(t,this.dominant==this.right?"R":"L"),t.bodyMovement&&this.bodyMovement.newGestureBML(t),t.hand){case"RIGHT":this._newGestureArm(t,this.right,this.dominant==this.right?0:e);break;case"LEFT":this._newGestureArm(t,this.left,this.dominant==this.left?0:e);break;case"BOTH":this._newGestureArm(t,this.dominant,0),this._newGestureArm(t,this.nonDominant,e);break;case"NON_DOMINANT":this._newGestureArm(t,this.nonDominant,e);break;default:this._newGestureArm(t,this.dominant,0)}}}u.BodyController=st,window.SpeechRecognition=window.webkitSpeechRecognition||window.SpeechRecognition;u.CharacterController=class{static WAITING=0;static PROCESSING=1;static SPEAKING=2;static LISTENING=3;constructor(t){this.time=0,this.character=t.character,this.characterConfig=t.characterConfig,this.skeleton=null,t.skeleton?this.skeleton=t.skeleton:this.character.traverse(t=>{t.isSkinnedMesh&&(this.skeleton=t.skeleton)}),t.skeleton=this.skeleton;for(let t in this.characterConfig.boneMap)this.characterConfig.boneMap[t]=x(this.skeleton,this.characterConfig.boneMap[t]);void 0!==T?this.BehaviourManager=new T:console.error("Manager not included"),void 0!==k?(this.BehaviourPlanner=new k,this.BehaviourPlanner.BehaviourManager=this.BehaviourManager):console.error("Planner not included"),void 0!==O?this.facialController=new O(t):console.error("FacialController module not found"),void 0!==st&&(this.bodyController=new st(this.character,this.skeleton,this.characterConfig)),this.automaticFlags={blink:!0,browRaise:!0}}setAutomaticFlags(t){t&&(t.hasOwnProperty("autoBlink")&&(this.automaticFlags.blink=!!t.autoBlink,this.facialController&&this.facialController.autoBlink&&this.facialController.autoBlink.setAuto(this.automaticFlags.blink)),t.hasOwnProperty("autoBrowRaise")&&(this.automaticFlags.browRaise=!!t.autoBrowRaise))}start(t){this.pendingResources=[],this.facialController&&this.facialController.start(t),this.setAutomaticFlags(t)}reset(t=!1){this.pendingResources.length=0,this.facialController&&this.facialController.reset(t),this.BehaviourPlanner&&this.BehaviourPlanner.reset(),this.BehaviourManager&&this.BehaviourManager.reset(),this.bodyController&&this.bodyController.reset(),this.endSpeakingTime=-1,this.speaking=!1}update(t,e){let s=null;this.time=e,this.facialController&&this.facialController.update(t),this.bodyController&&this.bodyController.update(t),this.BehaviourPlanner&&(s=this.BehaviourPlanner.update(t)),this.BehaviourManager&&this.BehaviourManager.update(this.processBML.bind(this),e),s&&this.automaticFlags.browRaise&&this.BehaviourManager.newBlock(s,e),this.facialController&&(this.BehaviourManager.lgStack.length&&this.BehaviourManager.time<=this.BehaviourManager.lgStack[this.BehaviourManager.lgStack.length-1].endGlobalTime?(this.endSpeakingTime=this.BehaviourManager.lgStack[this.BehaviourManager.lgStack.length-1].endGlobalTime+1,this.speaking=!0):this.endSpeakingTime>-1&&this.BehaviourManager.time<=this.endSpeakingTime||this.facialController.lipsyncModule.working?this.speaking=!0:(this.endSpeakingTime=-1,this.speaking=!1))}processMsg(t,e){if(!t)return;if(!this.BehaviourManager)return;this.BehaviourManager.update(this.processBML.bind(this),this.time),"string"==typeof t&&(t=JSON.parse(t)),"behaviours"==t.type&&(t=t.data);let s={};if(t.constructor==Array){let e=-1e6,i=1e6;for(let n=0;n<t.length;n++)"info"!=t[n].type&&(!t[n].end&&t[n].duration&&(t[n].end=t[n].start+t[n].duration,t[n].attackPeak&&(t[n].attackPeak+=t[n].start),t[n].ready&&(t[n].ready+=t[n].start),t[n].strokeStart&&(t[n].strokeStart+=t[n].start),t[n].stroke&&(t[n].stroke+=t[n].start),t[n].strokeEnd&&(t[n].strokeEnd+=t[n].start),t[n].relax&&(t[n].relax+=t[n].start)),s[t[n].type]||(s[t[n].type]=[]),s[t[n].type].push(t[n]),t[n].end>e&&(e=t[n].end),t[n].start<i&&(i=t[n].start));s.start=i,s.end=e,s.composition||(s.composition="MERGE"),s.speech&&(s.speech.constructor==Object||s.speech.length)&&(s.control=this.SPEAKING),this.BehaviourPlanner&&this.BehaviourPlanner.newBlock(s),this.BehaviourManager.newBlock(s,this.time)}else if(t.constructor==Object){if(s=t,"state"!=t.type&&"control"!=t.type||!t.parameters){if("info"==t.type)return}else s.control=this[t.parameters.state.toUpperCase()];s.speech&&(s.speech.constructor==Object||s.speech.length)&&(s.control=this.SPEAKING),this.BehaviourPlanner&&this.BehaviourPlanner.newBlock(s),this.BehaviourManager.newBlock(s,this.time)}if(e&&(s.fromWS=e),s.clientId&&!this.ws.id)return this.ws.id=s.clientId,void console.log("Client ID: ",s.clientId);if(s.lg){if(this.loadAudio(s))return this.pendingResources.push(s),void console.log("Needs to preload audio files.")}s?this.BehaviourManager&&(this.BehaviourManager.update(this.processBML.bind(this),this.time),s||console.error("An undefined block has been created due to the update of BMLManager.",s)):console.error("An undefined msg has been received.",s)}processBML(t,e){if(!this.facialController&&"gesture"!=t||!this.bodyController&&"gesture"==t)return;let s=this.facialController;switch(t){case"blink":s.newBlink(e);break;case"gaze":s.newGaze(e,!!e.shift);break;case"gazeShift":s.newGaze(e,!0);break;case"head":s.newHeadBML(e);break;case"headDirectionShift":s.headDirectionShift(e);break;case"face":case"faceLexeme":case"faceEmotion":case"faceVA":s.newFA(e,!!e.shift);break;case"faceFACS":s.newFA(e,!1);break;case"faceShift":s.newFA(e,!0);break;case"speech":e.phT&&(e.phT=new Float32Array(Object.values(e.phT))),s.newTextToLip(e);break;case"gesture":this.bodyController.newGesture(e);break;case"animation":break;case"lg":s.newLipsync(e)}}loadAudio(t){let e=!1;if(t.lg.constructor===Array)for(let s=0;s<t.lg.length;s++)t.lg[s].audio||(t.lg[s].audio=new Audio,t.lg[s].audio.src=t.lg[s].url,e=!0);else t.lg.audio||(t.lg.audio=new Audio,t.lg.audio.src=t.lg.url,e=!0);return e}};const it=.25,nt=.25,at=.25,rt=.3,ot=.3,lt=.3,ht=.3,ct=.5,dt=.8,pt=.8,mt=.3,ut=.5,ft=.5;function gt(t,e=0){let s=new DOMParser,i=null,n=[],a=e=isNaN(e)?0:e;try{i=s.parseFromString(t,"text/xml").children[0]}catch(t){return{data:[],duration:0,relaxEndDuration:0}}let r=0,o=0;for(let t=0;t<i.children.length;++t){if("hns_sign"!=i.children[t].tagName&&"hamgestural_sign"!=i.children[t].tagName)continue;a=a-r-o+.2,a-=.2;let e=At(i.children[t],a);a=e.end,n=n.concat(e.data),r=e.relaxEndDuration,o=e.peakRelaxDuration}return{data:n,duration:a-e,relaxEndDuration:r,peakRelaxDuration:o}}function At(t,e){let s=[],i=e,n=0,a=0,r={};for(let e=0;e<t.attributes.length;++e)r[t.attributes[e].name]=t.attributes[e].value;let o=parseFloat(r.speed);o=isNaN(o)?1:o;let l=null,h=null;for(let s=0;s<t.children.length;++s)h||"sign_nonmanual"!=t.children[s].tagName||(h=Nt(t.children[s],e,o),i<h.end&&(i=h.end)),l||"sign_manual"!=t.children[s].tagName||(l=_t(t.children[s],e,o),a=l.peakRelaxDuration,n=l.relaxEndDuration,i<l.end&&(i=l.end));return l&&(s=s.concat(l.data)),h&&(s=s.concat(h.data)),r.gloss&&s.unshift({gloss:r.gloss}),{data:s,end:i,relaxEndDuration:n,peakRelaxDuration:a}}let yt=["directedmotion","circularmotion","wristmotion","crossmotion","fingerplay","changeposture","nomotion"],xt=yt.concat(["nonman_motion","par_motion","seq_motion","split_motion","rpt_motion","tgt_motion"]),bt=["handconfig","split_handconfig","location_bodyarm","split_location","location_hand","handconstellation","use_locname"];function St(t,e=null,s=0){if(e||(e=[0,0,0]),e.fill(0),"string"!=typeof t)return e;t=t.toUpperCase(),e[0]=t.split("L").length-t.split("R").length,e[1]=t.split("U").length-t.split("D").length,e[2]=t.split("O").length-t.split("I").length,1&s&&(e[0]*=-1),2&s&&(e[1]*=-1),4&s&&(e[2]*=-1);let i=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return i<1e-4&&e.fill(0),e[0]/=i,e[1]/=i,e[2]/=i,e}function Lt(t,e,s=!1){let i;i=t?s?t:JSON.parse(JSON.stringify(t)):{RIGHT:[{type:"gesture",start:-1,locationBodyArm:"CHEST",secondLocationBodyArm:"STOMACH",hand:"RIGHT",distance:.37,side:"r",srcLocation:"HAND",srcSide:"PALMAR"},{type:"gesture",start:-1,extfidir:"dl",hand:"RIGHT"},{type:"gesture",start:-1,palmor:"l",hand:"RIGHT"},{type:"gesture",start:-1,handshape:"FLAT",hand:"RIGHT"}],LEFT:[{type:"gesture",start:-1,locationBodyArm:"CHEST",secondLocationBodyArm:"STOMACH",hand:"LEFT",distance:.37,side:"l",srcLocation:"HAND",srcSide:"PALMAR"},{type:"gesture",start:-1,extfidir:"dr",hand:"LEFT"},{type:"gesture",start:-1,palmor:"r",hand:"LEFT"},{type:"gesture",start:-1,handshape:"FLAT",hand:"LEFT"}],handConstellation:null};let n="RIGHT";for(;;){for(let t=0;t<e.length;++t){let s=e[t],a=-1;s.locationBodyArm?a=0:s.extfidir?a=1:s.palmor?a=2:s.handshape?a=3:s.handConstellation&&(a=4),a>-1&&a<4?(s.hand==n||"BOTH"==s.hand)&&i[n][a].start<s.start&&(i[n][a]=JSON.parse(JSON.stringify(s)),i[n][a].hand=n,delete i[n][a].attackPeak,delete i[n][a].relax,delete i[n][a].end):4==a&&(!i.handConstellation||i.handConstellation.start<s.start)&&(i.handConstellation=JSON.parse(JSON.stringify(s)),delete i.handConstellation.attackPeak,delete i.handConstellation.relax,delete i.handConstellation.end)}if("RIGHT"!=n)break;n="LEFT"}return i}function _t(t,e,s){let i=[],n=e,a=t.children;if(!a.length)return{data:[],end:e,peakRelaxDuration:0,relaxEndDuration:0};let r={};for(let e=0;e<t.attributes.length;++e)r[t.attributes[e].name]=t.attributes[e].value;const o={domHand:"RIGHT",nonDomHand:"LEFT",bothHands:!1,symmetry:0,outofphase:!1};o.bothHands="true"==r.both_hands,o.bothHands||"true"!=r.nondominant||(o.domHand="LEFT"),o.nonDomHand="RIGHT"==o.domHand?"LEFT":"RIGHT";let l="true"==r.lr_symm,h="true"==r.oi_symm,c="true"==r.ud_symm;o.symmetry=l|c<<1|h<<2,o.outofphase="true"==r.outofphase;let d=!1;i.push({type:"gesture",config:{dominant:o.domHand}});let p=Lt(null,[]);if("sign_manual"==a[0].tagName){let t=0,e=0;for(let r=0;r<a.length;++r){let o=a[r];if("sign_manual"==a[r].tagName){n=n-.8*t-e;let a=_t(o,n,s);i=i.concat(a.data),t=a.peakRelaxDuration,e=a.relaxEndDuration,n<a.end&&(n=a.end)}}return{data:i,end:n,peakRelaxDuration:t,relaxEndDuration:e}}for(let t=0;t<a.length;++t){let e=a[t],r=a[t].tagName;if(!d&&bt.includes(r)){let t=kt(e,n,o.bothHands?"BOTH":o.domHand,o.symmetry,s,o,p);i=i.concat(t.data),p=Lt(p,t.data)}if(xt.includes(r)){!d&&i.length>1&&(n+=ot/s),d=!0;let t=vt(e,n,o.bothHands?"BOTH":o.domHand,o.symmetry,s,o,p);i=i.concat(t.data),n<t.end&&(n=t.end),p=Lt(p,t.data)}}!d&&i.length>1&&(n+=ot/s);let m=function(t){let e="RIGHT",s={};for(;;){let i={isHandUsed:!1,firstHandUsage:9999999999999,firstLocationBody:9999999999999,usage:[!1,!1,!1,!1]};t||(t=[]);for(let s=0;s<t.length;++s){if("BOTH"!=t[s].hand&&t[s].hand!=e)continue;i.isHandUsed=!0;let n=t[s];n.start<i.firstHandUsage&&!n.locationBodyArm&&(i.firstHandUsage=n.start),n.start<i.firstLocationBody&&n.locationBodyArm&&(i.firstLocationBody=n.start),(n.locationBodyArm||n.handConstellation)&&(i.usage[0]=!0),n.extfidir&&(i.usage[1]=!0),n.palmor&&(i.usage[2]=!0),n.handshape&&(i.usage[3]=!0)}if(s[e]=i,"RIGHT"!=e)break;e="LEFT"}return s}(i);m.RIGHT.isHandUsed&&m.RIGHT.firstHandUsage+.05<m.RIGHT.firstLocationBody&&i.unshift({type:"gesture",start:e-1e-4,attackPeak:e+ot/s,locationBodyArm:"CHEST",secondLocationBodyArm:"STOMACH",hand:"RIGHT",distance:.37,side:"r",srcLocation:"HAND",srcSide:"PALMAR"}),m.LEFT.isHandUsed&&m.LEFT.firstHandUsage+.05<m.LEFT.firstLocationBody&&i.unshift({type:"gesture",start:e-1e-4,attackPeak:e+ot/s,locationBodyArm:"CHEST",secondLocationBodyArm:"STOMACH",hand:"LEFT",distance:.37,side:"l",srcLocation:"HAND",srcSide:"PALMAR"});let u=ft;n+=u;for(let t=0;t<i.length;++t)if((i[t].extfidir||i[t].palmor||i[t].handshape||i[t].locationBodyArm||i[t].handConstellation)&&(isNaN(i[t].relax)&&(i[t].relax=n),isNaN(i[t].end)&&(i[t].end=n+ut)),"DIRECTED"!=i[t].motion&&"CIRCULAR"!=i[t].motion||(isNaN(i[t].relax)&&(i[t].relax=n),isNaN(i[t].end)&&(i[t].end=n+ut)),"WRIST"==i[t].motion||"FINGERPLAY"==i[t].motion){let e=.15*(i[t].end-i[t].start);i[t].attackPeak=i[t].start+(e<.15?e:.15),isNaN(i[t].relax)&&(i[t].relax=i[t].end-(e<.15?e:.15))}return n+=ut,{data:i,end:n,peakRelaxDuration:u,relaxEndDuration:ut}}function kt(t,e,s,i,n,a,r=null){let o=[],l=t.tagName,h=0,c=e;if("handconfig"==l)o=o.concat(Tt(t,c,c+lt/n,s,i,a)),h=lt/n;else if("split_handconfig"==l)t.children.length>0&&"handconfig"==t.children[0].tagName&&(o=o.concat(Tt(t.children[0],c,c+lt/n,a.domHand,0,a)),h=lt/n),t.children.length>1&&"handconfig"==t.children[1].tagName&&(o=o.concat(Tt(t.children[1],c,c+lt/n,a.nonDomHand,0,a)),h=lt/n);else if("location_bodyarm"==l)o=o.concat(Mt(t,c,c+ot/n,s,i,a,r)),h=ot/n;else if("split_location"==l){t.children.length>0&&"location_bodyarm"==t.children[0].tagName&&(o=o.concat(Mt(t.children[0],c-1e-6,c+ot/n,a.domHand,0,a,r)),h=ot/n),t.children.length>1&&"location_bodyarm"==t.children[1].tagName&&(o=o.concat(Mt(t.children[1],c-1e-6,c+ot/n,a.nonDomHand,0,a,r)),h=ot/n);let e=null,s=null;if(t.children.length>0&&"location_hand"==t.children[0].tagName&&(e=Ct(t.children[0],!0)),t.children.length>1&&"location_hand"==t.children[1].tagName&&(s=Ct(t.children[1],!0)),e||s){let t={type:"gesture",start:c,attackPeak:c+ot/n,handConstellation:"true"};if(e&&s)t.hand="BOTH",t.dstLocation=e.location,t.dstSide=e.side,t.dstFinger=e.finger,t.srcLocation=s.location,t.srcSide=s.side,t.srcFinger=s.finger;else{let i=e||s;t.hand=e?a.domHand:a.nonDomHand,t.dstLocation=i.location,t.dstSide=i.side,t.dstFinger=i.finger,i.child&&(t.srcLocation=i.child.location,t.srcSide=i.child.side,t.srcFinger=i.child.finger)}o.push(t),h=ot/n}}else"handconstellation"==l?(o=o.concat(function(t,e,s,i,n,a){let r={};for(let e=0;e<t.attributes.length;++e)r[t.attributes[e].name]=t.attributes[e].value;let o={type:"gesture",start:e,attackPeak:s,hand:i,handConstellation:"true"};"touch"==r.contact?o.distance=0:"close"==r.contact?o.distance=.2:"armextended"==r.contact?o.distance=.5:o.distance=0;let l=null,h=0;for(let i=0;i<t.children.length&&i<3;++i){let r=t.children[i];if("location_bodyarm"==r.tagName){l=Mt(r,e-1e-7,s,"BOTH",0,n,a),l=l&&l.length>0?l[0]:null;break}if("location_hand"==r.tagName){let t=Ct(r,!1);0==i?(t.location&&(o.dstLocation=t.location),t.side&&(o.dstSide=t.side),t.finger&&(o.dstFinger=t.finger),t.secondLocation&&(o.secondDstLocation=t.secondLocation),t.secondSide&&(o.secondDstSide=t.secondSide),t.secondFinger&&(o.secondDstFinger=t.secondFinger),h++):(t.location&&(o.srcLocation=t.location),t.side&&(o.srcSide=t.side),t.finger&&(o.srcFinger=t.finger),t.secondLocation&&(o.secondSrcLocation=t.secondLocation),t.secondSide&&(o.secondSrcSide=t.secondSide),t.secondFinger&&(o.secondSrcFinger=t.secondFinger),h++);continue}break}if("BOTH"!=i&&0==h){if(a.handConstellation){let t=JSON.parse(JSON.stringify(a.handConstellation));return t.distance=o.distance,t.start=o.start,t.attackPeak=o.attackPeak,l?[l,t]:[t]}return l||(l=JSON.parse(JSON.stringify(a[i][0])),l.distance=o.distance,l.start=o.start,l.attackPeak=o.attackPeak,[l])}h<1&&(a&&a.handConstellation?(a.handConstellation.dstLocation&&(o.dstLocation=a.handConstellation.dstLocation),a.handConstellation.dstSide&&(o.dstSide=a.handConstellation.dstSide),a.handConstellation.dstFinger&&(o.dstFinger=a.handConstellation.dstFinger)):(o.dstLocation="TIP",o.dstFinger="1"));h<2&&(a&&a.handConstellation?(a.handConstellation.srcLocation&&(o.srcLocation=a.handConstellation.srcLocation),a.handConstellation.srcSide&&(o.srcSide=a.handConstellation.srcSide),a.handConstellation.srcFinger&&(o.srcFinger=a.handConstellation.srcFinger)):(o.srcLocation="TIP",o.srcFinger="1"));if(l)return[l,o];return[o]}(t,c,c+ot/n,s,a,r)),o.length>0&&(h=ot/n)):"location_hand"==l&&(o=o.concat(function(t,e,s,i){let n=Ct(t,!0);if(!n)return[];let a={type:"gesture",start:e,attackPeak:s,hand:i,handConstellation:"true"};a.hand=i,n.location&&(a.dstLocation=n.location);n.side&&(a.dstSide=n.side);n.finger&&(a.dstFinger=n.finger);n.secondLocation&&(a.secondDstLocation=n.secondLocation);n.secondSide&&(a.secondDstSide=n.secondSide);n.secondFinger&&(a.secondDstFinger=n.secondFinger);n.child?(n.child.location&&(a.srcLocation=n.child.location),n.child.side&&(a.srcSide=n.child.side),n.child.finger&&(a.srcFinger=n.child.finger),n.child.secondLocation&&(a.secondSrcLocation=n.child.secondLocation),n.child.secondSide&&(a.secondSrcSide=n.child.secondSide),n.child.secondFinger&&(a.secondSrcFinger=n.child.secondFinger)):(a.srcLocation="tip",a.srcFinger="1");return[a]}(t,c,c+ot/n,s)),o.length>0&&(h=ot/n));return{data:o,end:e+h}}function Tt(t,e,s,i,n,a){let r={};for(let e=0;e<t.attributes.length;++e)r[t.attributes[e].name]=t.attributes[e].value;let o=[];if(r.handshape||r.thumbpos||r.bend1||r.bend2||r.bend3||r.bend4||r.bend5||r.mainbend){let t={type:"gesture",start:e,attackPeak:s,hand:i};switch(t.handshape=r.handshape.toUpperCase().replace("FINGER","FINGER_").replace("SPREAD","_SPREAD").replace("PINCH","PINCH_").replace("CEE","CEE_").replace("OPEN","_OPEN")||"FLAT",r.second_handshape&&(t.secondHandshape=r.second_handshape.toUpperCase().replace("FINGER","FINGER_").replace("SPREAD","_SPREAD").replace("PINCH","PINCH_").replace("CEE","CEE_").replace("OPEN","_OPEN")),r.mainbend&&(t.mainBend=r.mainbend.toUpperCase().replace("HALF","HALF_").replace("DBL","DOUBLE_")),r.second_mainbend&&(t.secondMainBend=r.second_mainbend.toUpperCase().replace("HALF","HALF_").replace("DBL","DOUBLE_")),r.thumbpos&&(t.thumbshape=r.thumbpos.toUpperCase()),r.second_thumbpos&&(t.secondThumbshape=r.second_thumbpos.toUpperCase()),r.ceeopening){case"slack":t.tco=.4;break;case"tight":t.tco=-.4}switch(r.second_ceeopening){case"slack":t.secondtco=.4;break;case"tight":t.secondtco=-.4}r.bend1&&(t.bend1=r.bend1.toUpperCase().replace("HALF","HALF_").replace("DBL","DOUBLE_")),r.bend2&&(t.bend2=r.bend2.toUpperCase().replace("HALF","HALF_").replace("DBL","DOUBLE_")),r.bend3&&(t.bend3=r.bend3.toUpperCase().replace("HALF","HALF_").replace("DBL","DOUBLE_")),r.bend4&&(t.bend4=r.bend4.toUpperCase().replace("HALF","HALF_").replace("DBL","DOUBLE_")),r.bend5&&(t.bend5=r.bend5.toUpperCase().replace("HALF","HALF_").replace("DBL","DOUBLE_")),r.specialfingers&&(t.specialFingers=r.specialfingers),o.push(t)}if(r.extfidir){let t={type:"gesture",start:e,attackPeak:s,hand:i};t.extfidir=r.extfidir,r.second_extfidir&&(t.secondExtfidir=r.second_extfidir),1&n&&(t.lrSym=!0),2&n&&(t.udSym=!0),4&n&&(t.oiSym=!0),o.push(t)}if(r.palmor){let t={type:"gesture",start:e,attackPeak:s,hand:i};r.palmor.match(/[l,r,u,d]/g)?(t.palmor=r.palmor,r.second_palmor&&(t.secondPalmor=r.second_palmor)):r.second_palmor&&r.second_palmor.match(/[l,r,u,d]/g)?t.palmor=r.second_palmor:t.palmor="dlll",("BOTH"==i&&a.bothHands||1&n)&&(t.lrSym=!0),2&n&&(t.udSym=!0),4&n&&(t.oiSym=!0),o.push(t)}return o}let Et={forehead:"FOREHEAD",eyebrows:"EYEBROW",eyes:"EYE",uppereyelid:"EYE",lowereyelid:"EYE",nose:"NOSE",nostrils:"NOSE",ear:"EAR",earlobe:"EARLOBE",cheek:"CHEEK",lips:"MOUTH",upperlip:"MOUTH",lowerlip:"MOUTH",tongue:"MOUTH",teeth:"MOUTH",upperteeth:"MOUTH",lowerteeth:"MOUTH",chin:"CHIN",underchin:"UNDER_CHIN"},Rt={headtop:"HEAD_TOP",head:"HEAD",neck:"NECK",shoulders:"SHOULDER_LINE",shouldertop:"SHOULDER_TOP",chest:"CHEST",stomach:"STOMACH",belowstomach:"BELOW_STOMACH"},wt={};for(let t in Et)wt[t]=Et[t];for(let t in Rt)wt[t]=Rt[t];let It=["upperarm","elbow","elbowinside","lowerarm"],Pt=["wristback","thumbball","palm","handback","thumbside","pinkyside"];function Mt(t,e,s,i,n,a,r){let o={};for(let e=0;e<t.attributes.length;++e)o[t.attributes[e].name]=t.attributes[e].value;let l={type:"gesture",start:e-1e-5,attackPeak:s,hand:i};if(("BOTH"==i&&a.bothHands||1&n)&&(l.lrSym=!0),2&n&&(l.udSym=!0),4&n&&(l.oiSym=!0),"armextended"==o.contact?l.distance=.5:"close"==o.contact?l.distance=.3:(Et[o.location]&&(o.contact="touch"),"touch"==o.contact?l.distance=0:l.distance=.4),It.includes(o.location)||Pt.includes(o.location)){let e=Ct(t,!0);return l.handConstellation=!0,l.dstLocation=e.location,l.dstSide=e.side,e.child&&(e.child.finger&&(l.srcFinger=e.child.finger),e.child.location&&(l.srcLocation=e.child.location),e.child.side&&(l.srcSide=e.child.side)),[l]}l.locationBodyArm=wt[o.location];let h=wt[o.second_location];switch(h&&(l.secondLocationBodyArm=h),o.side){case"right_at":l.side="r";break;case"right_beside":l.side="rr";break;case"left_at":l.side="l";break;case"left_beside":l.side="ll";break;default:"BOTH"==i&&a.bothHands&&(l.side=a.domHand[0].toLowerCase(),l.lrSym=!0)}switch(o.second_side){case"right_at":l.secondSide="r";break;case"right_beside":l.secondSide="rr";break;case"left_at":l.secondSide="l";break;case"left_beside":l.secondSide="ll";break;default:"BOTH"==i&&a.bothHands&&(l.secondSide=a.domHand[0].toLowerCase(),l.lrSym=!0)}let c=null;if(t.children.length>0&&"location_hand"==t.children[0].tagName&&(c=Ct(t.children[0],!1),c.finger||c.side||c.location?(c.location&&(l.srcLocation=c.location),c.side&&(l.srcSide=c.side),c.finger&&(l.srcFinger=c.finger)):c=null),!c){let t=r[i==a.nonDomHand?a.nonDomHand:a.domHand][3].handshape,e="touch"==o.contact||"BOTH"!=i&&Et[o.location];e=e&&"FLAT"!=t&&"FIST"!=t&&"FINGER_2345"!=t,e?(l.srcFinger="1","FINGER_2"!=t&&"FINGER_23"!=t&&"FINGER_23_SPREAD"!=t&&"FINGER_2345"!=t||(l.srcFinger="2"),l.srcLocation="TIP"):(l.srcLocation="HAND",l.srcSide="PALMAR")}return[l]}function Ct(t,e=!0){let s={};for(let e=0;e<t.attributes.length;++e)s[t.attributes[e].name]=t.attributes[e].value;let i,n,a,r={},o=!1;for(let t=0;t<2;++t){if(o=1==t,i=o?s.second_digits:s.digits,i=1!=i&&2!=i&&3!=i&&4!=i&&5!=i?null:parseInt(i),n=o?s.second_location:s.location,a=o?s.second_side:s.side,i){switch(a){case"right_at":case"right_beside":a="RIGHT";break;case"left_at":case"left_beside":a="LEFT";break;case"front":default:a="PALMAR";break;case"dorsal":a="BACK";break;case"palmar":case"back":case"radial":case"ulnar":a=a.toUpperCase()}switch(n){case"nail":case"pad":n="PAD";break;case"midjoint":n="MID";break;case"side":n="MID",a="ULNAR";break;case"base":n="BASE";break;default:n="TIP",a=null}}else{switch(a){case"right_at":case"right_beside":a="RIGHT";break;case"left_at":case"left_beside":a="LEFT";break;case"front":default:a="PALMAR";break;case"dorsal":a="BACK";break;case"palmar":case"back":case"radial":case"ulnar":a=a.toUpperCase()}switch(n){case"wristback":n="WRIST";break;case"thumbball":n="THUMB_BALL";break;case"palm":n="HAND",a="PALMAR";break;case"handback":n="HAND",a="BACK";break;case"thumbside":i="2",n="BASE",a="RADIAL";break;case"pinkyside":i="5",n="BASE",a="ULNAR";break;case"upperarm":n="UPPER_ARM",a="PALMAR"==a?"FRONT":a;break;case"elbow":n="ELBOW",a="PALMAR"==a?"FRONT":a;break;case"elbowinside":n="ELBOW",a="FRONT";break;case"lowerarm":n="FOREARM",a="FRONT"==a?"PALMAR":a;break;default:n=null,a=null}}o?(i&&(r.secondFinger=i),n&&(r.secondLocation=n),a&&(r.secondSide=a)):(i&&(r.finger=i),n&&(r.location=n),a&&(r.side=a))}return e&&t.children.length>0&&"location_hand"==t.children[0].tagName&&(r.child=Ct(t.children[0],!1)),r.contact=s.contact,r}function vt(t,e,s,i,n,a,r){let o=[],l=e,h=t.tagName,c={};for(let e=0;e<t.attributes.length;++e)c[t.attributes[e].name]=t.attributes[e].value;"true"==c.fast&&(n*=1.5),"true"==c.slow&&(n*=.5),"true"==c.tense&&(n*=.5);let d=parseFloat(c.speed);if(n*=isNaN(d)?1:d,yt.includes(h)){let e=function(t,e,s,i,n,a,r){let o=[],l=0,h={};for(let e=0;e<t.attributes.length;++e)h[t.attributes[e].name]=t.attributes[e].value;if("directedmotion"==t.tagName){let t={motion:"DIRECTED"};t.direction=h.direction,"big"==h.size?t.distance=.2:"small"==h.size?t.distance=.06:t.distance=.12,h.second_direction&&(t.seconDirection=h.second_direction,"big"==h.second_size?t.distance=.5*t.distance+.075:"small"==h.second_size&&(t.distance=.5*t.distance+.03)),h.curve&&(t.curve=h.curve,"big"==h.curve_size?t.curveSize=.5:"small"==h.curve_size?t.curveSize=.05:t.curveSize=.15),"wavy"!=h.zigzag_style&&"zigzag"!=h.zigzag_style||(t.zigzag="l",t.zigzagSpeed=5*n,"big"==h.zigzag_size?t.zigzagSize=.3:t.zigzagSize=.1),l=ht/n,t.attackPeak=e+l,o.push(t)}else if("circularmotion"==t.tagName){let t={motion:"CIRCULAR"};t.direction=h.axis,"big"==h.size?t.distance=.1:"small"==h.size?t.distance=.02:t.distance=.05,h.second_axis&&(t.seconDirection=h.second_axis);let r=St(h.start,null,i),c=St(h.end,null,i);r[0]*r[0]+r[1]*r[1]+r[2]*r[2]<1e-7?t.startAngle=0:(t.startAngle=180*Math.atan2(r[1],r[0])/Math.PI,t.startAngle=t.startAngle<0?360+t.startAngle:t.startAngle),c[0]*c[0]+c[1]*c[1]+c[2]*c[2]<1e-7?t.endAngle=t.startAngle+360:(t.endAngle=180*Math.atan2(c[1],c[0])/Math.PI,t.endAngle=t.endAngle<0?360+t.endAngle:t.endAngle);let d=0;if("true"==h.clockplus&&d++,"true"==h.second_clockplus&&d++,d){let e=t.endAngle-t.startAngle<-1e-4?-1:1;t.endAngle=t.endAngle+360*d*e}"string"==typeof t.direction&&t.direction.includes("i")&&(t.endAngle=t.endAngle-t.startAngle+-1*t.startAngle,t.startAngle*=-1),"wavy"!=h.zigzag_style&&"zigzag"!=h.zigzag_style||(t.zigzag="o",t.zigzagSpeed=8*n,"big"==h.zigzag_size?t.zigzagSize=.1:t.zigzagSize=.05);let p=.5;switch(h.ellipse_size){case"big":p=.25;break;case"small":p=.75;break;default:p=.5}switch(h.ellipse_direction){case"h":t.ellipseAxisDirection="l",t.ellipseAxisRatio=p;break;case"ur":t.ellipseAxisDirection="ur",t.ellipseAxisRatio=p;break;case"v":t.ellipseAxisDirection="u",t.ellipseAxisRatio=p;break;case"ul":t.ellipseAxisDirection="ul",t.ellipseAxisRatio=p}if(l=(1+d)*ct/n,t.start=e,t.attackPeak=e+l,o.push(t),"BOTH"==s&&a.outofphase){let e=JSON.parse(JSON.stringify(t)),s=90*l/Math.abs(t.endAngle-t.startAngle);e.start+=s,e.attackPeak+=s,e.hand=a.nonDomHand,o.push(e),t.hand=a.domHand,l+=s}}else if("wristmotion"==t.tagName&&h.motion){let t={motion:"WRIST"};"big"==h.size?t.intensity=.3:t.intensity=.1,t.mode=h.motion.toUpperCase().replace("STIR","STIR_"),t.speed=4*n,"nodding"!=t.mode&&"nod"!=t.mode&&(t.lrSym=!0),l=pt/n,t.end=e+l,o.push(t)}else if("fingerplay"==t.tagName){let t={motion:"FINGERPLAY",intensity:.5};if(t.speed=4*n,l=dt/n,t.end=e+l,h.digits)t.fingers=h.digits;else{let e="BOTH"==s?a.domHand:s;e=r[e][3].handshape,e.includes("CEE")||e.includes("PINCH")?t.fingers="12345":t.fingers="2345"}o.push(t)}for(let t=0;t<o.length;++t){let n=o[t];n.type="gesture",n.start||(n.start=e),n.hand||(n.hand=s),1&i&&(n.lrSym=!0),4&i&&(n.oiSym=!0)}return{data:o,end:e+l}}(t,l,s,i,n,a,r);o=o.concat(e.data),l=e.end}else if("split_motion"==h){let e=l;if(t.children.length>0&&xt.includes(t.children[0].tagName)){let s=vt(t.children[0],l,a.domHand,0,n,a,r);o=o.concat(s.data),e<s.end&&(e=s.end)}if(t.children.length>1&&xt.includes(t.children[1].tagName)){let s=vt(t.children[1],l,a.nonDomHand,0,n,a,r);o=o.concat(s.data),e<s.end&&(e=s.end)}l=e}else if("seq_motion"==h){for(let e=0;e<t.children.length;++e)if(xt.includes(t.children[e].tagName)){"rpt_motion"!=t.children[e].tagName&&"tgt_motion"!=t.children[e].tagName||(r=Lt(r,o));let h=vt(t.children[e],l,s,i,n,a,r);o=o.concat(h.data),l=h.end}}else if("par_motion"==h){let e=l,h=[];for(let o=0;o<t.children.length;++o)if(xt.includes(t.children[o].tagName)){let c=vt(t.children[o],l,s,i,n,a,r);h.push(c),e<c.end&&(e=c.end)}for(let t=0;t<h.length;++t){let s=h[t];Bt(l,s.end,l,e,s.data),o=o.concat(s.data)}l=e}else if("tgt_motion"==h){let e=null,h=[],c=l,d=!1;for(let o=0;o<t.children.length;++o)if(xt.includes(t.children[o].tagName)){if(e||h.length)break;e=vt(t.children[o],l,s,i,n,a,r),c<e.end&&(c=e.end)}else if(bt.includes(t.children[o].tagName)){let e=kt(t.children[o],l,s,i,n,a,r);h.push(e),r=Lt(r,e.data);for(let t=0;t<e.data.length;++t)(e.data[t].locationBodyArm||e.data[t].handConstellation)&&(d=!0);c<e.end&&(c=e.end)}let p=[];e&&(Bt(l,e.end,l,c,e.data),p=e.data);let m=[];for(let t=0;t<h.length;++t){let e=h[t];Bt(l,e.end,l,c,e.data),m=m.concat(e.data)}if(d){let t=-1,e=-1;for(let s=0;s<p.length;++s)"DIRECTED"==p[s].motion&&e<p[s].start&&(e=p[s].start,t=s);t>-1&&(p[t].distance=0)}o=o.concat(p),o=o.concat(m),l=c}else if("rpt_motion"==h&&t.children.length>0&&xt.includes(t.children[0].tagName)){let e=vt(t.children[0],l,s,i,n,a,r),h=e.end-l,d=l,p=!1;for(let t=0;t<e.data.length;++t)if(!e.data[t].motion){p=!0;break}if(!p){let t=[0,0,0],s=[0,0,0];for(let i=0;i<e.data.length;++i){if(!e.data[i].motion){p=!0;break}let n=e.data[i];if("CIRCULAR"==n.motion){let t=(n.startAngle-n.endAngle)%360;if(t>.5&&t<359.5){p=!0;break}}if("DIRECTED"==n.motion){if(n.hand!=a.nonDomHand){let e=St(n.direction,null,0);t[0]+=e[0]*n.distance,t[1]+=e[1]*n.distance,t[2]+=e[2]*n.distance}if(n.hand!=a.domHand){let t=!!n.lrSym|!!n.udSym<1|!!n.oiSym<2,e=St(n.direction,null,t);s[0]+=e[0]*n.distance,s[1]+=e[1]*n.distance,s[2]+=e[2]*n.distance}}}let i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];i+=s[0]*s[0]+s[1]*s[1]+s[2]*s[2],i>1e-7&&(p=!0)}switch(c.repetition){case"fromstart":case"fromstart_several":case"manyrandom":let t="fromstart"==c.repetition?1:2,s=h+p*rt/n;for(let i=0;i<t;++i){let t=JSON.parse(JSON.stringify(e.data));for(let e=0;e<t.length;++e){let a=t[e];if("number"==typeof a.start&&(a.start+=i*s),"number"==typeof a.attackPeak&&(a.attackPeak+=i*s),"number"==typeof a.ready&&(a.ready+=i*s),a.locationBodyArm||a.handshape||a.extfidir||a.palmor)continue;let r="FINGERPLAY"==a.motion||"WRIST"==a.motion;!p&&r&&e==t.length-1?(a.relax=d+(i+1)*s,a.end=d+(i+1)*s+rt/n):("number"==typeof a.relax?a.relax+=i*s:r||(a.relax=d+i*s+h),"number"==typeof a.end?a.end+=i*s:a.end=d+(i+1)*s)}if(o=o.concat(t),l+=h,p){let t=[],s=!1;for(let i=0;i<e.data.length;++i){let n=-1,a=e.data[i];a.locationBodyArm?n=0:a.extfidir?n=1:a.palmor?n=2:a.handshape?n=3:a.handConstellation&&(n=4),4==n?s=!!r.handConstellation:n>-1&&("RIGHT"!=a.hand&&"BOTH"!=a.hand||t.push(JSON.parse(JSON.stringify(r.RIGHT[n]))),"LEFT"!=a.hand&&"BOTH"!=a.hand||t.push(JSON.parse(JSON.stringify(r.LEFT[n]))),a.locationBodyArm&&r.handConstellation&&(s|="BOTH"==r.handConstellation.hand||a.locationBodyArm.hand==r.handConstellation.hand))}for(let e=0;e<t.length;++e)t[e].start=l-1e-5,t[e].attackPeak=l+rt/n;o=o.concat(t),s&&(t=JSON.parse(JSON.stringify(r.handConstellation)),t.start=l,t.attackpeak=l+rt/n,o.push(t)),l+=rt/n}}let i=e.data,a=t*s;for(let t=0;t<i.length;++t)isNaN(i[t].start)||(i[t].start+=a),isNaN(i[t].attackPeak)||(i[t].attackPeak+=a),isNaN(i[t].ready)||(i[t].ready+=a),isNaN(i[t].relax)||(i[t].relax+=a),isNaN(i[t].end)||(i[t].end+=a);o=o.concat(i),l+=h;break;case"tofroto":case"reverse":case"continue":case"continue_several":break;default:o=o.concat(e.data),l+=h}}return"true"==c.rest&&(l+=mt/n),{data:o,end:l}}function Bt(t,e,s,i,n){let a=["start","attackPeak","relax","end","ready"];for(let r=0;r<n.length;++r){let o=n[r];for(let n=0;n<a.length;++n)if("number"==typeof o[a[n]]){let r=(o[a[n]]-t)/(e-t);o[a[n]]=s*(1-r)+i*r}}}function Nt(t,e,s){let i={shoulder_tier:[!1,"shoulder_par",["shoulder_movement"]],body_tier:[!1,"body_par",["body_movement"]],head_tier:[!1,"head_par",["head_movement"]],eyegaze_tier:[!1,"eye_par",["eye_gaze"]],facialexpr_tier:[!1,"facial_expr_par",["eye_gaze","eye_brows","eye_lids","nose"]],mouthing_tier:[!1,"mouthing_par",["mouth_gesture","mouth_picture","mouth_meta"]],extra_tier:[!1,"extra_par",["extra_movement"]]},n=[],a=e;e+=lt/s;for(let r=0;r<t.children.length;++r){let o=i[t.children[r].tagName];if(o&&!o[0]){o[0]=!0;let i=t.children[r].children,l=e;for(let t=0;t<i.length;++t)if(o[2].includes(i[t].tagName)){let e=Ot(i[t],l,s);if(!e||e.length<1)continue;n.length,e.data.length,n=n.concat(e.data),l=e.end}else if(o[1]==i[t].tagName){let e=i[t].children,a=l;for(let t=0;t<e.length;++t)if(o[2].includes(e[t].tagName)){let i=Ot(e[t],l,s);if(!i||i.length<1)continue;n=n.concat(i.data),i.end>a&&(a=i.end)}l=a}a<l&&(a=l)}}return{data:n,end:a}}function Ot(t,e,s){let i={};for(let e=0;e<t.attributes.length;++e)i[t.attributes[e].name]=t.attributes[e].value;s=parseFloat(i.speed),s=isNaN(s)?1:s;let n=parseFloat(i.amount);n=isNaN(n)?1:n;let a=null;switch(t.tagName){case"shoulder_movement":a=Ft[i.movement];break;case"body_movement":a=Ht[i.movement];break;case"head_movement":a=Dt[i.movement];break;case"eye_gaze":a=Ut[i.movement||i.direction];break;case"eye_brows":a=Vt[i.movement];break;case"eye_lids":a=zt[i.movement];break;case"nose":a=Wt[i.movement];break;case"mouth_gesture":a=Gt[i.movement];break;case"mouth_picture":a={type:"speech",text:i.picture+".",sentInt:.5};break;case"mouth_meta":case"extra_movement":case"neutral":break;default:return null}if(!a)return null;a=JSON.parse(JSON.stringify(a)),Array.isArray(a)||(a=[a]);let r=e;for(let t=0;t<a.length;++t){let i=a[t];if(i.hasOwnProperty("amount")?i.amount*=n:i.hasOwnProperty("shoulderRaise")?i.shoulderRaise*=n:i.hasOwnProperty("shoulderHunch")&&(i.shoulderHunch*=n),i.start=i.start?e+i.start/s:e,"speech"==i.type)i.speed&&(i.sentT=i.text.length*i.speed),i.sentT=i.sentT/s||i.text.length/(6.66*s),i.start+i.sentT>r&&(r=i.start+i.sentT);else if(i.duration||i.end){let t=i.end?e+i.end-i.start:i.duration;i.end=i.start+t/s,i.end>r&&(r=i.end)}else{let t=i.repetition?i.repetition:0;i.attackPeak=i.start+it/s,i.relax=i.attackPeak+(1+t)*nt/s,i.end=i.relax+at/s;let e=i.relax;i._durationUntilEnd&&(e=i.end,delete i._durationUntilEnd),e>r&&(r=e)}}return{data:a,end:r}}let Ft={UL:{type:"gesture",shoulderRaise:.55,hand:"LEFT"},UR:{type:"gesture",shoulderRaise:.55,hand:"RIGHT"},UB:{type:"gesture",shoulderRaise:.55,hand:"BOTH"},HL:{type:"gesture",shoulderHunch:.8,hand:"LEFT"},HR:{type:"gesture",shoulderHunch:.8,hand:"RIGHT"},HB:{type:"gesture",shoulderHunch:.8,hand:"BOTH"},SL:{type:"gesture",shoulderRaise:.55,hand:"LEFT",_durationUntilEnd:!0},SR:{type:"gesture",shoulderRaise:.55,hand:"RIGHT",_durationUntilEnd:!0},SB:{type:"gesture",shoulderRaise:.55,hand:"BOTH",_durationUntilEnd:!0}},Ht={RL:{type:"gesture",bodyMovement:"ROTATE_LEFT",amount:.7},RR:{type:"gesture",bodyMovement:"ROTATE_RIGHT",amount:.7},TL:{type:"gesture",bodyMovement:"TILT_LEFT",amount:.5},TR:{type:"gesture",bodyMovement:"TILT_RIGHT",amount:.5},TF:{type:"gesture",bodyMovement:"TILT_FORWARD",amount:.5},TB:{type:"gesture",bodyMovement:"TILT_BACKWARD",amount:.5},RD:{type:"gesture",bodyMovement:"TILT_FORWARD",amount:.4},SI:{type:"gesture",bodyMovement:"TILT_BACKWARD",amount:.3}},Dt={NO:{type:"head",lexeme:"NOD",repetition:1},SH:{type:"head",lexeme:"SHAKE",repetition:3},SR:{type:"head",lexeme:"ROTATE_RIGHT",repetition:0},SL:{type:"head",lexeme:"ROTATE_LEFT",repetition:0},TR:{type:"head",lexeme:"TILT_RIGHT",repetition:0},TL:{type:"head",lexeme:"TILT_LEFT",repetition:0},NF:{type:"head",lexeme:"TILT_FORWARD",repetition:0},NB:{type:"head",lexeme:"TILT_BACKWARD",repetition:0},PF:{type:"head",lexeme:"FORWARD",repetition:0},PB:{type:"head",lexeme:"BACKWARD",repetition:0}},Ut={AD:{type:"gaze",influence:"EYES",target:"CAMERA"},FR:{type:"gaze",influence:"EYES",target:"FRONT"},NO:{type:"gaze",influence:"EYES",target:"FRONT"},UP:{type:"gaze",influence:"EYES",target:"UP"},DN:{type:"gaze",influence:"EYES",target:"DOWN"},LE:{type:"gaze",influence:"EYES",target:"LEFT"},RI:{type:"gaze",influence:"EYES",target:"RIGHT"},LU:{type:"gaze",influence:"EYES",target:"UP_LEFT"},LD:{type:"gaze",influence:"EYES",target:"DOWN_LEFT"},RU:{type:"gaze",influence:"EYES",target:"UP_RIGHT"},RD:{type:"gaze",influence:"EYES",target:"DOWN_RIGHT"}},Vt={RB:{type:"faceLexeme",lexeme:"BROW_RAISER",amount:1},RR:{type:"faceLexeme",lexeme:"BROW_RAISER_RIGHT",amount:1},RL:{type:"faceLexeme",lexeme:"BROW_RAISER_LEFT",amount:1},FU:{type:"faceLexeme",lexeme:"BROW_LOWERER",amount:1}},zt={WB:{type:"faceLexeme",lexeme:"UPPER_LID_RAISER",amount:1},WR:{type:"faceLexeme",lexeme:"UPPER_LID_RAISER_RIGHT",amount:1},WL:{type:"faceLexeme",lexeme:"UPPER_LID_RAISER_LEFT",amount:1},SB:{type:"faceLexeme",lexeme:"EYES_CLOSED",amount:.4},SR:{type:"faceLexeme",lexeme:"WINK_RIGHT",amount:.4},SL:{type:"faceLexeme",lexeme:"WINK_LEFT",amount:.4},CB:{type:"faceLexeme",lexeme:"EYES_CLOSED",amount:1},CR:{type:"faceLexeme",lexeme:"WINK_RIGHT",amount:1},CL:{type:"faceLexeme",lexeme:"WINK_LEFT",amount:1},TB:{type:"faceLexeme",lexeme:"EYES_CLOSED",amount:1},TR:{type:"faceLexeme",lexeme:"WINK_RIGHT",amount:1},TL:{type:"faceLexeme",lexeme:"WINK_LEFT",amount:1}},Wt={WB:{type:"faceLexeme",lexeme:"NOSE_WRINKLER",amount:1}},Gt={D01:{type:"speech",text:"IIIIs ",sentInt:.4,sentT:.8},D02:{type:"speech",text:"ffff ",sentInt:.4,sentT:.6},D03:{type:"speech",text:"Efff ",sentInt:.4,sentT:.6},D04:{type:"speech",text:"afff ",sentInt:.4,sentT:.6},D05:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.05,start:0,duration:.15},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.05,start:.15,duration:.15},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.05,start:.3,duration:.15},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.05,start:.45,duration:.15},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.05,start:.6,duration:.15},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.05,start:.75,duration:.15}],D06:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.02,start:0,duration:.3},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:.4,start:0,duration:.3},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.1,start:0,duration:.3},{type:"faceLexeme",lexeme:"LIP_SUCK_UPPER",amount:-.2,start:0,duration:.3},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.02,start:.2,duration:.2},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:.4,start:.2,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.1,start:.2,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_UPPER",amount:-.2,start:.2,duration:.2},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.02,start:.3,duration:.2},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:.4,start:.3,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.1,start:.3,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_UPPER",amount:-.2,start:.3,duration:.2},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.02,start:.45,duration:.2},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:.4,start:.45,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.1,start:.45,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_UPPER",amount:-.2,start:.45,duration:.2},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.02,start:.6,duration:.2},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:.4,start:.6,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.1,start:.6,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_UPPER",amount:-.2,start:.6,duration:.2},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.02,start:.75,duration:.2},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:.4,start:.75,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.1,start:.75,duration:.2},{type:"faceLexeme",lexeme:"LIP_SUCK_UPPER",amount:-.2,start:.75,duration:.2}],D07:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.4,start:0,duration:.3},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:.2,start:0,duration:.3},{type:"faceLexeme",lexeme:"LOWER_LIP_DEPRESSOR",amount:.4,start:0,duration:.3},{type:"speech",text:"mm ",start:.25,sentInt:.5,sentT:.5}],D08:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.4,start:0,duration:.3},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:.6,start:.1,duration:.8},{type:"faceLexeme",lexeme:"LOWER_LIP_DEPRESSOR",amount:.8,start:0,duration:.8},{type:"faceLexeme",lexeme:"JAW_DROP",amount:-.3,start:.25,duration:.5}],D09:[{type:"speech",text:"tAiii ",sentInt:.8,sentT:.5},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:1,start:.3,duration:.5}],J01:[{type:"faceLexeme",lexeme:"JAW_SIDEWAYS_LEFT",amount:.5,start:0,duration:.2},{type:"faceLexeme",lexeme:"JAW_SIDEWAYS_RIGHT",amount:.5,start:.2,duration:.2},{type:"faceLexeme",lexeme:"JAW_SIDEWAYS_LEFT",amount:.5,start:.4,duration:.2},{type:"faceLexeme",lexeme:"JAW_SIDEWAYS_RIGHT",amount:.5,start:.6,duration:.2}],J02:[{type:"faceLexeme",lexeme:"JAW_DROP",amount:.7,start:0,duration:.6},{type:"faceLexeme",lexeme:"JAW_THRUST",amount:-.3,start:0,duration:.6},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:-.35,start:0,duration:.6},{type:"faceLexeme",lexeme:"JAW_DROP",amount:.7,start:.8,duration:.6},{type:"faceLexeme",lexeme:"JAW_THRUST",amount:-.3,start:.8,duration:.6},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:-.35,start:.8,duration:.6},{type:"faceLexeme",lexeme:"JAW_DROP",amount:.7,start:1.6,duration:.6},{type:"faceLexeme",lexeme:"JAW_THRUST",amount:-.3,start:1.6,duration:.6},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:-.35,start:1.6,duration:.6},{type:"faceLexeme",lexeme:"JAW_DROP",amount:.7,start:2.4,duration:.6},{type:"faceLexeme",lexeme:"JAW_THRUST",amount:-.3,start:2.4,duration:.6},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:-.35,start:2.4,duration:.6}],J03:[{type:"faceLexeme",lexeme:"JAW_THRUST",amount:1,start:0,duration:.8},{type:"faceLexeme",lexeme:"JAW_DROP",amount:.16,start:0,duration:.8},{type:"faceLexeme",lexeme:"LOWER_LIP_DEPRESSOR",amount:.9,start:0,duration:.8}],J04:{type:"speech",text:"GA GA GA GA GA",sentInt:.5,sentT:1},L02:{type:"speech",text:"p r r r",phInt:[.2,.3,.3,.3],phT:[.2,.05,.05,.05]},L01:{type:"speech",text:" S ",sentInt:1.2,sentT:.7},L03:{type:"speech",text:"p r",phInt:[.15,.3],phT:[.2,.2]},L04:{type:"faceLexeme",lexeme:"LIP_TIGHTENER",amount:.8,start:0,duration:.8},L05:{type:"speech",text:" Oo ",sentInt:1.2,sentT:.8},L06:{type:"speech",text:" O ",sentInt:.8,sentT:.8},L07:{type:"speech",text:" o ",sentInt:1.2,sentT:.7},L08:{type:"speech",text:"boAm ",phInt:[.1,.3,.2,.3],phT:[.1,.05,.05,.05]},L09:{type:"speech",text:"bAm ",phInt:[.1,.5,.2],phT:[.1,.1,.05]},L10:{type:"speech",text:"boA A ",phInt:[.5,.5,1,1],phT:[.1,.05,.3,.1]},L11:{type:"speech",text:"b A ",sentInt:.5,phT:[.1,.2]},L12:{type:"speech",text:"bii ",phInt:[.1,1,1],phT:[.1,.15,.5]},L13:{type:"speech",text:"pYY ",phInt:[.1,.6,.6],phT:[.05,.2,.3]},L14:{type:"speech",text:"pCh",phInt:[.1,1,.8],phT:[.1,.2,.4]},L15:[{type:"speech",text:"bs",sentInt:.3,sentT:.3},{type:"faceLexeme",lexeme:"LIPS_PART",amount:1,start:.2,duration:.9}],L16:{type:"speech",text:"pff ",sentInt:.5,phT:[.05,.2,.3,.1]},L17:{type:"speech",text:"ppA ",phInt:[.1,.01,.01,.01],phT:[.1,.1,.03,.05]},L18:{type:"speech",text:"pApApA ",sentInt:.05,sentT:.6},L19:[{type:"faceLexeme",lexeme:"ROUND_OPEN",amount:.3,start:0,duration:.6},{type:"faceLexeme",lexeme:"LIP_PUCKERER",amount:.9,start:0,duration:.6}],L20:[{type:"faceLexeme",lexeme:"LIP_PUCKERER",amount:.2,start:0,duration:.9},{type:"faceLexeme",lexeme:"LIP_CORNER_PULLER",amount:.2,start:0,duration:.9},{type:"faceLexeme",lexeme:"CHEEK_BLOW",amount:.9,start:0,duration:.9}],L22:[{type:"faceLexeme",lexeme:"LIP_PUCKERER",amount:.2,start:0,duration:.4},{type:"faceLexeme",lexeme:"LIP_CORNER_PULLER",amount:.2,start:0,duration:.4},{type:"faceLexeme",lexeme:"CHEEK_BLOW",amount:.9,start:0,duration:.4}],L23:{type:"speech",text:"mmm ",sentInt:.2},L24:{type:"speech",text:"ma m ",phInt:[.1,.05,.05,.2],phT:[.1,.1,.05,.45,.2]},L25:{type:"speech",text:"mamama ",phInt:[.2,.05,.2,.05,.2,.05],sentT:.7},L26:{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER_RIGHT",amount:.8,start:0,duration:.8},L27:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.25,start:0,duration:.6},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:1,start:0,duration:.6}],L28:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.5,start:0,duration:.6},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:1,start:0,duration:.6}],L29:[{type:"faceLexeme",lexeme:"LIP_CORNER_DEPRESSOR",amount:.15,start:0,duration:.6},{type:"faceLexeme",lexeme:"DIMPLER",amount:.6,start:0,duration:.6},{type:"faceLexeme",lexeme:"LID_TIGHTENER",amount:.25,start:0,duration:.6}],L30:[{type:"faceLexeme",lexeme:"LIP_CORNER_DEPRESSOR",amount:.6,start:0,duration:.7},{type:"faceLexeme",lexeme:"LIP_PUCKERER",amount:.4,start:0,duration:.7},{type:"faceLexeme",lexeme:"LID_TIGHTENER",amount:.25,start:0,duration:.7},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:-.1,start:0,duration:.7}],L31:[{type:"faceLexeme",lexeme:"LIP_CORNER_DEPRESSOR",amount:.15,start:0,duration:.6},{type:"faceLexeme",lexeme:"DIMPLER",amount:.6,start:0,duration:.6},{type:"faceLexeme",lexeme:"LID_TIGHTENER",amount:.25,start:0,duration:.6}],L32:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.1,start:0,duration:.8},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.3,start:.1,duration:.1},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:.2,start:.2,duration:.1},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.3,start:.3,duration:.1},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:.2,start:.4,duration:.1}],L33:{type:"speech",text:"A S ",phInt:[.3,.8,.8,.8],phT:[.1,.05,.55,.05]},L34:{type:"faceLexeme",lexeme:"LIP_CORNER_PULLER",amount:.5,start:0,duration:.6},L35:[{type:"faceLexeme",lexeme:"CHEEK_BLOW",amount:-.4,start:0,duration:1.45},{type:"faceLexeme",lexeme:"LIP_PUCKERER",amount:.4,start:0,duration:1.45},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.05,start:.2,duration:.4},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.2,start:.2,duration:.4},{type:"faceLexeme",lexeme:"LIP_SUCK_UPPER",amount:-.2,start:.2,duration:.4},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.05,start:.6,duration:.4},{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:-.2,start:.6,duration:.4},{type:"faceLexeme",lexeme:"LIP_SUCK_UPPER",amount:-.2,start:.6,duration:.4}],C01:{type:"faceLexeme",lexeme:"CHEEK_BLOW",amount:1,start:0,duration:.8},C02:[{type:"faceLexeme",lexeme:"CHEEK_BLOW",amount:.8,start:0,duration:.8},{type:"faceLexeme",lexeme:"LIP_PUCKERER",amount:.2,start:0,duration:.8}],C03:{type:"faceLexeme",lexeme:"CHEEK_BLOW",amount:.8,start:0,duration:.8},C04:[{type:"faceLexeme",lexeme:"CHEEK_BLOW_RIGHT",amount:1,start:0,duration:.8},{type:"faceLexeme",lexeme:"LIP_PUCKERER_RIGHT",amount:-.2,start:0,duration:.8}],C05:[{type:"faceLexeme",lexeme:"CHEEK_BLOW_RIGHT",amount:.8,start:0,duration:.4},{type:"faceLexeme",lexeme:"LIP_PUCKERER_RIGHT",amount:-.2,start:0,duration:.4}],C06:[{type:"faceLexeme",lexeme:"CHEEK_BLOW_RIGHT",amount:.8,start:0,duration:.4},{type:"faceLexeme",lexeme:"LIP_PUCKERER_RIGHT",amount:-.2,start:0,duration:.4}],C07:{type:"faceLexeme",lexeme:"CHEEK_SUCK",amount:1,start:0,duration:.8},C08:[{type:"faceLexeme",lexeme:"CHEEK_SUCK",amount:1,start:0,duration:.8},{type:"faceLexeme",lexeme:"LIP_FUNNELER",amount:1,start:0,duration:.8}],C11:[{type:"faceLexeme",lexeme:"CHEEK_BLOW_RIGHT",amount:1,start:0,duration:.2},{type:"faceLexeme",lexeme:"LIP_PUCKERER_RIGHT",amount:-.2,start:0,duration:.85},{type:"faceLexeme",lexeme:"CHEEK_BLOW_RIGHT",amount:1,start:.2,duration:.2},{type:"faceLexeme",lexeme:"CHEEK_BLOW_RIGHT",amount:1,start:.4,duration:.2},{type:"faceLexeme",lexeme:"CHEEK_BLOW_RIGHT",amount:1,start:.6,duration:.25}],C12:[{type:"faceLexeme",lexeme:"LIP_SUCK_LOWER",amount:.8,start:0,duration:.8},{type:"faceLexeme",lexeme:"JAW_THRUST",amount:1,start:0,duration:.8}],C13:[{type:"faceLexeme",lexeme:"JAW_DROP",amount:.3,start:0,duration:.8},{type:"faceLexeme",lexeme:"UPPER_LIP_RAISER",amount:-.6,start:0,duration:.8}],T01:{type:"speech",text:"lllll ",sentInt:1,sentT:.5},T02:[{type:"speech",text:"lllll ",sentInt:1,sentT:.5},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:.3,start:0}],T04:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.45,start:0,duration:.4},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:.5,start:0,duration:.4}],T05:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.5,start:0,duration:1},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:.55,start:0,duration:1}],T06:[{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.45,start:0,duration:.35},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:.5,start:0,duration:.35},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.45,start:.25,duration:.35},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:.5,start:.25,duration:.35},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.45,start:.55,duration:.35},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:.5,start:.55,duration:.35},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.45,start:.85,duration:.35},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:.5,start:.85,duration:.35}],T07:{type:"speech",text:"la la la la ",phInt:[1,1,.1,1,1,.1,1,1,.1,1,1,.1],sentT:1.2},T08:{type:"speech",text:"al al al al ",phInt:[1,1,.1,1,1,.1,1,1,.1,1,1,.1],sentT:1.2},T09:{type:"speech",text:"als ",sentInt:.8,sentT:.6},T10:{type:"speech",text:"llff ",sentInt:.8,sentT:.6},T11:{type:"speech",text:"loaf ",sentInt:.5,sentT:.6},T13:[{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:.5,start:0,duration:.8},{type:"faceLexeme",lexeme:"CHEEK_BLOW",amount:.4,start:0,duration:.8},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.2,start:0,duration:.8}],T16:[{type:"faceLexeme",lexeme:"LIP_PUCKERER",amount:.8,start:0,duration:.8},{type:"faceLexeme",lexeme:"TONGUE_SHOW",amount:1,start:0,duration:.8},{type:"faceLexeme",lexeme:"CHIN_RAISER",amount:-.4,start:0,duration:.8},{type:"faceLexeme",lexeme:"MOUTH_STRETCH",amount:.2,start:0,duration:.8}]};a.prototype.parseExtended=function(e){function s(e,i,n){if("ENDSITE"===n.type)return;const a={time:i,position:new t.Vector3,rotation:new t.Quaternion};n.frames.push(a);const r=new t.Quaternion,o=new t.Vector3(1,0,0),l=new t.Vector3(0,1,0),h=new t.Vector3(0,0,1);for(let t=0;t<n.channels.length;t++)switch(n.channels[t]){case"Xposition":a.position.x=parseFloat(e.shift().trim());break;case"Yposition":a.position.y=parseFloat(e.shift().trim());break;case"Zposition":a.position.z=parseFloat(e.shift().trim());break;case"Xrotation":r.setFromAxisAngle(o,parseFloat(e.shift().trim())*Math.PI/180),a.rotation.multiply(r);break;case"Yrotation":r.setFromAxisAngle(l,parseFloat(e.shift().trim())*Math.PI/180),a.rotation.multiply(r);break;case"Zrotation":r.setFromAxisAngle(h,parseFloat(e.shift().trim())*Math.PI/180),a.rotation.multiply(r);break;default:console.warn("THREE.BVHLoader: Invalid channel type.")}for(let t=0;t<n.children.length;t++)s(e,i,n.children[t])}function i(t,e,s){for(let i=0;i<s.length;i++){const n={time:e,weight:0};s[i].frames.push(n),n.weight=parseFloat(t.shift().trim())}}function n(e,s,i){const r={name:"",type:"",frames:[]};i.push(r);let o=s.split(/[\s]+/);"END"===o[0].toUpperCase()&&"SITE"===o[1].toUpperCase()?(r.type="ENDSITE",r.name="ENDSITE"):(r.name=o[1],r.type=o[0].toUpperCase()),"{"!==a(e)&&console.error("THREE.BVHLoader: Expected opening { after type & name"),o=a(e).split(/[\s]+/),"OFFSET"!==o[0]&&console.error("THREE.BVHLoader: Expected OFFSET but got: "+o[0]),4!==o.length&&console.error("THREE.BVHLoader: Invalid number of values for OFFSET.");const l=new t.Vector3(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]));if((isNaN(l.x)||isNaN(l.y)||isNaN(l.z))&&console.error("THREE.BVHLoader: Invalid values of OFFSET."),r.offset=l,"ENDSITE"!==r.type){o=a(e).split(/[\s]+/),"CHANNELS"!==o[0]&&console.error("THREE.BVHLoader: Expected CHANNELS definition.");const t=parseInt(o[1]);r.channels=o.splice(2,t),r.children=[]}for(;;){const t=a(e);if("}"===t)return r;r.children.push(n(e,t,i))}}function a(t){let e;for(;0===(e=t.shift().trim()).length;);return e}const r=this,o=e.split(/[\r\n]+/g),{bones:l,blendshapes:h}=function(t){let e=null;const r=[];let o=null,l=a(t);if("HIERARCHY"==l){e=n(t,a(t),r),l=a(t),"MOTION"!==l&&console.error("THREE.BVHLoader: MOTION expected.");let i=a(t).split(/[\s]+/);const o=parseInt(i[1]);isNaN(o)&&console.error("THREE.BVHLoader: Failed to read number of frames."),i=a(t).split(/[\s]+/);const h=parseFloat(i[2]);isNaN(h)&&console.error("THREE.BVHLoader: Failed to read frame time.");for(let n=0;n<o;n++)i=a(t).split(/[\s]+/),e&&s(i,n*h,e)}if(t.length>1&&(l=a(t),"BLENDSHAPES"==l)){const e=[];o=function(t,e,s){for(;;){let e=a(t);if("{"===e)continue;if("}"===e)return s;let i={name:"",meshes:[],frames:[]};s.push(i);let n=e.split(/[\s]+/);i.name=n[0];for(let t=1;t<n.length;t++)i.meshes.push(n[t])}}(t,a(t),e),l=a(t),"MOTION"!==l&&console.error("THREE.BVHLoader: MOTION expected.");let s=a(t).split(/[\s]+/);const n=parseInt(s[1]);isNaN(n)&&console.error("THREE.BVHLoader: Failed to read number of frames."),s=a(t).split(/[\s]+/);const r=parseFloat(s[2]);isNaN(r)&&console.error("THREE.BVHLoader: Failed to read frame time.");for(let e=0;e<n;e++)s=a(t).split(/[\s]+/),o&&i(s,e*r,o)}return{bones:r,blendshapes:o}}(o),c=[];l.length&&function e(s,i){const n=new t.Bone;if(i.push(n),n.position.add(s.offset),n.name=s.name,"ENDSITE"!==s.type)for(let t=0;t<s.children.length;t++)n.add(e(s.children[t],i));return n}(l[0],c);const{skeletonClip:d,blendshapesClip:p}=function(e,s){const i=[];for(let s=0;s<e.length;s++){const n=e[s];if("ENDSITE"===n.type)continue;const a=[],o=[],l=[];for(let t=0;t<n.frames.length;t++){const e=n.frames[t];a.push(e.time),o.push(e.position.x+n.offset.x),o.push(e.position.y+n.offset.y),o.push(e.position.z+n.offset.z),l.push(e.rotation.x),l.push(e.rotation.y),l.push(e.rotation.z),l.push(e.rotation.w)}r.animateBonePositions&&i.push(new t.VectorKeyframeTrack(n.name+".position",a,o)),r.animateBoneRotations&&i.push(new t.QuaternionKeyframeTrack(n.name+".quaternion",a,l))}const n=[];if(s)for(let e=0;e<s.length;e++){const i=s[e],a=[],r=[];for(let t=0;t<i.frames.length;t++){const e=i.frames[t];a.push(e.time),r.push(e.weight)}if(i.meshes.length)for(let e=0;e<i.meshes.length;e++)n.push(new t.NumberKeyframeTrack(i.meshes[e]+".morphTargetInfluences["+i.name+"]",a,r));else n.push(new t.NumberKeyframeTrack("Body.morphTargetInfluences["+i.name+"]",a,r))}return{skeletonClip:new t.AnimationClip("skeletonAnimation",-1,i),blendshapesClip:new t.AnimationClip("bsAnimation",-1,n)}}(l,h);return{skeletonAnim:{skeleton:d.tracks.length?new t.Skeleton(c):null,clip:d},blendshapesAnim:{clip:p}}};class jt{static BindPoseModes={DEFAULT:0,CURRENT:1};static boneMap={Hips:"hips",BelowStomach:"spine",Stomach:"spine1",ShouldersUnion:"spine2",Neck:"neck",Head:"head",LEye:"lefteye",REye:"righteye",LShoulder:"leftshoulder",LArm:"leftarm",LElbow:"leftforearm",LWrist:"lefthand",LHandThumb:"lefthandthumb1",LHandThumb2:"lefthandthumb2",LHandThumb3:"lefthandthumb3",LHandThumb4:"lefthandthumb4",LHandIndex:"lefthandindex1",LHandIndex2:"lefthandindex2",LHandIndex3:"lefthandindex3",LHandIndex4:"lefthandindex4",LHandMiddle:"lefthandmiddle1",LHandMiddle2:"lefthandmiddle2",LHandMiddle3:"lefthandmiddle3",LHandMiddle4:"lefthandmiddle4",LHandRing:"lefthandring1",LHandRing2:"lefthandring2",LHandRing3:"lefthandring3",LHandRing4:"lefthandring4",LHandPinky:"lefthandpinky1",LHandPinky2:"lefthandpinky2",LHandPinky3:"lefthandpinky3",LHandPinky4:"lefthandpinky4",RShoulder:"rightshoulder",RArm:"rightarm",RElbow:"rightforearm",RWrist:"righthand",RHandThumb:"righthandthumb1",RHandThumb2:"righthandthumb2",RHandThumb3:"righthandthumb3",RHandThumb4:"righthandthumb4",RHandIndex:"righthandindex1",RHandIndex2:"righthandindex2",RHandIndex3:"righthandindex3",RHandIndex4:"righthandindex4",RHandMiddle:"righthandmiddle1",RHandMiddle2:"righthandmiddle2",RHandMiddle3:"righthandmiddle3",RHandMiddle4:"righthandmiddle4",RHandRing:"righthandring1",RHandRing2:"righthandring2",RHandRing3:"righthandring3",RHandRing4:"righthandring4",RHandPinky:"righthandpinky1",RHandPinky2:"righthandpinky2",RHandPinky3:"righthandpinky3",RHandPinky4:"righthandpinky4",LUpLeg:"leftupleg",LLeg:"leftleg",LFoot:"leftfoot",RUpLeg:"rightupleg",RLeg:"rightleg",RFoot:"rightfoot"};static boneHierarchy={LEye:6,REye:6,Head:5,Neck:4,ShouldersUnion:3,Stomach:2,BelowStomach:1,Hips:0,RShoulder:4,RArm:5,RElbow:6,RWrist:7,RHandThumb:8,RHandThumb2:9,RHandThumb3:10,RHandThumb4:11,RHandIndex:8,RHandIndex2:9,RHandIndex3:10,RHandIndex4:11,RHandMiddle:8,RHandMiddle2:9,RHandMiddle3:10,RHandMiddle4:11,RHandRing:8,RHandRing2:9,RHandRing3:10,RHandRing4:11,RHandPinky:8,RHandPinky2:9,RHandPinky3:10,RHandPinky4:11,LShoulder:4,LArm:5,LElbow:6,LWrist:7,LHandThumb:8,LHandThumb2:9,LHandThumb3:10,LHandThumb4:11,LHandIndex:8,LHandIndex2:9,LHandIndex3:10,LHandIndex4:11,LHandMiddle:8,LHandMiddle2:9,LHandMiddle3:10,LHandMiddle4:11,LHandRing:8,LHandRing2:9,LHandRing3:10,LHandRing4:11,LHandPinky:8,LHandPinky2:9,LHandPinky3:10,LHandPinky4:11,LUpLeg:1,LLeg:2,LFoot:3,RUpLeg:1,RLeg:2,RFoot:3};static standardBones=()=>{const e=new t.Bone;e.name="Hips";const s=new t.Bone;s.name="BelowStomach";const i=new t.Bone;i.name="Stomach";const n=new t.Bone;n.name="ShouldersUnion";const a=new t.Bone;a.name="Neck";const r=new t.Bone;r.name="Head";const o=new t.Bone;o.name="LEye";const l=new t.Bone;l.name="REye";const h=new t.Bone;h.name="LShoulder";const c=new t.Bone;c.name="LArm";const d=new t.Bone;d.name="LElbow";const p=new t.Bone;p.name="LWrist";const m=new t.Bone;m.name="LHandThumb";const u=new t.Bone;u.name="LHandThumb2";const f=new t.Bone;f.name="LHandThumb3";const g=new t.Bone;g.name="LHandThumb4";const A=new t.Bone;A.name="LHandIndex";const y=new t.Bone;y.name="LHandIndex2";const x=new t.Bone;x.name="LHandIndex3";const b=new t.Bone;b.name="LHandIndex4";const S=new t.Bone;S.name="LHandMiddle";const L=new t.Bone;L.name="LHandMiddle2";const _=new t.Bone;_.name="LHandMiddle3";const k=new t.Bone;k.name="LHandMiddle4";const T=new t.Bone;T.name="LHandRing";const E=new t.Bone;E.name="LHandRing2";const R=new t.Bone;R.name="LHandRing3";const w=new t.Bone;w.name="LHandRing4";const I=new t.Bone;I.name="LHandPinky";const P=new t.Bone;P.name="LHandPinky2";const M=new t.Bone;M.name="LHandPinky3";const C=new t.Bone;C.name="LHandPinky4";const v=new t.Bone;v.name="RShoulder";const B=new t.Bone;B.name="RArm";const N=new t.Bone;N.name="RElbow";const O=new t.Bone;O.name="RWrist";const F=new t.Bone;F.name="RHandThumb";const H=new t.Bone;H.name="RHandThumb2";const D=new t.Bone;D.name="RHandThumb3";const U=new t.Bone;U.name="RHandThumb4";const V=new t.Bone;V.name="RHandIndex";const z=new t.Bone;z.name="RHandIndex2";const W=new t.Bone;W.name="RHandIndex3";const G=new t.Bone;G.name="RHandIndex4";const j=new t.Bone;j.name="RHandMiddle";const q=new t.Bone;q.name="RHandMiddle2";const Q=new t.Bone;Q.name="RHandMiddle3";const K=new t.Bone;K.name="RHandMiddle4";const J=new t.Bone;J.name="RHandRing";const Y=new t.Bone;Y.name="RHandRing2";const X=new t.Bone;X.name="RHandRing3";const Z=new t.Bone;Z.name="RHandRing4";const $=new t.Bone;$.name="RHandPinky";const tt=new t.Bone;tt.name="RHandPinky2";const et=new t.Bone;et.name="RHandPinky3";const st=new t.Bone;st.name="RHandPinky4";const it=new t.Bone;it.name="LUpLeg";const nt=new t.Bone;nt.name="LLeg";const at=new t.Bone;at.name="LFoot";const rt=new t.Bone;rt.name="RUpLeg";const ot=new t.Bone;ot.name="RLeg";const lt=new t.Bone;return lt.name="RFoot",e.add(s),s.add(i),i.add(n),n.add(a),n.add(h),n.add(v),a.add(r),r.add(o),r.add(l),h.add(c),c.add(d),d.add(p),p.add(m),p.add(A),p.add(S),p.add(T),p.add(I),m.add(u),u.add(f),f.add(g),A.add(y),y.add(x),x.add(b),S.add(L),L.add(_),_.add(k),T.add(E),E.add(R),R.add(w),I.add(P),P.add(M),M.add(C),v.add(B),B.add(N),N.add(O),O.add(F),O.add(V),O.add(j),O.add(J),O.add($),F.add(H),H.add(D),D.add(U),V.add(z),z.add(W),W.add(G),j.add(q),q.add(Q),Q.add(K),J.add(Y),Y.add(X),X.add(Z),$.add(tt),tt.add(et),et.add(st),e.add(it),it.add(nt),nt.add(at),e.add(rt),rt.add(ot),ot.add(lt),[e,s,i,n,a,r,o,l,h,c,d,p,m,u,f,g,A,y,x,b,S,L,_,k,T,E,R,w,I,P,M,C,v,B,N,O,F,H,D,U,V,z,W,G,j,q,Q,K,J,Y,X,Z,$,tt,et,st,it,nt,at,rt,ot,lt]};constructor(t,e,s={}){this.srcSkeleton=t,t.boneInverses||t.traverse(t=>{t.isSkinnedMesh&&(this.srcSkeleton=t.skeleton)}),this.trgSkeleton=e,e.boneInverses||e.traverse(t=>{t.isSkinnedMesh&&(this.trgSkeleton=t.skeleton)}),this.boneMap=this.computeBoneMap(this.srcSkeleton,this.trgSkeleton,s.boneNameMap),this.srcBindPose=this.cloneRawSkeleton(this.srcSkeleton,s.srcPoseMode,s.srcEmbedWorldTransforms),this.trgBindPose=this.cloneRawSkeleton(this.trgSkeleton,s.trgPoseMode,s.trgEmbedWorldTransforms),this.precomputedQuats=this.precomputeRetargetingQuats(),this.proportionRatio=this.computeProportionRatio()}_newTransform(){return{p:new t.Vector3(0,0,0),q:new t.Quaternion(0,0,0,1),s:new t.Vector3(1,1,1)}}cloneRawSkeleton(e,s,i=!1){let n,a=e.bones,r=new Array(a.length),o=new Int16Array(a.length);for(let t=0;t<a.length;++t)r[t]=a[t].clone(!1),r[t].parent=null;for(let t=0;t<a.length;++t){let s=qt(e,a[t].parent);s>-1&&r[s].add(r[t]),o[t]=s}if(r[0].updateWorldMatrix(!1,!0),s===jt.BindPoseModes.CURRENT)n=new t.Skeleton(r);else{let s=new Array(e.boneInverses.length);for(let t=0;t<s.length;++t)s[t]=e.boneInverses[t].clone();n=new t.Skeleton(r,s),n.pose()}n.parentIndices=o;let l=new Array(e.bones.length),h=new Array(e.bones.length);for(let t=0;t<l.length;++t){let e=this._newTransform();n.bones[t].matrixWorld.decompose(e.p,e.q,e.s),l[t]=e,e=this._newTransform(),n.boneInverses[t].decompose(e.p,e.q,e.s),h[t]=e}if(n.transformsWorld=l,n.transformsWorldInverses=h,i&&a[0].parent){let t={forward:this._newTransform(),inverse:this._newTransform()},s=t.forward;a[0].parent.updateWorldMatrix(!0,!1),a[0].parent.matrixWorld.decompose(s.p,s.q,s.s),s=t.inverse,e.bones[0].parent.matrixWorld.clone().invert().decompose(s.p,s.q,s.s),n.transformsWorldEmbedded=t}return n}computeBoneMap(t,e,s=null){let i=t.bones;e.bones;let n={idxMap:new Int16Array(i.length),nameMap:{}};if(n.idxMap.fill(-1),s)for(let i in s){let a=Qt(t,i);if(a<0)continue;let r=Qt(e,s[i]);n.idxMap[a]=r,n.nameMap[i]=s[i]}else{const s=Object.keys(jt.boneMap),i=Xt(t),a=Xt(e);if(i.idxMap.length&&a.idxMap.length)for(let t=0;t<s.length;t++){const e=s[t];i.idxMap[t]<0||(n.idxMap[i.idxMap[t]]=a.idxMap[t],n.nameMap[i.nameMap[e]]=a.nameMap[e])}}return n}computeProportionRatio(){let e=0;for(let s=1;s<this.srcBindPose.bones.length;s++){e+=this.srcBindPose.bones[s].getWorldPosition(new t.Vector3).distanceTo(this.srcBindPose.bones[s].parent.getWorldPosition(new t.Vector3))}let s=0;for(let e=1;e<this.trgBindPose.bones.length;e++){s+=this.trgBindPose.bones[e].getWorldPosition(new t.Vector3).distanceTo(this.trgBindPose.bones[e].parent.getWorldPosition(new t.Vector3))}return s/e}precomputeRetargetingQuats(){let e=new Array(this.srcBindPose.bones.length),s=new Array(this.srcBindPose.bones.length);for(let i=0;i<e.length;++i){let n=this.boneMap.idxMap[i];if(n<0){e[i]=null,s[i]=null;continue}let a=new t.Quaternion(0,0,0,1);if(a.copy(this.trgBindPose.transformsWorld[n].q),this.trgBindPose.transformsWorldEmbedded&&a.premultiply(this.trgBindPose.transformsWorldEmbedded.forward.q),this.srcBindPose.transformsWorldEmbedded&&a.premultiply(this.srcBindPose.transformsWorldEmbedded.inverse.q),a.premultiply(this.srcBindPose.transformsWorldInverses[i].q),s[i]=a,a=new t.Quaternion(0,0,0,1),this.srcBindPose.bones[i].parent){let t=this.srcBindPose.parentIndices[i];a.premultiply(this.srcBindPose.transformsWorld[t].q)}if(this.srcBindPose.transformsWorldEmbedded&&a.premultiply(this.srcBindPose.transformsWorldEmbedded.forward.q),this.trgBindPose.transformsWorldEmbedded&&a.premultiply(this.trgBindPose.transformsWorldEmbedded.inverse.q),this.trgBindPose.bones[n].parent){let t=this.trgBindPose.parentIndices[n];a.premultiply(this.trgBindPose.transformsWorldInverses[t].q)}e[i]=a}return{left:e,right:s}}_retargetQuaternion(e,s,i=null){return i||(i=new t.Quaternion(0,0,0,1)),i.copy(s),i.premultiply(this.precomputedQuats.left[e]),i.multiply(this.precomputedQuats.right[e]),i}retargetPose(){let t=this.boneMap.idxMap;for(let e=0;e<t.length;++e)t[e]<0||this._retargetQuaternion(e,this.srcSkeleton.bones[e].quaternion,this.trgSkeleton.bones[t[e]].quaternion)}retargetPositionTrack(e){let s=e.name.slice(0,e.name.length-9),i=Qt(this.srcSkeleton,s);if(i<0||this.boneMap.idxMap[i]<0)return null;let n=e.values,a=new Float32Array(n.length);if(0==i){let e=this.trgBindPose.bones[i].getWorldPosition(new t.Vector3),s=this.srcBindPose.bones[i].getWorldPosition(new t.Vector3),r=new t.Vector3;for(let i=0;i<n.length;i+=3){r.set(n[i],n[i+1],n[i+2]);let o=new t.Vector3;o.subVectors(r,s),o.multiplyScalar(this.proportionRatio),this.srcBindPose.transformsWorldEmbedded&&o.applyQuaternion(this.srcBindPose.transformsWorldEmbedded.forward.q),this.trgBindPose.transformsWorldEmbedded&&o.applyQuaternion(this.trgBindPose.transformsWorldEmbedded.inverse.q),o.add(e),a[i]=o.x,a[i+1]=o.y,a[i+2]=o.z}}return new t.VectorKeyframeTrack(this.boneMap.nameMap[s]+".position",e.times.slice(),a)}retargetQuaternionTrack(e){let s=e.name.slice(0,e.name.length-11),i=Qt(this.srcSkeleton,s);if(i<0||this.boneMap.idxMap[i]<0)return null;let n=new t.Quaternion(0,0,0,1),a=e.values,r=new Float32Array(a.length);for(let t=0;t<a.length;t+=4)n.set(a[t],a[t+1],a[t+2],a[t+3]),this._retargetQuaternion(i,n,n),r[t]=n.x,r[t+1]=n.y,r[t+2]=n.z,r[t+3]=n.w;return new t.QuaternionKeyframeTrack(this.boneMap.nameMap[s]+".quaternion",e.times.slice(),r)}retargetScaleTrack(e){let s=e.name.slice(0,e.name.length-6),i=Qt(this.srcSkeleton,s);return i<0||this.boneMap.idxMap[i]<0?null:new t.VectorKeyframeTrack(this.boneMap.nameMap[s]+".scale",e.times.slice(),e.values.slice())}retargetAnimation(e){let s=[],i=e.tracks;for(let t=0;t<i.length;++t){let e=i[t],n=null;e.name.endsWith(".position")&&e.name.includes(this.srcSkeleton.bones[0].name)?n=this.retargetPositionTrack(e):e.name.endsWith(".quaternion")?n=this.retargetQuaternionTrack(e):e.name.endsWith(".scale")&&(n=this.retargetScaleTrack(e)),n&&s.push(n)}return new t.AnimationClip(e.name,-1,s,e.blendMode)}}function qt(t,e){if(!e)return-1;let s=t.bones;for(let t=0;t<s.length;++t)if(s[t]==e)return t;return-1}function Qt(t,e){if(!e)return-1;let s=t.bones;for(let t=0;t<s.length;++t)if(s[t].name==e)return t;return-1}function Kt(e,s){s?Object.values(s).every(t=>null===t)&&(s=(s=Xt(e)).nameMap):s=(s=Xt(e)).nameMap;const i=e,n=new t.Vector3(1,0,0),a=new t.Vector3(0,1,0),r=new t.Vector3(0,0,1);Jt(i,i.bones[0].name,s.ShouldersUnion),Jt(i,s.LUpLeg,s.LFoot),Jt(i,s.RUpLeg,s.RFoot),Jt(i,s.LArm,s.LWrist),Jt(i,s.RArm,s.RWrist);const o=i.getBoneByName(s.LWrist);for(let t=0;t<o.children.length;t++)Jt(i,o.children[t]),Jt(i,s.LWrist,o.children[t].children[0]);const l=i.getBoneByName(s.RWrist);for(let t=0;t<l.children.length;t++)Jt(i,l.children[t]),Jt(i,s.RWrist,l.children[t].children[0]);const h=i.getBoneByName(s.RArm),c=i.getBoneByName(s.LArm),d=i.bones[0],p=i.getBoneByName(s.ShouldersUnion),m=h.getWorldPosition(new t.Vector3),u=c.getWorldPosition(new t.Vector3),f=d.getWorldPosition(new t.Vector3),g=p.getWorldPosition(new t.Vector3),A=new t.Vector3;A.subVectors(g,f).normalize();const y=new t.Vector3;y.subVectors(u,m).normalize(),function(e,s,i,n){let a=new t.Vector3;a.crossVectors(s,i).normalize();const r=a.angleTo(n);if(Math.abs(r)>.01){let s=new t.Vector3;s.crossVectors(a,n).normalize();const i=(new t.Quaternion).setFromAxisAngle(s,r);let o=e.getWorldQuaternion(new t.Quaternion);o=i.multiply(o);let l=o;if(e.parent){l=e.parent.getWorldQuaternion(new t.Quaternion).invert().multiply(o)}e.quaternion.copy(l),e.updateMatrix(),e.updateMatrixWorld(!1,!0)}}(i.bones[0],y,A,r),Yt(i,i.bones[0].name,s.ShouldersUnion,a);const x=a.clone().multiplyScalar(-1);Yt(i,s.LUpLeg,s.LFoot,x),Yt(i,s.RUpLeg,s.RFoot,x),Yt(i,s.LArm,s.LWrist,n);const b=n.clone().multiplyScalar(-1);Yt(i,s.RArm,s.RWrist,b);for(let t=0;t<o.children.length;t++)Yt(i,o.children[t],null,n);for(let t=0;t<l.children.length;t++)Yt(i,l.children[t],null,b);return i.update(),{skeleton:i,map:s}}function Jt(e,s,i){const n="string"==typeof s?e.getBoneByName(s):s;let a=null;if(i)a="string"==typeof i?e.getBoneByName(i):i;else{for(i=n;i.children.length;)i=i.children[0];a=i}let r=a.parent,o=r.parent;for(;o!=n.parent;){const e=a.getWorldPosition(new t.Vector3),s=r.getWorldPosition(new t.Vector3),i=o.getWorldPosition(new t.Vector3),n=new t.Vector3;n.subVectors(i,s).normalize();const l=new t.Vector3;l.subVectors(s,e);const h=l.angleTo(n);if(Math.abs(h)>.01){let e=new t.Vector3;e.crossVectors(l,n).normalize();const s=(new t.Quaternion).setFromAxisAngle(e,h);let i=r.getWorldQuaternion(new t.Quaternion);i=s.multiply(i);const a=o.getWorldQuaternion(new t.Quaternion).invert().multiply(i);r.quaternion.copy(a),r.updateMatrix(),r.updateMatrixWorld(!1,!0)}a=r,r=o,o=o.parent}}function Yt(e,s,i=null,n){const a="string"==typeof s?e.getBoneByName(s):s;a.updateMatrixWorld(!0,!0),i||(i=a.children[0]);const r="string"==typeof i?e.getBoneByName(i):i,o=a.getWorldPosition(new t.Vector3),l=r.getWorldPosition(new t.Vector3);let h=new t.Vector3;h.subVectors(l,o).normalize();const c=h.angleTo(n);if(Math.abs(c)>.001){let e=new t.Vector3;e.crossVectors(h,n).normalize();const s=(new t.Quaternion).setFromAxisAngle(e,c);let i=a.getWorldQuaternion(new t.Quaternion);i=s.multiply(i);let r=i;if(a.parent){r=a.parent.getWorldQuaternion(new t.Quaternion).invert().multiply(i)}a.quaternion.copy(r),a.updateMatrix(),a.updateMatrixWorld(!1,!0)}}function Xt(t){let e=jt.standardBones(),s=t.bones,i={idxMap:new Int16Array(e.length),nameMap:{}};i.idxMap.fill(-1);for(let t=0;t<e.length;t++){const n=e[t].name;for(let e=0;e<s.length;++e){let a=s[e].name;if("string"==typeof a&&(a=a.toLowerCase().replace("mixamorig","").replace(/[`~!@#$%^&*()_|+\-=?;:'"<>\{\}\\\/]/gi,""),!(a.length<1||a.toLowerCase()!=n.toLocaleLowerCase()&&a.toLowerCase()!=jt.boneMap[n].toLocaleLowerCase()))){i.nameMap[n]=s[e].name,i.idxMap[t]=e;break}}}const n=Zt(e[0]),a=Zt(s[0]);for(let t=0;t<e.length;t++){const r=e[t].name;if(i.nameMap[r])continue;const o=$t(e[t],n.depth,n.descendantCount);for(let e=0;e<s.length;e++){if(i.idxMap.indexOf(e)>-1)continue;if(te(o,$t(s[e],a.depth,a.descendantCount))){i.nameMap[r]=s[e].name,i.idxMap[t]=e;break}}i.nameMap[r]||console.warn("Failed to match bone by hierarchy structure: "+r)}return i}function Zt(t){const e={},s={},i=(t,n)=>{e[t.name]=n;let a=0;for(let e=0;e<t.children.length;e++){const s=t.children[e];s.isBone&&(a+=1+i(s,n+1))}return s[t.name]=a,a};return i(t,0),{depth:e,descendantCount:s}}function $t(t,e,s){return{depth:e[t.name],parentDepth:t.parent&&t.parent.isBone?e[t.parent.name]:-1,childCount:t.children.length,descendantCount:s[t.name]}}function te(t,e){return t.depth===e.depth&&t.parentDepth===e.parentDepth&&t.childCount===e.childCount}t.ShaderChunk.morphnormal_vertex="#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t    objectNormal += getMorph( gl_VertexID, i, 1, 2 ) * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",t.ShaderChunk.morphtarget_pars_vertex="#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform vec2 morphTargetsTextureSize;\n\t\tvec3 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset, const in int stride ) {\n\t\t\tfloat texelIndex = float( vertexIndex * stride + offset );\n\t\t\tfloat y = floor( texelIndex / morphTargetsTextureSize.x );\n\t\t\tfloat x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tvec3 morphUV = vec3( ( x + 0.5 ) / morphTargetsTextureSize.x, y / morphTargetsTextureSize.y, morphTargetIndex );\n\t\t\treturn texture( morphTargetsTexture, morphUV ).xyz;\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",t.ShaderChunk.morphtarget_vertex="#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\t#ifndef USE_MORPHNORMALS\n\t\t\t\ttransformed += getMorph( gl_VertexID, i, 0, 1 ) * morphTargetInfluences[ i ];\n\t\t\t#else\n\t\t\t\ttransformed += getMorph( gl_VertexID, i, 0, 2 ) * morphTargetInfluences[ i ];\n\t\t\t#endif\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif";class ee{constructor(){this.elapsedTime=0,this.clock=new t.Clock,this.loaderGLB=new i,this.controllers={},this.ECAcontroller=null,this.eyesTarget=null,this.headTarget=null,this.neckTarget=null,this.msg={},this.languageDictionaries={},this.selectedLanguage="NGT",this.loadedIdleAnimations={},this.bindedIdleAnimations={},this.currentIdle="",this.baseSkeleton=null,this.applyIdle=!1,this.intensity=.3,this.speed=1,this.mood="Neutral",this.moodIntensity=1,this.scene=null}loadMouthingDictionary(t){let e=this;fetch("./data/dictionaries/"+t+"/IPA/ipa.txt").then(t=>t.text()).then(function(s){let i=s.split("\n"),n={},a={},r={"'":"",".":" ",a:"a","":"a","":"a","":"@","":"E","":"c",e:"e","":"e","":"x",o:"o","":"I",i:"i",y:"i",u:"u","":"u",x:"k",j:"y",t:"t",p:"p",l:"l","":"G",k:"k",b:"b",s:"s","":"Z",m:"m",n:"n",v:"v",r:"r","":"g",f:"f","":"v",z:"z",h:"h",d:"d","":"g","":"S","":"J"},o={};for(let t=0;t<i.length;++t){let e=i[t].replace("\t","").split("/");if(e.length<2||0==e[0].length||0==e[1].length)continue;n[e[0]]=e[1];let s=e[1],o="";for(let t=0;t<s.length;++t){if(""==s[t]||":"==s[t]){o+=o[o.length-1];continue}let e=r[s[t]];null==e||(o+=e)}a[e[0]]=o}Object.keys(o).length>0&&console.error("MOUTHING: loading phonetics: unmapped IPA phonemes to ARPABET: \n",o),e.languageDictionaries[t].word2ARPA=a})}wordsToArpa(t,e="NGT"){if(!this.languageDictionaries[e]||!this.languageDictionaries[e].word2ARPA)return console.warn("missing word-ARPABET dictionary for "+e),"";let s=this.languageDictionaries[e].word2ARPA,i=t.replace(",","").replace(".","").split(" "),n="",a=[];for(let t=0;t<i.length;++t){let e=s[i[t]];e?n+=" "+e:a.push(i[t])}return a.length>0&&console.error("MOUTHING: phrase: ",t,"\nUnknown words: ",JSON.stringify(a)),n}loadLanguageDictionaries(t){this.languageDictionaries[t]={glosses:null,wordsToArpa:null},this.loadMouthingDictionary(t),fetch("./data/dictionaries/"+t+"/Glosses/_glossesDictionary.txt").then(t=>t.text()).then(e=>{let s=this.languageDictionaries[t].glosses={},i=e.split("\n");for(let t=0;t<i.length;++t){if(!i[t]||i[t].length<1)continue;let e=i[t].split("\t");e.length<2||(s[e[0]]=e[1].replace("\r","").replace("\n",""))}})}async loadIdleAnimations(t){let e=new a,s=[];for(let i=0;i<t.length;i++){let n=fetch(t[i]).then(t=>t.text()).then(s=>{const n=e.parseExtended(s),a=t[i].split("/").pop();this.loadBVHAnimation(a,n)});s.push(n)}return Promise.all(s)}loadBVHAnimation(e,s){let i=null,n=null,a=null;if(s&&s.skeletonAnim){if(i=s.skeletonAnim.skeleton,!i)return;i.bones.forEach(t=>{t.name=t.name.replace(/[`~!@#$%^&*()|+\-=?;:'"<>\{\}\\\/]/gi,"")}),i.bones[0].updateWorldMatrix(!1,!0),i=new t.Skeleton(i.bones),s.skeletonAnim.clip.tracks.forEach(t=>{t.name=t.name.replace(/[`~!@#$%^&*()|+\-=?;:'"<>\{\}\\\/]/gi,"")}),s.skeletonAnim.clip.name="bodyAnimation",n=s.skeletonAnim.clip}s&&s.blendshapesAnim&&(s.blendshapesAnim.clip.name="faceAnimation",a=s.blendshapesAnim.clip),this.loadedIdleAnimations[e]={name:e,bodyAnimation:n??new t.AnimationClip("bodyAnimation",-1,[]),faceAnimation:a??new t.AnimationClip("faceAnimation",-1,[]),skeleton:i,type:"bvhe"}}bindAnimationToCharacter(e,s){let i=this.loadedIdleAnimations[e];if(!i)return console.warn(e+" not found"),!1;this.currentAnimation=e;let n=this.controllers[s];if(n||console.warn(s+" not loaded"),n.originalSkeleton.pose(),!this.bindedIdleAnimations[e]||!this.bindedIdleAnimations[e][n.character.name]){let t=[],s=i.bodyAnimation;if(s){let e=[];for(let t=0;t<s.tracks.length;t++)s.tracks[t].name.includes("position")||(e.push(s.tracks[t]),e[e.length-1].name=e[e.length-1].name.replace(/[\[\]`~!@#$%^&*()|+\-=?;:'"<>\{\}\\\/]/gi,"").replace(".bones",""));s.tracks=e;let a=i.skeleton;s=new jt(a,n.character,{trgUseCurrentPose:!0,trgEmbedWorldTransforms:!0,srcPoseMode:jt.BindPoseModes.TPOSE,trgPoseMode:jt.BindPoseModes.TPOSE}).retargetAnimation(s),t=this.validateAnimationClip(s),s.name="bodyAnimation"}let a=i.faceAnimation;this.bindedIdleAnimations[e]||(this.bindedIdleAnimations[e]={}),this.bindedIdleAnimations[e][n.character.name]={mixerBodyAnimation:s,mixerFaceAnimation:a,bonesNames:t}}let a=this.bindedIdleAnimations[e][n.character.name],r=n.mixer;for(r.stopAllAction();r._actions.length;)r.uncacheClip(r._actions[0]._clip);r.clipAction(a.mixerBodyAnimation).setEffectiveWeight(this.intensity).play(),r.update(0),this.mixer=r,this.duration=a.mixerBodyAnimation.duration;let o=n.originalSkeleton.bones,l=new Array(o.length);for(let t=0;t<o.length;++t)l[t]=o[t].clone(!1),l[t].parent=null;for(let t=0;t<o.length;++t){let e=u.findIndexOfBone(n.originalSkeleton,o[t].parent);e>-1&&l[e].add(l[t])}return l[0].updateWorldMatrix(!1,!0),this.baseSkeleton=new t.Skeleton(l),!0}validateAnimationClip(e){let s=[],i=e.tracks,n=this.ECAcontroller.originalSkeleton.bones,a=[];i.map(t=>{a.push(t.name.split(".")[0])});for(let e=0;e<n.length;e++){let i=n[e].name;if(a.indexOf(i)>-1)continue;let r=[0],o=[n[e].quaternion.x,n[e].quaternion.y,n[e].quaternion.z,n[e].quaternion.w],l=new t.QuaternionKeyframeTrack(i+".quaternion",r,o);s.push(l)}return e.tracks=e.tracks.concat(s),a}init(e){this.loadLanguageDictionaries("NGT"),this.eyesTarget=new t.Object3D,this.eyesTarget.name="eyesTarget",this.eyesTarget.position.set(0,2.5,15),this.headTarget=new t.Object3D,this.headTarget.name="headTarget",this.headTarget.position.set(0,2.5,15),this.neckTarget=new t.Object3D,this.neckTarget.name="neckTarget",this.neckTarget.position.set(0,2.5,15),e.add(this.eyesTarget),e.add(this.headTarget),e.add(this.neckTarget),this.scene=e}update(t){t*=this.speed,this.elapsedTime+=t,this.ECAcontroller&&this.ECAcontroller.update(t,this.elapsedTime);const e=this.ECAcontroller.skeleton,s=this.ECAcontroller.originalSkeleton;if(this.applyIdle&&this.baseSkeleton&&this.mixer){this.bindedIdleAnimations[this.currentIdle]||this.bindAnimationToCharacter(this.currentIdle,this.ECAcontroller.character.name),this.mixer&&this.mixer.update(t/this.speed);const i=this.bindedIdleAnimations[this.currentIdle][this.ECAcontroller.character.name].bonesNames;for(let t=0;t<e.bones.length;t++){let n=e.bones[t].quaternion.clone();if(e.bones[t].name.includes("RightHand")||e.bones[t].name.includes("LeftHand")||i.indexOf(e.bones[t].name)<0){s.bones[t].quaternion.copy(n),s.bones[t].position.copy(e.bones[t].position);continue}const a=s.bones[t].quaternion.clone(),r=this.baseSkeleton.bones[t].quaternion.clone();n.multiply(r.invert().multiply(a)),s.bones[t].quaternion.copy(n)}s.bones[0].updateWorldMatrix(!1,!0)}else for(let t=0;t<e.bones.length;t++)s.bones[t].position.copy(e.bones[t].position),s.bones[t].quaternion.copy(e.bones[t].quaternion),s.bones[t].scale.copy(e.bones[t].scale)}replay(){this.msg&&this.ECAcontroller.processMsg(JSON.parse(JSON.stringify(this.msg)))}onLoadAvatar(e,s,i){let n=e.position.clone(),a=e.quaternion.clone(),r=e.scale.clone();e.position.set(0,0,0),e.quaternion.set(0,0,0,1),e.scale.set(1,1,1),e.eyesTarget=this.eyesTarget,e.headTarget=this.headTarget,e.neckTarget=this.neckTarget;const o=new t.AnimationMixer(e);this.mixer=o,i.pose();let l=i.bones,h=new Array(l.length);for(let t=0;t<l.length;++t)h[t]=l[t].clone(!1),h[t].parent=null;for(let t=0;t<l.length;++t){let e=u.findIndexOfBone(i,l[t].parent);e>-1&&h[e].add(h[t])}l[0].parent.clone(!1).add(h[0]),h[0].updateWorldMatrix(!0,!0);let c=new t.Skeleton(h),d=new u.CharacterController({character:e,characterConfig:s,skeleton:c});d.start(),d.reset(),d.processMsg({control:2}),d.originalSkeleton=i,d.mixer=o,this.ECAcontroller=this.controllers[e.name]=d,Object.keys(this.loadedIdleAnimations).length?this.bindAnimationToCharacter(this.currentIdle,e.name):this.loadIdleAnimations(["./data/animations/Idle.bvh","./data/animations/SitIdle.bvh","./data/animations/standingIdle.bvh"]).then(t=>{Object.keys(this.loadedIdleAnimations).length&&(this.currentIdle=Object.keys(this.loadedIdleAnimations)[0].replace("./data/animations/",""))}),e.position.copy(n),e.quaternion.copy(a),e.scale.copy(r)}onChangeAvatar(t){return!!this.controllers[t]&&(this.ECAcontroller=this.controllers[t],!0)}onApplyIdle(t){this.applyIdle=t,t&&!this.baseSkeleton&&this.bindAnimationToCharacter(this.currentIdle,this.ECAcontroller.character.name)}getLookAtPosition(e=new t.Vector3){return this.ECAcontroller&&this.ECAcontroller.skeleton.bones[this.ECAcontroller.characterConfig.boneMap.ShouldersUnion].getWorldPosition(e),e}async processMessageFiles(t=[]){let e=[];for(let s=0;s<t.length;s++){let i=null;const n=t[s];if(n.data)"bml"!=n.type&&"sigml"!=n.type||(i=new Promise(t=>{t(n)}));else{const t=n.name.substr(n.name.lastIndexOf(".")+1);"bml"!=t&&"sigml"!=t||(i=new Promise(e=>{fetch(n.name).then(t=>t.text()).then(s=>{e({type:t,data:s})})}))}e.push(i)}return Promise.all(e)}async processMessageRawBlocks(t=[],e=0){if(!t)return null;e=parseFloat(e);let s=e=isNaN(e)?0:e,i=[],n=this.languageDictionaries[this.selectedLanguage].glosses,a=0,r=0;for(let e=0;e<t.length;++e){let o=t[e];try{if("glossName"==o.type){let t=n[o.data];t?await fetch("./data/dictionaries/"+this.selectedLanguage+"/Glosses/"+t).then(t=>t.text()).then(e=>{let s=t.split(".");s=s[s.length-1],o={type:s,data:e}}):o={type:"invalid"}}if("bml"==o.type){let t=o.data;if("string"==typeof t&&(t=JSON.parse(t)),Array.isArray(t.behaviours))t=t.behaviours;else if(Array.isArray(t.data))t=t.data;else if(!Array.isArray(t))throw"error";s=s-r-a;let e=0,n=0;for(let i=0;i<t.length;++i){let a=t[i];isNaN(a.start)||(a.start+=s),isNaN(a.ready)||(a.ready+=s),isNaN(a.attackPeak)||(a.attackPeak+=s),isNaN(a.relax)||(n<a.relax&&(n=a.relax),a.relax+=s),isNaN(a.end)||(e<a.end&&(e=a.end),a.end+=s)}i=i.concat(t),s+=e,a=0,r=e-n}else{if("sigml"!=o.type){s+=3;continue}{s=s-r-a;let t=gt(o.data,s);i=i.concat(t.data),s+=t.duration,a=t.peakRelaxDuration,r=t.relaxEndDuration}}}catch(t){console.log("parse error: "+o),s+=3}}let o={type:"behaviours",data:i};return this.msg=JSON.parse(JSON.stringify(o)),this.ECAcontroller.processMsg(o),{msg:this.msg,duration:s-e,peakRelaxDuration:a,relaxEndDuration:r}}onMessage(t,e){t&&Array.isArray(t)&&(this.ECAcontroller.reset(),this.processMessageRawBlocks(t).then(t=>{e&&e(t)}))}setIntensity(t){if(this.intensity=t,this.mixer&&this.mixer._actions.length){this.mixer._actions[0].setEffectiveWeight(t),this.mixer.update(0);let e=this.ECAcontroller.originalSkeleton.bones;for(let t=0;t<e.length;++t)this.baseSkeleton.bones[t].position.copy(e[t].position),this.baseSkeleton.bones[t].quaternion.copy(e[t].quaternion),this.baseSkeleton.bones[t].scale.copy(e[t].scale);this.baseSkeleton.bones[0].updateWorldMatrix(!1,!0),this.baseSkeleton.calculateInverses()}}}class se{constructor(e,s){this.mixer=s,this.object=e,this.trajectories={LeftHand:new t.Group({name:"LeftHand",thickness:8}),LeftHandThumb4:new t.Group({name:"LeftHandThumb4",thickness:6,color:new t.Color("#51A3A3")}),LeftHandIndex4:new t.Group({name:"LeftHandIndex4",thickness:6,color:new t.Color("#75485E")}),LeftHandMiddle4:new t.Group({name:"LeftHandMiddle4",thickness:6,color:new t.Color("#CB904D")}),LeftHandRing4:new t.Group({name:"LeftHandRing4",thickness:6,color:new t.Color("#DFCC74")}),LeftHandPinky4:new t.Group({name:"LeftHandPinky4",thickness:6,color:new t.Color("#C3E991")}),RightHand:new t.Group({name:"RightHand",thickness:8}),RightHandThumb4:new t.Group({name:"RightHandThumb4",thickness:6,color:new t.Color("#51A3A3")}),RightHandIndex4:new t.Group({name:"RightHandIndex4",thickness:6,color:new t.Color("#75485E")}),RightHandMiddle4:new t.Group({name:"RightHandMiddle4",thickness:6,color:new t.Color("#CB904D")}),RightHandRing4:new t.Group({name:"RightHandRing4",thickness:6,color:new t.Color("#DFCC74")}),RightHandPinky4:new t.Group({name:"RightHandPinky4",thickness:6,color:new t.Color("#C3E991")})};for(const e in this.trajectories)this.trajectories[e].thickness=6,e.includes("Thumb")?this.trajectories[e].color=new t.Color("#51A3A3"):e.includes("Index")?this.trajectories[e].color=new t.Color("#75485E"):e.includes("Middle")?this.trajectories[e].color=new t.Color("#CB904D"):e.includes("Ring")?this.trajectories[e].color=new t.Color("#DFCC74"):e.includes("Pinky")?this.trajectories[e].color=new t.Color("#C3E991"):this.trajectories[e].thickness=8,this.trajectories[e].layers.set(2);this.trajectoryStart=0,this.trajectoryEnd=100}computeTrajectories(e){let s=null;this.dispose();for(let t=0;t<e.mixerBodyAnimation.tracks.length;t++){const i=e.mixerBodyAnimation.tracks[t].name;for(let t in this.trajectories)if((i.includes(t+".")||i.includes(t.replace("4","EndSite")+"."))&&(s=i.replace(".quaternion",""),s)){this.trajectories[t].name=s;("LeftHand"==t||"RightHand"==t?this.object:this.object.getObjectByName(s.replace("4","1").replace("EndSite","1"))).add(this.trajectories[t]);break}}const i=this.mixer,n=e.mixerBodyAnimation.tracks[0];this.trajectoryEnd=n.times.length;const a=t=>{let e=t.name.replace("mixamorig","").replaceAll("_","").replaceAll(":","");for(;t&&!e.includes("1");)e=(t=t.parent).name.replace("mixamorig","").replaceAll("_","").replaceAll(":","");return t};this.object.updateMatrixWorld(!0);for(let e in this.trajectories){const s=this.trajectories[e].name,r=[],o=[],c=this.object.getObjectByName(s),d="LeftHand"==e||"RightHand"==e,p=d?null:a(c),m=new t.Vector3,u=new t.Vector3,f=new t.Matrix4;for(let s=0;s<n.times.length;s++){if(i.setTime(n.times[s]),c.updateWorldMatrix(!0,!1),d)m.setFromMatrixPosition(c.matrixWorld);else{if(!c||!p)break;f.copy(p.matrixWorld).invert().multiply(c.matrixWorld),m.setFromMatrixPosition(f)}if(r.push(m.x,m.y,m.z),s>0){const i=this.trajectories[e].color||new t.Color(`hsl(${180*Math.sin(n.times[s]/Math.PI)}, 100%, 50%)`);o.push(i.r,i.g,i.b,.8),o.push(i.r,i.g,i.b,.8);const a=ne(m.x,m.y,m.z,u.x,u.y,u.z,2e-4*this.trajectories[e].thickness,i);a&&(a.name=s-1,a.layers.set(2),this.trajectories[e].add(a))}u.set(m.x,m.y,m.z)}const g=new oe;g.setPositions(r),g.setAttribute("color",new t.Float32BufferAttribute(o,4)),g.setColors(o);const A=new l({vertexColors:!0,dashed:!1,alphaToCoverage:!0,linewidth:this.trajectories[e].thickness,vertexShader:re,fragmentShader:ae,transparent:!0});A.resolution.set(window.innerWidth,window.innerHeight);const y=new h(g,A);y.name="line",y.layers.set(2),this.trajectories[e].add(y),this.trajectories[e].positions=r,this.trajectories[e].colors=o}}updateTrajectories(t,e){const s=this.mixer._actions[0];if(!s)return;const i=ie(s,t);this.trajectoryStart=i;const n=ie(s,e);this.trajectoryEnd=n;for(let t in this.trajectories){const e=this.trajectories[t].positions;let s=this.trajectories[t].colors;const a=e.length/3;if(a<2)continue;const r=this.trajectories[t].children,o=r[r.length-1];let l=r[0].isLine2?-1:r[0].name,h=0;for(let t=0;t<a;t++){let e=0;t<i?e=(t-i)/10:t>n&&(e=(n-t)/10);const a=Math.max(0,Math.min(1,.8+e));if(s[8*t+3]=a,s[8*t+7]=a,l==t){const t=r[h];t.children[0].material.opacity=a,t.visible=a>0,h++,l=r[h].isLine2?-1:r[h].name}}o.geometry.setColors(s)}}show(){for(let t in this.trajectories)this.trajectories[t].visible=!0}hide(){for(let t in this.trajectories)this.trajectories[t].visible=!1}dispose(){for(const t in this.trajectories)this.trajectories[t].traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.trajectories[t].clear(),this.trajectories[t].removeFromParent()}}const ie=(t,e=t.time,s=0)=>{if(!t)return-1;const i=e,n=t._clip.tracks[0].times;let a=0,r=n.length-1;if(n[a]>i)return-1==s?-1:0;if(n[r]<i)return 1==s?-1:r;let o=Math.floor((a+r)/2);for(;a<o&&o<r;)i<n[o]?r=o:a=o,o=Math.floor((a+r)/2);return 0==s?Math.abs(i-n[a])<Math.abs(i-n[r])?a:r:-1==s?n[r]==i?r:a:n[a]==i?a:r},ne=(e,s,i,n,a,r,o,l)=>{const h=Math.sqrt((n-e)**2+(a-s)**2+(r-i)**2);if(h<.01)return null;const c=new t.MeshLambertMaterial({color:l,transparent:!0}),d=new t.ConeGeometry(1,1,3).rotateX(Math.PI/2).translate(0,0,-.5),p=new t.Mesh(d,c);p.position.set(0,0,h),p.scale.set(2*o,2*o,8*o);const m=new t.Group;return m.position.set(n,a,r),m.lookAt(e,s,i),m.add(p),m},ae="\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float linewidth;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\tfloat mua;\n\t\t\tfloat mub;\n\n\t\t\tvec3 p13 = p1 - p3;\n\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\tmua = numer / denom;\n\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\treturn vec2( mua, mub );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tfloat alpha = opacity;\n\t\t\tvec4 diffuseColor = vec4( vec3(1.0,1.0,1.0), alpha );\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// Find the closest points on the view ray and the line segment\n\t\t\t\tvec3 rayEnd = normalize( worldPos.xyz ) * 1e5;\n\t\t\t\tvec3 lineDir = worldEnd - worldStart;\n\t\t\t\tvec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n\t\t\t\tvec3 p1 = worldStart + lineDir * params.x;\n\t\t\t\tvec3 p2 = rayEnd * params.y;\n\t\t\t\tvec3 delta = p1 - p2;\n\t\t\t\tfloat len = length( delta );\n\t\t\t\tfloat norm = len / linewidth;\n\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\tfloat dnorm = fwidth( norm );\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tif ( norm > 0.5 ) {\n\n\t\t\t\t\t\t\tdiscard;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t#else\n\n\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\tfloat len2 = a * a + b * b;\n\t\t\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t#endif\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n            #ifdef USE_COLOR_ALPHA\n                alpha = vColor.a;\n                //diffuseColor.rgb = vColor.rbg;\n            #endif\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, alpha );\n\n\t\t\t// #include <tonemapping_fragment>\n\t\t\t// #include <colorspace_fragment>\n\t\t\t// #include <fog_fragment>\n\t\t\t// #include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t",re="\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n        #ifdef USE_COLOR_ALPHA\n\n            attribute vec4 instanceColorStart;\n            attribute vec4 instanceColorEnd;\n        #else\n            attribute vec3 instanceColorStart;\n            attribute vec3 instanceColorEnd;\n        #endif\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n            \n            #ifdef USE_COLOR_ALPHA\n                vColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n            #endif\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart.xyz : instanceColorEnd.xyz;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tworldStart = start.xyz;\n\t\t\t\tworldEnd = end.xyz;\n\n\t\t\t#else\n\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz );\n\t\t\t\tvec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );\n\t\t\t\tvec3 worldUp = normalize( cross( worldDir, tmpFwd ) );\n\t\t\t\tvec3 worldFwd = cross( worldDir, worldUp );\n\t\t\t\tworldPos = position.y < 0.5 ? start: end;\n\n\t\t\t\t// height offset\n\t\t\t\tfloat hw = linewidth * 0.5;\n\t\t\t\tworldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;\n\n\t\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t\t// won't be rendering the endcaps\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t// cap extension\n\t\t\t\t\tworldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;\n\n\t\t\t\t\t// add width to the box\n\t\t\t\t\tworldPos.xyz += worldFwd * hw;\n\n\t\t\t\t\t// endcaps\n\t\t\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\n\t\t\t\t\t\tworldPos.xyz -= worldFwd * 2.0 * hw;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t\t// project the worldpos\n\t\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n\t\t\t\t// shift the depth of the projected points so the line\n\t\t\t\t// segments overlap neatly\n\t\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\t\tclip.z = clipPose.z * clip.w;\n\n\t\t\t#else\n\n\t\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\t\t\t\t// undo aspect ratio adjustment\n\t\t\t\tdir.x /= aspect;\n\t\t\t\toffset.x /= aspect;\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\t\toffset += - dir;\n\n\t\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\t\toffset += dir;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth;\n\n\t\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\t\toffset /= resolution.y;\n\n\t\t\t\t// select end\n\t\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t\t// back to clip space\n\t\t\t\toffset *= clip.w;\n\n\t\t\t\tclip.xy += offset;\n\n\t\t\t#endif\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t";class oe extends o{constructor(){super()}setColors(e){const s=e.length-4;let i=new Float32Array(2*s);for(let t=0;t<s;t+=4)i[2*t]=e[t],i[2*t+1]=e[t+1],i[2*t+2]=e[t+2],i[2*t+3]=e[t+3],i[2*t+4]=e[t+4],i[2*t+5]=e[t+5],i[2*t+6]=e[t+6],i[2*t+7]=e[t+7];e instanceof Float32Array?i=e:Array.isArray(e)&&(i=new Float32Array(e));const n=new t.InstancedInterleavedBuffer(i,8,1);return this.setAttribute("instanceColorStart",new t.InterleavedBufferAttribute(n,4,0)),this.setAttribute("instanceColorEnd",new t.InterleavedBufferAttribute(n,4,4)),this}}class le{constructor(){this.elapsedTime=0,this.clock=new t.Clock,this.GLTFLoader=new i,this.FBXLoader=new r,this.BVHLoader=new a,this.currentCharacter="",this.loadedCharacters={},this.currentAnimation="",this.loadedAnimations={},this.bindedAnimations={},this.mixer=null,this.playing=!1,this.speed=1,this.blendTime=1,this.useCrossFade=!1,this.srcPoseMode=jt.BindPoseModes.DEFAULT,this.trgPoseMode=jt.BindPoseModes.DEFAULT,this.srcEmbedWorldTransforms=!1,this.trgEmbedWorldTransforms=!0,this.trajectoriesHelper=null,this.trajectoriesStart=0,this.trajectoriesEnd=0,this.trajectoriesActive=!1,this.trajectoriesComputationPending=!0,fetch("https://resources.gti.upf.edu/3Dcharacters/Eva_Low/Eva_Low.json").then(t=>t.json()).then(t=>this.stardardConfig=t)}update(t){t*=this.speed,this.elapsedTime+=t,this.playing&&this.mixer&&this.mixer.update(t)}changePlayState(t=!this.playing){this.playing=t,this.playing&&this.mixer&&this.mixer.setTime(0)}onLoadAvatar(e){const s=new t.AnimationMixer(e.model);this.currentCharacter=e.model.name,this.loadedCharacters[e.model.name]=e,this.loadedCharacters[e.model.name].mixer=s,this.mixer=s}onChangeAvatar(e){if(!this.loadedCharacters[e])return!1;this.trajectoriesHelper&&this.trajectoriesHelper.dispose(),this.trajectoriesHelper=new se(this.loadedCharacters[e].model,this.loadedCharacters[e].mixer),this.trajectoriesComputationPending=!0,this.trajectoriesActive?this.trajectoriesHelper.show():this.trajectoriesHelper.hide(),this.currentCharacter=e,this.mixer=this.loadedCharacters[e].mixer,this.onChangeAnimation(this.currentAnimation,!0),this.changePlayState(this.playing);const s=this.loadedCharacters[e].skeleton.getBoneByName(this.loadedCharacters[e].LToeName).getWorldPosition(new t.Vector3);this.loadedCharacters[e].skeleton.getBoneByName(this.loadedCharacters[e].RToeName).getWorldPosition(new t.Vector3);let i=this.loadedCharacters[e].LToePos.y-s.y;return this.loadedCharacters[e].model.position.y=this.loadedCharacters[e].position.y-this.loadedCharacters[e].diffToGround+i,!0}onChangeAnimation(e,s){if(!e||!this.loadedAnimations[e])return void console.warn(e+"not found");const i=this.loadedCharacters[this.currentCharacter];i.model.position.y=this.loadedCharacters[this.currentCharacter].position.y,i.rotation=i.model.quaternion.clone(),i.scale=i.model.scale.clone(),i.model.quaternion.set(0,0,0,1),i.model.scale.set(1,1,1);let n=null;if(s){for(let t in this.loadedAnimations)this.bindAnimationToCharacter(t,this.currentCharacter,!0);for(n=this.bindedAnimations[e][this.currentCharacter],this.mixer.stopAllAction();this.mixer._actions.length;)this.mixer.uncacheClip(this.mixer._actions[0]._clip);this.mixer.clipAction(n.mixerBodyAnimation).setEffectiveWeight(1).play(),this.currentAnimation=e}else if(n=this.bindedAnimations[e][this.currentCharacter],this.mixer._actions.length&&this.useCrossFade){let t=this.mixer.clipAction(n.mixerBodyAnimation);t.setEffectiveWeight(1),t.play();for(let s=0;s<this.mixer._actions.length;s++)if(this.mixer._actions[s]._clip==this.bindedAnimations[this.currentAnimation][this.currentCharacter].mixerBodyAnimation){this.prepareCrossFade(this.mixer._actions[s],t,this.blendTime),this.currentAnimation=e;break}}else{for(;this.mixer._actions.length;)this.mixer.uncacheClip(this.mixer._actions[0]._clip);this.mixer.clipAction(n.mixerBodyAnimation).setEffectiveWeight(1).play(),this.currentAnimation=e}this.mixer.update(.1),this.mixer.update(0);const a=this.loadedCharacters[this.currentCharacter].model.getObjectByName(this.loadedCharacters[this.currentCharacter].LToeName).getWorldPosition(new t.Vector3);this.loadedCharacters[this.currentCharacter].model.getObjectByName(this.loadedCharacters[this.currentCharacter].RToeName).getWorldPosition(new t.Vector3);let r=this.loadedCharacters[this.currentCharacter].LToePos.y-a.y;this.loadedCharacters[this.currentCharacter].model.position.y=this.loadedCharacters[this.currentCharacter].position.y-this.loadedCharacters[this.currentCharacter].diffToGround+r,i.model.quaternion.copy(i.rotation),i.model.scale.copy(i.scale),this.trajectoriesStart=0,this.trajectoriesEnd=n.mixerBodyAnimation.duration,this.trajectoriesActive?(this.computeTrajectories(n),this.showTrajectories()):(this.trajectoriesComputationPending=!0,this.hideTrajectories())}prepareCrossFade(t,e,s){this.unPauseAllActions(t),this.synchronizeCrossFade(t,e,s)}synchronizeCrossFade(t,e,s){const i=n=>{n.action===t&&(this.mixer.removeEventListener("loop",i),this.executeCrossFade(t,e,s))};this.mixer.addEventListener("loop",i)}executeCrossFade(t,e,s){e.enabled=!0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1),e.time=0,t.crossFadeTo(e,s,!0)}unPauseAllActions(t){this.mixer._actions.forEach(e=>{e!=t&&(e.enabled=!1)})}onMessage(t,e){this.processMessageFiles(t.data).then(t=>{if(t){for(let e=0;e<t.length;e++)this.bindAnimationToCharacter(t[e],this.currentCharacter);this.currentAnimation=t[0]}e&&e(t)})}async processMessageFiles(e=[]){let s=[],i=null,n="bvh";for(let a=0;a<e.length;a++){const r=e[a],o=r.name.substr(r.name.lastIndexOf(".")+1);"bvh"==o||"bvhe"==o?(i=this.BVHLoader,n="bvh"):"fbx"==o?(i=this.FBXLoader,n="fbx"):(i=this.GLTFLoader,n="glb");let l=null;l=new Promise("bvh"==n?t=>{const e=e=>{let s=this.BVHLoader.parseExtended(e),i=r.name;if(this.loadedAnimations[i]){let t=r.name.split(".");t.pop(),t.join("."),i=i+"_"+t}this.loadBVHAnimation(i,s),t(i)},s=new FileReader;s.onload=()=>{e(s.result)};let i=r.data??r;r.constructor.name==File.name||r.data&&"object"==typeof r.data?s.readAsText(i):r.data&&"string"==typeof r.data?e(r.data):fetch(r.name||r).then(t=>{t.ok?t.text().then(t=>{e(t)}):console.log("Not found")}).catch(function(t){console.log("Error:"+t.message)})}:e=>{const s=s=>{i.load(s,s=>{let i=null,n=s.scene?s.scene:s;n.traverse(t=>{t.skeleton&&(i=t.skeleton)});let a=[];if(i){let t=i.bones[0];for(;t.parent&&"Scene"!=t.parent.type;)t=t.parent;t.skeleton=i}else{if(!this.loadedAnimations[this.currentAnimation])return void e(a);i=this.loadedAnimations[this.currentAnimation].skeleton}for(let e=0;e<s.animations.length;e++){let o=s.animations[e].name;const l=[];for(let i=0;i<s.animations[e].tracks.length;i++){let a=s.animations[e].tracks[i];const r=t.PropertyBinding.parseTrackName(a.name);r.nodeName;let o=r.propertyIndex;if("morphTargetInfluences"!=r.propertyName||o){l.push(a);continue}const h=t.PropertyBinding.findNode(n,r.nodeName),c=h.morphTargetInfluences.length,d=a.times;for(let e in h.morphTargetDictionary){const s=h.morphTargetDictionary[e],i=new a.ValueBufferType(a.times.length);for(let t=0;t<d.length;t++)i[t]=a.values[t*c+s];l.push(new t.NumberKeyframeTrack(a.name+"["+e+"]",d,i,a.getInterpolation()))}}if(s.animations[e].tracks=l,this.loadedAnimations[o]){let t=r.name.split(".");t.pop(),t.join("."),o=o+"_"+t}this.loadGLTFAnimation(o,s.animations[e],i),a.push(o)}e(a)})};let n=r.data??r;if(r.constructor.name!=File.name)s(r.name||r);else{const t=new FileReader;t.onload=()=>{s(t.result)},t.readAsDataURL(n)}}),s.push(l)}return Promise.all(s)}loadFiles(t,e){this.processMessageFiles(t).then(t=>{if(t[0].length){let s="string"==typeof t[0]?t[0]:t[0][0];this.currentAnimation=s,e&&e(s)}else e&&e()})}loadBVHAnimation(e,s){let i=null,n=null,a=null;if(s&&s.skeletonAnim){if(i=s.skeletonAnim.skeleton,!i)return;i.bones.forEach(t=>{t.name=t.name.replace(/[`~!@#$%^&*()_|+\-=?;:'"<>\{\}\\\/]/gi,"")}),i.bones[0].updateWorldMatrix(!1,!0),i=new t.Skeleton(i.bones),s.skeletonAnim.clip.tracks.forEach(t=>{t.name=t.name.replace(/[`~!@#$%^&*()_|+\-=?;:'"<>\{\}\\\/]/gi,"")}),s.skeletonAnim.clip.name="bodyAnimation",n=s.skeletonAnim.clip}s&&s.blendshapesAnim&&(s.blendshapesAnim.clip.name="faceAnimation",a=s.blendshapesAnim.clip),this.loadedAnimations[e]={name:e,bodyAnimation:n??new t.AnimationClip("bodyAnimation",-1,[]),faceAnimation:a??new t.AnimationClip("faceAnimation",-1,[]),skeleton:i,type:"bvhe"},this.bindAnimationToCharacter(e,this.currentCharacter)}loadGLTFAnimation(e,s,i,n){this.loadedAnimations[e]={name:e,bodyAnimation:s??new t.AnimationClip("bodyAnimation",-1,[]),skeleton:i,model:n,type:"glb"},this.onLoadGLTFAnimation&&this.onLoadGLTFAnimation(this.loadedAnimations[e]),this.bindAnimationToCharacter(e,this.currentCharacter)}bindAnimationToCharacter(e,s,i){let n=this.loadedAnimations[e];if(!n)return console.warn(e+" not found"),!1;let a=this.loadedCharacters[s];a||console.warn(s+" not loaded");let r=a.mixer;this.mixer=r;let o=null,l=null;if(!this.bindedAnimations[e]||!this.bindedAnimations[e][s]||i){(s.includes("readyplayerme")||s.includes("Eva"))&&(this.trgPoseMode=2,this.srcPoseMode=2);let i=this.srcPoseMode,r=this.trgPoseMode;if(this.trgPoseMode!=jt.BindPoseModes.CURRENT&&this.trgPoseMode!=jt.BindPoseModes.DEFAULT){a.skeleton.pose();const t=Kt(a.skeleton).skeleton;t?(a.skeleton=t,r=jt.BindPoseModes.CURRENT):console.warn("T-pose can't be applyied to the TARGET. Automap falied.")}else this.trgPoseMode==jt.BindPoseModes.DEFAULT&&a.skeleton.pose();if(l=Object.assign({},n.bodyAnimation),l){let e=[];const s=[];for(let i=0;i<l.tracks.length;i++)l.tracks[i].constructor.name!=t.NumberKeyframeTrack.name?i&&l.tracks[i].name.includes("position")||(e.push(l.tracks[i]),e[e.length-1].name=e[e.length-1].name.replace(".bones","")):s.push(l.tracks[i]);if(l.tracks=e,this.srcPoseMode!=jt.BindPoseModes.CURRENT&&this.srcPoseMode!=jt.BindPoseModes.DEFAULT){n.skeleton.pose();const t=Kt(n.skeleton).skeleton;t?(n.skeleton=t,i=jt.BindPoseModes.CURRENT):console.warn("T-pose can't be applyied to the SOURCE. Automap falied.")}else this.srcPoseMode==jt.BindPoseModes.DEFAULT&&a.skeleton.pose();l=new jt(n.skeleton,a.model,{srcEmbedWorldTransforms:this.srcEmbedWorldTransforms,trgEmbedWorldTransforms:this.trgEmbedWorldTransforms,srcPoseMode:i,trgPoseMode:r}).retargetAnimation(l),this.validateAnimationClip(l),s.length&&(o=new t.AnimationClip("faceAnimation",l.duration,s)),l.name="bodyAnimation"}n.faceAnimation&&(o=o?n.faceAnimation.tracks.concat(o.tracks):n.faceAnimation);let h=null;if(o){h=o.clone();const e=a.morphTargets,s=Object.values(e),i=a.config?a.config.faceController.blendshapeMap:null,n=a.config?a.config.faceController.parts:null,r=[],c=[],d=[];for(let e=0;e<o.tracks.length;e++){const a=o.tracks[e],l=a.times;let h=a.values;const p=t.PropertyBinding.parseTrackName(a.name);p.nodeName;let m=p.propertyIndex;if(!m){r.push(a);continue}let u=1;if(!d.includes(m)){if(i){let e=!1;for(let t=0;t<s.length;t++)if(null!=s[t][m]){e=!0,r.push(a);break}if(e)continue;if(this.stardardConfig){const t=this.stardardConfig.faceController.blendshapeMap;let s=[],i=[];for(let e in t){const n=t[e];for(let t=0;t<n.length;t++)if(n[t][0]==m){s.push(e),i.push(1);break}}s.length&&(d.push(m),e=!0),m=s,u=i}for(let e in i){const s=i[e];m instanceof String&&(m=[m],u=[u]);for(let i=0;i<m.length;i++)if(e==m[i])for(let e=0;e<s.length;e++){const a=s[e][0];if(a){u[i]<1&&(h=h.map(t=>t*u[i]));for(let e in n){const s=e+".morphTargetInfluences["+a+"]",n=c.indexOf(s);n>-1&&u[i]<1?r[n].values=r[n].values.map((t,e)=>t+h[e]):(r.push(new t.NumberKeyframeTrack(s,l,h)),c.push(s))}break}}}}r.length<(e+1)*s.length&&r.push(a)}}r&&(h.tracks=r),l.tracks=l.tracks.concat(h.tracks)}this.bindedAnimations[e]||(this.bindedAnimations[e]={}),this.bindedAnimations[e][this.currentCharacter]={mixerBodyAnimation:l,mixerFaceAnimation:h}}return!0}validateAnimationClip(e){let s=[],i=e.tracks,n=this.loadedCharacters[this.currentCharacter].skeleton.bones,a=[];i.map(t=>{a.push(t.name.split(".")[0])});for(let e=0;e<n.length;e++){let i=n[e].name;if(a.indexOf(i)>-1)continue;let r=[0],o=[n[e].quaternion.x,n[e].quaternion.y,n[e].quaternion.z,n[e].quaternion.w],l=new t.QuaternionKeyframeTrack(i+".quaternion",r,o);s.push(l)}e.tracks=e.tracks.concat(s)}exportAnimations(){const e=[];for(let s in this.bindedAnimations){const i=this.bindedAnimations[s][this.currentCharacter],n=s;let a=[];i.mixerBodyAnimation&&(a=a.concat(i.mixerBodyAnimation.tracks)),i.mixerFaceAnimation&&(a=a.concat(i.mixerFaceAnimation.tracks)),i.mixerAnimation&&(a=a.concat(i.mixerAnimation.tracks)),e.push(new t.AnimationClip(n,-1,a))}return e}computeTrajectories(t){this.trajectoriesHelper&&t&&(this.trajectoriesHelper.computeTrajectories(t),this.trajectoriesComputationPending=!1)}updateTrajectories(t,e){this.trajectoriesHelper&&(this.trajectoriesStart=t,this.trajectoriesEnd=e,this.trajectoriesHelper.updateTrajectories(t,e))}showTrajectories(){if(this.trajectoriesHelper&&(this.trajectoriesHelper.show(),this.trajectoriesActive=!0,window.localStorage.setItem("trajectories",this.trajectoriesActive),this.bindedAnimations[this.currentAnimation]&&this.trajectoriesComputationPending)){const t=this.bindedAnimations[this.currentAnimation][this.currentCharacter];this.computeTrajectories(t)}}hideTrajectories(){this.trajectoriesHelper&&(this.trajectoriesHelper.hide(),this.trajectoriesActive=!1,window.localStorage.setItem("trajectories",this.trajectoriesActive))}}t.ShaderChunk.morphnormal_vertex="#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t    objectNormal += getMorph( gl_VertexID, i, 1, 2 ) * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",t.ShaderChunk.morphtarget_pars_vertex="#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform vec2 morphTargetsTextureSize;\n\t\tvec3 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset, const in int stride ) {\n\t\t\tfloat texelIndex = float( vertexIndex * stride + offset );\n\t\t\tfloat y = floor( texelIndex / morphTargetsTextureSize.x );\n\t\t\tfloat x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tvec3 morphUV = vec3( ( x + 0.5 ) / morphTargetsTextureSize.x, y / morphTargetsTextureSize.y, morphTargetIndex );\n\t\t\treturn texture( morphTargetsTexture, morphUV ).xyz;\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",t.ShaderChunk.morphtarget_vertex="#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\t#ifndef USE_MORPHNORMALS\n\t\t\t\ttransformed += getMorph( gl_VertexID, i, 0, 1 ) * morphTargetInfluences[ i ];\n\t\t\t#else\n\t\t\t\ttransformed += getMorph( gl_VertexID, i, 0, 2 ) * morphTargetInfluences[ i ];\n\t\t\t#endif\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif";class he{constructor(){this.elapsedTime=0,this.clock=new t.Clock,this.loaderGLB=new i,this.GLTFExporter=new n,this.scene=null,this.renderer=null,this.camera=null,this.cameras=[],this.controls=[],this.cameraRestricted=!0,this.loadedCharacters={},this.currentCharacter=null,this.backPlane=null,this.avatarShirt=null,this.autoplay=!1,this.mode=c.Modes.SCRIPT,this.scriptApp=new ee,this.keyframeApp=new le,this.isAppReady=!1,this.pendingMessageReceived=null,this.controlsActive=!0,this.sceneColor="#46c219",this.background=window.localStorage.getItem("background")||c.Backgrounds.OPEN,this.logo="./data/imgs/performs2.png",this.videoBackground=null,this.backgroundSettings="Expand",this.textureScale=1,this.texturePosition=[0,0],this._atelier=null,this.raycaster=new t.Raycaster,this.avatars={Eva:[c.AVATARS_URL+"Eva_Low/Eva_Low.glb",c.AVATARS_URL+"Eva_Low/Eva_Low.json",0,c.AVATARS_URL+"Eva_Low/Eva_Low.png"],"Ready Eva":[c.AVATARS_URL+"ReadyEva/ReadyEva.glb",c.AVATARS_URL+"ReadyEva/ReadyEva_v3.json",0,c.AVATARS_URL+"ReadyEva/ReadyEva.png"],Victor:[c.AVATARS_URL+"Victor/Victor.glb",c.AVATARS_URL+"Victor/Victor.json",0,c.AVATARS_URL+"Victor/Victor.png"],Sara:[c.AVATARS_URL+"Sara/Sara.glb",c.AVATARS_URL+"Sara/Sara.json",0,c.AVATARS_URL+"Sara/Sara.png"],Nia:[c.AVATARS_URL+"Nia/Nia.glb",c.AVATARS_URL+"Nia/Nia.json",0,c.AVATARS_URL+"Nia/Nia.png"],Joan:[c.AVATARS_URL+"Joan/Joan.glb",c.AVATARS_URL+"Joan/Joan.json",0,c.AVATARS_URL+"Joan/Joan.png"],David:[c.AVATARS_URL+"David/David.glb",c.AVATARS_URL+"David/David.json",0,c.AVATARS_URL+"David/David.png"],Alex:[c.AVATARS_URL+"Alex/Alex.glb",c.AVATARS_URL+"Alex/Alex.json",0,c.AVATARS_URL+"Alex/Alex.png"],Noa:[c.AVATARS_URL+"Noa/Noa.glb",c.AVATARS_URL+"Noa/Noa.json",0,c.AVATARS_URL+"Noa/Noa.png"],Witch:[c.AVATARS_URL+"Eva_Witch/Eva_Witch.glb",c.AVATARS_URL+"Eva_Witch/Eva_Witch.json",0,c.AVATARS_URL+"Eva_Witch/Eva_Witch.png"],Kevin:[c.AVATARS_URL+"Kevin/Kevin.glb",c.AVATARS_URL+"Kevin/Kevin.json",0,c.AVATARS_URL+"Kevin/Kevin.png"],Ada:[c.AVATARS_URL+"Ada/Ada.glb",c.AVATARS_URL+"Ada/Ada.json",0,c.AVATARS_URL+"Ada/Ada.png"]}}setSpeed(t){this.mode==c.Modes.KEYFRAME?this.keyframeApp.speed=t:this.scriptApp.speed=t}setBackPlaneColor(e){return window.localStorage.setItem("color",e),"#transparent"==e?(this.scene.background=null,this.ground.material.color.set("#ffffff"),this.ground.material.opacity=.01,void(this.gui&&this.gui.setTransparentBackground())):(this.scene.background||(this.scene.background=new t.Color(e),this.gui&&this.gui.restoreColorBackground(),this.ground.material.opacity=.1),this.sceneColor=e,this.scene.background.set(e),this.backPlane&&(this.backPlane.material.color?this.backPlane.material.color.set(e):(this.photocallMaterial.uniforms.color.value.set(e),this.backPlane.material.uniforms.color.value.set(e),this.backPlane.material.needsUpdate=!0)),this.ground&&this.ground.material.color.set(e),!0)}setBackground(e,s=null){switch(this.background=e,window.localStorage.setItem("background",this.background),e){case c.Backgrounds.OPEN:this.backPlane.visible=!1,this.ground.visible=!0;break;case c.Backgrounds.STUDIO:if(this.backPlane.visible=!0,this.ground.visible=!1,this.repeatBackground=!1,s){s instanceof String?this.backgroundTexture=(new t.TextureLoader).load(this.backgroundTexture):s instanceof t.Texture||s instanceof t.VideoTexture||(this.backgroundTexture=new t.Texture(this.backgroundTexture),this.backgroundTexture.colorSpace=t.SRGBColorSpace),this.backgroundTexture.needsUpdate=!0;const e=this.backPlane.material.userData.shader;e?e.uniforms.textureMap.value=this.backgroundTexture:this.studioMaterial.uniforms.textureMap.value=this.backgroundTexture}this.backPlane.material=this.studioMaterial,this.backPlane.material.color?this.backPlane.material.color.set(this.sceneColor):this.backPlane.material.uniforms.color.value.set(this.sceneColor),this.backPlane.material.needsUpdate=!0;break;case c.Backgrounds.PHOTOCALL:if(this.backPlane.visible=!0,this.ground.visible=!1,this.repeatBackground=!0,s){"string"==typeof s?this.logoTexture=(new t.TextureLoader).load(this.logo):(this.logoTexture=new t.Texture(this.logo),this.logoTexture.colorSpace=t.SRGBColorSpace),this.logoTexture.needsUpdate=!0;const e=this.backPlane.material.userData.shader;e?e.uniforms.textureMap.value=this.logoTexture:this.photocallMaterial.uniforms.textureMap.value=this.logoTexture}this.backPlane.material=this.photocallMaterial,this.backPlane.material.color?this.backPlane.material.color.set(this.sceneColor):this.backPlane.material.uniforms.color.value.set(this.sceneColor),this.backPlane.material.needsUpdate=!0}}setPhotocallOffset(t){if(this.backPlane.material.uniforms)this.backPlane.material.uniforms.offset.value=t;else{const e=this.backPlane.material.userData.shader;e&&(e.uniforms.offset.value=t)}this.backPlane.material.needsUpdate=!0,this.repeatOffset=t}setBackgroundSettings(t){if(this.backPlane.material.uniforms)this.backPlane.material.defines.EXPAND="Expand"==t,this.backPlane.material.defines.FILL="Fill"==t,this.backPlane.material.defines.EXTEND="Extend"==t,this.backPlane.material.defines.ADJUST="Adjust"==t;else{const e=this.backPlane.material.userData.shader;e&&(e.defines.EXPAND="Expand"==t,e.defines.FILL="Fill"==t,e.defines.EXTEND="Extend"==t,e.defines.ADJUST="Adjust"==t)}this.backPlane.material.needsUpdate=!0,this.backgroundSettings=t}setBackgroundTextureScale(t){if(this.backPlane.material.uniforms)this.backPlane.material.uniforms.scale.value=t;else{const e=this.backPlane.material.userData.shader;e&&(e.uniforms.scale.value=t)}this.backPlane.material.needsUpdate=!0,this.textureScale=t}setBackgroundTexturePosition(t){if(this.backPlane.material.uniforms)this.backPlane.material.uniforms.position.value=t;else{const e=this.backPlane.material.userData.shader;e&&(e.uniforms.position.value=t)}this.backPlane.material.needsUpdate=!0,this.texturePosition=t}setClothesColor(t){return!!this.avatarShirt&&(this.avatarShirt.material.color.set(t),!0)}async setConfiguration(e,s){let i=e.rotation||window.localStorage.getItem("rotation");i&&(i=i.split(","),i=i.map(t=>Number(t)));let n=e.position||window.localStorage.getItem("position");n&&(n=n.split(","),n=n.map(t=>Number(t)));let a=e.scale||window.localStorage.getItem("scale");a&&(a=Number(a),a=[a,a,a]);const r=e=>{if(e.cloth){let t=e.cloth;"string"==typeof t&&(t=t.replace("0x","#")),this.setClothesColor(t)}if(i&&(this.currentCharacter.rotation=(new t.Quaternion).fromArray(i)),n&&(this.currentCharacter.position=(new t.Vector3).fromArray(n)),a&&(this.currentCharacter.scale=(new t.Vector3).fromArray(a)),e.animations)"string"==typeof e.animations&&(e.animations=JSON.parse(e.animations)),this.keyframeApp.processMessageFiles(e.animations).then(t=>{this.keyframeApp.currentAnimation=t[0],this.changeMode(c.Modes.KEYFRAME),this.autoplay&&this.changePlayState(!0),i&&this.currentCharacter.model.quaternion.fromArray(i),n&&this.currentCharacter.model.position.fromArray(n),a&&this.currentCharacter.model.scale.fromArray(a),s&&s(),e.onReady&&e.onReady()});else if(e.scripts){if("string"==typeof e.scripts)try{e.scripts=JSON.parse(e.scripts)}catch(t){console.warn(t)}this.scriptApp.processMessageFiles(e.scripts).then(t=>{this.scriptApp.onMessage(t),this.changeMode(c.Modes.SCRIPT),this.autoplay&&(this.changePlayState(),this.videoBackground&&this.videoBackground.play()),i&&this.currentCharacter.model.quaternion.fromArray(i),n&&this.currentCharacter.model.position.fromArray(n),a&&this.currentCharacter.model.scale.fromArray(a),e.onReady&&e.onReady(),s&&s()})}else i&&this.currentCharacter.model.quaternion.fromArray(i),n&&this.currentCharacter.model.position.fromArray(n),a&&this.currentCharacter.model.scale.fromArray(a),e.onReady&&e.onReady(),s&&s()};null!=e.trajectories?this.keyframeApp.trajectoriesActive=JSON.parse(e.trajectories):null!=window.localStorage.getItem("trajectories")&&(this.keyframeApp.trajectoriesActive=JSON.parse(window.localStorage.getItem("trajectories"))),null!=e.autoplay?this.autoplay=e.autoplay:null!=window.localStorage.getItem("autoplay")&&(this.autoplay=window.localStorage.getItem("autoplay")),null!=e.crossfade&&(this.keyframeApp.useCrossFade=e.crossfade),null!=e.srcEmbeddedTransforms?this.keyframeApp.srcEmbedWorldTransforms=e.srcEmbeddedTransforms:null!=window.localStorage.getItem("srcEmbeddedTransforms")&&(this.keyframeApp.srcEmbedWorldTransforms=window.localStorage.getItem("srcEmbeddedTransforms")),null!=e.trgEmbeddedTransforms?this.keyframeApp.trgEmbedWorldTransforms=e.trgEmbeddedTransforms:null!=window.localStorage.getItem("trgEmbedWorldTransforms")&&(this.keyframeApp.trgEmbedWorldTransforms=window.localStorage.getItem("trgEmbedWorldTransforms")),null!=e.srcReferencePose?this.keyframeApp.srcPoseMode=e.srcReferencePose:null!=window.localStorage.getItem("srcReferencePose")&&(this.keyframeApp.srcPoseMode=window.localStorage.getItem("srcReferencePose")),null!=e.trgReferencePose?this.keyframeApp.trgPoseMode=e.trgReferencePose:null!=window.localStorage.getItem("trgReferencePose")&&(this.keyframeApp.trgPoseMode=window.localStorage.getItem("trgReferencePose"));let o=!0;if(e.avatar){let i=e.avatar;const n=i.split(".");let a="",l=null;n.length>1?(a=n[n.length-2],a=a.split("/"),a=a.pop()):this.avatars[n[0]]&&(a=n[0],i=this.avatars[a][0],e.config=e.config||this.avatars[a][1],l=this.avatars[a][3]),(!this.currentCharacter||this.currentCharacter&&this.currentCharacter.model.name!=a)&&(o=!1,i.includes("models.readyplayer.me")&&(i+="?pose=T&morphTargets=ARKit&lod=1",l="https://models.readyplayer.me/"+a+".png?background=68,68,68"),this.gui&&(this.gui.avatarOptions[a]=[i,e.config,new t.Quaternion,l]),this.loadAvatar(i,e.config,new t.Quaternion,a,()=>{this.changeAvatar(a),r(e)},t=>{console.error(t),s&&s(t)}))}if(o){if(r(e),e.config){let t=this.currentCharacter.model.name;try{const s=await fetch(e.config);if(!s.ok)throw new Error(`Response status: ${s.status}`);let i=await s.json();i._filename=e.config,this.currentCharacter.config=i,this.scriptApp.onLoadAvatar(this.currentCharacter.model,this.currentCharacter.config,this.currentCharacter.skeleton),this.currentCharacter.skeleton.pose(),this.scriptApp.ECAcontroller.reset(),this.changeMode(c.Modes.SCRIPT),this.gui&&(this.gui.avatarOptions[t][1]=i._filename,this.gui.activePanelType==c.GUI.ACTIVEPANEL_SETTINGS&&this.gui.createSettingsPanel())}catch(t){console.error(t.message,"File error!")}}i&&this.currentCharacter.model.quaternion.fromArray(i)}if(null!=e.controls)this.controlsActive=!("false"===e.controls||!1===e.controls);else if(null!=window.localStorage.getItem("controls")){const t=window.localStorage.getItem("controls");this.controlsActive=!("false"===t||!1===t)}let l=e.background||window.localStorage.getItem("background");if(l){switch(l.toLocaleLowerCase()){case"studio":this.background=c.Backgrounds.STUDIO;break;case"photocall":this.background=c.Backgrounds.PHOTOCALL}this.setBackground(this.background)}if(e.img){this.setBackground(c.Backgrounds.PHOTOCALL);let t=e.img;const s=t=>{this.logo=t.target,this.setBackground(c.Backgrounds.PHOTOCALL,this.logo)},i=new Image;i.onload=s,fetch(t).then(function(t){t.ok?t.blob().then(function(t){var e=URL.createObjectURL(t);i.src=e}):console.log("Bad request")}).catch(function(t){console.log("Error:"+t.message)})}let h=e.color||window.localStorage.getItem("color");if(h&&("string"==typeof h&&(h=h.replace("0x","#"),h.includes("#")||(h="#"+h)),this.sceneColor=h,this.setBackPlaneColor(this.sceneColor)),e.offset){let t=Number(e.offset);this.setPhotocallOffset(t)}if(e.light){let t=e.light;"string"==typeof t&&(t=t.replace("0x","#")),this.dirLight.color.set(t)}if(e.lightpos){let t=e.lightpos;t=t.split(","),3==t.length&&this.dirLight.position.set(Number(t[0]),Number(t[1]),Number(t[2]))}if(null!=e.restrictView){let t="false"===e.restrictView||!1===e.restrictView;this.changeCameraMode(!t)}else if(null!=window.localStorage.getItem("restrictView")){let t=window.localStorage.getItem("restrictView");t=!("false"===t||!1===t),this.changeCameraMode(!t)}null!=e.applyIdle?this.scriptApp.applyIdle=e.applyIdle:null!=window.localStorage.getItem("applyIdle")&&(this.scriptApp.applyIdle=window.localStorage.getItem("applyIdle"))}changeMode(t){this.mode=t,this.currentCharacter&&this.currentCharacter.skeleton.pose(),this.scriptApp.ECAcontroller&&(this.scriptApp.ECAcontroller.reset(),this.scriptApp.ECAcontroller.update(0,0)),this.mode==c.Modes.KEYFRAME&&this.keyframeApp.currentAnimation&&(this.changeAnimation(this.keyframeApp.currentAnimation,!0),this.autoplay&&this.changePlayState(!0)),this.gui&&this.gui.onChangeMode(t)}changeAnimation(t,e=!1){this.mode==c.Modes.KEYFRAME&&this.keyframeApp.onChangeAnimation(t,e)}changePlayState(t){this.mode==c.Modes.KEYFRAME?this.keyframeApp.changePlayState(t):this.scriptApp.replay()}getSpeed(){return this.mode==c.Modes.KEYFRAME?this.keyframeApp.speed:this.scriptApp.speed}getBackPlaneColor(){return this.sceneColor}getClothesColor(){return this.avatarShirt?this.avatarShirt.material.color.getHexString():0}loadFiles(t,e){}init(e){this.scene=new t.Scene;const s=this.sceneColor=window.debugMode?"#4f4f9c ":"#46c219";if(this.scene.background=new t.Color(s),this.renderer=new t.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.toneMapping=t.LinearToneMapping,this.renderer.toneMappingExposure=1,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=t.PCFSoftShadowMap,this._createCameras(),this._createLights(),this._createBackgrounds(),this._createRecorder(),this.changeCameraMode(this.cameraRestricted),this.renderer.render(this.scene,this.cameras[this.camera]),this.scriptApp.init(this.scene),!e){e={};const t=window.location.search,s=new URLSearchParams(t);for(const[t,i]of s.entries())e[t]=i}let i={},n=window.localStorage.getItem("avatar")||"Eva";if(e.avatar){let s=e.avatar;const a=s.split(".");let r="";a.length>1?(r=a[a.length-2],r=r.split("/"),r=r.pop(),s+=s.includes("models.readyplayer.me")?"?pose=T&morphTargets=ARKit&lod=1":"",i=[s,e.config,new t.Quaternion,null,r],n=r):1==a.length&&this.avatars[a[0]]?(n=a[0],i=this.avatars[n],i.push(n)):e.avatar=n}else e.avatar=n;if(e.rotation){let t=e.rotation;t=t.split(","),i[2].fromArray(t)}c.GUI&&(this.gui=new c.GUI(this)),this._onLoading("Loading avatar..."),this.setConfiguration(e,t=>{this.gui?(this.gui.avatarOptions[n]||(i[3]=i[0].includes("models.readyplayer.me")?"https://models.readyplayer.me/"+name+".png?background=transparent":c.GUI.THUMBNAIL,this.gui.avatarOptions[n]=i,this.gui.refresh()),this.controlsActive||this.gui.hideControls()):window.document.body.appendChild(this.renderer.domElement),this._onLoadingEnded(),this._animate(),this.isAppReady=!0,this.pendingMessageReceived&&(this._onMessage(this.pendingMessageReceived),this.pendingMessageReceived=null)}),window.addEventListener("message",this._onMessage.bind(this)),window.addEventListener("resize",this._onWindowResize.bind(this))}appendCanvasTo(t){t&&(this.renderer.domElement.remove(),t.appendChild(this.renderer.domElement),this._onWindowResize())}_newCameraFrom({azimuthAngle:e=0,polarAngle:i=0,depth:n=0,controlsEnabled:a=!1}){let r=new t.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.01,1e3);r.record=!0;let o=new s(r,this.renderer.domElement);o.target.set(0,1.3,0);let l=new t.Vector3(0,1.5,Math.cos(5*Math.PI/180)),h=l.distanceTo(o.target),c=(new t.Vector3).subVectors(l,o.target).normalize();return c.applyAxisAngle(new t.Vector3(1,0,0),i*Math.PI/180),c.applyAxisAngle(new t.Vector3(0,1,0),e*Math.PI/180),l.addVectors(o.target,c.multiplyScalar(h)),l.add(new t.Vector3(0,0,n)),o.object.position.set(...l),o.enableDamping=!0,o.dampingFactor=.1,o.enabled=a,o.update(),this.cameras.push(r),this.controls.push(o),{camera:r,controls:o}}_createCameras(){this._newCameraFrom({azimuthAngle:0,controlsEnabled:!0}),this._newCameraFrom({azimuthAngle:25}),this._newCameraFrom({azimuthAngle:-25}),this.camera=0}_createLights(){const e=new t.HemisphereLight(16777215,16777215,.5);this.scene.add(e);const s=new t.SpotLight(16777215,3.5,0,Math.PI/180*45,.5,2);s.position.set(.5,2,2),s.target.position.set(0,1,0),this.scene.add(s.target),this.scene.add(s);const i=new t.SpotLight(16777215,2,0,Math.PI/180*45,.5,2);i.position.set(-.5,2,1.5),i.target.position.set(0,1,0),this.scene.add(i.target),this.scene.add(i);const n=this.dirLight=new t.DirectionalLight(16777215,2);n.position.set(1.5,5,2),n.castShadow=!0,n.shadow.mapSize.width=1024,n.shadow.mapSize.height=1024,n.shadow.camera.left=-2,n.shadow.camera.right=2,n.shadow.camera.bottom=-2,n.shadow.camera.top=2,n.shadow.camera.near=.5,n.shadow.camera.far=20,n.shadow.bias=1e-5,this.scene.add(n);const a=new t.Object3D;this.scene.add(a),n.target=a}_createBackgrounds(){const e=this.ground=new t.Mesh(new t.PlaneGeometry(20,20),new t.MeshStandardMaterial({color:this.sceneColor,opacity:.1,transparent:!0,depthWrite:!0,roughness:1,metalness:0}));e.name="Ground",e.rotation.x=-Math.PI/2,e.receiveShadow=!0,this.scene.add(e),this.studioMaterial=new t.MeshStandardMaterial({color:this.sceneColor,depthWrite:!0,roughness:1,metalness:0}),this.studioMaterial.onBeforeCompile=async t=>{t.uniforms.textureMap={value:this.backgroundTexture},t.uniforms.position={value:this.texturePosition},t.uniforms.scale={value:this.textureScale},t.uniforms.type={value:this.backgroundSettings},t.uniforms.size={value:[20,20]},t.vertexShader="#define USE_UV;\n#define USE_TRANSMISSION;\nvarying vec3 vPosition;\n"+t.vertexShader,t.fragmentShader=`#define EXPAND ${"Expand"==this.backgroundSettings}\n#define EXTEND ${"Extend"==this.backgroundSettings}\n#define FILL ${"Fill"==this.backgroundSettings}\n#define ADJUST ${"Adjust"==this.backgroundSettings}\n#define USE_UV;\nuniform sampler2D textureMap;\nuniform vec2 position; uniform float scale; // Texture repetition count\nuniform float offset;// Offset for the texture in UV space;\nuniform vec2 size;\nvarying vec3 vWorldPosition;\n`+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("vec4 diffuseColor = vec4( diffuse, opacity );",de),this.studioMaterial.userData.shader=t},this.logoTexture=(new t.TextureLoader).load(this.logo),this.logoTexture.wrapS=t.RepeatWrapping,this.repeatOffset=0,this.repeatCount=[20,20],this.repeatBackground=!0,this.photocallMaterial=new t.MeshStandardMaterial({color:this.sceneColor,depthWrite:!0,roughness:1,metalness:0}),this.photocallMaterial.onBeforeCompile=async t=>{t.uniforms.textureMap={value:this.logoTexture},t.uniforms.repeat={value:this.repeatCount},t.uniforms.offset={value:this.repeatOffset},t.vertexShader="#define USE_UV;\n#define USE_TRANSMISSION;\nvarying vec3 vPosition;\n"+t.vertexShader,t.fragmentShader="#define USE_UV;\nuniform sampler2D textureMap\n;uniform vec2 repeat; // Texture repetition count\nuniform float offset; // Offset for the texture in UV space;\nvarying vec3 vWorldPosition;\n"+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("vec4 diffuseColor = vec4( diffuse, opacity );",ce),this.photocallMaterial.userData.shader=t;const e=new URLSearchParams(window.location.search);if(e.has("img")){const t=new Image;t.onload=t=>{this.logo=t.target,this.setBackground(c.Backgrounds.PHOTOCALL,this.logo)};const s=e.get("img");try{const e=await fetch(s);if(!e.ok)throw new Error(`Response status: ${e.status}`);const i=await e.blob(),n=URL.createObjectURL(i);t.src=n}catch(t){console.error(t.message,"File error!")}}};const s=this.backPlane=new t.Mesh(function(e=5,s=5,i=2){const n=new t.PlaneGeometry(e,s,i,i),a=n.attributes.position;let r=[];for(let e=0;e<a.count;e++){let s=new t.Vector3;s.fromBufferAttribute(a,e),s.y<0&&(s.z=-s.y,s.y=0),r.push(s.x),r.push(s.y),r.push(s.z)}return r=new Float32Array(r),n.setAttribute("position",new t.BufferAttribute(r,3)),n}(15,10),this.studioMaterial);s.name="Chroma",s.position.z=-1,s.receiveShadow=!0,s.castShadow=!0,s.visible=!1,this.scene.add(s),this.setBackground(this.background)}_createRecorder(){this.animationRecorder=new m(this.cameras.length,this),this.animationRecorder.onStartCapture=t=>{this.gui&&this.gui.showCaptureModal(t)},this.animationRecorder.onStopCapture=()=>{this.gui&&this.gui.hideCaptureModal()}}loadAvatar(e,s,i,n,a=null,r=null){e.includes("models.readyplayer.me")&&(e+="?morphTargets=ARKit"),this.loaderGLB.load(e,async e=>{let r=e.scene;r.quaternion.premultiply(i),r.castShadow=!0;let o=null;const l={};if("Witch"==n?r.traverse(e=>{e.isMesh||e.isSkinnedMesh?(e.skeleton&&(o=e.skeleton),e.name.includes("Hat")||(e.material.side=t.FrontSide),e.frustumCulled=!1,e.castShadow=!0,e.receiveShadow=!0,"Eyelashes"==e.name&&(e.castShadow=!1),e.material.map&&(e.material.map.anisotropy=16),"Hair"==e.name&&(e.material.map=null,e.material.color.set(7149697)),e.name.includes("Bottom")&&(e.material.map=null,e.material.color.set(0)),e.name.includes("Top")&&(e.material.map=null,e.material.color.set(0)),e.name.includes("Shoes")&&(e.material.map=null,e.material.color.set(1681315)),e.morphTargetDictionary&&(l[e.name]=e.morphTargetDictionary)):e.isBone&&e.scale.set(1,1,1)}):r.traverse(e=>{e.isMesh||e.isSkinnedMesh?(e.skeleton&&(o=e.skeleton),e.material.side=t.FrontSide,e.frustumCulled=!1,e.castShadow=!0,e.receiveShadow=!0,"Eyelashes"==e.name&&(e.castShadow=!1),e.material.map&&(e.material.map.anisotropy=16),e.morphTargetDictionary&&(l[e.name]=e.morphTargetDictionary)):e.isBone&&e.scale.set(1,1,1)}),"Kevin"==n){let t=r.getObjectByName("Classic_short");t&&t.children.length>1&&(t.children[1].renderOrder=1)}if(r.name=n,this.loadedCharacters[n]={model:r,skeleton:o,config:null,morphTargets:l},s)if("string"==typeof s){const t=await fetch(s);if(t.ok){const e=await t.text();let i=JSON.parse(e);i._filename=s,this.loadedCharacters[n].config=i,this.scriptApp.onLoadAvatar(r,i,o),this.keyframeApp.onLoadAvatar(this.loadedCharacters[n])}a&&a()}else{const t=s;this.loadedCharacters[n].config=t,this.scriptApp.onLoadAvatar(r,t,o),this.keyframeApp.onLoadAvatar(this.loadedCharacters[n]),a&&a()}else this.keyframeApp.onLoadAvatar(this.loadedCharacters[n]),a&&a()},null,t=>{r&&r(t)})}_animate(){if(requestAnimationFrame(this._animate.bind(this)),!this.cameraRestricted){let e=this.controls[this.camera].target.clone();e.y=0;let s=this.cameras[this.camera].position.clone();s.y=0;let i=e.distanceTo(s),n=new t.Vector2(this.controls[this.camera].target.y,0),a=new t.Vector2(0,i),r=Math.atan2(a.y-n.y,a.x-n.x);this.controls[this.camera].maxPolarAngle=r-.01}this.controls[this.camera].update();let e=this.clock.getDelta();switch(this.elapsedTime+=e,this.mode){case c.Modes.SCRIPT:this.scriptApp.update(e);break;case c.Modes.KEYFRAME:this.keyframeApp.update(e)}this.animationRecorder&&this.animationRecorder.isRecording&&this.animationRecorder.update(this.scene,this.cameras),this.cameras[this.camera].layers.enable(0),this.cameras[this.camera].layers.enable(1),this.keyframeApp.trajectoriesActive?this.cameras[this.camera].layers.enable(2):this.cameras[this.camera].layers.disable(2),this.renderer.render(this.scene,this.cameras[this.camera])}_precomputeFeetOffset(e){const s=this.loadedCharacters[e],i=Xt(s.skeleton);s.LToeName=s.model.getObjectByName(i.nameMap.LFoot).children[0].name,s.RToeName=s.model.getObjectByName(i.nameMap.RFoot).children[0].name;const n=s.model.getObjectByName(i.nameMap.LFoot).children[0].getWorldPosition(new t.Vector3),a=s.model.getObjectByName(i.nameMap.RFoot).children[0].getWorldPosition(new t.Vector3);let r=new t.Vector3(0,1,0);this.raycaster.set(new t.Vector3(n.x,-1,n.z),r),this.raycaster.layers.enable(0);const o=this.raycaster.intersectObjects(s.model.children[0].children,!0);let l=0;if(o.length>0){l=o[0].point.y}return s.LToePos=n,s.RToePos=a,l}_onMessage(t){if(!this.isAppReady)return void(this.pendingMessageReceived=t);let e=t.data;if("string"==typeof e)try{e=JSON.parse(e)}catch(s){if(e.includes("setImmediate"))return;console.error("Error while parsing an external message: ",t)}e&&(e.askingStatus?t.source.postMessage({appStatus:!0},"*"):Array.isArray(e)?this.scriptApp.onMessage(e,t=>{this.changeMode(c.Modes.SCRIPT),this.gui&&this.gui.setBMLInputText(JSON.stringify(this.scriptApp.msg.data,function(t,e){return e.toFixed?Number(e.toFixed(3)):e})),this.autoplay&&(this.changePlayState(),this.videoBackground&&this.videoBackground.play())}):"bvh"!=e.type&&"bvhe"!=e.type&&"glb"!=e.type&&"gltf"!=e.type&&"fbx"!=e.type||this.keyframeApp.onMessage(e,()=>{this.changeMode(c.Modes.KEYFRAME),this.gui&&this.gui.refresh(),this.autoplay&&this.changePlayState(!0)}))}_onWindowResize(){const t=this.renderer.domElement.parentElement;let e=window.innerWidth,s=window.innerHeight;if(t){e=t.clientWidth,s=t.clientHeight;const i=t.style.paddingTop?Number(t.style.paddingTop.replace("px","")):0,n=t.style.paddingBottom?Number(t.style.paddingBottom.replace("px","")):0;e-=(t.style.paddingLeft?Number(t.style.paddingLeft.replace("px","")):0)+(t.style.paddingRight?Number(t.style.paddingRight.replace("px","")):0),s-=i+n}for(let t=0;t<this.cameras.length;t++)this.cameras[t].aspect=e/s,this.cameras[t].updateProjectionMatrix();this.renderer.setSize(e,s)}changeAvatar(t){this.currentCharacter&&this.scene.remove(this.currentCharacter.model),this.currentCharacter=this.loadedCharacters[t],this.scene.add(this.currentCharacter.model);const e=this._precomputeFeetOffset(t);this.loadedCharacters[t].diffToGround=e,this.loadedCharacters[t].position=this.currentCharacter.model.position.clone(),this.keyframeApp.trajectoriesActive=this.keyframeApp.trajectoriesActive&&this.mode==c.Modes.KEYFRAME,this.scriptApp.onChangeAvatar(t),this.keyframeApp.onChangeAvatar(t),this.currentCharacter.config?(this.currentCharacter.skeleton.bones[this.currentCharacter.config.boneMap.ShouldersUnion].getWorldPosition(this.controls[this.camera].target),this.controls.forEach(t=>{t.target.copy(this.controls[this.camera].target),t.saveState(),t.update()}),this.mode==c.Modes.SCRIPT&&this.scriptApp.currentIdle&&this.scriptApp.bindAnimationToCharacter(this.scriptApp.currentIdle,this.currentCharacter.model.name)):this.changeMode(c.Modes.KEYFRAME),this.currentCharacter.model.traverse(t=>{t.isSkinnedMesh&&(t.name.includes("Top")||t.name.includes("Shirt"))&&(this.avatarShirt=t)}),window.localStorage.setItem("avatar",t),this.gui&&this.gui.refresh()}toggleCameraMode(){this.changeCameraMode(!this.cameraRestricted)}changeCameraMode(e){e?(this.controls[this.camera].enablePan=!1,this.controls[this.camera].minDistance=.7,this.controls[this.camera].maxDistance=2,this.controls[this.camera].minAzimuthAngle=-2,this.controls[this.camera].maxAzimuthAngle=2,this.controls[this.camera].minPolarAngle=.6,this.controls[this.camera].maxPolarAngle=2.1,this.currentCharacter&&this.currentCharacter.config&&this.currentCharacter.skeleton.bones[this.currentCharacter.config.boneMap.ShouldersUnion].getWorldPosition(this.controls[this.camera].target)):(this.controls[this.camera].enablePan=!0,this.controls[this.camera].minDistance=.1,this.controls[this.camera].maxDistance=10,this.controls[this.camera].minAzimuthAngle=t.Infinity,this.controls[this.camera].maxAzimuthAngle=t.Infinity,this.controls[this.camera].minPolarAngle=0,this.controls[this.camera].maxPolarAngle=Math.PI),this.controls[this.camera].update(),this.cameraRestricted=e,window.localStorage.setItem("restrictView",e)}openAtelier(e,s,i,n=!0,a=0){let r=i;if(i&&!n){r=JSON.parse(JSON.stringify(i));const e=this.currentCharacter.skeleton,s=s=>{let i={};const n=new t.Matrix4,a=new t.Matrix3;for(let t in s){const r=[],o=s[t];o.parent||(o.parent=e.bones[u.findIndexOfBoneByName(e,o[0])].name);let l=u.findIndexOfBoneByName(e,o.parent.name);l<0||(r.push(o.parent.name),n.copy(e.boneInverses[l]).invert(),r.push(o.position.clone().applyMatrix4(n)),o.direction&&(a.setFromMatrix4(n),r.push(o.direction.clone().applyMatrix3(a))),i[t]=r)}return i};r.bodyController.bodyLocations=s(i.bodyController.bodyLocations),r.bodyController.handLocationsL=s(i.bodyController.handLocationsL),r.bodyController.handLocationsR=s(i.bodyController.handLocationsR)}const o=[e,s,r,a];(t=>{!this._atelier||this._atelier.closed?(this._atelier=window.open(c.ATELIER_URL,"Atelier"),setTimeout(()=>this._atelier.postMessage(t,"*"),1e3)):(this._atelier.focus(),this._atelier.postMessage(t,"*"))})(JSON.stringify(o))}export(t=null,e=null,s){if("GLB"===t){let t={binary:!0,animations:[]};const i=this.keyframeApp.exportAnimations();let n=this.currentCharacter.mixer._root;t.animations=[...i],this.GLTFExporter.parse(n,t=>function(t,e,s="text/plain"){const i=new Blob([t],{type:s});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(i,e);else{let t=document.createElement("a"),s=URL.createObjectURL(i);t.href=s,t.download=e,t.click(),setTimeout(function(){window.URL.revokeObjectURL(s)},0)}}(t,(e||"animations")+".glb","arraybuffer"),t=>{console.log("An error happened:",t),s&&s(t)},t)}}_onLoading(t){this.onLoading?this.onLoading(t):this.gui&&this.gui.makeLoading(t)}_onLoadingEnded(){this.onLoadingEnded?this.onLoadingEnded():this.gui&&this.gui.hideLoading()}}c.Performs=he;const ce='vec4 diffuseColor = vec4( diffuse, 1.0 );\n\n     ivec2 texSize = textureSize(textureMap, 0);\n     float texAspect = float(texSize.x) / float(texSize.y);\n     if (vWorldPosition.y > 0.0) { \n       // Get the aspect ratio of the texture \n       // Adjust UVs based on the texture aspect ratio \n       vec2 aspectCorrectedUV = vec2(vUv.x, vUv.y * texAspect); \n       // Scale the UV coordinates by the repeat factors \n       vec2 uvScaled = aspectCorrectedUV * repeat; \n       // Use mod to wrap the UVs for repeating the texture \n       vec2 uvMod = mod(uvScaled, 1.0); \n       float shrinkFactor = 1.0 - 2.0 * offset; // Shrink the texture to fit between gaps\n       // Only apply the texture inside the non-gap area \n       if (uvMod.x > offset && uvMod.x < (1.0 - offset) && uvMod.y > offset && uvMod.y < (1.0 - offset)) { \n           // Calculate the "shrunken" UV coordinates to fit the texture within the non-gap area \n           vec2 uvShrink = (fract(uvScaled) - offset) / vec2(shrinkFactor); \n           // Compute derivatives for mipmapping \n           vec2 smooth_uv = uvScaled; \n           vec4 duv = vec4(dFdx(smooth_uv), dFdy(smooth_uv)); \n           vec4 texColor = textureGrad(textureMap, uvShrink, duv.xy, duv.zw); \n           diffuseColor = mix(texColor, diffuseColor, 1.0 - texColor.a); \n       } \n     }\n',de="vec4 diffuseColor = vec4( diffuse, 1.0 );\n\n     ivec2 texSize = textureSize(textureMap, 0);\n     float texAspect = float(texSize.x) / float(texSize.y);\n     vec2 resolution = vec2(size.x, size.y*0.5 ); \n     float objAspect = resolution.x / resolution.y;\n     if (vWorldPosition.y > 0.0) { \n         vec2 smooth_uv = vUv;\n         smooth_uv.y = 2.0 * (smooth_uv.y) - 1.0; \n         if ( FILL ) {\n           // Fill all surface taking into accound proportions (if texture is bigger than the resolution, only a part is shown)\n           if( texAspect > objAspect ) {\n               smooth_uv.x = ( smooth_uv.x - 0.5) * ( objAspect / texAspect ) + 0.5;\n           }\n           else {\n               smooth_uv.y = ( smooth_uv.y - 0.5) * ( texAspect / objAspect ) + 0.5;\n           }\n         } \n         else if ( ADJUST ) {\n           // Adjust the texture in the surface (if texture is lower than the resolution, empty parts are shown)\n           if( texAspect > objAspect ) {\n               smooth_uv.y = ( smooth_uv.y - 0.5) * ( texAspect / objAspect ) + 0.5;\n           }\n           else {\n               smooth_uv.x = ( smooth_uv.x - 0.5) * ( objAspect / texAspect ) + 0.5;\n           }\n         } \n         else if ( EXTEND ) {\n           smooth_uv = (smooth_uv - 0.5) * texAspect / objAspect + 0.5;\n         } \n         // Expand the texture to adjust it into the surface (does not take into account proportions) \n         else if ( EXPAND ) {\n             // Compute derivatives for mipmapping\n             //smooth_uv.x = 2.0 * (smooth_uv.x) - 0.5; \n         } \n         smooth_uv -= position;\n         smooth_uv /= vec2(scale);\n         if( smooth_uv.x <= 1.0 && smooth_uv.x >= 0.0 && smooth_uv.y <= 1.0 && smooth_uv.y >= 0.0 ) { \n           vec4 texColor = texture2D(textureMap, smooth_uv);\n           diffuseColor = mix(diffuseColor, texColor, texColor.a);\n         }\n     }\n";export{d as GUI,c as PERFORMS,he as Performs};
